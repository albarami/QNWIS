name: Readiness Gate CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # Manual trigger

jobs:
  pre-gate:
    name: "Pre-Gate Sanity"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install minimal dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Run placeholder scan
        run: |
          python src/qnwis/scripts/qa/placeholder_scan.py --limit 200

      - name: Build import graph
        run: |
          python src/qnwis/scripts/qa/import_graph.py --output src/qnwis/docs/audit/import_graph.json

  pre-commit:
    name: "Pre-commit Hooks"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: pre-gate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pre-commit

      - name: Run pre-commit
        run: |
          pre-commit run --all-files --show-diff-on-failure

  api-slice:
    name: "Step 27 API Slice"
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: pre-commit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Lint API slice
        run: |
          ruff check src/qnwis/api src/qnwis/security src/qnwis/observability src/qnwis/cli

      - name: Type-check API slice
        run: |
          mypy src/qnwis/api src/qnwis/security src/qnwis/observability src/qnwis/cli

      - name: Run API unit/integration tests
        run: |
          pytest -q tests/unit/api tests/integration/api

  step26-slice:
    name: "Step 26 Scenario Slice"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: pre-commit
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dev dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Scenario placeholder scan (core)
        run: |
          python src/qnwis/scripts/qa/placeholder_scan.py --limit 200 --root src/qnwis/scenario

      - name: Scenario placeholder scan (agents)
        run: |
          python src/qnwis/scripts/qa/placeholder_scan.py --limit 200 --root src/qnwis/agents

      - name: Run Step 26 tests
        run: |
          pytest \
            tests/unit/scenario \
            tests/unit/agents/test_scenario_agent.py \
            tests/integration/agents/test_scenario_end_to_end.py \
            tests/integration/agents/test_scenario_verification.py \
            -v --maxfail=1

  step28-slice:
    name: "Step 28 Alert Slice"
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: pre-commit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run alert pytest slice
        run: |
          pytest -q \
            tests/unit/alerts \
            tests/unit/agents/test_alert_center.py \
            tests/integration/agents/test_alert_flow.py

      - name: Run Ops Gate
        run: |
          python src/qnwis/scripts/qa/ops_gate.py

  step29-slice:
    name: "Step 29 Notify Slice"
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: pre-commit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pre-commit

      - name: Run notify pre-commit slice
        run: |
          pre-commit run step29-notify-slice --all-files --show-diff-on-failure

      - name: Run Ops Notify Gate
        run: |
          python src/qnwis/scripts/qa/ops_notify_gate.py

      - name: Upload notify artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: step29-notify-artifacts
          path: |
            OPS_NOTIFY_SUMMARY.md
            ops_notify_report.json
          docs/audit/ops/RG4_SUMMARY.json
          src/qnwis/docs/audit/badges/rg4_notify.svg
          retention-days: 30

  step30-slice:
    name: "Step 30 Ops Console Slice"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: pre-commit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pre-commit

      - name: Run ops console pre-commit slice
        run: |
          pre-commit run step30-ops-console-slice --all-files --show-diff-on-failure

      - name: Run Ops Console Gate
        run: |
          python src/qnwis/scripts/qa/ops_console_gate.py

      - name: Upload ops console artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: step30-ops-console-artifacts
          path: |
            src/qnwis/docs/audit/ops/ui_gate_report.json
            src/qnwis/docs/audit/ops/ui_metrics.json
            src/qnwis/docs/audit/badges/rg5_ops_console.svg
            OPS_UI_SUMMARY.md
          retention-days: 30

  step31-slice:
    name: "Step 31 SLO Slice"
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: pre-commit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run SLO slice
        run: |
          python src/qnwis/scripts/qa/step31_slo_slice.py

      - name: Run RG-6 gate
        run: |
          python src/qnwis/scripts/qa/rg6_resilience_gate.py

      - name: Upload RG-6 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: step31-rg6-artifacts
          path: |
            docs/audit/rg6/rg6_report.json
            docs/audit/rg6/SLO_SUMMARY.md
            docs/audit/rg6/sli_snapshot.json
            docs/audit/badges/rg6_pass.svg
          retention-days: 30

  step32-dr-slice:
    name: "Step 32 DR Slice"
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: pre-commit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run DR slice
        run: |
          python src/qnwis/scripts/qa/step32_dr_slice.py

      - name: Run RG-7 gate
        run: |
          python -m src.qnwis.scripts.qa.rg7_recovery_gate

      - name: Upload RG-7 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: step32-rg7-artifacts
          path: |
            docs/audit/rg7/rg7_report.json
            docs/audit/rg7/DR_SUMMARY.md
            docs/audit/rg7/sample_manifest.json
            src/qnwis/docs/audit/badges/rg7_pass.svg
          retention-days: 30

  step33-continuity-slice:
    name: "Step 33 Continuity Slice"
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: pre-commit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run continuity slice
        run: |
          python src/qnwis/scripts/qa/step33_continuity_slice.py

      - name: Run RG-8 gate
        run: |
          python src/qnwis/scripts/qa/rg8_continuity_gate.py

      - name: Upload RG-8 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: step33-rg8-artifacts
          path: |
            docs/audit/rg8/rg8_report.json
            docs/audit/rg8/CONTINUITY_SUMMARY.md
            docs/audit/rg8/sample_plan.yaml
            docs/audit/badges/rg8_pass.svg
            src/qnwis/docs/audit/badges/rg8_pass.svg
          retention-days: 30

  readiness-gate:
    name: "Readiness Gate - Steps 1-33"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs:
      - pre-commit
      - step28-slice
      - step29-slice
      - step30-slice
      - step31-slice
      - step32-dr-slice
      - step33-continuity-slice

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pyyaml

      - name: Create required directories
        run: |
          mkdir -p src/qnwis/docs/audit/artifacts
          mkdir -p tests/system

      - name: Run Readiness Gate
        id: readiness_gate
        run: |
          python src/qnwis/scripts/qa/readiness_gate.py
        continue-on-error: true

      - name: Upload JSON Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: readiness-report-json
          path: src/qnwis/docs/audit/readiness_report.json
          retention-days: 30

      - name: Upload Markdown Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: readiness-report-md
          path: src/qnwis/docs/audit/READINESS_REPORT_1_25.md
          retention-days: 30

      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/
          retention-days: 30

      - name: Check Gate Status
        run: |
          if [ -f "src/qnwis/docs/audit/readiness_report.json" ]; then
            PASS=$(python -c "import json; f=open('src/qnwis/docs/audit/readiness_report.json'); print(json.load(f)['overall_pass'])")
            if [ "$PASS" != "True" ]; then
              echo "❌ Readiness Gate FAILED"
              exit 1
            else
              echo "✅ Readiness Gate PASSED"
            fi
          else
            echo "❌ Readiness report not generated"
            exit 1
          fi

      - name: Comment PR with Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'src/qnwis/docs/audit/readiness_report.json';
            
            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              const status = report.overall_pass ? '✅ PASSED' : '❌ FAILED';
              const summary = report.summary;
              
              let comment = `## Readiness Gate Results ${status}\n\n`;
              comment += `**Execution Time:** ${report.execution_time_ms.toFixed(0)}ms\n\n`;
              comment += `### Summary\n`;
              comment += `- Total Gates: ${summary.total}\n`;
              comment += `- Passed: ${summary.passed}\n`;
              comment += `- Failed: ${summary.failed}\n\n`;
              
              comment += `### Gate Details\n`;
              for (const gate of report.gates) {
                const gateStatus = gate.ok ? '✅' : '❌';
                comment += `- ${gateStatus} **${gate.name}** (${gate.duration_ms.toFixed(0)}ms)\n`;
              }
              
              comment += `\n[View full report](${context.payload.pull_request.html_url}/checks)`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  system-tests:
    name: "System Tests - Readiness Gate"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: pre-commit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pyyaml

      - name: Run System Tests
        run: |
          pytest tests/system/test_api_readiness.py -v --tb=short

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: system-test-results
          path: |
            junit.xml
            pytest-report.html
          retention-days: 30
