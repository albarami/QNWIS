<?xml version="1.0" encoding="utf-8"?><testsuites name="pytest tests"><testsuite name="pytest" errors="19" failures="124" skipped="9" tests="1853" time="493.491" timestamp="2025-11-10T06:00:11.649721+00:00" hostname="VM-MOL-ITLY-A10"><testcase classname="" name="tests.system.test_readiness_gate" time="0.000"><skipped message="collection skipped">('D:\\lmis_int\\tests\\system\\test_readiness_gate.py', 21, 'Skipped: Skip readiness gate system tests during nested RG-1 execution')</skipped></testcase><testcase classname="tests.integration.agents.test_pattern_miner_integration.TestStableRelationsIntegration" name="test_end_to_end_with_strong_correlation" time="0.119" /><testcase classname="tests.integration.agents.test_pattern_miner_integration.TestStableRelationsIntegration" name="test_narrative_includes_all_metadata" time="0.001" /><testcase classname="tests.integration.agents.test_pattern_miner_integration.TestStableRelationsIntegration" name="test_multiple_drivers_ranked" time="0.002" /><testcase classname="tests.integration.agents.test_pattern_miner_integration.TestSeasonalEffectsIntegration" name="test_end_to_end_seasonal_analysis" time="0.001" /><testcase classname="tests.integration.agents.test_pattern_miner_integration.TestSeasonalEffectsIntegration" name="test_narrative_structure_complete" time="0.001" /><testcase classname="tests.integration.agents.test_pattern_miner_integration.TestDriverScreenIntegration" name="test_end_to_end_cohort_screening" time="0.005" /><testcase classname="tests.integration.agents.test_pattern_miner_integration.TestDriverScreenIntegration" name="test_multiple_cohorts_mentioned" time="0.003" /><testcase classname="tests.integration.agents.test_pattern_miner_integration.TestDriverScreenIntegration" name="test_multiple_windows_processed" time="0.003" /><testcase classname="tests.integration.agents.test_pattern_miner_integration.TestDerivedResultProvenance" name="test_stable_relations_derived_qid_format" time="0.001" /><testcase classname="tests.integration.agents.test_pattern_miner_integration.TestDerivedResultProvenance" name="test_seasonal_effects_derived_qid_format" time="0.002" /><testcase classname="tests.integration.agents.test_pattern_miner_integration.TestDerivedResultProvenance" name="test_driver_screen_derived_qid_format" time="0.001" /><testcase classname="tests.integration.agents.test_pattern_miner_integration.TestCitationCompliance" name="test_stable_relations_includes_citations" time="0.001" /><testcase classname="tests.integration.agents.test_pattern_miner_integration.TestCitationCompliance" name="test_seasonal_effects_includes_citations" time="0.001" /><testcase classname="tests.integration.agents.test_pattern_miner_integration.TestCitationCompliance" name="test_freshness_included" time="0.001" /><testcase classname="tests.integration.agents.test_predictor_agent.TestPredictorForecastBaseline" name="test_successful_forecast" time="0.013"><failure message="TypeError: build_forecast_table() got an unexpected keyword argument 'method'">self = &lt;test_predictor_agent.TestPredictorForecastBaseline object at 0x000001C13A5B01D0&gt;
mock_client = &lt;Mock spec='DataClient' id='1929467582352'&gt;

    def test_successful_forecast(self, mock_client: Mock) -&gt; None:
        """Forecast with sufficient data returns narrative."""
        agent = PredictorAgent(mock_client)
    
&gt;       narrative = agent.forecast_baseline(
            metric="retention",
            sector="Construction",
            start=date(2022, 1, 1),
            end=date(2024, 12, 1),
            horizon_months=6,
            season=12,
        )

tests\integration\agents\test_predictor_agent.py:61: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = &lt;src.qnwis.agents.predictor.PredictorAgent object at 0x000001C13DC73390&gt;
metric = 'retention', sector = 'Construction', start = datetime.date(2022, 1, 1)
end = datetime.date(2024, 12, 1), horizon_months = 6, season = 12
confidence_hint = None

    def forecast_baseline(
        self,
        metric: str,
        sector: str | None,
        start: date,
        end: date,
        horizon_months: int = 6,
        season: int = 12,
        confidence_hint: dict[str, Any] | None = None,
    ) -&gt; str:
        """
        Generate baseline forecast with prediction intervals.
    
        Selects best method via backtest, computes forecast and intervals,
        returns citation-ready narrative.
    
        Args:
            metric: Labour market metric (e.g., "retention", "qatarization")
            sector: Sector filter (None for "All")
            start: Start date for training data
            end: End date for training data
            horizon_months: Forecast horizon (default 6, max 12)
            season: Seasonal period for seasonal_naive (default 12)
            confidence_hint: Optional Step-22 confidence payload for footer display
    
        Returns:
            Formatted narrative with forecast table, intervals, backtest metrics, and QID citations
    
        Raises:
            ValueError: If horizon_months &gt; 12 or insufficient data
        """
        if horizon_months &gt; 12:
            raise ValueError("horizon_months must be ≤ 12")
    
        logger.info(
            "forecast_baseline: metric=%s sector=%s start=%s end=%s horizon=%d",
            metric,
            sector,
            start,
            end,
            horizon_months,
        )
    
        query_id = self._resolve_query_id(metric)
    
        try:
            res = self.client.run(query_id)
        except Exception as exc:
            logger.error("Failed to fetch time series: %s", exc)
            return f"Error: Unable to fetch data for {metric}. Query '{query_id}' not found."
    
        # Extract time series
        series, dates = self._extract_time_series(res, metric_field=metric)
    
        if len(series) &lt; self.min_train_points:
            return (
                f"Insufficient data: {len(series)} points available "
                f"(need ≥ {self.min_train_points} for baseline forecast)."
            )
    
        train_series, stability_reason = self._apply_stability_guard(series, dates)
        selection = choose_baseline(
            train_series,
            season=season,
            min_train=self.min_train_points,
            seasonal_win_delta=self.seasonal_win_delta,
        )
        method_name = selection.method
        logger.info("Selected method: %s", method_name)
    
        # Map method name to function
        method_map = {
            "seasonal_naive": (seasonal_naive, {"season": season}),
            "ewma": (ewma_forecast, {"alpha": 0.3}),
            "rolling_mean": (rolling_mean_forecast, {"window": 12}),
            "robust_trend": (robust_trend_forecast, {"window": 24}),
        }
    
        method_func, method_params = method_map[method_name]
    
        # Generate forecast
        forecast = method_func(train_series, horizon=horizon_months, **method_params)
    
        # Backtest to compute intervals
        backtest_metrics = rolling_origin_backtest(
            train_series,
            method_func,
            horizon=1,
            min_train=self.min_train_points,
            **method_params,
        )
    
        # In-sample fit for MAD interval
        fitted_full = method_func(train_series, horizon=len(train_series), **method_params)
        residuals = residuals_in_sample(train_series, fitted_full)
        half_width = mad_interval(residuals, z=1.96)
    
        # Clamp forecast for non-negative metrics
        forecast_clamped = clamp_nonnegative(forecast)
    
        # Build forecast table
&gt;       forecast_table = build_forecast_table(
            method=method_name,
            history=series,
            forecast=forecast_clamped,
            half_width=half_width,
            start_idx=len(series),
        )
E       TypeError: build_forecast_table() got an unexpected keyword argument 'method'

src\qnwis\agents\predictor.py:294: TypeError</failure></testcase><testcase classname="tests.integration.agents.test_predictor_agent.TestPredictorForecastBaseline" name="test_insufficient_data_error" time="0.003" /><testcase classname="tests.integration.agents.test_predictor_agent.TestPredictorForecastBaseline" name="test_horizon_validation" time="0.003" /><testcase classname="tests.integration.agents.test_predictor_agent.TestPredictorForecastBaseline" name="test_query_not_found_error" time="0.003" /><testcase classname="tests.integration.agents.test_predictor_agent.TestPredictorEarlyWarning" name="test_successful_warning_no_flags" time="0.008" /><testcase classname="tests.integration.agents.test_predictor_agent.TestPredictorEarlyWarning" name="test_successful_warning_with_spike" time="0.008" /><testcase classname="tests.integration.agents.test_predictor_agent.TestPredictorEarlyWarning" name="test_insufficient_data_error" time="0.002" /><testcase classname="tests.integration.agents.test_predictor_agent.TestPredictorScenarioCompare" name="test_successful_comparison" time="0.008" /><testcase classname="tests.integration.agents.test_predictor_agent.TestPredictorScenarioCompare" name="test_single_method_comparison" time="0.003" /><testcase classname="tests.integration.agents.test_predictor_agent.TestPredictorScenarioCompare" name="test_insufficient_data_error" time="0.003" /><testcase classname="tests.integration.agents.test_predictor_agent.TestPredictorIntegration" name="test_forecast_produces_valid_qids" time="0.012"><failure message="TypeError: build_forecast_table() got an unexpected keyword argument 'method'">self = &lt;test_predictor_agent.TestPredictorIntegration object at 0x000001C13A5C0910&gt;
mock_client = &lt;Mock spec='DataClient' id='1929494863184'&gt;

    def test_forecast_produces_valid_qids(self, mock_client: Mock) -&gt; None:
        """Forecast narrative includes valid derived QIDs."""
        agent = PredictorAgent(mock_client)
    
&gt;       narrative = agent.forecast_baseline(
            metric="retention",
            sector="Construction",
            start=date(2022, 1, 1),
            end=date(2024, 12, 1),
            horizon_months=6,
        )

tests\integration\agents\test_predictor_agent.py:328: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = &lt;src.qnwis.agents.predictor.PredictorAgent object at 0x000001C13EDB0410&gt;
metric = 'retention', sector = 'Construction', start = datetime.date(2022, 1, 1)
end = datetime.date(2024, 12, 1), horizon_months = 6, season = 12
confidence_hint = None

    def forecast_baseline(
        self,
        metric: str,
        sector: str | None,
        start: date,
        end: date,
        horizon_months: int = 6,
        season: int = 12,
        confidence_hint: dict[str, Any] | None = None,
    ) -&gt; str:
        """
        Generate baseline forecast with prediction intervals.
    
        Selects best method via backtest, computes forecast and intervals,
        returns citation-ready narrative.
    
        Args:
            metric: Labour market metric (e.g., "retention", "qatarization")
            sector: Sector filter (None for "All")
            start: Start date for training data
            end: End date for training data
            horizon_months: Forecast horizon (default 6, max 12)
            season: Seasonal period for seasonal_naive (default 12)
            confidence_hint: Optional Step-22 confidence payload for footer display
    
        Returns:
            Formatted narrative with forecast table, intervals, backtest metrics, and QID citations
    
        Raises:
            ValueError: If horizon_months &gt; 12 or insufficient data
        """
        if horizon_months &gt; 12:
            raise ValueError("horizon_months must be ≤ 12")
    
        logger.info(
            "forecast_baseline: metric=%s sector=%s start=%s end=%s horizon=%d",
            metric,
            sector,
            start,
            end,
            horizon_months,
        )
    
        query_id = self._resolve_query_id(metric)
    
        try:
            res = self.client.run(query_id)
        except Exception as exc:
            logger.error("Failed to fetch time series: %s", exc)
            return f"Error: Unable to fetch data for {metric}. Query '{query_id}' not found."
    
        # Extract time series
        series, dates = self._extract_time_series(res, metric_field=metric)
    
        if len(series) &lt; self.min_train_points:
            return (
                f"Insufficient data: {len(series)} points available "
                f"(need ≥ {self.min_train_points} for baseline forecast)."
            )
    
        train_series, stability_reason = self._apply_stability_guard(series, dates)
        selection = choose_baseline(
            train_series,
            season=season,
            min_train=self.min_train_points,
            seasonal_win_delta=self.seasonal_win_delta,
        )
        method_name = selection.method
        logger.info("Selected method: %s", method_name)
    
        # Map method name to function
        method_map = {
            "seasonal_naive": (seasonal_naive, {"season": season}),
            "ewma": (ewma_forecast, {"alpha": 0.3}),
            "rolling_mean": (rolling_mean_forecast, {"window": 12}),
            "robust_trend": (robust_trend_forecast, {"window": 24}),
        }
    
        method_func, method_params = method_map[method_name]
    
        # Generate forecast
        forecast = method_func(train_series, horizon=horizon_months, **method_params)
    
        # Backtest to compute intervals
        backtest_metrics = rolling_origin_backtest(
            train_series,
            method_func,
            horizon=1,
            min_train=self.min_train_points,
            **method_params,
        )
    
        # In-sample fit for MAD interval
        fitted_full = method_func(train_series, horizon=len(train_series), **method_params)
        residuals = residuals_in_sample(train_series, fitted_full)
        half_width = mad_interval(residuals, z=1.96)
    
        # Clamp forecast for non-negative metrics
        forecast_clamped = clamp_nonnegative(forecast)
    
        # Build forecast table
&gt;       forecast_table = build_forecast_table(
            method=method_name,
            history=series,
            forecast=forecast_clamped,
            half_width=half_width,
            start_idx=len(series),
        )
E       TypeError: build_forecast_table() got an unexpected keyword argument 'method'

src\qnwis\agents\predictor.py:294: TypeError</failure></testcase><testcase classname="tests.integration.agents.test_predictor_agent.TestPredictorIntegration" name="test_early_warning_produces_valid_qids" time="0.008" /><testcase classname="tests.integration.agents.test_predictor_agent.TestPredictorIntegration" name="test_reproducibility_snippets_present" time="0.012"><failure message="TypeError: build_forecast_table() got an unexpected keyword argument 'method'">self = &lt;test_predictor_agent.TestPredictorIntegration object at 0x000001C13A5C1610&gt;
mock_client = &lt;Mock spec='DataClient' id='1929477814608'&gt;

    def test_reproducibility_snippets_present(self, mock_client: Mock) -&gt; None:
        """All narratives include reproducibility code snippets."""
        agent = PredictorAgent(mock_client)
    
&gt;       forecast_narrative = agent.forecast_baseline(
            metric="retention",
            sector="Construction",
            start=date(2022, 1, 1),
            end=date(2024, 12, 1),
            horizon_months=6,
        )

tests\integration\agents\test_predictor_agent.py:356: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = &lt;src.qnwis.agents.predictor.PredictorAgent object at 0x000001C13EEBF8D0&gt;
metric = 'retention', sector = 'Construction', start = datetime.date(2022, 1, 1)
end = datetime.date(2024, 12, 1), horizon_months = 6, season = 12
confidence_hint = None

    def forecast_baseline(
        self,
        metric: str,
        sector: str | None,
        start: date,
        end: date,
        horizon_months: int = 6,
        season: int = 12,
        confidence_hint: dict[str, Any] | None = None,
    ) -&gt; str:
        """
        Generate baseline forecast with prediction intervals.
    
        Selects best method via backtest, computes forecast and intervals,
        returns citation-ready narrative.
    
        Args:
            metric: Labour market metric (e.g., "retention", "qatarization")
            sector: Sector filter (None for "All")
            start: Start date for training data
            end: End date for training data
            horizon_months: Forecast horizon (default 6, max 12)
            season: Seasonal period for seasonal_naive (default 12)
            confidence_hint: Optional Step-22 confidence payload for footer display
    
        Returns:
            Formatted narrative with forecast table, intervals, backtest metrics, and QID citations
    
        Raises:
            ValueError: If horizon_months &gt; 12 or insufficient data
        """
        if horizon_months &gt; 12:
            raise ValueError("horizon_months must be ≤ 12")
    
        logger.info(
            "forecast_baseline: metric=%s sector=%s start=%s end=%s horizon=%d",
            metric,
            sector,
            start,
            end,
            horizon_months,
        )
    
        query_id = self._resolve_query_id(metric)
    
        try:
            res = self.client.run(query_id)
        except Exception as exc:
            logger.error("Failed to fetch time series: %s", exc)
            return f"Error: Unable to fetch data for {metric}. Query '{query_id}' not found."
    
        # Extract time series
        series, dates = self._extract_time_series(res, metric_field=metric)
    
        if len(series) &lt; self.min_train_points:
            return (
                f"Insufficient data: {len(series)} points available "
                f"(need ≥ {self.min_train_points} for baseline forecast)."
            )
    
        train_series, stability_reason = self._apply_stability_guard(series, dates)
        selection = choose_baseline(
            train_series,
            season=season,
            min_train=self.min_train_points,
            seasonal_win_delta=self.seasonal_win_delta,
        )
        method_name = selection.method
        logger.info("Selected method: %s", method_name)
    
        # Map method name to function
        method_map = {
            "seasonal_naive": (seasonal_naive, {"season": season}),
            "ewma": (ewma_forecast, {"alpha": 0.3}),
            "rolling_mean": (rolling_mean_forecast, {"window": 12}),
            "robust_trend": (robust_trend_forecast, {"window": 24}),
        }
    
        method_func, method_params = method_map[method_name]
    
        # Generate forecast
        forecast = method_func(train_series, horizon=horizon_months, **method_params)
    
        # Backtest to compute intervals
        backtest_metrics = rolling_origin_backtest(
            train_series,
            method_func,
            horizon=1,
            min_train=self.min_train_points,
            **method_params,
        )
    
        # In-sample fit for MAD interval
        fitted_full = method_func(train_series, horizon=len(train_series), **method_params)
        residuals = residuals_in_sample(train_series, fitted_full)
        half_width = mad_interval(residuals, z=1.96)
    
        # Clamp forecast for non-negative metrics
        forecast_clamped = clamp_nonnegative(forecast)
    
        # Build forecast table
&gt;       forecast_table = build_forecast_table(
            method=method_name,
            history=series,
            forecast=forecast_clamped,
            half_width=half_width,
            start_idx=len(series),
        )
E       TypeError: build_forecast_table() got an unexpected keyword argument 'method'

src\qnwis\agents\predictor.py:294: TypeError</failure></testcase><testcase classname="tests.integration.agents.test_scenario_end_to_end.TestScenarioEndToEnd" name="test_apply_scenario_full_pipeline" time="0.192" /><testcase classname="tests.integration.agents.test_scenario_end_to_end.TestScenarioEndToEnd" name="test_compare_scenarios_full_pipeline" time="0.191" /><testcase classname="tests.integration.agents.test_scenario_end_to_end.TestScenarioEndToEnd" name="test_batch_scenarios_full_pipeline" time="0.192" /><testcase classname="tests.integration.agents.test_scenario_end_to_end.TestScenarioEndToEnd" name="test_scenario_with_clamping" time="0.190" /><testcase classname="tests.integration.agents.test_scenario_end_to_end.TestScenarioEndToEnd" name="test_scenario_with_stability_warning" time="0.190" /><testcase classname="tests.integration.agents.test_scenario_end_to_end.TestScenarioPerformance" name="test_scenario_meets_sla" time="0.012" /><testcase classname="tests.integration.agents.test_scenario_verification.TestScenarioVerificationIntegration" name="test_scenario_narrative_passes_citation_enforcement" time="0.002" /><testcase classname="tests.integration.agents.test_scenario_verification.TestScenarioVerificationIntegration" name="test_scenario_result_passes_result_verification" time="0.001" /><testcase classname="tests.integration.agents.test_scenario_verification.TestScenarioVerificationIntegration" name="test_scenario_audit_pack_includes_spec_and_integrity" time="0.006" /><testcase classname="tests.integration.agents.test_scenario_verification.TestScenarioVerificationIntegration" name="test_end_to_end_scenario_verification_pipeline" time="0.204" /><testcase classname="tests.integration.agents.test_step13_end_to_end.TestStep13EndToEnd" name="test_pattern_detective_only_uses_dataclient_methods" time="1.732" /><testcase classname="tests.integration.agents.test_step13_end_to_end.TestStep13EndToEnd" name="test_national_strategy_only_uses_dataclient_methods" time="1.727" /><testcase classname="tests.integration.agents.test_step13_end_to_end.TestStep13EndToEnd" name="test_pattern_detective_narrative_structure" time="1.726" /><testcase classname="tests.integration.agents.test_step13_end_to_end.TestStep13EndToEnd" name="test_national_strategy_narrative_structure" time="1.711"><skipped type="pytest.skip" message="Insufficient GCC data in synthetic dataset">d:\lmis_int\tests\integration\agents\test_step13_end_to_end.py:139: Insufficient GCC data in synthetic dataset</skipped></testcase><testcase classname="tests.integration.agents.test_step13_end_to_end.TestStep13EndToEnd" name="test_pattern_detective_best_practices_full_narrative" time="1.698" /><testcase classname="tests.integration.agents.test_step13_end_to_end.TestStep13EndToEnd" name="test_national_strategy_vision2030_full_narrative" time="1.718" /><testcase classname="tests.integration.agents.test_step13_end_to_end.TestStep13EndToEnd" name="test_agent_reports_contain_warnings_when_applicable" time="1.714" /><testcase classname="tests.integration.agents.test_step13_end_to_end.TestStep13EndToEnd" name="test_no_direct_execute_query_calls" time="1.736" /><testcase classname="tests.integration.agents.test_step13_end_to_end.TestStep13EndToEnd" name="test_all_evidence_includes_query_ids" time="1.697" /><testcase classname="tests.integration.agents.test_step13_end_to_end.TestStep13EndToEnd" name="test_derived_results_have_proper_query_ids" time="1.696" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestTimeBaselineIntegration" name="test_baseline_report_complete_structure" time="0.003" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestTimeBaselineIntegration" name="test_baseline_uses_allowed_query_ids_only" time="0.002" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestTimeTrendIntegration" name="test_trend_report_complete_structure" time="0.002" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestTimeTrendIntegration" name="test_trend_includes_yoy_qtq_slopes" time="0.002" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestTimeBreaksIntegration" name="test_breaks_report_complete_structure" time="0.002" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestTimeBreaksIntegration" name="test_breaks_includes_cusum_zscore_summary" time="0.002" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestRouterIntegration" name="test_router_maps_baseline_intent" time="0.149" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestRouterIntegration" name="test_router_maps_trend_intent" time="0.146" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestRouterIntegration" name="test_router_maps_breaks_intent" time="0.146" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestDataFreshnessAndCitations" name="test_all_reports_include_freshness" time="0.004" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestDataFreshnessAndCitations" name="test_all_reports_include_qid_citations" time="0.004" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestDataFreshnessAndCitations" name="test_reports_include_reproducibility_snippets" time="0.004" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestEndToEndWorkflow" name="test_baseline_workflow_complete" time="0.146" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestEndToEndWorkflow" name="test_trend_workflow_complete" time="0.146" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestEndToEndWorkflow" name="test_breaks_workflow_complete" time="0.146" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestErrorHandlingIntegration" name="test_insufficient_data_raises_clear_error" time="0.001" /><testcase classname="tests.integration.analysis.test_time_machine_integration.TestErrorHandlingIntegration" name="test_invalid_metric_raises_clear_error" time="0.001" /><testcase classname="tests.integration.api.test_api_endpoints" name="test_root" time="4.068" /><testcase classname="tests.integration.api.test_api_endpoints" name="test_metrics_endpoint" time="4.042" /><testcase classname="tests.integration.api.test_api_endpoints" name="test_requires_auth" time="4.037" /><testcase classname="tests.integration.api.test_api_endpoints" name="test_role_mismatch_returns_403" time="4.045" /><testcase classname="tests.integration.api.test_api_endpoints" name="test_time_baseline_happy_path" time="4.060"><failure message="TypeError: build_response() got an unexpected keyword argument 'principal'">+ Exception Group Traceback (most recent call last):
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 82, in test_time_baseline_happy_path
    |     response = api_client.post("/api/v1/agents/time/baseline", json=payload, headers=analyst_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 108, in baseline
    |     return _run_agent(request, "baseline_report", params=_prepare_request(payload))
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 70, in _run_agent
    |     return build_response(
    |            ^^^^^^^^^^^^^^^
    | TypeError: build_response() got an unexpected keyword argument 'principal'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 82, in test_time_baseline_happy_path
    response = api_client.post("/api/v1/agents/time/baseline", json=payload, headers=analyst_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 108, in baseline
    return _run_agent(request, "baseline_report", params=_prepare_request(payload))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 70, in _run_agent
    return build_response(
           ^^^^^^^^^^^^^^^
TypeError: build_response() got an unexpected keyword argument 'principal'

During handling of the above exception, another exception occurred:

api_client = &lt;starlette.testclient.TestClient object at 0x000001C13EF438D0&gt;
analyst_headers = {'X-API-Key': 'integration-key'}

    def test_time_baseline_happy_path(api_client, analyst_headers):
        payload = {
            "intent": "time.baseline",
            "params": {"metric": "retention"},
            "options": {"enforce_citations": True, "verify_numbers": True, "audit_pack": True},
        }
&gt;       response = api_client.post("/api/v1/agents/time/baseline", json=payload, headers=analyst_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\api\test_api_endpoints.py:82: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:178: in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:99: in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\agents_time.py:108: in baseline
    return _run_agent(request, "baseline_report", params=_prepare_request(payload))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

request = &lt;starlette.requests.Request object at 0x000001C13F308090&gt;
agent_fn = 'baseline_report'

    def _run_agent(
        request: Request,
        agent_fn: str,
        *,
        params: dict[str, Any],
    ) -&gt; AgentResponse:
        clock = get_clock(request)
        started = clock.time()
        agent_started = clock.time()
    
        client = get_data_client(request)
        agent = TimeMachineAgent(client)
    
        metric = params["metric"]
        try:
            narrative = getattr(agent, agent_fn)(
                metric=metric,
                sector=params.get("sector"),
                start=params.get("start"),
                end=params.get("end"),
            )
        except ValueError as exc:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc)) from exc
        except Exception as exc:  # pragma: no cover - unexpected agent bug
            raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(exc)) from exc
    
        agent_finished = clock.time()
        series_qid = agent.series_map.get(metric)
        if not series_qid:
            raise HTTPException(status_code=400, detail=f"Unknown metric '{metric}'")
        source_result = client.run(series_qid)
    
        principal: Principal = request.state.principal
        request_model: AgentRequest = request.state.agent_request
        request_id = getattr(request.state, "request_id", str(uuid.uuid4()))
&gt;       return build_response(
            request_model=request_model,
            request_id=request_id,
            principal=principal,
            payload={
                "intent": request_model.intent,
                "narrative": narrative,
            },
            sources=[source_result],
            started_ts=started,
            agent_started_ts=agent_started,
            agent_finished_ts=agent_finished,
            clock=clock,
        )
E       TypeError: build_response() got an unexpected keyword argument 'principal'

src\qnwis\api\routers\agents_time.py:70: TypeError</failure></testcase><testcase classname="tests.integration.api.test_api_endpoints" name="test_time_intent_mismatch_returns_400" time="4.044" /><testcase classname="tests.integration.api.test_api_endpoints" name="test_time_trend_endpoint" time="4.053"><failure message="TypeError: build_response() got an unexpected keyword argument 'principal'">+ Exception Group Traceback (most recent call last):
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 104, in test_time_trend_endpoint
    |     response = api_client.post("/api/v1/agents/time/trend", json=payload, headers=analyst_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 120, in trend
    |     return _run_agent(request, "trend_report", params=_prepare_request(payload))
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 70, in _run_agent
    |     return build_response(
    |            ^^^^^^^^^^^^^^^
    | TypeError: build_response() got an unexpected keyword argument 'principal'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 104, in test_time_trend_endpoint
    response = api_client.post("/api/v1/agents/time/trend", json=payload, headers=analyst_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 120, in trend
    return _run_agent(request, "trend_report", params=_prepare_request(payload))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 70, in _run_agent
    return build_response(
           ^^^^^^^^^^^^^^^
TypeError: build_response() got an unexpected keyword argument 'principal'

During handling of the above exception, another exception occurred:

api_client = &lt;starlette.testclient.TestClient object at 0x000001C13F7795D0&gt;
analyst_headers = {'X-API-Key': 'integration-key'}

    def test_time_trend_endpoint(api_client, analyst_headers):
        payload = {
            "intent": "time.trend",
            "params": {"metric": "retention"},
            "options": {"enforce_citations": True, "verify_numbers": True, "audit_pack": True},
        }
&gt;       response = api_client.post("/api/v1/agents/time/trend", json=payload, headers=analyst_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\api\test_api_endpoints.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:178: in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:99: in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\agents_time.py:120: in trend
    return _run_agent(request, "trend_report", params=_prepare_request(payload))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

request = &lt;starlette.requests.Request object at 0x000001C13DC35610&gt;
agent_fn = 'trend_report'

    def _run_agent(
        request: Request,
        agent_fn: str,
        *,
        params: dict[str, Any],
    ) -&gt; AgentResponse:
        clock = get_clock(request)
        started = clock.time()
        agent_started = clock.time()
    
        client = get_data_client(request)
        agent = TimeMachineAgent(client)
    
        metric = params["metric"]
        try:
            narrative = getattr(agent, agent_fn)(
                metric=metric,
                sector=params.get("sector"),
                start=params.get("start"),
                end=params.get("end"),
            )
        except ValueError as exc:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc)) from exc
        except Exception as exc:  # pragma: no cover - unexpected agent bug
            raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(exc)) from exc
    
        agent_finished = clock.time()
        series_qid = agent.series_map.get(metric)
        if not series_qid:
            raise HTTPException(status_code=400, detail=f"Unknown metric '{metric}'")
        source_result = client.run(series_qid)
    
        principal: Principal = request.state.principal
        request_model: AgentRequest = request.state.agent_request
        request_id = getattr(request.state, "request_id", str(uuid.uuid4()))
&gt;       return build_response(
            request_model=request_model,
            request_id=request_id,
            principal=principal,
            payload={
                "intent": request_model.intent,
                "narrative": narrative,
            },
            sources=[source_result],
            started_ts=started,
            agent_started_ts=agent_started,
            agent_finished_ts=agent_finished,
            clock=clock,
        )
E       TypeError: build_response() got an unexpected keyword argument 'principal'

src\qnwis\api\routers\agents_time.py:70: TypeError</failure></testcase><testcase classname="tests.integration.api.test_api_endpoints" name="test_pattern_anomalies" time="4.050"><failure message="TypeError: build_response() got an unexpected keyword argument 'principal'">+ Exception Group Traceback (most recent call last):
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 117, in test_pattern_anomalies
    |     response = api_client.post("/api/v1/agents/pattern/anomalies", json=payload, headers=analyst_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_pattern.py", line 58, in anomalies
    |     return build_response(
    |            ^^^^^^^^^^^^^^^
    | TypeError: build_response() got an unexpected keyword argument 'principal'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 117, in test_pattern_anomalies
    response = api_client.post("/api/v1/agents/pattern/anomalies", json=payload, headers=analyst_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_pattern.py", line 58, in anomalies
    return build_response(
           ^^^^^^^^^^^^^^^
TypeError: build_response() got an unexpected keyword argument 'principal'

During handling of the above exception, another exception occurred:

api_client = &lt;starlette.testclient.TestClient object at 0x000001C13F4B1C90&gt;
analyst_headers = {'X-API-Key': 'integration-key'}

    def test_pattern_anomalies(api_client, analyst_headers):
        payload = {
            "intent": "pattern.anomalies",
            "params": {"z_threshold": 2.0},
            "options": {"enforce_citations": True, "verify_numbers": True, "audit_pack": True},
        }
&gt;       response = api_client.post("/api/v1/agents/pattern/anomalies", json=payload, headers=analyst_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\api\test_api_endpoints.py:117: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:178: in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:99: in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

payload = AgentRequest(intent='pattern.anomalies', params={'z_threshold': 2.0}, options=AgentRequestOptions(enforce_citations=True, verify_numbers=True, audit_pack=True, max_rows=None))
request = &lt;starlette.requests.Request object at 0x000001C13F7E8550&gt;
principal = Principal(subject='analyst', roles=('analyst',), ratelimit_id='analyst')

    @router.post("/anomalies", response_model=AgentResponse)
    async def anomalies(
        payload: AgentRequest,
        request: Request,
        principal: Principal = Depends(ROLE_DEP),
    ) -&gt; AgentResponse:
        ensure_intent(payload, "pattern.anomalies")
        request.state.principal = principal
        request.state.agent_request = payload
        client = get_data_client(request)
        agent = PatternDetectiveAgent(client)
        params = _prepare_request(payload)
        clock = get_clock(request)
        started = clock.time()
        agent_started = clock.time()
        report = agent.detect_anomalous_retention(
            z_threshold=params.get("z_threshold", 2.5),
            min_sample_size=params.get("min_sample_size", 3),
        )
        agent_finished = clock.time()
        source = client.run("syn_attrition_by_sector_latest")
        request_id = getattr(request.state, "request_id", "pattern-anomalies")
&gt;       return build_response(
            request_model=payload,
            request_id=request_id,
            principal=principal,
            payload=report,
            sources=[source],
            started_ts=started,
            agent_started_ts=agent_started,
            agent_finished_ts=agent_finished,
            clock=clock,
        )
E       TypeError: build_response() got an unexpected keyword argument 'principal'

src\qnwis\api\routers\agents_pattern.py:58: TypeError</failure></testcase><testcase classname="tests.integration.api.test_api_endpoints" name="test_pattern_correlations" time="4.055"><failure message="TypeError: build_response() got an unexpected keyword argument 'principal'">+ Exception Group Traceback (most recent call last):
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 130, in test_pattern_correlations
    |     response = api_client.post("/api/v1/agents/pattern/correlations", json=payload, headers=analyst_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_pattern.py", line 97, in correlations
    |     return build_response(
    |            ^^^^^^^^^^^^^^^
    | TypeError: build_response() got an unexpected keyword argument 'principal'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 130, in test_pattern_correlations
    response = api_client.post("/api/v1/agents/pattern/correlations", json=payload, headers=analyst_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_pattern.py", line 97, in correlations
    return build_response(
           ^^^^^^^^^^^^^^^
TypeError: build_response() got an unexpected keyword argument 'principal'

During handling of the above exception, another exception occurred:

api_client = &lt;starlette.testclient.TestClient object at 0x000001C1400DA110&gt;
analyst_headers = {'X-API-Key': 'integration-key'}

    def test_pattern_correlations(api_client, analyst_headers):
        payload = {
            "intent": "pattern.correlations",
            "params": {"min_correlation": 0.5},
            "options": {"enforce_citations": True, "verify_numbers": True, "audit_pack": True},
        }
&gt;       response = api_client.post("/api/v1/agents/pattern/correlations", json=payload, headers=analyst_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\api\test_api_endpoints.py:130: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:178: in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:99: in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

payload = AgentRequest(intent='pattern.correlations', params={'min_correlation': 0.5}, options=AgentRequestOptions(enforce_citations=True, verify_numbers=True, audit_pack=True, max_rows=None))
request = &lt;starlette.requests.Request object at 0x000001C13FE46B50&gt;
principal = Principal(subject='analyst', roles=('analyst',), ratelimit_id='analyst')

    @router.post("/correlations", response_model=AgentResponse)
    async def correlations(
        payload: AgentRequest,
        request: Request,
        principal: Principal = Depends(ROLE_DEP),
    ) -&gt; AgentResponse:
        ensure_intent(payload, "pattern.correlations")
        request.state.principal = principal
        request.state.agent_request = payload
        client = get_data_client(request)
        agent = PatternDetectiveAgent(client)
        params = _prepare_request(payload)
        clock = get_clock(request)
        started = clock.time()
        agent_started = clock.time()
        report = agent.find_correlations(
            method=params.get("method", "spearman"),
            min_correlation=params.get("min_correlation", 0.5),
            min_sample_size=params.get("min_sample_size", 5),
        )
        agent_finished = clock.time()
        sources = [
            client.run("syn_qatarization_by_sector_latest"),
            client.run("syn_attrition_by_sector_latest"),
        ]
        request_id = getattr(request.state, "request_id", "pattern-correlations")
&gt;       return build_response(
            request_model=payload,
            request_id=request_id,
            principal=principal,
            payload=report,
            sources=sources,
            started_ts=started,
            agent_started_ts=agent_started,
            agent_finished_ts=agent_finished,
            clock=clock,
        )
E       TypeError: build_response() got an unexpected keyword argument 'principal'

src\qnwis\api\routers\agents_pattern.py:97: TypeError</failure></testcase><testcase classname="tests.integration.api.test_api_endpoints" name="test_predictor_forecast" time="4.056"><failure message="TypeError: build_response() got an unexpected keyword argument 'principal'">+ Exception Group Traceback (most recent call last):
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 141, in test_predictor_forecast
    |     response = api_client.post("/api/v1/agents/predictor/forecast", json=payload, headers=analyst_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_predictor.py", line 70, in forecast
    |     return build_response(
    |            ^^^^^^^^^^^^^^^
    | TypeError: build_response() got an unexpected keyword argument 'principal'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 141, in test_predictor_forecast
    response = api_client.post("/api/v1/agents/predictor/forecast", json=payload, headers=analyst_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_predictor.py", line 70, in forecast
    return build_response(
           ^^^^^^^^^^^^^^^
TypeError: build_response() got an unexpected keyword argument 'principal'

During handling of the above exception, another exception occurred:

api_client = &lt;starlette.testclient.TestClient object at 0x000001C13FE1C1D0&gt;
analyst_headers = {'X-API-Key': 'integration-key'}

    def test_predictor_forecast(api_client, analyst_headers):
        payload = {
            "intent": "predictor.forecast",
            "params": {"metric": "retention", "horizon_months": 6},
            "options": {"enforce_citations": True, "verify_numbers": True, "audit_pack": True},
        }
&gt;       response = api_client.post("/api/v1/agents/predictor/forecast", json=payload, headers=analyst_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\api\test_api_endpoints.py:141: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:178: in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:99: in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

payload = AgentRequest(intent='predictor.forecast', params={'metric': 'retention', 'horizon_months': 6}, options=AgentRequestOptions(enforce_citations=True, verify_numbers=True, audit_pack=True, max_rows=None))
request = &lt;starlette.requests.Request object at 0x000001C13F4947D0&gt;
principal = Principal(subject='analyst', roles=('analyst',), ratelimit_id='analyst')

    @router.post("/forecast", response_model=AgentResponse)
    async def forecast(
        payload: AgentRequest,
        request: Request,
        principal: Principal = Depends(ROLE_DEP),
    ) -&gt; AgentResponse:
        ensure_intent(payload, "predictor.forecast")
        request.state.principal = principal
        request.state.agent_request = payload
        client = get_data_client(request)
        agent = PredictorAgent(client)
        metric = _metric(payload)
        sector = payload.params.get("sector")
        horizon = int(payload.params.get("horizon_months", 6))
        clock = get_clock(request)
        today = clock.now().date()
        start = _parse_date(payload.params.get("start_date"), "start_date") or today.replace(year=today.year - 3)
        end = _parse_date(payload.params.get("end_date"), "end_date") or today
        started = clock.time()
        agent_started = clock.time()
        try:
            narrative = agent.forecast_baseline(
                metric=metric,
                sector=sector,
                start=start,
                end=end,
                horizon_months=horizon,
            )
        except ValueError as exc:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc)) from exc
        agent_finished = clock.time()
    
        query_id = agent._resolve_query_id(metric)  # type: ignore[attr-defined]
        source = client.run(query_id)
        request_id = getattr(request.state, "request_id", "predictor-forecast")
&gt;       return build_response(
            request_model=payload,
            request_id=request_id,
            principal=principal,
            payload={"intent": payload.intent, "narrative": narrative},
            sources=[source],
            started_ts=started,
            agent_started_ts=agent_started,
            agent_finished_ts=agent_finished,
            clock=clock,
        )
E       TypeError: build_response() got an unexpected keyword argument 'principal'

src\qnwis\api\routers\agents_predictor.py:70: TypeError</failure></testcase><testcase classname="tests.integration.api.test_api_endpoints" name="test_predictor_warnings" time="4.054"><failure message="TypeError: build_response() got an unexpected keyword argument 'principal'">+ Exception Group Traceback (most recent call last):
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 153, in test_predictor_warnings
    |     response = api_client.post("/api/v1/agents/predictor/warnings", json=payload, headers=analyst_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_predictor.py", line 117, in warnings
    |     return build_response(
    |            ^^^^^^^^^^^^^^^
    | TypeError: build_response() got an unexpected keyword argument 'principal'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 153, in test_predictor_warnings
    response = api_client.post("/api/v1/agents/predictor/warnings", json=payload, headers=analyst_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_predictor.py", line 117, in warnings
    return build_response(
           ^^^^^^^^^^^^^^^
TypeError: build_response() got an unexpected keyword argument 'principal'

During handling of the above exception, another exception occurred:

api_client = &lt;starlette.testclient.TestClient object at 0x000001C13FB00E90&gt;
analyst_headers = {'X-API-Key': 'integration-key'}

    def test_predictor_warnings(api_client, analyst_headers):
        payload = {
            "intent": "predictor.warnings",
            "params": {"metric": "retention", "horizon_months": 3},
        }
&gt;       response = api_client.post("/api/v1/agents/predictor/warnings", json=payload, headers=analyst_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\api\test_api_endpoints.py:153: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:178: in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:99: in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

payload = AgentRequest(intent='predictor.warnings', params={'metric': 'retention', 'horizon_months': 3}, options=AgentRequestOptions(enforce_citations=True, verify_numbers=True, audit_pack=True, max_rows=None))
request = &lt;starlette.requests.Request object at 0x000001C13FCAD6D0&gt;
principal = Principal(subject='analyst', roles=('analyst',), ratelimit_id='analyst')

    @router.post("/warnings", response_model=AgentResponse)
    async def warnings(
        payload: AgentRequest,
        request: Request,
        principal: Principal = Depends(ROLE_DEP),
    ) -&gt; AgentResponse:
        ensure_intent(payload, "predictor.warnings")
        request.state.principal = principal
        request.state.agent_request = payload
        client = get_data_client(request)
        agent = PredictorAgent(client)
        metric = _metric(payload)
        sector = payload.params.get("sector")
        clock = get_clock(request)
        today = clock.now().date()
        end = _parse_date(payload.params.get("end_date"), "end_date") or today
        horizon = int(payload.params.get("horizon_months", 3))
    
        started = clock.time()
        agent_started = clock.time()
        try:
            narrative = agent.early_warning(
                metric=metric,
                sector=sector,
                end=end,
                horizon_months=horizon,
            )
        except ValueError as exc:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc)) from exc
        agent_finished = clock.time()
    
        query_id = agent._resolve_query_id(metric)  # type: ignore[attr-defined]
        source = client.run(query_id)
        request_id = getattr(request.state, "request_id", "predictor-warnings")
&gt;       return build_response(
            request_model=payload,
            request_id=request_id,
            principal=principal,
            payload={"intent": payload.intent, "narrative": narrative},
            sources=[source],
            started_ts=started,
            agent_started_ts=agent_started,
            agent_finished_ts=agent_finished,
            clock=clock,
        )
E       TypeError: build_response() got an unexpected keyword argument 'principal'

src\qnwis\api\routers\agents_predictor.py:117: TypeError</failure></testcase><testcase classname="tests.integration.api.test_api_endpoints" name="test_scenario_apply" time="4.053"><failure message="TypeError: build_response() got an unexpected keyword argument 'principal'">+ Exception Group Traceback (most recent call last):
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 164, in test_scenario_apply
    |     response = api_client.post("/api/v1/agents/scenario/apply", json=payload, headers=analyst_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_scenario.py", line 59, in scenario_apply
    |     return build_response(
    |            ^^^^^^^^^^^^^^^
    | TypeError: build_response() got an unexpected keyword argument 'principal'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 164, in test_scenario_apply
    response = api_client.post("/api/v1/agents/scenario/apply", json=payload, headers=analyst_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_scenario.py", line 59, in scenario_apply
    return build_response(
           ^^^^^^^^^^^^^^^
TypeError: build_response() got an unexpected keyword argument 'principal'

During handling of the above exception, another exception occurred:

api_client = &lt;starlette.testclient.TestClient object at 0x000001C13FE7B8D0&gt;
analyst_headers = {'X-API-Key': 'integration-key'}

    def test_scenario_apply(api_client, analyst_headers):
        payload = {
            "intent": "scenario.apply",
            "params": {"spec": _scenario_spec("Retention Boost", "Energy"), "format": "dict"},
            "options": {"audit_pack": True},
        }
&gt;       response = api_client.post("/api/v1/agents/scenario/apply", json=payload, headers=analyst_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\api\test_api_endpoints.py:164: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:178: in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:99: in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

payload = AgentRequest(intent='scenario.apply', params={'spec': {'name': 'Retention Boost', 'description': 'Retention Boost test...at': 'dict'}, options=AgentRequestOptions(enforce_citations=True, verify_numbers=True, audit_pack=True, max_rows=None))
request = &lt;starlette.requests.Request object at 0x000001C13D3F2790&gt;
principal = Principal(subject='analyst', roles=('analyst',), ratelimit_id='analyst')

    @router.post("/apply", response_model=AgentResponse)
    async def scenario_apply(
        payload: AgentRequest,
        request: Request,
        principal: Principal = Depends(ROLE_DEP),
    ) -&gt; AgentResponse:
        ensure_intent(payload, "scenario.apply")
        spec_source = payload.params.get("spec")
        if spec_source is None:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="params.spec is required")
    
        fmt = _spec_format(payload.params)
        spec = _scenario_spec(spec_source, fmt)
    
        request.state.principal = principal
        request.state.agent_request = payload
        client = get_data_client(request)
        agent = ScenarioAgent(client)
        clock = get_clock(request)
        started = clock.time()
        agent_started = clock.time()
        narrative = agent.apply(scenario_spec=spec_source, spec_format=fmt)
        agent_finished = clock.time()
        baseline = agent._fetch_baseline_forecast(spec.metric, spec.sector, spec.horizon_months)
        request_id = getattr(request.state, "request_id", "scenario-apply")
&gt;       return build_response(
            request_model=payload,
            request_id=request_id,
            principal=principal,
            payload={"intent": payload.intent, "narrative": narrative},
            sources=[baseline],
            started_ts=started,
            agent_started_ts=agent_started,
            agent_finished_ts=agent_finished,
            clock=clock,
        )
E       TypeError: build_response() got an unexpected keyword argument 'principal'

src\qnwis\api\routers\agents_scenario.py:59: TypeError</failure></testcase><testcase classname="tests.integration.api.test_api_endpoints" name="test_scenario_apply_requires_spec" time="4.043" /><testcase classname="tests.integration.api.test_api_endpoints" name="test_scenario_compare" time="4.053"><failure message="TypeError: build_response() got an unexpected keyword argument 'principal'">+ Exception Group Traceback (most recent call last):
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 188, in test_scenario_compare
    |     response = api_client.post("/api/v1/agents/scenario/compare", json=payload, headers=analyst_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_scenario.py", line 95, in scenario_compare
    |     return build_response(
    |            ^^^^^^^^^^^^^^^
    | TypeError: build_response() got an unexpected keyword argument 'principal'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 188, in test_scenario_compare
    response = api_client.post("/api/v1/agents/scenario/compare", json=payload, headers=analyst_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_scenario.py", line 95, in scenario_compare
    return build_response(
           ^^^^^^^^^^^^^^^
TypeError: build_response() got an unexpected keyword argument 'principal'

During handling of the above exception, another exception occurred:

api_client = &lt;starlette.testclient.TestClient object at 0x000001C13FE2A4D0&gt;
analyst_headers = {'X-API-Key': 'integration-key'}

    def test_scenario_compare(api_client, analyst_headers):
        payload = {
            "intent": "scenario.compare",
            "params": {
                "specs": [
                    _scenario_spec("Energy Push", "Energy"),
                    _scenario_spec("Construction Stabilize", "Construction"),
                ],
                "format": "dict",
            },
        }
&gt;       response = api_client.post("/api/v1/agents/scenario/compare", json=payload, headers=analyst_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\api\test_api_endpoints.py:188: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:178: in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:99: in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

payload = AgentRequest(intent='scenario.compare', params={'specs': [{'name': 'Energy Push', 'description': 'Energy Push test sce...at': 'dict'}, options=AgentRequestOptions(enforce_citations=True, verify_numbers=True, audit_pack=True, max_rows=None))
request = &lt;starlette.requests.Request object at 0x000001C13FBA68D0&gt;
principal = Principal(subject='analyst', roles=('analyst',), ratelimit_id='analyst')

    @router.post("/compare", response_model=AgentResponse)
    async def scenario_compare(
        payload: AgentRequest,
        request: Request,
        principal: Principal = Depends(ROLE_DEP),
    ) -&gt; AgentResponse:
        ensure_intent(payload, "scenario.compare")
        specs_input = payload.params.get("specs")
        if not isinstance(specs_input, list) or not specs_input:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="params.specs must be a non-empty list")
        fmt = _spec_format(payload.params)
        specs = [_scenario_spec(spec_item, fmt) for spec_item in specs_input]
        request.state.principal = principal
        request.state.agent_request = payload
        client = get_data_client(request)
        agent = ScenarioAgent(client)
        clock = get_clock(request)
        started = clock.time()
        agent_started = clock.time()
        narrative = agent.compare(scenario_specs=specs_input, spec_format=fmt)
        agent_finished = clock.time()
        baseline = agent._fetch_baseline_forecast(specs[0].metric, specs[0].sector, specs[0].horizon_months)
        request_id = getattr(request.state, "request_id", "scenario-compare")
&gt;       return build_response(
            request_model=payload,
            request_id=request_id,
            principal=principal,
            payload={"intent": payload.intent, "narrative": narrative},
            sources=[baseline],
            started_ts=started,
            agent_started_ts=agent_started,
            agent_finished_ts=agent_finished,
            clock=clock,
        )
E       TypeError: build_response() got an unexpected keyword argument 'principal'

src\qnwis\api\routers\agents_scenario.py:95: TypeError</failure></testcase><testcase classname="tests.integration.api.test_api_endpoints" name="test_strategy_benchmark" time="4.051"><failure message="TypeError: build_response() got an unexpected keyword argument 'principal'">+ Exception Group Traceback (most recent call last):
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 195, in test_strategy_benchmark
    |     response = api_client.post("/api/v1/agents/strategy/benchmark", json=payload, headers=analyst_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_strategy.py", line 39, in gcc_benchmark
    |     return build_response(
    |            ^^^^^^^^^^^^^^^
    | TypeError: build_response() got an unexpected keyword argument 'principal'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 195, in test_strategy_benchmark
    response = api_client.post("/api/v1/agents/strategy/benchmark", json=payload, headers=analyst_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_strategy.py", line 39, in gcc_benchmark
    return build_response(
           ^^^^^^^^^^^^^^^
TypeError: build_response() got an unexpected keyword argument 'principal'

During handling of the above exception, another exception occurred:

api_client = &lt;starlette.testclient.TestClient object at 0x000001C13FD868D0&gt;
analyst_headers = {'X-API-Key': 'integration-key'}

    def test_strategy_benchmark(api_client, analyst_headers):
        payload = {"intent": "strategy.benchmark", "params": {"min_countries": 3}}
&gt;       response = api_client.post("/api/v1/agents/strategy/benchmark", json=payload, headers=analyst_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\api\test_api_endpoints.py:195: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:178: in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:99: in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

payload = AgentRequest(intent='strategy.benchmark', params={'min_countries': 3}, options=AgentRequestOptions(enforce_citations=True, verify_numbers=True, audit_pack=True, max_rows=None))
request = &lt;starlette.requests.Request object at 0x000001C13FCF1A10&gt;
principal = Principal(subject='analyst', roles=('analyst',), ratelimit_id='analyst')

    @router.post("/benchmark", response_model=AgentResponse)
    async def gcc_benchmark(
        payload: AgentRequest,
        request: Request,
        principal: Principal = Depends(ROLE_DEP),
    ) -&gt; AgentResponse:
        ensure_intent(payload, "strategy.benchmark")
        min_countries = int(payload.params.get("min_countries", 3))
        request.state.principal = principal
        request.state.agent_request = payload
        client = get_data_client(request)
        agent = NationalStrategyAgent(client)
        clock = get_clock(request)
        started = clock.time()
        agent_started = clock.time()
        try:
            report = agent.gcc_benchmark(min_countries=min_countries)
        except ValueError as exc:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc)) from exc
        agent_finished = clock.time()
        source = client.run("syn_unemployment_rate_gcc_latest")
        request_id = getattr(request.state, "request_id", "strategy-benchmark")
&gt;       return build_response(
            request_model=payload,
            request_id=request_id,
            principal=principal,
            payload=report,
            sources=[source],
            started_ts=started,
            agent_started_ts=agent_started,
            agent_finished_ts=agent_finished,
            clock=clock,
        )
E       TypeError: build_response() got an unexpected keyword argument 'principal'

src\qnwis\api\routers\agents_strategy.py:39: TypeError</failure></testcase><testcase classname="tests.integration.api.test_api_endpoints" name="test_strategy_vision" time="4.053"><failure message="TypeError: build_response() got an unexpected keyword argument 'principal'">+ Exception Group Traceback (most recent call last):
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 202, in test_strategy_vision
    |     response = api_client.post("/api/v1/agents/strategy/vision", json=payload, headers=analyst_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_strategy.py", line 75, in vision_alignment
    |     return build_response(
    |            ^^^^^^^^^^^^^^^
    | TypeError: build_response() got an unexpected keyword argument 'principal'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 202, in test_strategy_vision
    response = api_client.post("/api/v1/agents/strategy/vision", json=payload, headers=analyst_headers)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_strategy.py", line 75, in vision_alignment
    return build_response(
           ^^^^^^^^^^^^^^^
TypeError: build_response() got an unexpected keyword argument 'principal'

During handling of the above exception, another exception occurred:

api_client = &lt;starlette.testclient.TestClient object at 0x000001C13FFECE50&gt;
analyst_headers = {'X-API-Key': 'integration-key'}

    def test_strategy_vision(api_client, analyst_headers):
        payload = {"intent": "strategy.vision", "params": {"target_year": 2030}}
&gt;       response = api_client.post("/api/v1/agents/strategy/vision", json=payload, headers=analyst_headers)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\api\test_api_endpoints.py:202: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:178: in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:99: in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

payload = AgentRequest(intent='strategy.vision', params={'target_year': 2030}, options=AgentRequestOptions(enforce_citations=True, verify_numbers=True, audit_pack=True, max_rows=None))
request = &lt;starlette.requests.Request object at 0x000001C13FA20C10&gt;
principal = Principal(subject='analyst', roles=('analyst',), ratelimit_id='analyst')

    @router.post("/vision", response_model=AgentResponse)
    async def vision_alignment(
        payload: AgentRequest,
        request: Request,
        principal: Principal = Depends(ROLE_DEP),
    ) -&gt; AgentResponse:
        ensure_intent(payload, "strategy.vision")
        target_year = int(payload.params.get("target_year", 2030))
        current_year = int(payload.params.get("current_year", 2024))
        request.state.principal = principal
        request.state.agent_request = payload
        client = get_data_client(request)
        agent = NationalStrategyAgent(client)
        clock = get_clock(request)
        started = clock.time()
        agent_started = clock.time()
        try:
            report = agent.vision2030_alignment(target_year=target_year, current_year=current_year)
        except ValueError as exc:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc)) from exc
        agent_finished = clock.time()
        source = client.run("syn_qatarization_by_sector_latest")
        request_id = getattr(request.state, "request_id", "strategy-vision")
&gt;       return build_response(
            request_model=payload,
            request_id=request_id,
            principal=principal,
            payload=report,
            sources=[source],
            started_ts=started,
            agent_started_ts=agent_started,
            agent_finished_ts=agent_finished,
            clock=clock,
        )
E       TypeError: build_response() got an unexpected keyword argument 'principal'

src\qnwis\api\routers\agents_strategy.py:75: TypeError</failure></testcase><testcase classname="tests.integration.api.test_api_endpoints" name="test_rate_limit_returns_429" time="4.054"><failure message="TypeError: build_response() got an unexpected keyword argument 'principal'">+ Exception Group Traceback (most recent call last):
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 208, in test_rate_limit_returns_429
    |     ok = api_client.post(
    |          ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 108, in baseline
    |     return _run_agent(request, "baseline_report", params=_prepare_request(payload))
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 70, in _run_agent
    |     return build_response(
    |            ^^^^^^^^^^^^^^^
    | TypeError: build_response() got an unexpected keyword argument 'principal'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\lmis_int\tests\integration\api\test_api_endpoints.py", line 208, in test_rate_limit_returns_429
    ok = api_client.post(
         ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 108, in baseline
    return _run_agent(request, "baseline_report", params=_prepare_request(payload))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 70, in _run_agent
    return build_response(
           ^^^^^^^^^^^^^^^
TypeError: build_response() got an unexpected keyword argument 'principal'

During handling of the above exception, another exception occurred:

api_client = &lt;starlette.testclient.TestClient object at 0x000001C13EE44310&gt;
analyst_headers = {'X-API-Key': 'integration-key'}

    def test_rate_limit_returns_429(api_client, analyst_headers):
        api_client.app.state.rate_limiter = ExhaustedLimiter()
&gt;       ok = api_client.post(
            "/api/v1/agents/time/baseline",
            json={"intent": "time.baseline", "params": {"metric": "retention"}},
            headers=analyst_headers,
        )

tests\integration\api\test_api_endpoints.py:208: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:178: in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:99: in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\agents_time.py:108: in baseline
    return _run_agent(request, "baseline_report", params=_prepare_request(payload))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

request = &lt;starlette.requests.Request object at 0x000001C13FEABA50&gt;
agent_fn = 'baseline_report'

    def _run_agent(
        request: Request,
        agent_fn: str,
        *,
        params: dict[str, Any],
    ) -&gt; AgentResponse:
        clock = get_clock(request)
        started = clock.time()
        agent_started = clock.time()
    
        client = get_data_client(request)
        agent = TimeMachineAgent(client)
    
        metric = params["metric"]
        try:
            narrative = getattr(agent, agent_fn)(
                metric=metric,
                sector=params.get("sector"),
                start=params.get("start"),
                end=params.get("end"),
            )
        except ValueError as exc:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc)) from exc
        except Exception as exc:  # pragma: no cover - unexpected agent bug
            raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(exc)) from exc
    
        agent_finished = clock.time()
        series_qid = agent.series_map.get(metric)
        if not series_qid:
            raise HTTPException(status_code=400, detail=f"Unknown metric '{metric}'")
        source_result = client.run(series_qid)
    
        principal: Principal = request.state.principal
        request_model: AgentRequest = request.state.agent_request
        request_id = getattr(request.state, "request_id", str(uuid.uuid4()))
&gt;       return build_response(
            request_model=request_model,
            request_id=request_id,
            principal=principal,
            payload={
                "intent": request_model.intent,
                "narrative": narrative,
            },
            sources=[source_result],
            started_ts=started,
            agent_started_ts=agent_started,
            agent_finished_ts=agent_finished,
            clock=clock,
        )
E       TypeError: build_response() got an unexpected keyword argument 'principal'

src\qnwis\api\routers\agents_time.py:70: TypeError</failure></testcase><testcase classname="tests.integration.api.test_api_endpoints" name="test_internal_error_exposes_error_id" time="4.048" /><testcase classname="tests.integration.audit.test_audit_end_to_end.TestAuditEndToEnd" name="test_complete_audit_flow" time="0.001"><skipped type="pytest.skip" message="Audit pack persistence mock needs investigation - config patching issue">D:\lmis_int\tests\integration\audit\test_audit_end_to_end.py:135: Audit pack persistence mock needs investigation - config patching issue</skipped></testcase><testcase classname="tests.integration.audit.test_audit_end_to_end.TestAuditEndToEnd" name="test_audit_pack_integrity" time="0.000"><skipped type="pytest.skip" message="Audit pack persistence mock needs investigation - config patching issue">D:\lmis_int\tests\integration\audit\test_audit_end_to_end.py:223: Audit pack persistence mock needs investigation - config patching issue</skipped></testcase><testcase classname="tests.integration.audit.test_audit_end_to_end.TestAuditEndToEnd" name="test_audit_pack_indexed_in_sqlite" time="0.000"><skipped type="pytest.skip" message="Audit pack persistence mock needs investigation - config patching issue">D:\lmis_int\tests\integration\audit\test_audit_end_to_end.py:265: Audit pack persistence mock needs investigation - config patching issue</skipped></testcase><testcase classname="tests.integration.audit.test_audit_end_to_end.TestAuditEndToEnd" name="test_audit_pack_filesystem_discovery" time="0.000"><skipped type="pytest.skip" message="Audit pack persistence mock needs investigation - config patching issue">D:\lmis_int\tests\integration\audit\test_audit_end_to_end.py:307: Audit pack persistence mock needs investigation - config patching issue</skipped></testcase><testcase classname="tests.integration.audit.test_audit_end_to_end.TestAuditEndToEnd" name="test_audit_pack_reproducibility_snippet" time="0.000"><skipped type="pytest.skip" message="Audit pack persistence mock needs investigation - config patching issue">D:\lmis_int\tests\integration\audit\test_audit_end_to_end.py:357: Audit pack persistence mock needs investigation - config patching issue</skipped></testcase><testcase classname="tests.integration.audit.test_audit_end_to_end.TestAuditEndToEnd" name="test_audit_summary_in_final_report" time="0.082" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_basic_invocation" time="1.295" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_json_output_structure" time="1.287" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_markdown_output" time="1.285" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_parameter_passing" time="1.266" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_request_id_tracking" time="1.277" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_missing_required_intent" time="1.181" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_invalid_intent" time="1.178" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_disabled_intent" time="1.199" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_help_flag" time="1.173" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_log_level" time="1.276" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_multiple_metrics" time="1.264" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_year_range_parameters" time="1.271" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_numeric_parameters" time="1.279" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_output_directory_creation" time="1.282" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_stdout_output" time="1.269" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_user_id_tracking" time="1.260" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_missing_config_file" time="1.176" /><testcase classname="tests.integration.orchestration.test_cli" name="test_cli_json_format_default" time="1.266" /><testcase classname="tests.integration.orchestration.test_cli_query_mode" name="test_cli_query_mode_anomalies" time="1.307"><failure message="AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour&#10;  2025-11-10 06:02:20,674 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for &quot;Find anomalies in Healthcare retention last 24 months&quot;?&#10;  &#10;assert 1 == 0">@pytest.mark.integration
    def test_cli_query_mode_anomalies() -&gt; None:
        """Test CLI with query for anomaly detection."""
        query = "Find anomalies in Healthcare retention last 24 months"
    
        exit_code, stdout, stderr = run_cli_query(query)
    
        # Should exit successfully
&gt;       assert exit_code == 0, f"CLI failed with stderr: {stderr}"
E       AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour
E         2025-11-10 06:02:20,674 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for "Find anomalies in Healthcare retention last 24 months"?
E         
E       assert 1 == 0

tests\integration\orchestration\test_cli_query_mode.py:63: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_cli_query_mode" name="test_cli_query_mode_correlation" time="1.292"><failure message="AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour&#10;  2025-11-10 06:02:21,976 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for &quot;Is there a correlation between salary and retention in Construction?&quot;?&#10;  &#10;assert 1 == 0">@pytest.mark.integration
    def test_cli_query_mode_correlation() -&gt; None:
        """Test CLI with query for correlation analysis."""
        query = "Is there a correlation between salary and retention in Construction?"
    
        exit_code, stdout, stderr = run_cli_query(query)
    
        # Should exit successfully
&gt;       assert exit_code == 0, f"CLI failed with stderr: {stderr}"
E       AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour
E         2025-11-10 06:02:21,976 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for "Is there a correlation between salary and retention in Construction?"?
E         
E       assert 1 == 0

tests\integration\orchestration\test_cli_query_mode.py:99: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_cli_query_mode" name="test_cli_query_mode_gcc_benchmark" time="1.297"><failure message="AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour&#10;  2025-11-10 06:02:23,288 - src.qnwis.orchestration.nodes.invoke - ERROR - Agent invocation failed&#10;  Traceback (most recent call last):&#10;    File &quot;D:\lmis_int\src\qnwis\orchestration\nodes\invoke.py&quot;, line 197, in invoke_agent&#10;      result = method(**valid_params)&#10;               ^^^^^^^^^^^^^^^^^^^^^^&#10;    File &quot;D:\lmis_int\src\qnwis\agents\national_strategy.py&quot;, line 88, in gcc_benchmark&#10;      gcc_res = self.client.run(&quot;syn_unemployment_rate_gcc_latest&quot;)&#10;                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#10;    File &quot;D:\lmis_int\src\qnwis\agents\base.py&quot;, line 180, in run&#10;      res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)&#10;            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#10;    File &quot;D:\lmis_int\src\qnwis\data\deterministic\cache_access.py&quot;, line 229, in execute_cached&#10;      res = execute_uncached(query_id, registry, spec_override=spec)&#10;            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#10;    File &quot;D:\lmis_int\src\qnwis\data\deterministic\access.py&quot;, line 39, in execute&#10;      result = run_csv_query(spec)&#10;               ^^^^^^^^^^^^^^^^^^^&#10;    File &quot;D:\lmis_int\src\qnwis\data\connectors\csv_catalog.py&quot;, line 157, in run_csv_query&#10;      file_path = _resolve_latest_csv(parsed.pattern)&#10;                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#10;    File &quot;D:\lmis_int\src\qnwis\data\connectors\csv_catalog.py&quot;, line 115, in _resolve_latest_csv&#10;      raise FileNotFoundError(f&quot;CSV catalog directory missing: {BASE}&quot;)&#10;  FileNotFoundError: CSV catalog directory missing: D:\lmis_int\src\external_data\qatar_open_data&#10;  2025-11-10 06:02:23,290 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Agent error: FileNotFoundError: CSV catalog directory missing: D:\lmis_int\src\external_data\qatar_open_data&#10;  &#10;assert 1 == 0">@pytest.mark.integration
    def test_cli_query_mode_gcc_benchmark() -&gt; None:
        """Test CLI with query for GCC benchmark."""
        query = "Compare Qatar wage growth to UAE and Saudi Arabia"
    
        exit_code, stdout, stderr = run_cli_query(query)
    
        # Should exit successfully
&gt;       assert exit_code == 0, f"CLI failed with stderr: {stderr}"
E       AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour
E         2025-11-10 06:02:23,288 - src.qnwis.orchestration.nodes.invoke - ERROR - Agent invocation failed
E         Traceback (most recent call last):
E           File "D:\lmis_int\src\qnwis\orchestration\nodes\invoke.py", line 197, in invoke_agent
E             result = method(**valid_params)
E                      ^^^^^^^^^^^^^^^^^^^^^^
E           File "D:\lmis_int\src\qnwis\agents\national_strategy.py", line 88, in gcc_benchmark
E             gcc_res = self.client.run("syn_unemployment_rate_gcc_latest")
E                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           File "D:\lmis_int\src\qnwis\agents\base.py", line 180, in run
E             res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
E                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           File "D:\lmis_int\src\qnwis\data\deterministic\cache_access.py", line 229, in execute_cached
E             res = execute_uncached(query_id, registry, spec_override=spec)
E                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           File "D:\lmis_int\src\qnwis\data\deterministic\access.py", line 39, in execute
E             result = run_csv_query(spec)
E                      ^^^^^^^^^^^^^^^^^^^
E           File "D:\lmis_int\src\qnwis\data\connectors\csv_catalog.py", line 157, in run_csv_query
E             file_path = _resolve_latest_csv(parsed.pattern)
E                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           File "D:\lmis_int\src\qnwis\data\connectors\csv_catalog.py", line 115, in _resolve_latest_csv
E             raise FileNotFoundError(f"CSV catalog directory missing: {BASE}")
E         FileNotFoundError: CSV catalog directory missing: D:\lmis_int\src\external_data\qatar_open_data
E         2025-11-10 06:02:23,290 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Agent error: FileNotFoundError: CSV catalog directory missing: D:\lmis_int\src\external_data\qatar_open_data
E         
E       assert 1 == 0

tests\integration\orchestration\test_cli_query_mode.py:119: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_cli_query_mode" name="test_cli_query_mode_vision2030" time="1.297"><failure message="AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour&#10;  2025-11-10 06:02:24,594 - src.qnwis.orchestration.nodes.invoke - ERROR - Agent invocation failed&#10;  Traceback (most recent call last):&#10;    File &quot;D:\lmis_int\src\qnwis\orchestration\nodes\invoke.py&quot;, line 197, in invoke_agent&#10;      result = method(**valid_params)&#10;               ^^^^^^^^^^^^^^^^^^^^^^&#10;    File &quot;D:\lmis_int\src\qnwis\agents\national_strategy.py&quot;, line 303, in vision2030_alignment&#10;      qat_res = self.client.run(&quot;syn_qatarization_by_sector_latest&quot;)&#10;                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#10;    File &quot;D:\lmis_int\src\qnwis\agents\base.py&quot;, line 180, in run&#10;      res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)&#10;            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#10;    File &quot;D:\lmis_int\src\qnwis\data\deterministic\cache_access.py&quot;, line 229, in execute_cached&#10;      res = execute_uncached(query_id, registry, spec_override=spec)&#10;            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#10;    File &quot;D:\lmis_int\src\qnwis\data\deterministic\access.py&quot;, line 39, in execute&#10;      result = run_csv_query(spec)&#10;               ^^^^^^^^^^^^^^^^^^^&#10;    File &quot;D:\lmis_int\src\qnwis\data\connectors\csv_catalog.py&quot;, line 157, in run_csv_query&#10;      file_path = _resolve_latest_csv(parsed.pattern)&#10;                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&#10;    File &quot;D:\lmis_int\src\qnwis\data\connectors\csv_catalog.py&quot;, line 115, in _resolve_latest_csv&#10;      raise FileNotFoundError(f&quot;CSV catalog directory missing: {BASE}&quot;)&#10;  FileNotFoundError: CSV catalog directory missing: D:\lmis_int\src\external_data\qatar_open_data&#10;  2025-11-10 06:02:24,597 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Agent error: FileNotFoundError: CSV catalog directory missing: D:\lmis_int\src\external_data\qatar_open_data&#10;  &#10;assert 1 == 0">@pytest.mark.integration
    def test_cli_query_mode_vision2030() -&gt; None:
        """Test CLI with query for Vision 2030 alignment."""
        query = "Assess qatarization progress toward Vision 2030 targets"
    
        exit_code, stdout, stderr = run_cli_query(query)
    
        # Should exit successfully
&gt;       assert exit_code == 0, f"CLI failed with stderr: {stderr}"
E       AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour
E         2025-11-10 06:02:24,594 - src.qnwis.orchestration.nodes.invoke - ERROR - Agent invocation failed
E         Traceback (most recent call last):
E           File "D:\lmis_int\src\qnwis\orchestration\nodes\invoke.py", line 197, in invoke_agent
E             result = method(**valid_params)
E                      ^^^^^^^^^^^^^^^^^^^^^^
E           File "D:\lmis_int\src\qnwis\agents\national_strategy.py", line 303, in vision2030_alignment
E             qat_res = self.client.run("syn_qatarization_by_sector_latest")
E                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           File "D:\lmis_int\src\qnwis\agents\base.py", line 180, in run
E             res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
E                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           File "D:\lmis_int\src\qnwis\data\deterministic\cache_access.py", line 229, in execute_cached
E             res = execute_uncached(query_id, registry, spec_override=spec)
E                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           File "D:\lmis_int\src\qnwis\data\deterministic\access.py", line 39, in execute
E             result = run_csv_query(spec)
E                      ^^^^^^^^^^^^^^^^^^^
E           File "D:\lmis_int\src\qnwis\data\connectors\csv_catalog.py", line 157, in run_csv_query
E             file_path = _resolve_latest_csv(parsed.pattern)
E                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           File "D:\lmis_int\src\qnwis\data\connectors\csv_catalog.py", line 115, in _resolve_latest_csv
E             raise FileNotFoundError(f"CSV catalog directory missing: {BASE}")
E         FileNotFoundError: CSV catalog directory missing: D:\lmis_int\src\external_data\qatar_open_data
E         2025-11-10 06:02:24,597 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Agent error: FileNotFoundError: CSV catalog directory missing: D:\lmis_int\src\external_data\qatar_open_data
E         
E       assert 1 == 0

tests\integration\orchestration\test_cli_query_mode.py:139: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_cli_query_mode" name="test_cli_query_mode_talent_competition" time="1.309"><failure message="AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour&#10;  2025-11-10 06:02:25,918 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for &quot;Analyze poaching patterns in Finance sector&quot;?&#10;  &#10;assert 1 == 0">@pytest.mark.integration
    def test_cli_query_mode_talent_competition() -&gt; None:
        """Test CLI with query for talent competition."""
        query = "Analyze poaching patterns in Finance sector"
    
        exit_code, stdout, stderr = run_cli_query(query)
    
        # Should exit successfully
&gt;       assert exit_code == 0, f"CLI failed with stderr: {stderr}"
E       AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour
E         2025-11-10 06:02:25,918 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for "Analyze poaching patterns in Finance sector"?
E         
E       assert 1 == 0

tests\integration\orchestration\test_cli_query_mode.py:159: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_cli_query_mode" name="test_cli_query_mode_low_confidence_fails_gracefully" time="1.322" /><testcase classname="tests.integration.orchestration.test_cli_query_mode" name="test_cli_query_mode_with_output_file" time="1.302"><failure message="AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour&#10;  2025-11-10 06:02:28,554 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for &quot;Find correlations in Construction retention&quot;?&#10;  &#10;assert 1 == 0">tmp_path = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_cli_query_mode_with_outpu0')

    @pytest.mark.integration
    def test_cli_query_mode_with_output_file(tmp_path: Path) -&gt; None:
        """Test CLI with --output flag."""
        query = "Find correlations in Construction retention"
        output_file = tmp_path / "result.json"
    
        exit_code, stdout, stderr = run_cli_query(
            query,
            extra_args=["--output", str(output_file)],
        )
    
        # Should exit successfully
&gt;       assert exit_code == 0, f"CLI failed with stderr: {stderr}"
E       AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour
E         2025-11-10 06:02:28,554 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for "Find correlations in Construction retention"?
E         
E       assert 1 == 0

tests\integration\orchestration\test_cli_query_mode.py:201: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_cli_query_mode" name="test_cli_query_mode_json_includes_metadata" time="1.303"><failure message="AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour&#10;  2025-11-10 06:02:29,863 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for &quot;Analyze retention trends in Healthcare&quot;?&#10;  &#10;assert 1 == 0">@pytest.mark.integration
    def test_cli_query_mode_json_includes_metadata() -&gt; None:
        """Test that JSON output includes routing metadata."""
        query = "Analyze retention trends in Healthcare"
    
        exit_code, stdout, stderr = run_cli_query(query)
    
        # Should exit successfully
&gt;       assert exit_code == 0, f"CLI failed with stderr: {stderr}"
E       AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour
E         2025-11-10 06:02:29,863 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for "Analyze retention trends in Healthcare"?
E         
E       assert 1 == 0

tests\integration\orchestration\test_cli_query_mode.py:222: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_cli_query_mode" name="test_cli_query_mode_markdown_format" time="1.318"><failure message="AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour&#10;  2025-11-10 06:02:31,201 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for &quot;Find anomalies in Construction&quot;?&#10;  &#10;assert 1 == 0&#10; +  where 1 = CompletedProcess(args=['C:\\Program Files\\Python311\\python.exe', '-m', 'src.qnwis.cli.qnwis_workflow', '--query', 'F...ce 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for &quot;Find anomalies in Construction&quot;?\n').returncode">@pytest.mark.integration
    def test_cli_query_mode_markdown_format() -&gt; None:
        """Test CLI with --format markdown."""
        query = "Find anomalies in Construction"
    
        args = [
            sys.executable,
            "-m",
            "src.qnwis.cli.qnwis_workflow",
            "--query",
            query,
            "--format",
            "markdown",
            "--log-level",
            "ERROR",
        ]
    
        result = subprocess.run(
            args,
            capture_output=True,
            text=True,
            cwd=str(Path(__file__).parent.parent.parent.parent),
        )
    
        # Should exit successfully
&gt;       assert result.returncode == 0, f"CLI failed with stderr: {result.stderr}"
E       AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour
E         2025-11-10 06:02:31,201 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for "Find anomalies in Construction"?
E         
E       assert 1 == 0
E        +  where 1 = CompletedProcess(args=['C:\\Program Files\\Python311\\python.exe', '-m', 'src.qnwis.cli.qnwis_workflow', '--query', 'F...ce 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for "Find anomalies in Construction"?\n').returncode

tests\integration\orchestration\test_cli_query_mode.py:267: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_cli_query_mode" name="test_cli_query_mode_request_id_propagation" time="1.298"><failure message="AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour&#10;  2025-11-10 06:02:32,511 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.00 &lt; 0.55). Could you clarify the primary labour market metric or sector for &quot;Analyze retention in Finance&quot;?&#10;  &#10;assert 1 == 0">@pytest.mark.integration
    def test_cli_query_mode_request_id_propagation() -&gt; None:
        """Test that request_id is propagated through workflow."""
        query = "Analyze retention in Finance"
        request_id = "test-req-12345"
    
        exit_code, stdout, stderr = run_cli_query(
            query,
            extra_args=["--request-id", request_id],
        )
    
        # Should exit successfully
&gt;       assert exit_code == 0, f"CLI failed with stderr: {stderr}"
E       AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour
E         2025-11-10 06:02:32,511 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.00 &lt; 0.55). Could you clarify the primary labour market metric or sector for "Analyze retention in Finance"?
E         
E       assert 1 == 0

tests\integration\orchestration\test_cli_query_mode.py:287: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_cli_query_mode" name="test_cli_query_mode_deterministic_output" time="2.608"><failure message="assert 1 == 0">@pytest.mark.integration
    def test_cli_query_mode_deterministic_output() -&gt; None:
        """Test that same query produces deterministic output."""
        query = "Find correlations in Construction retention over 24 months"
    
        # Run twice
        exit_code1, stdout1, stderr1 = run_cli_query(query)
        exit_code2, stdout2, stderr2 = run_cli_query(query)
    
        # Both should succeed
&gt;       assert exit_code1 == 0
E       assert 1 == 0

tests\integration\orchestration\test_cli_query_mode.py:305: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_cli_query_mode" name="test_cli_query_mode_root_causes" time="1.316"><failure message="AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour&#10;  2025-11-10 06:02:36,452 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for &quot;Why is retention declining in Construction?&quot;?&#10;  &#10;assert 1 == 0">@pytest.mark.integration
    def test_cli_query_mode_root_causes() -&gt; None:
        """Test CLI with root cause query."""
        query = "Why is retention declining in Construction?"
    
        exit_code, stdout, stderr = run_cli_query(query)
    
        # Should exit successfully
&gt;       assert exit_code == 0, f"CLI failed with stderr: {stderr}"
E       AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour
E         2025-11-10 06:02:36,452 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for "Why is retention declining in Construction?"?
E         
E       assert 1 == 0

tests\integration\orchestration\test_cli_query_mode.py:329: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_cli_query_mode" name="test_cli_query_mode_best_practices" time="1.313"><failure message="AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour&#10;  2025-11-10 06:02:37,773 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for &quot;Which companies have best practices for retention in Healthcare?&quot;?&#10;  &#10;assert 1 == 0">@pytest.mark.integration
    def test_cli_query_mode_best_practices() -&gt; None:
        """Test CLI with best practices query."""
        query = "Which companies have best practices for retention in Healthcare?"
    
        exit_code, stdout, stderr = run_cli_query(query)
    
        # Should exit successfully
&gt;       assert exit_code == 0, f"CLI failed with stderr: {stderr}"
E       AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour
E         2025-11-10 06:02:37,773 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for "Which companies have best practices for retention in Healthcare?"?
E         
E       assert 1 == 0

tests\integration\orchestration\test_cli_query_mode.py:348: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_cli_query_mode" name="test_cli_query_mode_with_sector_override" time="1.300"><failure message="AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour&#10;  2025-11-10 06:02:39,095 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for &quot;Find anomalies in retention&quot;?&#10;  &#10;assert 1 == 0">@pytest.mark.integration
    def test_cli_query_mode_with_sector_override() -&gt; None:
        """Test CLI query with explicit sector parameter override."""
        query = "Find anomalies in retention"
    
        exit_code, stdout, stderr = run_cli_query(
            query,
            extra_args=["--sector", "Finance"],
        )
    
        # Should exit successfully
&gt;       assert exit_code == 0, f"CLI failed with stderr: {stderr}"
E       AssertionError: CLI failed with stderr: &lt;frozen runpy&gt;:128: RuntimeWarning: 'src.qnwis.cli.qnwis_workflow' found in sys.modules after import of package 'src.qnwis.cli', but prior to execution of 'src.qnwis.cli.qnwis_workflow'; this may result in unpredictable behaviour
E         2025-11-10 06:02:39,095 - src.qnwis.orchestration.nodes.error - ERROR - Handling workflow error: Clarification required (confidence 0.40 &lt; 0.55). Could you clarify the primary labour market metric or sector for "Find anomalies in retention"?
E         
E       assert 1 == 0

tests\integration\orchestration\test_cli_query_mode.py:370: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationSingle" name="test_single_mode_execution" time="0.003" /><testcase classname="tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationSingle" name="test_single_mode_with_findings" time="0.003" /><testcase classname="tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationParallel" name="test_parallel_mode_execution" time="0.004" /><testcase classname="tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationParallel" name="test_parallel_mode_merges_correctly" time="0.004"><failure message="AssertionError: assert 1 &gt;= 2&#10; +  where 1 = len([Citation(query_id='test_query', dataset_id='test_dataset', locator='test.csv', fields=['field1'], timestamp=None)])&#10; +    where [Citation(query_id='test_query', dataset_id='test_dataset', locator='test.csv', fields=['field1'], timestamp=None)] = OrchestrationResult(ok=True, intent='test.agent1', sections=[ReportSection(title='Executive Summary', body_md='**Agent...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).citations">self = &lt;tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationParallel object at 0x000001C13AEEB890&gt;

    def test_parallel_mode_merges_correctly(self):
        """Test parallel mode merges multiple agent outputs."""
        registry = AgentRegistry()
        agent1 = StubAgent("Agent1")
        agent2 = StubAgent("Agent2")
        registry.register("test.agent1", agent1, "run")
        registry.register("test.agent2", agent2, "run")
    
        coordinator = Coordinator(registry, CoordinationPolicy())
    
        specs = [
            AgentCallSpec(intent="test.agent1", method="run", params={}),
            AgentCallSpec(intent="test.agent2", method="run", params={}),
        ]
    
        waves = coordinator.plan("test.agent1", specs, "parallel")
        results = coordinator.execute(waves, prefetch_cache={}, mode="parallel")
        merged = coordinator.aggregate(results)
    
        assert merged.ok is True
        assert len(merged.sections) &gt;= 2  # At least one section from each agent
        # Should have citations from both agents
&gt;       assert len(merged.citations) &gt;= 2
E       AssertionError: assert 1 &gt;= 2
E        +  where 1 = len([Citation(query_id='test_query', dataset_id='test_dataset', locator='test.csv', fields=['field1'], timestamp=None)])
E        +    where [Citation(query_id='test_query', dataset_id='test_dataset', locator='test.csv', fields=['field1'], timestamp=None)] = OrchestrationResult(ok=True, intent='test.agent1', sections=[ReportSection(title='Executive Summary', body_md='**Agent...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).citations

tests\integration\orchestration\test_graph_coordination.py:219: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationSequential" name="test_sequential_mode_execution" time="0.003" /><testcase classname="tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationSequential" name="test_sequential_mode_with_dependencies" time="0.003" /><testcase classname="tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationSequential" name="test_sequential_mode_skips_dependent_on_failure" time="0.002"><failure message="ValueError: per_agent_timeout_ms must be at least 1000ms">self = &lt;tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationSequential object at 0x000001C13AECA7D0&gt;

    def test_sequential_mode_skips_dependent_on_failure(self):
        """Test sequential mode skips dependent when prerequisite fails."""
        registry = AgentRegistry()
        failing_agent = StubAgent("FailingAgent", return_findings=False)
        dependent_agent = StubAgent("DependentAgent")
        registry.register("test.failing", failing_agent, "run")
        registry.register("test.dependent", dependent_agent, "run")
    
        # Force failing agent to timeout
&gt;       policy = CoordinationPolicy(per_agent_timeout_ms=1)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\orchestration\test_graph_coordination.py:283: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
&lt;string&gt;:9: in __init__
    ???
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = CoordinationPolicy(max_parallel=3, crisis_parallel=5, per_agent_timeout_ms=1, total_timeout_ms=60000, strict_merge=False, retry_transient=1)

    def __post_init__(self) -&gt; None:
        """Validate policy constraints."""
        if self.max_parallel &lt; 1:
            raise ValueError("max_parallel must be at least 1")
        if self.crisis_parallel &lt; self.max_parallel:
            raise ValueError("crisis_parallel must be &gt;= max_parallel")
        if self.per_agent_timeout_ms &lt; 1000:
&gt;           raise ValueError("per_agent_timeout_ms must be at least 1000ms")
E           ValueError: per_agent_timeout_ms must be at least 1000ms

src\qnwis\orchestration\policies.py:42: ValueError</failure></testcase><testcase classname="tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationCrisis" name="test_crisis_mode_uses_higher_parallelism" time="0.003" /><testcase classname="tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationPrefetch" name="test_prefetch_populates_cache" time="0.003"><failure message="src.qnwis.orchestration.prefetch.PrefetchError: Prefetch failed for run({'query_id': 'query1'}): 2 validation errors for Provenance&#10;source&#10;  Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&#10;fields&#10;  Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing">self = &lt;tests.integration.orchestration.test_graph_coordination.MockDataClient object at 0x000001C13F500BD0&gt;
query_id = 'query1'

    def run(self, query_id: str) -&gt; QueryResult:
        """Mock run method."""
        self.calls.append(("run", {"query_id": query_id}))
        return QueryResult(
            query_id=query_id,
            rows=[Row(data={"value": 100})],
&gt;           provenance=Provenance(
                dataset_id="prefetch_dataset",
                locator="prefetch.csv",
                source_format="csv",
            ),
            freshness=Freshness(asof_date="2024-01-01"),
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance
E       source
E         Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       fields
E         Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\integration\orchestration\test_graph_coordination.py:92: ValidationError

The above exception was the direct cause of the following exception:

self = &lt;tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationPrefetch object at 0x000001C13AEF9110&gt;

    def test_prefetch_populates_cache(self):
        """Test that prefetch specs populate cache for agents."""
        client = MockDataClient()
        prefetcher = Prefetcher(client)
    
        specs = [
            PrefetchSpec(
                fn="run",
                params={"query_id": "query1"},
                cache_key="key1",
            ),
            PrefetchSpec(
                fn="get_metrics",
                params={"sector": "health"},
                cache_key="key2",
            ),
        ]
    
&gt;       cache = prefetcher.run(specs)
                ^^^^^^^^^^^^^^^^^^^^^

tests\integration\orchestration\test_graph_coordination.py:357: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = &lt;src.qnwis.orchestration.prefetch.Prefetcher object at 0x000001C13F5000D0&gt;
specs = [{'cache_key': 'key1', 'fn': 'run', 'params': {'query_id': 'query1'}}, {'cache_key': 'key2', 'fn': 'get_metrics', 'params': {'sector': 'health'}}]

    def run(self, specs: list[PrefetchSpec]) -&gt; dict[str, QueryResult]:
        """
        Execute prefetch specifications and return cache.
    
        Args:
            specs: List of PrefetchSpec declarations
    
        Returns:
            Dictionary mapping cache_key to QueryResult
    
        Raises:
            PrefetchError: If prefetch fails or times out
        """
        start_time = time.perf_counter()
        cache: dict[str, QueryResult] = {}
        seen_keys: set[str] = set()
    
        logger.info("Starting prefetch with %d specs", len(specs))
    
        for idx, spec in enumerate(specs):
            # Check timeout
            elapsed_ms = (time.perf_counter() - start_time) * 1000
            if elapsed_ms &gt; self.timeout_ms:
                msg = f"Prefetch timeout after {elapsed_ms:.0f}ms (limit: {self.timeout_ms}ms)"
                logger.error(msg)
                raise PrefetchError(msg)
    
            cache_key = spec["cache_key"]
    
            # Deduplicate by cache_key
            if cache_key in seen_keys:
                logger.debug("Skipping duplicate cache_key: %s", cache_key)
                continue
            seen_keys.add(cache_key)
    
            fn_name = spec["fn"]
            params = spec["params"]
    
            logger.debug(
                "Prefetch [%d/%d]: %s with params=%s",
                idx + 1,
                len(specs),
                fn_name,
                self._sanitize_params(params),
            )
    
            try:
                # Execute via DataClient
                method = getattr(self.client, fn_name, None)
                if method is None:
                    msg = f"DataClient has no method: {fn_name}"
                    logger.error(msg)
                    raise PrefetchError(msg)
    
                if not callable(method):
                    msg = f"DataClient.{fn_name} is not callable"
                    logger.error(msg)
                    raise PrefetchError(msg)
    
                # Call the method
                result = method(**params)
    
                # Validate result type
                if not isinstance(result, QueryResult):
                    msg = (
                        f"DataClient.{fn_name} returned {type(result).__name__}, "
                        "expected QueryResult"
                    )
                    logger.error(msg)
                    raise PrefetchError(msg)
    
                cache[cache_key] = result
                logger.debug("Cached result for key: %s (rows=%d)", cache_key, len(result.rows))
    
                # Write to Redis cache if available
                if self.cache:
                    try:
                        from ..cache.keys import make_cache_key
    
                        qid = getattr(result, "query_id", None)
                        if not isinstance(qid, str) or not qid:
                            raise ValueError(
                                f"Prefetch result from {fn_name} missing query_id."
                            )
                        cache_k, ttl = make_cache_key(
                            fn_name, qid, params, self.cache_version
                        )
                        self.cache.set(cache_k, result, ttl)
                    except Exception as cache_exc:
                        logger.warning(
                            "Failed to write to cache: %s", cache_exc
                        )
    
            except Exception as exc:
                msg = f"Prefetch failed for {fn_name}({params}): {exc}"
                logger.exception(msg)
&gt;               raise PrefetchError(msg) from exc
E               src.qnwis.orchestration.prefetch.PrefetchError: Prefetch failed for run({'query_id': 'query1'}): 2 validation errors for Provenance
E               source
E                 Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]
E                   For further information visit https://errors.pydantic.dev/2.11/v/missing
E               fields
E                 Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]
E                   For further information visit https://errors.pydantic.dev/2.11/v/missing

src\qnwis\orchestration\prefetch.py:153: PrefetchError</failure></testcase><testcase classname="tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationPrefetch" name="test_prefetch_deduplication" time="0.002"><failure message="src.qnwis.orchestration.prefetch.PrefetchError: Prefetch failed for run({'query_id': 'query1'}): 2 validation errors for Provenance&#10;source&#10;  Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&#10;fields&#10;  Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing">self = &lt;tests.integration.orchestration.test_graph_coordination.MockDataClient object at 0x000001C13DD6E6D0&gt;
query_id = 'query1'

    def run(self, query_id: str) -&gt; QueryResult:
        """Mock run method."""
        self.calls.append(("run", {"query_id": query_id}))
        return QueryResult(
            query_id=query_id,
            rows=[Row(data={"value": 100})],
&gt;           provenance=Provenance(
                dataset_id="prefetch_dataset",
                locator="prefetch.csv",
                source_format="csv",
            ),
            freshness=Freshness(asof_date="2024-01-01"),
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance
E       source
E         Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       fields
E         Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\integration\orchestration\test_graph_coordination.py:92: ValidationError

The above exception was the direct cause of the following exception:

self = &lt;tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationPrefetch object at 0x000001C13AEF9490&gt;

    def test_prefetch_deduplication(self):
        """Test that prefetch deduplicates by cache_key."""
        client = MockDataClient()
        prefetcher = Prefetcher(client)
    
        specs = [
            PrefetchSpec(
                fn="run",
                params={"query_id": "query1"},
                cache_key="duplicate",
            ),
            PrefetchSpec(
                fn="run",
                params={"query_id": "query2"},
                cache_key="duplicate",
            ),
        ]
    
&gt;       cache = prefetcher.run(specs)
                ^^^^^^^^^^^^^^^^^^^^^

tests\integration\orchestration\test_graph_coordination.py:382: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = &lt;src.qnwis.orchestration.prefetch.Prefetcher object at 0x000001C13DD6DED0&gt;
specs = [{'cache_key': 'duplicate', 'fn': 'run', 'params': {'query_id': 'query1'}}, {'cache_key': 'duplicate', 'fn': 'run', 'params': {'query_id': 'query2'}}]

    def run(self, specs: list[PrefetchSpec]) -&gt; dict[str, QueryResult]:
        """
        Execute prefetch specifications and return cache.
    
        Args:
            specs: List of PrefetchSpec declarations
    
        Returns:
            Dictionary mapping cache_key to QueryResult
    
        Raises:
            PrefetchError: If prefetch fails or times out
        """
        start_time = time.perf_counter()
        cache: dict[str, QueryResult] = {}
        seen_keys: set[str] = set()
    
        logger.info("Starting prefetch with %d specs", len(specs))
    
        for idx, spec in enumerate(specs):
            # Check timeout
            elapsed_ms = (time.perf_counter() - start_time) * 1000
            if elapsed_ms &gt; self.timeout_ms:
                msg = f"Prefetch timeout after {elapsed_ms:.0f}ms (limit: {self.timeout_ms}ms)"
                logger.error(msg)
                raise PrefetchError(msg)
    
            cache_key = spec["cache_key"]
    
            # Deduplicate by cache_key
            if cache_key in seen_keys:
                logger.debug("Skipping duplicate cache_key: %s", cache_key)
                continue
            seen_keys.add(cache_key)
    
            fn_name = spec["fn"]
            params = spec["params"]
    
            logger.debug(
                "Prefetch [%d/%d]: %s with params=%s",
                idx + 1,
                len(specs),
                fn_name,
                self._sanitize_params(params),
            )
    
            try:
                # Execute via DataClient
                method = getattr(self.client, fn_name, None)
                if method is None:
                    msg = f"DataClient has no method: {fn_name}"
                    logger.error(msg)
                    raise PrefetchError(msg)
    
                if not callable(method):
                    msg = f"DataClient.{fn_name} is not callable"
                    logger.error(msg)
                    raise PrefetchError(msg)
    
                # Call the method
                result = method(**params)
    
                # Validate result type
                if not isinstance(result, QueryResult):
                    msg = (
                        f"DataClient.{fn_name} returned {type(result).__name__}, "
                        "expected QueryResult"
                    )
                    logger.error(msg)
                    raise PrefetchError(msg)
    
                cache[cache_key] = result
                logger.debug("Cached result for key: %s (rows=%d)", cache_key, len(result.rows))
    
                # Write to Redis cache if available
                if self.cache:
                    try:
                        from ..cache.keys import make_cache_key
    
                        qid = getattr(result, "query_id", None)
                        if not isinstance(qid, str) or not qid:
                            raise ValueError(
                                f"Prefetch result from {fn_name} missing query_id."
                            )
                        cache_k, ttl = make_cache_key(
                            fn_name, qid, params, self.cache_version
                        )
                        self.cache.set(cache_k, result, ttl)
                    except Exception as cache_exc:
                        logger.warning(
                            "Failed to write to cache: %s", cache_exc
                        )
    
            except Exception as exc:
                msg = f"Prefetch failed for {fn_name}({params}): {exc}"
                logger.exception(msg)
&gt;               raise PrefetchError(msg) from exc
E               src.qnwis.orchestration.prefetch.PrefetchError: Prefetch failed for run({'query_id': 'query1'}): 2 validation errors for Provenance
E               source
E                 Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]
E                   For further information visit https://errors.pydantic.dev/2.11/v/missing
E               fields
E                 Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]
E                   For further information visit https://errors.pydantic.dev/2.11/v/missing

src\qnwis\orchestration\prefetch.py:153: PrefetchError</failure></testcase><testcase classname="tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationPrefetch" name="test_coordination_with_prefetch_cache" time="0.003"><failure message="src.qnwis.orchestration.prefetch.PrefetchError: Prefetch failed for run({'query_id': 'prefetch_query'}): 2 validation errors for Provenance&#10;source&#10;  Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&#10;fields&#10;  Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing">self = &lt;tests.integration.orchestration.test_graph_coordination.MockDataClient object at 0x000001C13FD7B110&gt;
query_id = 'prefetch_query'

    def run(self, query_id: str) -&gt; QueryResult:
        """Mock run method."""
        self.calls.append(("run", {"query_id": query_id}))
        return QueryResult(
            query_id=query_id,
            rows=[Row(data={"value": 100})],
&gt;           provenance=Provenance(
                dataset_id="prefetch_dataset",
                locator="prefetch.csv",
                source_format="csv",
            ),
            freshness=Freshness(asof_date="2024-01-01"),
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance
E       source
E         Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       fields
E         Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\integration\orchestration\test_graph_coordination.py:92: ValidationError

The above exception was the direct cause of the following exception:

self = &lt;tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationPrefetch object at 0x000001C13AEF9810&gt;

    def test_coordination_with_prefetch_cache(self):
        """Test coordinator execution with populated prefetch cache."""
        registry = AgentRegistry()
        agent = StubAgent("TestAgent")
        registry.register("test.agent", agent, "run")
    
        coordinator = Coordinator(registry, CoordinationPolicy())
    
        # Create prefetch cache
        client = MockDataClient()
        prefetcher = Prefetcher(client)
        prefetch_specs = [
            PrefetchSpec(
                fn="run",
                params={"query_id": "prefetch_query"},
                cache_key="prefetch_key",
            )
        ]
&gt;       prefetch_cache = prefetcher.run(prefetch_specs)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\orchestration\test_graph_coordination.py:407: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = &lt;src.qnwis.orchestration.prefetch.Prefetcher object at 0x000001C13FD78B90&gt;
specs = [{'cache_key': 'prefetch_key', 'fn': 'run', 'params': {'query_id': 'prefetch_query'}}]

    def run(self, specs: list[PrefetchSpec]) -&gt; dict[str, QueryResult]:
        """
        Execute prefetch specifications and return cache.
    
        Args:
            specs: List of PrefetchSpec declarations
    
        Returns:
            Dictionary mapping cache_key to QueryResult
    
        Raises:
            PrefetchError: If prefetch fails or times out
        """
        start_time = time.perf_counter()
        cache: dict[str, QueryResult] = {}
        seen_keys: set[str] = set()
    
        logger.info("Starting prefetch with %d specs", len(specs))
    
        for idx, spec in enumerate(specs):
            # Check timeout
            elapsed_ms = (time.perf_counter() - start_time) * 1000
            if elapsed_ms &gt; self.timeout_ms:
                msg = f"Prefetch timeout after {elapsed_ms:.0f}ms (limit: {self.timeout_ms}ms)"
                logger.error(msg)
                raise PrefetchError(msg)
    
            cache_key = spec["cache_key"]
    
            # Deduplicate by cache_key
            if cache_key in seen_keys:
                logger.debug("Skipping duplicate cache_key: %s", cache_key)
                continue
            seen_keys.add(cache_key)
    
            fn_name = spec["fn"]
            params = spec["params"]
    
            logger.debug(
                "Prefetch [%d/%d]: %s with params=%s",
                idx + 1,
                len(specs),
                fn_name,
                self._sanitize_params(params),
            )
    
            try:
                # Execute via DataClient
                method = getattr(self.client, fn_name, None)
                if method is None:
                    msg = f"DataClient has no method: {fn_name}"
                    logger.error(msg)
                    raise PrefetchError(msg)
    
                if not callable(method):
                    msg = f"DataClient.{fn_name} is not callable"
                    logger.error(msg)
                    raise PrefetchError(msg)
    
                # Call the method
                result = method(**params)
    
                # Validate result type
                if not isinstance(result, QueryResult):
                    msg = (
                        f"DataClient.{fn_name} returned {type(result).__name__}, "
                        "expected QueryResult"
                    )
                    logger.error(msg)
                    raise PrefetchError(msg)
    
                cache[cache_key] = result
                logger.debug("Cached result for key: %s (rows=%d)", cache_key, len(result.rows))
    
                # Write to Redis cache if available
                if self.cache:
                    try:
                        from ..cache.keys import make_cache_key
    
                        qid = getattr(result, "query_id", None)
                        if not isinstance(qid, str) or not qid:
                            raise ValueError(
                                f"Prefetch result from {fn_name} missing query_id."
                            )
                        cache_k, ttl = make_cache_key(
                            fn_name, qid, params, self.cache_version
                        )
                        self.cache.set(cache_k, result, ttl)
                    except Exception as cache_exc:
                        logger.warning(
                            "Failed to write to cache: %s", cache_exc
                        )
    
            except Exception as exc:
                msg = f"Prefetch failed for {fn_name}({params}): {exc}"
                logger.exception(msg)
&gt;               raise PrefetchError(msg) from exc
E               src.qnwis.orchestration.prefetch.PrefetchError: Prefetch failed for run({'query_id': 'prefetch_query'}): 2 validation errors for Provenance
E               source
E                 Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]
E                   For further information visit https://errors.pydantic.dev/2.11/v/missing
E               fields
E                 Field required [type=missing, input_value={'dataset_id': 'prefetch_... 'source_format': 'csv'}, input_type=dict]
E                   For further information visit https://errors.pydantic.dev/2.11/v/missing

src\qnwis\orchestration\prefetch.py:153: PrefetchError</failure></testcase><testcase classname="tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationTimeout" name="test_agent_timeout_produces_warning" time="0.053" /><testcase classname="tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationMerge" name="test_merge_combines_sections" time="0.004" /><testcase classname="tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationMerge" name="test_merge_deduplicates_citations" time="0.004"><failure message="AssertionError: assert 1 &gt;= 2&#10; +  where 1 = len([Citation(query_id='test_query', dataset_id='test_dataset', locator='test.csv', fields=['field1'], timestamp=None)])&#10; +    where [Citation(query_id='test_query', dataset_id='test_dataset', locator='test.csv', fields=['field1'], timestamp=None)] = OrchestrationResult(ok=True, intent='test.agent1', sections=[ReportSection(title='Executive Summary', body_md='**Agent...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).citations">self = &lt;tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationMerge object at 0x000001C13AEFAC90&gt;

    def test_merge_deduplicates_citations(self):
        """Test that merge deduplicates citations."""
        registry = AgentRegistry()
        agent1 = StubAgent("Agent1")
        agent2 = StubAgent("Agent2")
        registry.register("test.agent1", agent1, "run")
        registry.register("test.agent2", agent2, "run")
    
        coordinator = Coordinator(registry, CoordinationPolicy())
    
        specs = [
            AgentCallSpec(intent="test.agent1", method="run", params={}),
            AgentCallSpec(intent="test.agent2", method="run", params={}),
        ]
    
        waves = coordinator.plan("test.agent1", specs, "parallel")
        results = coordinator.execute(waves, prefetch_cache={}, mode="parallel")
        merged = coordinator.aggregate(results)
    
        # Should have at least 2 citations (one from each agent)
&gt;       assert len(merged.citations) &gt;= 2
E       AssertionError: assert 1 &gt;= 2
E        +  where 1 = len([Citation(query_id='test_query', dataset_id='test_dataset', locator='test.csv', fields=['field1'], timestamp=None)])
E        +    where [Citation(query_id='test_query', dataset_id='test_dataset', locator='test.csv', fields=['field1'], timestamp=None)] = OrchestrationResult(ok=True, intent='test.agent1', sections=[ReportSection(title='Executive Summary', body_md='**Agent...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).citations

tests\integration\orchestration\test_graph_coordination.py:515: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_graph_coordination.TestGraphCoordinationMerge" name="test_merge_tracks_agent_traces" time="0.004" /><testcase classname="tests.integration.orchestration.test_graph_end_to_end" name="test_graph_pattern_anomalies_end_to_end" time="0.001"><error message="failed on setup with &quot;pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance&#10;source&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&#10;fields&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&quot;">@pytest.fixture
    def stubbed_client() -&gt; StubbedDataClient:
        """Fixture providing a stubbed client with synthetic data."""
        client = StubbedDataClient()
    
        # Add synthetic attrition data for pattern detective
        attrition_result = QueryResult(
            query_id="syn_attrition_by_sector_latest",
            rows=[
                Row(data={"sector": "Finance", "attrition_percent": 10.0}),
                Row(data={"sector": "Retail", "attrition_percent": 12.0}),
                Row(data={"sector": "Manufacturing", "attrition_percent": 11.0}),
                Row(data={"sector": "Healthcare", "attrition_percent": 15.0}),
                Row(data={"sector": "Construction", "attrition_percent": 45.0}),  # Anomaly
            ],
&gt;           provenance=Provenance(
                dataset_id="attrition_data",
                locator="data/attrition.csv",
            ),
            freshness=Freshness(
                as_of="2024-01-15T00:00:00Z",
                updated_at="2024-01-15T00:00:00Z",
            ),
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance
E       source
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       fields
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\integration\orchestration\test_graph_end_to_end.py:73: ValidationError</error></testcase><testcase classname="tests.integration.orchestration.test_graph_end_to_end" name="test_graph_pattern_correlation_end_to_end" time="0.001"><error message="failed on setup with &quot;pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance&#10;source&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&#10;fields&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&quot;">@pytest.fixture
    def stubbed_client() -&gt; StubbedDataClient:
        """Fixture providing a stubbed client with synthetic data."""
        client = StubbedDataClient()
    
        # Add synthetic attrition data for pattern detective
        attrition_result = QueryResult(
            query_id="syn_attrition_by_sector_latest",
            rows=[
                Row(data={"sector": "Finance", "attrition_percent": 10.0}),
                Row(data={"sector": "Retail", "attrition_percent": 12.0}),
                Row(data={"sector": "Manufacturing", "attrition_percent": 11.0}),
                Row(data={"sector": "Healthcare", "attrition_percent": 15.0}),
                Row(data={"sector": "Construction", "attrition_percent": 45.0}),  # Anomaly
            ],
&gt;           provenance=Provenance(
                dataset_id="attrition_data",
                locator="data/attrition.csv",
            ),
            freshness=Freshness(
                as_of="2024-01-15T00:00:00Z",
                updated_at="2024-01-15T00:00:00Z",
            ),
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance
E       source
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       fields
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\integration\orchestration\test_graph_end_to_end.py:73: ValidationError</error></testcase><testcase classname="tests.integration.orchestration.test_graph_end_to_end" name="test_graph_strategy_gcc_benchmark_end_to_end" time="0.001"><error message="failed on setup with &quot;pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance&#10;source&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&#10;fields&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&quot;">@pytest.fixture
    def stubbed_client() -&gt; StubbedDataClient:
        """Fixture providing a stubbed client with synthetic data."""
        client = StubbedDataClient()
    
        # Add synthetic attrition data for pattern detective
        attrition_result = QueryResult(
            query_id="syn_attrition_by_sector_latest",
            rows=[
                Row(data={"sector": "Finance", "attrition_percent": 10.0}),
                Row(data={"sector": "Retail", "attrition_percent": 12.0}),
                Row(data={"sector": "Manufacturing", "attrition_percent": 11.0}),
                Row(data={"sector": "Healthcare", "attrition_percent": 15.0}),
                Row(data={"sector": "Construction", "attrition_percent": 45.0}),  # Anomaly
            ],
&gt;           provenance=Provenance(
                dataset_id="attrition_data",
                locator="data/attrition.csv",
            ),
            freshness=Freshness(
                as_of="2024-01-15T00:00:00Z",
                updated_at="2024-01-15T00:00:00Z",
            ),
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance
E       source
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       fields
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\integration\orchestration\test_graph_end_to_end.py:73: ValidationError</error></testcase><testcase classname="tests.integration.orchestration.test_graph_end_to_end" name="test_graph_handles_unknown_intent" time="0.001"><error message="failed on setup with &quot;pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance&#10;source&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&#10;fields&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&quot;">@pytest.fixture
    def stubbed_client() -&gt; StubbedDataClient:
        """Fixture providing a stubbed client with synthetic data."""
        client = StubbedDataClient()
    
        # Add synthetic attrition data for pattern detective
        attrition_result = QueryResult(
            query_id="syn_attrition_by_sector_latest",
            rows=[
                Row(data={"sector": "Finance", "attrition_percent": 10.0}),
                Row(data={"sector": "Retail", "attrition_percent": 12.0}),
                Row(data={"sector": "Manufacturing", "attrition_percent": 11.0}),
                Row(data={"sector": "Healthcare", "attrition_percent": 15.0}),
                Row(data={"sector": "Construction", "attrition_percent": 45.0}),  # Anomaly
            ],
&gt;           provenance=Provenance(
                dataset_id="attrition_data",
                locator="data/attrition.csv",
            ),
            freshness=Freshness(
                as_of="2024-01-15T00:00:00Z",
                updated_at="2024-01-15T00:00:00Z",
            ),
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance
E       source
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       fields
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\integration\orchestration\test_graph_end_to_end.py:73: ValidationError</error></testcase><testcase classname="tests.integration.orchestration.test_graph_end_to_end" name="test_graph_handles_agent_errors_gracefully" time="0.001"><error message="failed on setup with &quot;pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance&#10;source&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&#10;fields&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&quot;">@pytest.fixture
    def stubbed_client() -&gt; StubbedDataClient:
        """Fixture providing a stubbed client with synthetic data."""
        client = StubbedDataClient()
    
        # Add synthetic attrition data for pattern detective
        attrition_result = QueryResult(
            query_id="syn_attrition_by_sector_latest",
            rows=[
                Row(data={"sector": "Finance", "attrition_percent": 10.0}),
                Row(data={"sector": "Retail", "attrition_percent": 12.0}),
                Row(data={"sector": "Manufacturing", "attrition_percent": 11.0}),
                Row(data={"sector": "Healthcare", "attrition_percent": 15.0}),
                Row(data={"sector": "Construction", "attrition_percent": 45.0}),  # Anomaly
            ],
&gt;           provenance=Provenance(
                dataset_id="attrition_data",
                locator="data/attrition.csv",
            ),
            freshness=Freshness(
                as_of="2024-01-15T00:00:00Z",
                updated_at="2024-01-15T00:00:00Z",
            ),
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance
E       source
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       fields
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\integration\orchestration\test_graph_end_to_end.py:73: ValidationError</error></testcase><testcase classname="tests.integration.orchestration.test_graph_end_to_end" name="test_graph_multiple_sequential_runs" time="0.001"><error message="failed on setup with &quot;pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance&#10;source&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&#10;fields&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&quot;">@pytest.fixture
    def stubbed_client() -&gt; StubbedDataClient:
        """Fixture providing a stubbed client with synthetic data."""
        client = StubbedDataClient()
    
        # Add synthetic attrition data for pattern detective
        attrition_result = QueryResult(
            query_id="syn_attrition_by_sector_latest",
            rows=[
                Row(data={"sector": "Finance", "attrition_percent": 10.0}),
                Row(data={"sector": "Retail", "attrition_percent": 12.0}),
                Row(data={"sector": "Manufacturing", "attrition_percent": 11.0}),
                Row(data={"sector": "Healthcare", "attrition_percent": 15.0}),
                Row(data={"sector": "Construction", "attrition_percent": 45.0}),  # Anomaly
            ],
&gt;           provenance=Provenance(
                dataset_id="attrition_data",
                locator="data/attrition.csv",
            ),
            freshness=Freshness(
                as_of="2024-01-15T00:00:00Z",
                updated_at="2024-01-15T00:00:00Z",
            ),
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance
E       source
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       fields
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\integration\orchestration\test_graph_end_to_end.py:73: ValidationError</error></testcase><testcase classname="tests.integration.orchestration.test_graph_end_to_end" name="test_graph_with_custom_config" time="0.001"><error message="failed on setup with &quot;pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance&#10;source&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&#10;fields&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&quot;">@pytest.fixture
    def stubbed_client() -&gt; StubbedDataClient:
        """Fixture providing a stubbed client with synthetic data."""
        client = StubbedDataClient()
    
        # Add synthetic attrition data for pattern detective
        attrition_result = QueryResult(
            query_id="syn_attrition_by_sector_latest",
            rows=[
                Row(data={"sector": "Finance", "attrition_percent": 10.0}),
                Row(data={"sector": "Retail", "attrition_percent": 12.0}),
                Row(data={"sector": "Manufacturing", "attrition_percent": 11.0}),
                Row(data={"sector": "Healthcare", "attrition_percent": 15.0}),
                Row(data={"sector": "Construction", "attrition_percent": 45.0}),  # Anomaly
            ],
&gt;           provenance=Provenance(
                dataset_id="attrition_data",
                locator="data/attrition.csv",
            ),
            freshness=Freshness(
                as_of="2024-01-15T00:00:00Z",
                updated_at="2024-01-15T00:00:00Z",
            ),
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance
E       source
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       fields
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\integration\orchestration\test_graph_end_to_end.py:73: ValidationError</error></testcase><testcase classname="tests.integration.orchestration.test_graph_end_to_end" name="test_graph_preserves_request_id" time="0.001"><error message="failed on setup with &quot;pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance&#10;source&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&#10;fields&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&quot;">@pytest.fixture
    def stubbed_client() -&gt; StubbedDataClient:
        """Fixture providing a stubbed client with synthetic data."""
        client = StubbedDataClient()
    
        # Add synthetic attrition data for pattern detective
        attrition_result = QueryResult(
            query_id="syn_attrition_by_sector_latest",
            rows=[
                Row(data={"sector": "Finance", "attrition_percent": 10.0}),
                Row(data={"sector": "Retail", "attrition_percent": 12.0}),
                Row(data={"sector": "Manufacturing", "attrition_percent": 11.0}),
                Row(data={"sector": "Healthcare", "attrition_percent": 15.0}),
                Row(data={"sector": "Construction", "attrition_percent": 45.0}),  # Anomaly
            ],
&gt;           provenance=Provenance(
                dataset_id="attrition_data",
                locator="data/attrition.csv",
            ),
            freshness=Freshness(
                as_of="2024-01-15T00:00:00Z",
                updated_at="2024-01-15T00:00:00Z",
            ),
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance
E       source
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       fields
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\integration\orchestration\test_graph_end_to_end.py:73: ValidationError</error></testcase><testcase classname="tests.integration.orchestration.test_graph_end_to_end" name="test_graph_deterministic_output" time="0.001"><error message="failed on setup with &quot;pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance&#10;source&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&#10;fields&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&quot;">@pytest.fixture
    def stubbed_client() -&gt; StubbedDataClient:
        """Fixture providing a stubbed client with synthetic data."""
        client = StubbedDataClient()
    
        # Add synthetic attrition data for pattern detective
        attrition_result = QueryResult(
            query_id="syn_attrition_by_sector_latest",
            rows=[
                Row(data={"sector": "Finance", "attrition_percent": 10.0}),
                Row(data={"sector": "Retail", "attrition_percent": 12.0}),
                Row(data={"sector": "Manufacturing", "attrition_percent": 11.0}),
                Row(data={"sector": "Healthcare", "attrition_percent": 15.0}),
                Row(data={"sector": "Construction", "attrition_percent": 45.0}),  # Anomaly
            ],
&gt;           provenance=Provenance(
                dataset_id="attrition_data",
                locator="data/attrition.csv",
            ),
            freshness=Freshness(
                as_of="2024-01-15T00:00:00Z",
                updated_at="2024-01-15T00:00:00Z",
            ),
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance
E       source
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       fields
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\integration\orchestration\test_graph_end_to_end.py:73: ValidationError</error></testcase><testcase classname="tests.integration.orchestration.test_graph_end_to_end" name="test_graph_citation_quality" time="0.001"><error message="failed on setup with &quot;pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance&#10;source&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&#10;fields&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&quot;">@pytest.fixture
    def stubbed_client() -&gt; StubbedDataClient:
        """Fixture providing a stubbed client with synthetic data."""
        client = StubbedDataClient()
    
        # Add synthetic attrition data for pattern detective
        attrition_result = QueryResult(
            query_id="syn_attrition_by_sector_latest",
            rows=[
                Row(data={"sector": "Finance", "attrition_percent": 10.0}),
                Row(data={"sector": "Retail", "attrition_percent": 12.0}),
                Row(data={"sector": "Manufacturing", "attrition_percent": 11.0}),
                Row(data={"sector": "Healthcare", "attrition_percent": 15.0}),
                Row(data={"sector": "Construction", "attrition_percent": 45.0}),  # Anomaly
            ],
&gt;           provenance=Provenance(
                dataset_id="attrition_data",
                locator="data/attrition.csv",
            ),
            freshness=Freshness(
                as_of="2024-01-15T00:00:00Z",
                updated_at="2024-01-15T00:00:00Z",
            ),
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance
E       source
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       fields
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\integration\orchestration\test_graph_end_to_end.py:73: ValidationError</error></testcase><testcase classname="tests.integration.orchestration.test_graph_end_to_end" name="test_graph_freshness_metadata" time="0.001"><error message="failed on setup with &quot;pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance&#10;source&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&#10;fields&#10;  Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/missing&quot;">@pytest.fixture
    def stubbed_client() -&gt; StubbedDataClient:
        """Fixture providing a stubbed client with synthetic data."""
        client = StubbedDataClient()
    
        # Add synthetic attrition data for pattern detective
        attrition_result = QueryResult(
            query_id="syn_attrition_by_sector_latest",
            rows=[
                Row(data={"sector": "Finance", "attrition_percent": 10.0}),
                Row(data={"sector": "Retail", "attrition_percent": 12.0}),
                Row(data={"sector": "Manufacturing", "attrition_percent": 11.0}),
                Row(data={"sector": "Healthcare", "attrition_percent": 15.0}),
                Row(data={"sector": "Construction", "attrition_percent": 45.0}),  # Anomaly
            ],
&gt;           provenance=Provenance(
                dataset_id="attrition_data",
                locator="data/attrition.csv",
            ),
            freshness=Freshness(
                as_of="2024-01-15T00:00:00Z",
                updated_at="2024-01-15T00:00:00Z",
            ),
        )
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for Provenance
E       source
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       fields
E         Field required [type=missing, input_value={'dataset_id': 'attrition...': 'data/attrition.csv'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\integration\orchestration\test_graph_end_to_end.py:73: ValidationError</error></testcase><testcase classname="tests.integration.orchestration.test_graph_routing" name="test_graph_routing_pattern_anomalies" time="0.356"><failure message="AssertionError: assert False is True&#10; +  where False = OrchestrationResult(ok=False, intent='unknown', sections=[ReportSection(title='Error Summary', body_md='**Status**: Fa...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).ok">registry_with_fake_agents = (&lt;src.qnwis.orchestration.registry.AgentRegistry object at 0x000001C13F85E410&gt;, &lt;tests.integration.orchestration.test_...000001C13F490810&gt;, &lt;tests.integration.orchestration.test_graph_routing.FakeStrategyAgent object at 0x000001C13AEEBD50&gt;)

    def test_graph_routing_pattern_anomalies(
        registry_with_fake_agents: tuple[AgentRegistry, FakePatternAgent, FakeStrategyAgent]
    ) -&gt; None:
        """Test graph routing for pattern.anomalies intent."""
        registry, pattern_agent, strategy_agent = registry_with_fake_agents
    
        config: dict[str, Any] = {"enabled_intents": list(registry.intents())}
        graph = create_graph(registry, config)
    
        query = "Find anomalies in Construction retention over last 24 months"
        task = OrchestrationTask(query_text=query, params={})
    
        result = graph.run(task)
    
        # Should succeed
&gt;       assert result.ok is True
E       AssertionError: assert False is True
E        +  where False = OrchestrationResult(ok=False, intent='unknown', sections=[ReportSection(title='Error Summary', body_md='**Status**: Fa...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).ok

tests\integration\orchestration\test_graph_routing.py:237: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_graph_routing" name="test_graph_routing_pattern_correlation" time="0.209"><failure message="AssertionError: assert False is True&#10; +  where False = OrchestrationResult(ok=False, intent='unknown', sections=[ReportSection(title='Error Summary', body_md='**Status**: Fa...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).ok">registry_with_fake_agents = (&lt;src.qnwis.orchestration.registry.AgentRegistry object at 0x000001C13EF43DD0&gt;, &lt;tests.integration.orchestration.test_...000001C13F449990&gt;, &lt;tests.integration.orchestration.test_graph_routing.FakeStrategyAgent object at 0x000001C13EF9AFD0&gt;)

    def test_graph_routing_pattern_correlation(
        registry_with_fake_agents: tuple[AgentRegistry, FakePatternAgent, FakeStrategyAgent]
    ) -&gt; None:
        """Test graph routing for pattern.correlation intent."""
        registry, pattern_agent, strategy_agent = registry_with_fake_agents
    
        config: dict[str, Any] = {"enabled_intents": list(registry.intents())}
        graph = create_graph(registry, config)
    
        query = "Is there a correlation between salary and retention in Healthcare?"
        task = OrchestrationTask(query_text=query, params={})
    
        result = graph.run(task)
    
        # Should succeed
&gt;       assert result.ok is True
E       AssertionError: assert False is True
E        +  where False = OrchestrationResult(ok=False, intent='unknown', sections=[ReportSection(title='Error Summary', body_md='**Status**: Fa...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).ok

tests\integration\orchestration\test_graph_routing.py:267: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_graph_routing" name="test_graph_routing_pattern_root_causes" time="0.207"><failure message="AssertionError: assert False is True&#10; +  where False = OrchestrationResult(ok=False, intent='unknown', sections=[ReportSection(title='Error Summary', body_md='**Status**: Fa...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).ok">registry_with_fake_agents = (&lt;src.qnwis.orchestration.registry.AgentRegistry object at 0x000001C13EF74710&gt;, &lt;tests.integration.orchestration.test_...000001C13EF76350&gt;, &lt;tests.integration.orchestration.test_graph_routing.FakeStrategyAgent object at 0x000001C13EF76B50&gt;)

    def test_graph_routing_pattern_root_causes(
        registry_with_fake_agents: tuple[AgentRegistry, FakePatternAgent, FakeStrategyAgent]
    ) -&gt; None:
        """Test graph routing for pattern.root_causes intent."""
        registry, pattern_agent, strategy_agent = registry_with_fake_agents
    
        config: dict[str, Any] = {"enabled_intents": list(registry.intents())}
        graph = create_graph(registry, config)
    
        query = "Why is retention declining in Construction sector?"
        task = OrchestrationTask(query_text=query, params={})
    
        result = graph.run(task)
    
        # Should succeed
&gt;       assert result.ok is True
E       AssertionError: assert False is True
E        +  where False = OrchestrationResult(ok=False, intent='unknown', sections=[ReportSection(title='Error Summary', body_md='**Status**: Fa...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).ok

tests\integration\orchestration\test_graph_routing.py:291: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_graph_routing" name="test_graph_routing_pattern_best_practices" time="0.207"><failure message="AssertionError: assert False is True&#10; +  where False = OrchestrationResult(ok=False, intent='unknown', sections=[ReportSection(title='Error Summary', body_md='**Status**: Fa...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).ok">registry_with_fake_agents = (&lt;src.qnwis.orchestration.registry.AgentRegistry object at 0x000001C13F9B9090&gt;, &lt;tests.integration.orchestration.test_...000001C13AF06010&gt;, &lt;tests.integration.orchestration.test_graph_routing.FakeStrategyAgent object at 0x000001C13F9BA510&gt;)

    def test_graph_routing_pattern_best_practices(
        registry_with_fake_agents: tuple[AgentRegistry, FakePatternAgent, FakeStrategyAgent]
    ) -&gt; None:
        """Test graph routing for pattern.best_practices intent."""
        registry, pattern_agent, strategy_agent = registry_with_fake_agents
    
        config: dict[str, Any] = {"enabled_intents": list(registry.intents())}
        graph = create_graph(registry, config)
    
        query = "Which companies have best practices for retention in Healthcare?"
        task = OrchestrationTask(query_text=query, params={})
    
        result = graph.run(task)
    
        # Should succeed
&gt;       assert result.ok is True
E       AssertionError: assert False is True
E        +  where False = OrchestrationResult(ok=False, intent='unknown', sections=[ReportSection(title='Error Summary', body_md='**Status**: Fa...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).ok

tests\integration\orchestration\test_graph_routing.py:312: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_graph_routing" name="test_graph_routing_strategy_gcc_benchmark" time="0.212" /><testcase classname="tests.integration.orchestration.test_graph_routing" name="test_graph_routing_strategy_talent_competition" time="0.212" /><testcase classname="tests.integration.orchestration.test_graph_routing" name="test_graph_routing_strategy_vision2030" time="0.211" /><testcase classname="tests.integration.orchestration.test_graph_routing" name="test_graph_routing_prefetch_present_not_executed" time="0.209"><failure message="AssertionError: assert False is True&#10; +  where False = OrchestrationResult(ok=False, intent='unknown', sections=[ReportSection(title='Error Summary', body_md='**Status**: Fa...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).ok">registry_with_fake_agents = (&lt;src.qnwis.orchestration.registry.AgentRegistry object at 0x000001C13FD7ACD0&gt;, &lt;tests.integration.orchestration.test_...000001C13EF76850&gt;, &lt;tests.integration.orchestration.test_graph_routing.FakeStrategyAgent object at 0x000001C13EF74790&gt;)

    def test_graph_routing_prefetch_present_not_executed(
        registry_with_fake_agents: tuple[AgentRegistry, FakePatternAgent, FakeStrategyAgent]
    ) -&gt; None:
        """Test that RoutingDecision.prefetch is present but not executed."""
        registry, pattern_agent, strategy_agent = registry_with_fake_agents
    
        config: dict[str, Any] = {"enabled_intents": list(registry.intents())}
        graph = create_graph(registry, config)
    
        query = "Analyze retention trends in Construction over 36 months"
        task = OrchestrationTask(query_text=query, params={})
    
        result = graph.run(task)
    
        # Should succeed
&gt;       assert result.ok is True
E       AssertionError: assert False is True
E        +  where False = OrchestrationResult(ok=False, intent='unknown', sections=[ReportSection(title='Error Summary', body_md='**Status**: Fa...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).ok

tests\integration\orchestration\test_graph_routing.py:399: AssertionError</failure></testcase><testcase classname="tests.integration.orchestration.test_graph_routing" name="test_graph_routing_explicit_intent_still_works" time="0.210" /><testcase classname="tests.integration.orchestration.test_graph_routing" name="test_graph_routing_low_confidence_fails_gracefully" time="0.209" /><testcase classname="tests.integration.orchestration.test_graph_routing" name="test_graph_routing_multiple_intents_parallel_mode" time="0.211"><failure message="AssertionError: assert False is True&#10; +  where False = OrchestrationResult(ok=False, intent='unknown', sections=[ReportSection(title='Error Summary', body_md='**Status**: Fa...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).ok">registry_with_fake_agents = (&lt;src.qnwis.orchestration.registry.AgentRegistry object at 0x000001C140004810&gt;, &lt;tests.integration.orchestration.test_...000001C13EEA9A90&gt;, &lt;tests.integration.orchestration.test_graph_routing.FakeStrategyAgent object at 0x000001C140004410&gt;)

    def test_graph_routing_multiple_intents_parallel_mode(
        registry_with_fake_agents: tuple[AgentRegistry, FakePatternAgent, FakeStrategyAgent]
    ) -&gt; None:
        """Test parallel mode when multiple intents tie."""
        registry, pattern_agent, strategy_agent = registry_with_fake_agents
    
        config: dict[str, Any] = {"enabled_intents": list(registry.intents())}
        graph = create_graph(registry, config)
    
        # Query that matches both anomalies and correlations
        query = "Find outliers and relationships in Construction retention last 24 months"
        task = OrchestrationTask(query_text=query, params={})
    
        result = graph.run(task)
    
        # Should succeed (even if parallel mode not fully implemented, should execute primary)
&gt;       assert result.ok is True
E       AssertionError: assert False is True
E        +  where False = OrchestrationResult(ok=False, intent='unknown', sections=[ReportSection(title='Error Summary', body_md='**Status**: Fa...tats={}, verification={}, redactions_applied=0, issues_summary={}, audit_manifest=None, audit_id=None, confidence=None).ok

tests\integration\orchestration\test_graph_routing.py:478: AssertionError</failure></testcase><testcase classname="tests.integration.perf.test_mv_job.TestMVRefreshJob" name="test_job_loads_definitions_and_materializes" time="0.015" /><testcase classname="tests.integration.perf.test_mv_job.TestMVRefreshJob" name="test_job_uses_rendered_sql_from_registry" time="0.013" /><testcase classname="tests.integration.perf.test_mv_job.TestMVRefreshJob" name="test_job_creates_indexes_for_each_mv" time="0.013" /><testcase classname="tests.integration.perf.test_mv_job.TestMVRefreshJob" name="test_job_calls_refresh_concurrently" time="0.013" /><testcase classname="tests.integration.perf.test_mv_job.TestMVRefreshJob" name="test_job_validates_queries_exist_in_registry" time="0.013" /><testcase classname="tests.integration.perf.test_mv_job.TestMVRefreshJob" name="test_job_handles_empty_params" time="0.010" /><testcase classname="tests.integration.perf.test_mv_job.TestMVRefreshJob" name="test_job_output_json_format" time="0.013" /><testcase classname="tests.integration.perf.test_mv_job.TestMVRefreshJob" name="test_job_uses_materializer_correctly" time="0.013" /><testcase classname="tests.integration.perf.test_mv_job.TestMVRefreshJob" name="test_job_passes_params_to_render_select" time="0.013" /><testcase classname="tests.integration.perf.test_mv_job.TestMVRefreshJob" name="test_job_handles_single_mv" time="0.009" /><testcase classname="tests.integration.perf.test_mv_job.TestMVRefreshJob" name="test_job_handles_mv_with_no_indexes" time="0.018" /><testcase classname="tests.integration.perf.test_prefetch_cache_integration.TestPrefetchCacheIntegration" name="test_prefetch_writes_to_cache" time="0.005" /><testcase classname="tests.integration.perf.test_prefetch_cache_integration.TestPrefetchCacheIntegration" name="test_cached_client_reads_from_cache_after_prefetch" time="0.005" /><testcase classname="tests.integration.perf.test_prefetch_cache_integration.TestPrefetchCacheIntegration" name="test_prefetch_deduplicates_by_cache_key" time="0.005" /><testcase classname="tests.integration.perf.test_prefetch_cache_integration.TestPrefetchCacheIntegration" name="test_prefetch_timeout_raises_error" time="0.106" /><testcase classname="tests.integration.perf.test_prefetch_cache_integration.TestPrefetchCacheIntegration" name="test_prefetch_invalid_method_raises_error" time="0.005" /><testcase classname="tests.integration.perf.test_prefetch_cache_integration.TestPrefetchCacheIntegration" name="test_prefetch_handles_cache_write_failure_gracefully" time="0.005" /><testcase classname="tests.integration.perf.test_prefetch_cache_integration.TestPrefetchCacheIntegration" name="test_cached_client_falls_back_to_delegate_on_cache_miss" time="0.004" /><testcase classname="tests.integration.test_agents_graphs" name="test_graph_runs_with_deterministic_client" time="0.205" /><testcase classname="tests.integration.test_agents_graphs" name="test_graph_with_multiple_queries" time="0.011" /><testcase classname="tests.integration.test_agents_graphs" name="test_graph_with_empty_results" time="0.011" /><testcase classname="tests.integration.test_api_briefing" name="test_minister_briefing_endpoint" time="8.090"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error&#10;During task with name 'run' and id 'a9c1c8e3-62b9-4d24-1cce-64e33f8b98b8'">tmp_path = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_minister_briefing_endpoin0')
monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C13DC35810&gt;

    def test_minister_briefing_endpoint(tmp_path, monkeypatch):
        """Test POST /v1/briefing/minister endpoint returns complete briefing."""
        # Generate synthetic data
        with synthetic_catalog(Path(tmp_path)):
            monkeypatch.setenv("QNWIS_QUERIES_DIR", "src/qnwis/data/queries")
            c = TestClient(app)
&gt;           r = c.post("/v1/briefing/minister")
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_api_briefing.py:44: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
src\qnwis\utils\request_id.py:75: in __call__
    await self.app(scope, receive, send_wrapper)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:215: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\concurrency.py:38: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\to_thread.py:56: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:2470: in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:967: in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\briefing.py:46: in minister_briefing
    b = build_briefing(queries_dir=queries_dir, ttl_s=effective_ttl)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\briefing\minister.py:96: in build_briefing
    council_json = run_council(CouncilConfig(queries_dir=resolved_queries_dir, ttl_s=ttl_s))
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:273: in run_council
    final_state = graph_app.invoke(state)
                  ^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:3094: in invoke
    for chunk in self.stream(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:2679: in stream
    for _ in runner.tick(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_runner.py:167: in tick
    run_with_retry(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_retry.py:42: in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:656: in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:400: in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:182: in run_step
    state["reports"] = _run_agents(state["agents"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:86: in _run_agents
    reports.append(agent.run())
                   ^^^^^^^^^^^
src\qnwis\agents\nationalization.py:42: in run
    res = self.client.run(UNEMPLOY_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\agents\base.py:180: in run
    res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\access.py:41: in execute
    result = run_world_bank_query(spec)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

spec = QuerySpec(id='q_unemployment_rate_gcc_latest', title='Unemployment rate GCC comparison', description='Compare Qatar vs...ZS', 'countries': ['QAT', 'SAU', 'ARE', 'KWT', 'BHR', 'OMN']}, expected_unit='percent', constraints={}, postprocess=[])

    def run_world_bank_query(spec: QuerySpec) -&gt; QueryResult:
        """
        Execute a deterministic World Bank query via the shared API integrator.
    
        Required params:
            indicator (str): World Bank indicator code.
    
        Optional params:
            countries (Iterable[str]): ISO-3 country codes (default GCC set).
            year / start_year / end_year: Passed through to the API client.
            timeout_s (float): Maximum seconds per API request (default 30).
            max_rows (int): Maximum rows to include in the result set (default 10000).
        """
        params = spec.params or {}
        indicator = params.get("indicator")
        if not isinstance(indicator, str) or not indicator.strip():
            raise ValueError("World Bank query requires a non-empty 'indicator' parameter.")
        indicator_code = indicator.strip()
    
        countries = _validate_countries(params.get("countries"))
    
        # Default timeout_s to 30 if not provided
        timeout_s = 30.0
        if "timeout_s" in params:
            timeout_s = _validate_positive_number(params["timeout_s"], "timeout_s")
    
        # Default max_rows to 10000 if not provided
        max_rows = 10000
        if "max_rows" in params:
            max_rows = _validate_positive_int(params["max_rows"], "max_rows")
    
        if UDCGlobalDataIntegrator is None:
            raise ImportError(
                "World Bank connector requires 'data.apis.world_bank' module. "
                "Please install the required external dependency."
            )
    
        integ = UDCGlobalDataIntegrator()
        dataframe = integ.get_indicator(
            indicator=indicator_code,
            countries=countries,
            year=params.get("year"),
            start_year=params.get("start_year"),
            end_year=params.get("end_year"),
            timeout_s=timeout_s,
            max_rows=max_rows,
        )
    
        if dataframe.empty:
            raise ValueError(
                f"World Bank query returned no data for indicator '{indicator_code}' "
                f"with countries {countries}"
            )
    
        records = dataframe.to_dict(orient="records")
        rows: list[Row] = [Row(data=record) for record in records]
    
        return QueryResult(
            query_id=spec.id,
            rows=rows,
            unit=spec.expected_unit,
            provenance=Provenance(
                source="world_bank",
                dataset_id=indicator_code,
                locator=f"indicator={indicator_code}",
                fields=list(dataframe.columns),
                license=WORLD_BANK_LICENSE,
            ),
&gt;           freshness=Freshness(asof_date="api", updated_at=None),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error
E       During task with name 'run' and id 'a9c1c8e3-62b9-4d24-1cce-64e33f8b98b8'

src\qnwis\data\connectors\world_bank_det.py:125: ValidationError</failure></testcase><testcase classname="tests.integration.test_api_briefing" name="test_minister_briefing_response_structure" time="7.299"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error&#10;During task with name 'run' and id '6b607e89-3b82-c95f-0a91-4f9037a8f4fd'">tmp_path = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_minister_briefing_respons0')
monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C140DC1AD0&gt;

    def test_minister_briefing_response_structure(tmp_path, monkeypatch):
        """Test that briefing response has all required fields."""
        with synthetic_catalog(Path(tmp_path)):
            monkeypatch.setenv("QNWIS_QUERIES_DIR", "src/qnwis/data/queries")
            c = TestClient(app)
&gt;           r = c.post("/v1/briefing/minister")
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_api_briefing.py:56: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
src\qnwis\utils\request_id.py:75: in __call__
    await self.app(scope, receive, send_wrapper)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:215: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\concurrency.py:38: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\to_thread.py:56: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:2470: in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:967: in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\briefing.py:46: in minister_briefing
    b = build_briefing(queries_dir=queries_dir, ttl_s=effective_ttl)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\briefing\minister.py:96: in build_briefing
    council_json = run_council(CouncilConfig(queries_dir=resolved_queries_dir, ttl_s=ttl_s))
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:273: in run_council
    final_state = graph_app.invoke(state)
                  ^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:3094: in invoke
    for chunk in self.stream(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:2679: in stream
    for _ in runner.tick(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_runner.py:167: in tick
    run_with_retry(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_retry.py:42: in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:656: in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:400: in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:182: in run_step
    state["reports"] = _run_agents(state["agents"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:86: in _run_agents
    reports.append(agent.run())
                   ^^^^^^^^^^^
src\qnwis\agents\nationalization.py:42: in run
    res = self.client.run(UNEMPLOY_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\agents\base.py:180: in run
    res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\access.py:41: in execute
    result = run_world_bank_query(spec)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

spec = QuerySpec(id='q_unemployment_rate_gcc_latest', title='Unemployment rate GCC comparison', description='Compare Qatar vs...ZS', 'countries': ['QAT', 'SAU', 'ARE', 'KWT', 'BHR', 'OMN']}, expected_unit='percent', constraints={}, postprocess=[])

    def run_world_bank_query(spec: QuerySpec) -&gt; QueryResult:
        """
        Execute a deterministic World Bank query via the shared API integrator.
    
        Required params:
            indicator (str): World Bank indicator code.
    
        Optional params:
            countries (Iterable[str]): ISO-3 country codes (default GCC set).
            year / start_year / end_year: Passed through to the API client.
            timeout_s (float): Maximum seconds per API request (default 30).
            max_rows (int): Maximum rows to include in the result set (default 10000).
        """
        params = spec.params or {}
        indicator = params.get("indicator")
        if not isinstance(indicator, str) or not indicator.strip():
            raise ValueError("World Bank query requires a non-empty 'indicator' parameter.")
        indicator_code = indicator.strip()
    
        countries = _validate_countries(params.get("countries"))
    
        # Default timeout_s to 30 if not provided
        timeout_s = 30.0
        if "timeout_s" in params:
            timeout_s = _validate_positive_number(params["timeout_s"], "timeout_s")
    
        # Default max_rows to 10000 if not provided
        max_rows = 10000
        if "max_rows" in params:
            max_rows = _validate_positive_int(params["max_rows"], "max_rows")
    
        if UDCGlobalDataIntegrator is None:
            raise ImportError(
                "World Bank connector requires 'data.apis.world_bank' module. "
                "Please install the required external dependency."
            )
    
        integ = UDCGlobalDataIntegrator()
        dataframe = integ.get_indicator(
            indicator=indicator_code,
            countries=countries,
            year=params.get("year"),
            start_year=params.get("start_year"),
            end_year=params.get("end_year"),
            timeout_s=timeout_s,
            max_rows=max_rows,
        )
    
        if dataframe.empty:
            raise ValueError(
                f"World Bank query returned no data for indicator '{indicator_code}' "
                f"with countries {countries}"
            )
    
        records = dataframe.to_dict(orient="records")
        rows: list[Row] = [Row(data=record) for record in records]
    
        return QueryResult(
            query_id=spec.id,
            rows=rows,
            unit=spec.expected_unit,
            provenance=Provenance(
                source="world_bank",
                dataset_id=indicator_code,
                locator=f"indicator={indicator_code}",
                fields=list(dataframe.columns),
                license=WORLD_BANK_LICENSE,
            ),
&gt;           freshness=Freshness(asof_date="api", updated_at=None),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error
E       During task with name 'run' and id '6b607e89-3b82-c95f-0a91-4f9037a8f4fd'

src\qnwis\data\connectors\world_bank_det.py:125: ValidationError</failure></testcase><testcase classname="tests.integration.test_api_briefing" name="test_minister_briefing_with_custom_ttl" time="7.208"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error&#10;During task with name 'run' and id '00918e1b-9723-739d-aafe-098702eae635'">tmp_path = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_minister_briefing_with_cu0')
monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C140673ED0&gt;

    def test_minister_briefing_with_custom_ttl(tmp_path, monkeypatch):
        """Test that briefing endpoint accepts custom TTL parameter."""
        with synthetic_catalog(Path(tmp_path)):
            monkeypatch.setenv("QNWIS_QUERIES_DIR", "src/qnwis/data/queries")
            c = TestClient(app)
&gt;           r = c.post("/v1/briefing/minister?ttl_s=60")
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_api_briefing.py:86: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
src\qnwis\utils\request_id.py:75: in __call__
    await self.app(scope, receive, send_wrapper)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:215: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\concurrency.py:38: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\to_thread.py:56: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:2470: in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:967: in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\briefing.py:46: in minister_briefing
    b = build_briefing(queries_dir=queries_dir, ttl_s=effective_ttl)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\briefing\minister.py:96: in build_briefing
    council_json = run_council(CouncilConfig(queries_dir=resolved_queries_dir, ttl_s=ttl_s))
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:273: in run_council
    final_state = graph_app.invoke(state)
                  ^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:3094: in invoke
    for chunk in self.stream(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:2679: in stream
    for _ in runner.tick(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_runner.py:167: in tick
    run_with_retry(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_retry.py:42: in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:656: in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:400: in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:182: in run_step
    state["reports"] = _run_agents(state["agents"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:86: in _run_agents
    reports.append(agent.run())
                   ^^^^^^^^^^^
src\qnwis\agents\nationalization.py:42: in run
    res = self.client.run(UNEMPLOY_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\agents\base.py:180: in run
    res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\access.py:41: in execute
    result = run_world_bank_query(spec)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

spec = QuerySpec(id='q_unemployment_rate_gcc_latest', title='Unemployment rate GCC comparison', description='Compare Qatar vs...ZS', 'countries': ['QAT', 'SAU', 'ARE', 'KWT', 'BHR', 'OMN']}, expected_unit='percent', constraints={}, postprocess=[])

    def run_world_bank_query(spec: QuerySpec) -&gt; QueryResult:
        """
        Execute a deterministic World Bank query via the shared API integrator.
    
        Required params:
            indicator (str): World Bank indicator code.
    
        Optional params:
            countries (Iterable[str]): ISO-3 country codes (default GCC set).
            year / start_year / end_year: Passed through to the API client.
            timeout_s (float): Maximum seconds per API request (default 30).
            max_rows (int): Maximum rows to include in the result set (default 10000).
        """
        params = spec.params or {}
        indicator = params.get("indicator")
        if not isinstance(indicator, str) or not indicator.strip():
            raise ValueError("World Bank query requires a non-empty 'indicator' parameter.")
        indicator_code = indicator.strip()
    
        countries = _validate_countries(params.get("countries"))
    
        # Default timeout_s to 30 if not provided
        timeout_s = 30.0
        if "timeout_s" in params:
            timeout_s = _validate_positive_number(params["timeout_s"], "timeout_s")
    
        # Default max_rows to 10000 if not provided
        max_rows = 10000
        if "max_rows" in params:
            max_rows = _validate_positive_int(params["max_rows"], "max_rows")
    
        if UDCGlobalDataIntegrator is None:
            raise ImportError(
                "World Bank connector requires 'data.apis.world_bank' module. "
                "Please install the required external dependency."
            )
    
        integ = UDCGlobalDataIntegrator()
        dataframe = integ.get_indicator(
            indicator=indicator_code,
            countries=countries,
            year=params.get("year"),
            start_year=params.get("start_year"),
            end_year=params.get("end_year"),
            timeout_s=timeout_s,
            max_rows=max_rows,
        )
    
        if dataframe.empty:
            raise ValueError(
                f"World Bank query returned no data for indicator '{indicator_code}' "
                f"with countries {countries}"
            )
    
        records = dataframe.to_dict(orient="records")
        rows: list[Row] = [Row(data=record) for record in records]
    
        return QueryResult(
            query_id=spec.id,
            rows=rows,
            unit=spec.expected_unit,
            provenance=Provenance(
                source="world_bank",
                dataset_id=indicator_code,
                locator=f"indicator={indicator_code}",
                fields=list(dataframe.columns),
                license=WORLD_BANK_LICENSE,
            ),
&gt;           freshness=Freshness(asof_date="api", updated_at=None),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error
E       During task with name 'run' and id '00918e1b-9723-739d-aafe-098702eae635'

src\qnwis\data\connectors\world_bank_det.py:125: ValidationError</failure></testcase><testcase classname="tests.integration.test_api_briefing" name="test_minister_briefing_markdown_content" time="7.371"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error&#10;During task with name 'run' and id '829b1fbc-af9c-a217-4265-95f3124c3f79'">tmp_path = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_minister_briefing_markdow0')
monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C140FC3FD0&gt;

    def test_minister_briefing_markdown_content(tmp_path, monkeypatch):
        """Test that markdown contains expected content structure."""
        with synthetic_catalog(Path(tmp_path)):
            monkeypatch.setenv("QNWIS_QUERIES_DIR", "src/qnwis/data/queries")
            c = TestClient(app)
&gt;           r = c.post("/v1/briefing/minister")
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_api_briefing.py:97: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
src\qnwis\utils\request_id.py:75: in __call__
    await self.app(scope, receive, send_wrapper)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:215: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\concurrency.py:38: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\to_thread.py:56: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:2470: in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:967: in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\briefing.py:46: in minister_briefing
    b = build_briefing(queries_dir=queries_dir, ttl_s=effective_ttl)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\briefing\minister.py:96: in build_briefing
    council_json = run_council(CouncilConfig(queries_dir=resolved_queries_dir, ttl_s=ttl_s))
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:273: in run_council
    final_state = graph_app.invoke(state)
                  ^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:3094: in invoke
    for chunk in self.stream(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:2679: in stream
    for _ in runner.tick(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_runner.py:167: in tick
    run_with_retry(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_retry.py:42: in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:656: in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:400: in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:182: in run_step
    state["reports"] = _run_agents(state["agents"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:86: in _run_agents
    reports.append(agent.run())
                   ^^^^^^^^^^^
src\qnwis\agents\nationalization.py:42: in run
    res = self.client.run(UNEMPLOY_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\agents\base.py:180: in run
    res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\access.py:41: in execute
    result = run_world_bank_query(spec)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

spec = QuerySpec(id='q_unemployment_rate_gcc_latest', title='Unemployment rate GCC comparison', description='Compare Qatar vs...ZS', 'countries': ['QAT', 'SAU', 'ARE', 'KWT', 'BHR', 'OMN']}, expected_unit='percent', constraints={}, postprocess=[])

    def run_world_bank_query(spec: QuerySpec) -&gt; QueryResult:
        """
        Execute a deterministic World Bank query via the shared API integrator.
    
        Required params:
            indicator (str): World Bank indicator code.
    
        Optional params:
            countries (Iterable[str]): ISO-3 country codes (default GCC set).
            year / start_year / end_year: Passed through to the API client.
            timeout_s (float): Maximum seconds per API request (default 30).
            max_rows (int): Maximum rows to include in the result set (default 10000).
        """
        params = spec.params or {}
        indicator = params.get("indicator")
        if not isinstance(indicator, str) or not indicator.strip():
            raise ValueError("World Bank query requires a non-empty 'indicator' parameter.")
        indicator_code = indicator.strip()
    
        countries = _validate_countries(params.get("countries"))
    
        # Default timeout_s to 30 if not provided
        timeout_s = 30.0
        if "timeout_s" in params:
            timeout_s = _validate_positive_number(params["timeout_s"], "timeout_s")
    
        # Default max_rows to 10000 if not provided
        max_rows = 10000
        if "max_rows" in params:
            max_rows = _validate_positive_int(params["max_rows"], "max_rows")
    
        if UDCGlobalDataIntegrator is None:
            raise ImportError(
                "World Bank connector requires 'data.apis.world_bank' module. "
                "Please install the required external dependency."
            )
    
        integ = UDCGlobalDataIntegrator()
        dataframe = integ.get_indicator(
            indicator=indicator_code,
            countries=countries,
            year=params.get("year"),
            start_year=params.get("start_year"),
            end_year=params.get("end_year"),
            timeout_s=timeout_s,
            max_rows=max_rows,
        )
    
        if dataframe.empty:
            raise ValueError(
                f"World Bank query returned no data for indicator '{indicator_code}' "
                f"with countries {countries}"
            )
    
        records = dataframe.to_dict(orient="records")
        rows: list[Row] = [Row(data=record) for record in records]
    
        return QueryResult(
            query_id=spec.id,
            rows=rows,
            unit=spec.expected_unit,
            provenance=Provenance(
                source="world_bank",
                dataset_id=indicator_code,
                locator=f"indicator={indicator_code}",
                fields=list(dataframe.columns),
                license=WORLD_BANK_LICENSE,
            ),
&gt;           freshness=Freshness(asof_date="api", updated_at=None),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error
E       During task with name 'run' and id '829b1fbc-af9c-a217-4265-95f3124c3f79'

src\qnwis\data\connectors\world_bank_det.py:125: ValidationError</failure></testcase><testcase classname="tests.integration.test_api_briefing" name="test_minister_briefing_key_metrics_numeric" time="7.391"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error&#10;During task with name 'run' and id 'e85e8d51-146a-2a01-5447-9d2c77739391'">tmp_path = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_minister_briefing_key_met0')
monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C1409D0F90&gt;

    def test_minister_briefing_key_metrics_numeric(tmp_path, monkeypatch):
        """Test that key_metrics contains only numeric values."""
        with synthetic_catalog(Path(tmp_path)):
            monkeypatch.setenv("QNWIS_QUERIES_DIR", "src/qnwis/data/queries")
            c = TestClient(app)
&gt;           r = c.post("/v1/briefing/minister")
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_api_briefing.py:116: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
src\qnwis\utils\request_id.py:75: in __call__
    await self.app(scope, receive, send_wrapper)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:215: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\concurrency.py:38: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\to_thread.py:56: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:2470: in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:967: in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\briefing.py:46: in minister_briefing
    b = build_briefing(queries_dir=queries_dir, ttl_s=effective_ttl)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\briefing\minister.py:96: in build_briefing
    council_json = run_council(CouncilConfig(queries_dir=resolved_queries_dir, ttl_s=ttl_s))
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:273: in run_council
    final_state = graph_app.invoke(state)
                  ^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:3094: in invoke
    for chunk in self.stream(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:2679: in stream
    for _ in runner.tick(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_runner.py:167: in tick
    run_with_retry(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_retry.py:42: in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:656: in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:400: in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:182: in run_step
    state["reports"] = _run_agents(state["agents"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:86: in _run_agents
    reports.append(agent.run())
                   ^^^^^^^^^^^
src\qnwis\agents\nationalization.py:42: in run
    res = self.client.run(UNEMPLOY_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\agents\base.py:180: in run
    res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\access.py:41: in execute
    result = run_world_bank_query(spec)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

spec = QuerySpec(id='q_unemployment_rate_gcc_latest', title='Unemployment rate GCC comparison', description='Compare Qatar vs...ZS', 'countries': ['QAT', 'SAU', 'ARE', 'KWT', 'BHR', 'OMN']}, expected_unit='percent', constraints={}, postprocess=[])

    def run_world_bank_query(spec: QuerySpec) -&gt; QueryResult:
        """
        Execute a deterministic World Bank query via the shared API integrator.
    
        Required params:
            indicator (str): World Bank indicator code.
    
        Optional params:
            countries (Iterable[str]): ISO-3 country codes (default GCC set).
            year / start_year / end_year: Passed through to the API client.
            timeout_s (float): Maximum seconds per API request (default 30).
            max_rows (int): Maximum rows to include in the result set (default 10000).
        """
        params = spec.params or {}
        indicator = params.get("indicator")
        if not isinstance(indicator, str) or not indicator.strip():
            raise ValueError("World Bank query requires a non-empty 'indicator' parameter.")
        indicator_code = indicator.strip()
    
        countries = _validate_countries(params.get("countries"))
    
        # Default timeout_s to 30 if not provided
        timeout_s = 30.0
        if "timeout_s" in params:
            timeout_s = _validate_positive_number(params["timeout_s"], "timeout_s")
    
        # Default max_rows to 10000 if not provided
        max_rows = 10000
        if "max_rows" in params:
            max_rows = _validate_positive_int(params["max_rows"], "max_rows")
    
        if UDCGlobalDataIntegrator is None:
            raise ImportError(
                "World Bank connector requires 'data.apis.world_bank' module. "
                "Please install the required external dependency."
            )
    
        integ = UDCGlobalDataIntegrator()
        dataframe = integ.get_indicator(
            indicator=indicator_code,
            countries=countries,
            year=params.get("year"),
            start_year=params.get("start_year"),
            end_year=params.get("end_year"),
            timeout_s=timeout_s,
            max_rows=max_rows,
        )
    
        if dataframe.empty:
            raise ValueError(
                f"World Bank query returned no data for indicator '{indicator_code}' "
                f"with countries {countries}"
            )
    
        records = dataframe.to_dict(orient="records")
        rows: list[Row] = [Row(data=record) for record in records]
    
        return QueryResult(
            query_id=spec.id,
            rows=rows,
            unit=spec.expected_unit,
            provenance=Provenance(
                source="world_bank",
                dataset_id=indicator_code,
                locator=f"indicator={indicator_code}",
                fields=list(dataframe.columns),
                license=WORLD_BANK_LICENSE,
            ),
&gt;           freshness=Freshness(asof_date="api", updated_at=None),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error
E       During task with name 'run' and id 'e85e8d51-146a-2a01-5447-9d2c77739391'

src\qnwis\data\connectors\world_bank_det.py:125: ValidationError</failure></testcase><testcase classname="tests.integration.test_api_briefing" name="test_minister_briefing_deterministic" time="7.546"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error&#10;During task with name 'run' and id 'c3c9cbbb-f84d-c385-4e50-63bd194b8f1e'">tmp_path = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_minister_briefing_determi0')
monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C1405DD6D0&gt;

    def test_minister_briefing_deterministic(tmp_path, monkeypatch):
        """Test that briefing is deterministic (same data = same result)."""
        with synthetic_catalog(Path(tmp_path)):
            monkeypatch.setenv("QNWIS_QUERIES_DIR", "src/qnwis/data/queries")
            c = TestClient(app)
    
            # Call twice
&gt;           r1 = c.post("/v1/briefing/minister")
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_api_briefing.py:131: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
src\qnwis\utils\request_id.py:75: in __call__
    await self.app(scope, receive, send_wrapper)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:215: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\concurrency.py:38: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\to_thread.py:56: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:2470: in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:967: in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\briefing.py:46: in minister_briefing
    b = build_briefing(queries_dir=queries_dir, ttl_s=effective_ttl)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\briefing\minister.py:96: in build_briefing
    council_json = run_council(CouncilConfig(queries_dir=resolved_queries_dir, ttl_s=ttl_s))
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:273: in run_council
    final_state = graph_app.invoke(state)
                  ^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:3094: in invoke
    for chunk in self.stream(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:2679: in stream
    for _ in runner.tick(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_runner.py:167: in tick
    run_with_retry(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_retry.py:42: in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:656: in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:400: in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:182: in run_step
    state["reports"] = _run_agents(state["agents"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:86: in _run_agents
    reports.append(agent.run())
                   ^^^^^^^^^^^
src\qnwis\agents\nationalization.py:42: in run
    res = self.client.run(UNEMPLOY_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\agents\base.py:180: in run
    res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\access.py:41: in execute
    result = run_world_bank_query(spec)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

spec = QuerySpec(id='q_unemployment_rate_gcc_latest', title='Unemployment rate GCC comparison', description='Compare Qatar vs...ZS', 'countries': ['QAT', 'SAU', 'ARE', 'KWT', 'BHR', 'OMN']}, expected_unit='percent', constraints={}, postprocess=[])

    def run_world_bank_query(spec: QuerySpec) -&gt; QueryResult:
        """
        Execute a deterministic World Bank query via the shared API integrator.
    
        Required params:
            indicator (str): World Bank indicator code.
    
        Optional params:
            countries (Iterable[str]): ISO-3 country codes (default GCC set).
            year / start_year / end_year: Passed through to the API client.
            timeout_s (float): Maximum seconds per API request (default 30).
            max_rows (int): Maximum rows to include in the result set (default 10000).
        """
        params = spec.params or {}
        indicator = params.get("indicator")
        if not isinstance(indicator, str) or not indicator.strip():
            raise ValueError("World Bank query requires a non-empty 'indicator' parameter.")
        indicator_code = indicator.strip()
    
        countries = _validate_countries(params.get("countries"))
    
        # Default timeout_s to 30 if not provided
        timeout_s = 30.0
        if "timeout_s" in params:
            timeout_s = _validate_positive_number(params["timeout_s"], "timeout_s")
    
        # Default max_rows to 10000 if not provided
        max_rows = 10000
        if "max_rows" in params:
            max_rows = _validate_positive_int(params["max_rows"], "max_rows")
    
        if UDCGlobalDataIntegrator is None:
            raise ImportError(
                "World Bank connector requires 'data.apis.world_bank' module. "
                "Please install the required external dependency."
            )
    
        integ = UDCGlobalDataIntegrator()
        dataframe = integ.get_indicator(
            indicator=indicator_code,
            countries=countries,
            year=params.get("year"),
            start_year=params.get("start_year"),
            end_year=params.get("end_year"),
            timeout_s=timeout_s,
            max_rows=max_rows,
        )
    
        if dataframe.empty:
            raise ValueError(
                f"World Bank query returned no data for indicator '{indicator_code}' "
                f"with countries {countries}"
            )
    
        records = dataframe.to_dict(orient="records")
        rows: list[Row] = [Row(data=record) for record in records]
    
        return QueryResult(
            query_id=spec.id,
            rows=rows,
            unit=spec.expected_unit,
            provenance=Provenance(
                source="world_bank",
                dataset_id=indicator_code,
                locator=f"indicator={indicator_code}",
                fields=list(dataframe.columns),
                license=WORLD_BANK_LICENSE,
            ),
&gt;           freshness=Freshness(asof_date="api", updated_at=None),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error
E       During task with name 'run' and id 'c3c9cbbb-f84d-c385-4e50-63bd194b8f1e'

src\qnwis\data\connectors\world_bank_det.py:125: ValidationError</failure></testcase><testcase classname="tests.integration.test_api_briefing" name="test_minister_briefing_ttl_clamped" time="0.013" /><testcase classname="tests.integration.test_api_council" name="test_council_endpoint_exists" time="0.209" /><testcase classname="tests.integration.test_api_council" name="test_council_endpoint_returns_json" time="0.208" /><testcase classname="tests.integration.test_api_council" name="test_council_endpoint_structure" time="0.209" /><testcase classname="tests.integration.test_api_council" name="test_council_endpoint_with_params" time="0.208" /><testcase classname="tests.integration.test_api_council" name="test_council_endpoint_agents_present" time="0.209" /><testcase classname="tests.integration.test_api_council" name="test_council_endpoint_findings_format" time="0.209" /><testcase classname="tests.integration.test_api_council" name="test_council_endpoint_verification_format" time="0.210" /><testcase classname="tests.integration.test_api_council" name="test_council_endpoint_consensus" time="0.209" /><testcase classname="tests.integration.test_api_council" name="test_council_endpoint_warnings" time="0.209" /><testcase classname="tests.integration.test_api_council" name="test_council_endpoint_idempotent" time="0.417" /><testcase classname="tests.integration.test_api_council" name="test_council_endpoint_post_method_only" time="0.015" /><testcase classname="tests.integration.test_api_council" name="test_council_endpoint_with_queries_dir" time="0.021" /><testcase classname="tests.integration.test_api_council" name="test_council_endpoint_tags" time="0.044" /><testcase classname="tests.integration.test_api_queries" name="test_list_queries" time="0.026" /><testcase classname="tests.integration.test_api_queries" name="test_list_queries_empty" time="0.009" /><testcase classname="tests.integration.test_api_queries" name="test_run_query_basic" time="0.034" /><testcase classname="tests.integration.test_api_queries" name="test_run_query_with_ttl" time="0.022" /><testcase classname="tests.integration.test_api_queries" name="test_run_query_with_param_overrides" time="0.023" /><testcase classname="tests.integration.test_api_queries" name="test_run_query_overrides_do_not_mutate_registry" time="0.033" /><testcase classname="tests.integration.test_api_queries" name="test_run_query_ttl_bounds" time="0.053" /><testcase classname="tests.integration.test_api_queries" name="test_run_query_invalid_override_type" time="0.015" /><testcase classname="tests.integration.test_api_queries" name="test_run_query_whitelisted_params" time="0.037" /><testcase classname="tests.integration.test_api_queries" name="test_run_query_unknown_id" time="0.015" /><testcase classname="tests.integration.test_api_queries" name="test_run_query_normalized_rows" time="0.022" /><testcase classname="tests.integration.test_api_queries" name="test_run_query_provenance_and_freshness" time="0.021" /><testcase classname="tests.integration.test_api_queries" name="test_get_query_spec" time="0.015" /><testcase classname="tests.integration.test_api_queries" name="test_get_query_spec_unknown" time="0.015" /><testcase classname="tests.integration.test_api_queries" name="test_run_query_no_sum_to_one_warnings" time="0.022" /><testcase classname="tests.integration.test_api_queries" name="test_invalidate_cache" time="0.031" /><testcase classname="tests.integration.test_api_queries" name="test_invalidate_cache_unknown_query" time="0.016" /><testcase classname="tests.integration.test_api_queries" name="test_request_id_header" time="0.022" /><testcase classname="tests.integration.test_api_queries" name="test_health_endpoints" time="0.010" /><testcase classname="tests.integration.test_api_queries" name="test_queries_dir_fallback" time="0.200" /><testcase classname="tests.integration.test_api_ui_cards" name="test_ui_cards_top_sectors" time="2.325" /><testcase classname="tests.integration.test_api_ui_cards" name="test_ui_cards_ewi" time="2.330" /><testcase classname="tests.integration.test_api_ui_cards" name="test_ui_cards_parameter_validation" time="1.927" /><testcase classname="tests.integration.test_api_ui_charts" name="test_ui_chart_salary_yoy" time="1.930" /><testcase classname="tests.integration.test_api_ui_charts" name="test_ui_chart_sector_employment" time="2.343" /><testcase classname="tests.integration.test_api_ui_charts" name="test_ui_chart_employment_share" time="2.106" /><testcase classname="tests.integration.test_api_ui_charts" name="test_ui_charts_ttl_clamping" time="1.930" /><testcase classname="tests.integration.test_api_ui_dashboard" name="test_dashboard_and_exports" time="3.291" /><testcase classname="tests.integration.test_api_ui_dashboard" name="test_dashboard_with_params" time="2.066" /><testcase classname="tests.integration.test_api_ui_dashboard" name="test_export_etags" time="3.188" /><testcase classname="tests.integration.test_api_ui_dashboard" name="test_dashboard_etag_short_circuit" time="3.371" /><testcase classname="tests.integration.test_api_ui_dashboard" name="test_export_deterministic" time="2.288" /><testcase classname="tests.integration.test_api_ui_dashboard" name="test_csv_export_validation" time="1.745" /><testcase classname="tests.integration.test_api_ui_dashboard" name="test_png_export_validation" time="1.877" /><testcase classname="tests.integration.test_api_ui_dashboard" name="test_top_sectors_csv_with_n" time="1.929" /><testcase classname="tests.integration.test_api_ui_dashboard" name="test_dashboard_default_year" time="2.058" /><testcase classname="tests.integration.test_api_ui_export" name="test_export_csv_top_sectors" time="1.729" /><testcase classname="tests.integration.test_api_ui_export" name="test_export_csv_ewi" time="1.721" /><testcase classname="tests.integration.test_api_ui_export" name="test_export_csv_sector_employment" time="1.709" /><testcase classname="tests.integration.test_api_ui_export" name="test_export_csv_salary_yoy" time="1.722" /><testcase classname="tests.integration.test_api_ui_export" name="test_export_csv_employment_share" time="1.716" /><testcase classname="tests.integration.test_api_ui_export" name="test_export_csv_etag_short_circuit" time="1.919" /><testcase classname="tests.integration.test_api_ui_export" name="test_export_svg_sector_employment" time="1.712" /><testcase classname="tests.integration.test_api_ui_export" name="test_export_svg_etag_short_circuit" time="1.918" /><testcase classname="tests.integration.test_api_ui_export" name="test_export_svg_salary_yoy" time="1.705" /><testcase classname="tests.integration.test_api_ui_export" name="test_export_csv_ttl_validation" time="1.711" /><testcase classname="tests.integration.test_api_ui_export" name="test_export_svg_deterministic" time="1.906" /><testcase classname="tests.integration.test_api_ui_export" name="test_export_png_disabled_by_default" time="1.506" /><testcase classname="tests.integration.test_api_ui_export" name="test_export_png_enabled" time="1.744" /><testcase classname="tests.integration.test_api_ui_export" name="test_csv_export_invalid_resource" time="1.502" /><testcase classname="tests.integration.test_api_ui_export" name="test_svg_export_invalid_chart" time="1.506" /><testcase classname="tests.integration.test_audit_log" name="test_file_audit_log" time="0.015" /><testcase classname="tests.integration.test_council_end_to_end" name="test_council_run_on_synthetic" time="1.707"><failure message="FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv&#10;During task with name 'run' and id '285f1e19-2364-97c5-9dd5-b81535acddc9'">synthetic_data_env = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_council_run_on_synthetic0')

    def test_council_run_on_synthetic(synthetic_data_env):
        """Test council endpoint with real synthetic data."""
        client = TestClient(app)
&gt;       response = client.post("/v1/council/run", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_council_end_to_end.py:40: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
src\qnwis\utils\request_id.py:75: in __call__
    await self.app(scope, receive, send_wrapper)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:215: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\concurrency.py:38: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\to_thread.py:56: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:2470: in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:967: in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\council.py:37: in council_run
    return run_council(cfg)
           ^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:273: in run_council
    final_state = graph_app.invoke(state)
                  ^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:3094: in invoke
    for chunk in self.stream(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:2679: in stream
    for _ in runner.tick(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_runner.py:167: in tick
    run_with_retry(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_retry.py:42: in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:656: in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:400: in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:182: in run_step
    state["reports"] = _run_agents(state["agents"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:86: in _run_agents
    reports.append(agent.run())
                   ^^^^^^^^^^^
src\qnwis\agents\labour_economist.py:40: in run
    res = self.client.run(EMPLOYMENT_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\agents\base.py:180: in run
    res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\access.py:39: in execute
    result = run_csv_query(spec)
             ^^^^^^^^^^^^^^^^^^^
src\qnwis\data\connectors\csv_catalog.py:157: in run_csv_query
    file_path = _resolve_latest_csv(parsed.pattern)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

pattern = 'employed-persons-15-years-and-above*.csv'

    def _resolve_latest_csv(pattern: str) -&gt; Path:
        if not BASE.exists():
            raise FileNotFoundError(f"CSV catalog directory missing: {BASE}")
        files = sorted(BASE.glob(pattern))
        if not files:
&gt;           raise FileNotFoundError(f"No CSV matches: {pattern}")
E           FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv
E           During task with name 'run' and id '285f1e19-2364-97c5-9dd5-b81535acddc9'

src\qnwis\data\connectors\csv_catalog.py:118: FileNotFoundError</failure></testcase><testcase classname="tests.integration.test_council_end_to_end" name="test_council_findings_structure" time="1.705"><failure message="FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv&#10;During task with name 'run' and id '7b57bc9f-cc07-27d7-6113-8880c6e00e5e'">synthetic_data_env = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_council_findings_structur0')

    def test_council_findings_structure(synthetic_data_env):
        """Test that findings have complete structure."""
        client = TestClient(app)
&gt;       response = client.post("/v1/council/run", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_council_end_to_end.py:82: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
src\qnwis\utils\request_id.py:75: in __call__
    await self.app(scope, receive, send_wrapper)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:215: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\concurrency.py:38: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\to_thread.py:56: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:2470: in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:967: in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\council.py:37: in council_run
    return run_council(cfg)
           ^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:273: in run_council
    final_state = graph_app.invoke(state)
                  ^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:3094: in invoke
    for chunk in self.stream(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:2679: in stream
    for _ in runner.tick(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_runner.py:167: in tick
    run_with_retry(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_retry.py:42: in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:656: in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:400: in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:182: in run_step
    state["reports"] = _run_agents(state["agents"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:86: in _run_agents
    reports.append(agent.run())
                   ^^^^^^^^^^^
src\qnwis\agents\labour_economist.py:40: in run
    res = self.client.run(EMPLOYMENT_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\agents\base.py:180: in run
    res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\access.py:39: in execute
    result = run_csv_query(spec)
             ^^^^^^^^^^^^^^^^^^^
src\qnwis\data\connectors\csv_catalog.py:157: in run_csv_query
    file_path = _resolve_latest_csv(parsed.pattern)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

pattern = 'employed-persons-15-years-and-above*.csv'

    def _resolve_latest_csv(pattern: str) -&gt; Path:
        if not BASE.exists():
            raise FileNotFoundError(f"CSV catalog directory missing: {BASE}")
        files = sorted(BASE.glob(pattern))
        if not files:
&gt;           raise FileNotFoundError(f"No CSV matches: {pattern}")
E           FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv
E           During task with name 'run' and id '7b57bc9f-cc07-27d7-6113-8880c6e00e5e'

src\qnwis\data\connectors\csv_catalog.py:118: FileNotFoundError</failure></testcase><testcase classname="tests.integration.test_council_end_to_end" name="test_council_consensus_numeric" time="1.706"><failure message="FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv&#10;During task with name 'run' and id '0accc50c-48b7-3ede-e6d4-2538ee3c3829'">synthetic_data_env = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_council_consensus_numeric0')

    def test_council_consensus_numeric(synthetic_data_env):
        """Test that consensus contains numeric values."""
        client = TestClient(app)
&gt;       response = client.post("/v1/council/run", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_council_end_to_end.py:117: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
src\qnwis\utils\request_id.py:75: in __call__
    await self.app(scope, receive, send_wrapper)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:215: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\concurrency.py:38: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\to_thread.py:56: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:2470: in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:967: in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\council.py:37: in council_run
    return run_council(cfg)
           ^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:273: in run_council
    final_state = graph_app.invoke(state)
                  ^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:3094: in invoke
    for chunk in self.stream(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:2679: in stream
    for _ in runner.tick(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_runner.py:167: in tick
    run_with_retry(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_retry.py:42: in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:656: in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:400: in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:182: in run_step
    state["reports"] = _run_agents(state["agents"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:86: in _run_agents
    reports.append(agent.run())
                   ^^^^^^^^^^^
src\qnwis\agents\labour_economist.py:40: in run
    res = self.client.run(EMPLOYMENT_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\agents\base.py:180: in run
    res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\access.py:39: in execute
    result = run_csv_query(spec)
             ^^^^^^^^^^^^^^^^^^^
src\qnwis\data\connectors\csv_catalog.py:157: in run_csv_query
    file_path = _resolve_latest_csv(parsed.pattern)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

pattern = 'employed-persons-15-years-and-above*.csv'

    def _resolve_latest_csv(pattern: str) -&gt; Path:
        if not BASE.exists():
            raise FileNotFoundError(f"CSV catalog directory missing: {BASE}")
        files = sorted(BASE.glob(pattern))
        if not files:
&gt;           raise FileNotFoundError(f"No CSV matches: {pattern}")
E           FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv
E           During task with name 'run' and id '0accc50c-48b7-3ede-e6d4-2538ee3c3829'

src\qnwis\data\connectors\csv_catalog.py:118: FileNotFoundError</failure></testcase><testcase classname="tests.integration.test_council_end_to_end" name="test_council_verification_format" time="1.695"><failure message="FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv&#10;During task with name 'run' and id '305c8d23-048a-5c31-e174-bd3a8a073021'">synthetic_data_env = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_council_verification_form0')

    def test_council_verification_format(synthetic_data_env):
        """Test verification output format."""
        client = TestClient(app)
&gt;       response = client.post("/v1/council/run", json={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_council_end_to_end.py:130: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
src\qnwis\utils\request_id.py:75: in __call__
    await self.app(scope, receive, send_wrapper)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:215: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\concurrency.py:38: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\to_thread.py:56: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:2470: in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:967: in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\council.py:37: in council_run
    return run_council(cfg)
           ^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:273: in run_council
    final_state = graph_app.invoke(state)
                  ^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:3094: in invoke
    for chunk in self.stream(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:2679: in stream
    for _ in runner.tick(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_runner.py:167: in tick
    run_with_retry(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_retry.py:42: in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:656: in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:400: in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:182: in run_step
    state["reports"] = _run_agents(state["agents"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:86: in _run_agents
    reports.append(agent.run())
                   ^^^^^^^^^^^
src\qnwis\agents\labour_economist.py:40: in run
    res = self.client.run(EMPLOYMENT_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\agents\base.py:180: in run
    res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\access.py:39: in execute
    result = run_csv_query(spec)
             ^^^^^^^^^^^^^^^^^^^
src\qnwis\data\connectors\csv_catalog.py:157: in run_csv_query
    file_path = _resolve_latest_csv(parsed.pattern)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

pattern = 'employed-persons-15-years-and-above*.csv'

    def _resolve_latest_csv(pattern: str) -&gt; Path:
        if not BASE.exists():
            raise FileNotFoundError(f"CSV catalog directory missing: {BASE}")
        files = sorted(BASE.glob(pattern))
        if not files:
&gt;           raise FileNotFoundError(f"No CSV matches: {pattern}")
E           FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv
E           During task with name 'run' and id '305c8d23-048a-5c31-e174-bd3a8a073021'

src\qnwis\data\connectors\csv_catalog.py:118: FileNotFoundError</failure></testcase><testcase classname="tests.integration.test_council_end_to_end" name="test_council_deterministic" time="1.697"><failure message="FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv&#10;During task with name 'run' and id '9d788daa-8a32-ef81-49cc-21b33fc77855'">synthetic_data_env = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_council_deterministic0')

    def test_council_deterministic(synthetic_data_env):
        """Test that council produces identical results on repeated runs."""
        client = TestClient(app)
    
&gt;       response1 = client.post("/v1/council/run", json={})
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\test_council_end_to_end.py:148: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
src\qnwis\utils\request_id.py:75: in __call__
    await self.app(scope, receive, send_wrapper)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:215: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\concurrency.py:38: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\to_thread.py:56: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:2470: in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py:967: in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\council.py:37: in council_run
    return run_council(cfg)
           ^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:273: in run_council
    final_state = graph_app.invoke(state)
                  ^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:3094: in invoke
    for chunk in self.stream(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:2679: in stream
    for _ in runner.tick(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_runner.py:167: in tick
    run_with_retry(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_retry.py:42: in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:656: in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:400: in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:182: in run_step
    state["reports"] = _run_agents(state["agents"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:86: in _run_agents
    reports.append(agent.run())
                   ^^^^^^^^^^^
src\qnwis\agents\labour_economist.py:40: in run
    res = self.client.run(EMPLOYMENT_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\agents\base.py:180: in run
    res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\access.py:39: in execute
    result = run_csv_query(spec)
             ^^^^^^^^^^^^^^^^^^^
src\qnwis\data\connectors\csv_catalog.py:157: in run_csv_query
    file_path = _resolve_latest_csv(parsed.pattern)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

pattern = 'employed-persons-15-years-and-above*.csv'

    def _resolve_latest_csv(pattern: str) -&gt; Path:
        if not BASE.exists():
            raise FileNotFoundError(f"CSV catalog directory missing: {BASE}")
        files = sorted(BASE.glob(pattern))
        if not files:
&gt;           raise FileNotFoundError(f"No CSV matches: {pattern}")
E           FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv
E           During task with name 'run' and id '9d788daa-8a32-ef81-49cc-21b33fc77855'

src\qnwis\data\connectors\csv_catalog.py:118: FileNotFoundError</failure></testcase><testcase classname="tests.integration.test_dashboard_static" name="test_static_dashboard_served" time="0.063" /><testcase classname="tests.integration.test_dashboard_static" name="test_dashboard_has_expected_structure" time="0.013" /><testcase classname="tests.integration.test_dashboard_static" name="test_dashboard_has_export_links" time="0.013" /><testcase classname="tests.integration.test_dashboard_static" name="test_dashboard_has_inline_css" time="0.015" /><testcase classname="tests.integration.test_dashboard_static" name="test_dashboard_has_js" time="0.014" /><testcase classname="tests.integration.test_dashboard_static" name="test_static_css_missing" time="0.008" /><testcase classname="tests.integration.test_dashboard_static" name="test_static_js_served" time="0.029" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestEndToEndDataAPI" name="test_data_api_end_to_end" time="1.745" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestEndToEndDataAPI" name="test_all_employment_methods" time="1.703" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestEndToEndDataAPI" name="test_all_unemployment_methods" time="1.695" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestEndToEndDataAPI" name="test_all_qatarization_methods" time="1.697" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestEndToEndDataAPI" name="test_all_salary_methods" time="1.719" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestEndToEndDataAPI" name="test_all_attrition_methods" time="1.721" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestEndToEndDataAPI" name="test_all_company_size_methods" time="1.724" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestEndToEndDataAPI" name="test_all_sector_employment_methods" time="1.720" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestEndToEndDataAPI" name="test_all_early_warning_methods" time="1.721" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestEndToEndDataAPI" name="test_all_analytics_methods" time="1.730" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestParameterOverrides" name="test_year_overrides_work_consistently" time="1.709" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestDataConsistency" name="test_employment_totals_consistency" time="1.711" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestDataConsistency" name="test_qatarization_consistency" time="1.718" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestErrorHandling" name="test_nonexistent_query_raises_error" time="1.681" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestErrorHandling" name="test_future_year_returns_empty_gracefully" time="1.705" /><testcase classname="tests.integration.test_data_api_on_synthetic.TestErrorHandling" name="test_invalid_sector_in_yoy_returns_empty" time="1.714" /><testcase classname="tests.integration.test_orchestration_workflow" name="test_workflow_execution_success" time="0.020" /><testcase classname="tests.integration.test_orchestration_workflow" name="test_workflow_unknown_intent" time="0.017" /><testcase classname="tests.integration.test_orchestration_workflow" name="test_workflow_with_params" time="0.019" /><testcase classname="tests.integration.test_orchestration_workflow" name="test_workflow_with_request_tracking" time="0.019" /><testcase classname="tests.integration.test_orchestration_workflow" name="test_workflow_state_transitions" time="0.019" /><testcase classname="tests.integration.test_orchestration_workflow" name="test_full_workflow_with_real_agents" time="0.252"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask&#10;intent&#10;  Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='pattern.driver_screen', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/literal_error">@pytest.mark.integration
    def test_full_workflow_with_real_agents():
        """Test workflow with real agents (requires data layer)."""
        # Skip if data layer not available
        try:
            from src.qnwis.orchestration.registry import create_default_registry
    
            client = DataClient()
            registry = create_default_registry(client)
        except Exception:
            pytest.skip("Data layer not available")
    
        graph = create_graph(registry)
    
        # Try each registered intent
        for intent in registry.intents():
&gt;           task = OrchestrationTask(intent=intent, params={})
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E           pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask
E           intent
E             Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='pattern.driver_screen', input_type=str]
E               For further information visit https://errors.pydantic.dev/2.11/v/literal_error

tests\integration\test_orchestration_workflow.py:171: ValidationError</failure></testcase><testcase classname="tests.integration.test_queries_with_transforms" name="test_top5_sector_employment_latest" time="1.689" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_sector_employment_energy_yoy" time="0.009" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_sector_employment_finance_yoy" time="0.009" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_rolling3_energy" time="0.009" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_rolling3_finance" time="0.009" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_salary_latest_top5" time="0.008" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_salary_yoy_ict" time="0.009" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_attrition_hotspots_latest" time="0.008" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_qatarization_gap_latest" time="0.008" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_qatarization_energy_time_series" time="0.008" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_company_sizes_latest_top5" time="0.008" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_gcc_unemployment_rank" time="0.007" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_employment_share_latest_renamed" time="0.007" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_employment_share_bounds_check" time="0.007" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_ewi_hotlist_latest" time="0.008" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_sector_employment_2019_vs_2024" time="0.009" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_salary_2019_vs_2024_ict" time="0.009" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_attrition_rolling3_healthcare" time="0.009" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_qatarization_energy_share_of_total" time="0.007" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_qatarization_sorted_latest" time="0.007" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_cache_key_includes_postprocess" time="0.014" /><testcase classname="tests.integration.test_queries_with_transforms" name="test_multiple_transforms_execute_in_order" time="0.007" /><testcase classname="tests.integration.test_routing_samples.TestRoutingSamples" name="test_all_samples_classify" time="0.214" /><testcase classname="tests.integration.test_routing_samples.TestRoutingSamples" name="test_intent_matching" time="0.171" /><testcase classname="tests.integration.test_routing_samples.TestRoutingSamples" name="test_complexity_reasonable" time="0.172" /><testcase classname="tests.integration.test_routing_samples.TestRoutingSamples" name="test_entity_extraction_sectors" time="0.161" /><testcase classname="tests.integration.test_routing_samples.TestRoutingSamples" name="test_entity_extraction_metrics" time="0.169" /><testcase classname="tests.integration.test_routing_samples.TestRoutingSamples" name="test_crisis_detection" time="0.147" /><testcase classname="tests.integration.test_routing_samples.TestRoutingSamples" name="test_simple_queries" time="0.149" /><testcase classname="tests.integration.test_routing_samples.TestRoutingSamples" name="test_confidence_scores" time="0.171"><failure message="AssertionError: Only 21/46 samples had confidence &gt;= 0.4&#10;assert 0.45652173913043476 &gt;= 0.5">self = &lt;tests.integration.test_routing_samples.TestRoutingSamples object at 0x000001C13CE38910&gt;
classifier = &lt;src.qnwis.orchestration.classifier.QueryClassifier object at 0x000001C13DC28150&gt;
routing_samples = [{'complexity': 'medium', 'entities': {'metrics': ['retention'], 'sectors': ['Construction'], 'time_horizon': {'type':..., 'expected_intents': ['pattern.root_causes'], 'query': 'Root causes of high turnover in Finance and Healthcare'}, ...]

    def test_confidence_scores(self, classifier: QueryClassifier, routing_samples: list[dict]) -&gt; None:
        """Test that confidence scores are reasonable."""
        high_confidence_count = 0
    
        for sample in routing_samples:
            query = sample["query"]
    
            # Skip samples with no expected intents
            if not sample["expected_intents"]:
                continue
    
            result = classifier.classify_text(query)
    
            # Samples with clear intents should have decent confidence
            if result.confidence &gt;= 0.4:
                high_confidence_count += 1
    
        # Most samples with expected intents should have reasonable confidence
        # Note: Keyword-based matching won't be perfect, 50% is reasonable
        samples_with_intents = len([s for s in routing_samples if s["expected_intents"]])
        confidence_rate = high_confidence_count / samples_with_intents if samples_with_intents &gt; 0 else 0
    
&gt;       assert confidence_rate &gt;= 0.50, \
            f"Only {high_confidence_count}/{samples_with_intents} samples had confidence &gt;= 0.4"
E       AssertionError: Only 21/46 samples had confidence &gt;= 0.4
E       assert 0.45652173913043476 &gt;= 0.5

tests\integration\test_routing_samples.py:198: AssertionError</failure></testcase><testcase classname="tests.integration.test_routing_samples.TestSpecificSamples" name="test_anomaly_simple" time="0.144" /><testcase classname="tests.integration.test_routing_samples.TestSpecificSamples" name="test_correlation_query" time="0.146" /><testcase classname="tests.integration.test_routing_samples.TestSpecificSamples" name="test_urgent_crisis" time="0.146" /><testcase classname="tests.integration.test_routing_samples.TestSpecificSamples" name="test_multi_sector_complex" time="0.145" /><testcase classname="tests.integration.test_routing_samples.TestSpecificSamples" name="test_gcc_benchmark" time="0.146" /><testcase classname="tests.integration.test_routing_samples.TestSpecificSamples" name="test_vision2030" time="0.146" /><testcase classname="tests.integration.test_synthetic_seed_and_queries" name="test_seed_and_execute_queries" time="1.712" /><testcase classname="tests.integration.test_synthetic_seed_and_queries" name="test_all_synthetic_queries_executable" time="1.743" /><testcase classname="tests.integration.test_synthetic_seed_and_queries" name="test_query_results_have_expected_fields" time="1.704" /><testcase classname="tests.integration.test_synthetic_seed_and_queries" name="test_synthetic_data_determinism" time="3.073" /><testcase classname="tests.integration.verification.test_audit_integration.TestAuditIntegration" name="test_audit_manifest_exists_in_state" time="0.003" /><testcase classname="tests.integration.verification.test_audit_integration.TestAuditIntegration" name="test_audit_pack_written_and_verified" time="0.022" /><testcase classname="tests.integration.verification.test_audit_integration.TestAuditIntegration" name="test_final_formatted_report_contains_audit_summary" time="0.012" /><testcase classname="tests.integration.verification.test_audit_integration.TestAuditIntegration" name="test_minimal_orchestration_with_mocked_results" time="0.023" /><testcase classname="tests.integration.verification.test_citation_integration.TestCitationEnforcementIntegration" name="test_valid_citations_pass_verification" time="0.002" /><testcase classname="tests.integration.verification.test_citation_integration.TestCitationEnforcementIntegration" name="test_uncited_claims_fail_verification" time="0.002" /><testcase classname="tests.integration.verification.test_citation_integration.TestCitationEnforcementIntegration" name="test_missing_qid_fails_verification" time="0.002" /><testcase classname="tests.integration.verification.test_citation_integration.TestCitationEnforcementIntegration" name="test_multiple_sources" time="0.003" /><testcase classname="tests.integration.verification.test_citation_integration.TestCitationEnforcementIntegration" name="test_unknown_source_fails" time="0.002" /><testcase classname="tests.integration.verification.test_citation_integration.TestCitationEnforcementIntegration" name="test_citation_issues_convert_to_verification_issues" time="0.002" /><testcase classname="tests.integration.verification.test_citation_integration.TestCitationEnforcementIntegration" name="test_no_citation_rules_skips_enforcement" time="0.001" /><testcase classname="tests.integration.verification.test_citation_integration.TestCitationEnforcementIntegration" name="test_years_ignored" time="0.002" /><testcase classname="tests.integration.verification.test_citation_integration.TestCitationEnforcementIntegration" name="test_citation_with_layers_2_4" time="0.002" /><testcase classname="tests.integration.verification.test_citation_integration.TestCitationEnforcementIntegration" name="test_empty_narrative" time="0.002" /><testcase classname="tests.integration.verification.test_citation_integration.TestCitationEnforcementIntegration" name="test_no_query_results" time="0.001" /><testcase classname="tests.integration.verification.test_confidence_integration.TestConfidenceInWorkflow" name="test_perfect_verification_green_confidence" time="0.001"><error message="failed on setup with &quot;TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'&quot;">@pytest.fixture
    def agent_report_perfect() -&gt; AgentReport:
        """Perfect agent report with all citations and evidence."""
        return AgentReport(
            agent="test_agent",
            findings=[
&gt;               Insight(
                    title="Healthcare Retention Analysis",
                    summary=(
                        "The retention rate for Healthcare is 85% according to LMIS (QID:Q001). "
                        "Cross-validated with GCC-STAT at 84% (QID:Q002)."
                    ),
                    metrics={"retention_rate": 0.85},
                    evidence=[
                        Evidence(
                            query_id="Q001",
                            dataset_id="LMIS",
                            locator="test/data.csv",
                            fields=["retention_rate"],
                            freshness_as_of="2025-11-01T00:00:00Z",
                        ),
                        Evidence(
                            query_id="Q002",
                            dataset_id="GCC-STAT",
                            locator="test/ref.csv",
                            fields=["retention_rate"],
                            freshness_as_of="2025-11-01T00:00:00Z",
                        ),
                    ],
                    confidence_score=1.0,
                )
            ],
            warnings=[],
        )
E       TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'

tests\integration\verification\test_confidence_integration.py:57: TypeError</error></testcase><testcase classname="tests.integration.verification.test_confidence_integration.TestConfidenceInWorkflow" name="test_minor_issues_amber_confidence" time="0.001"><error message="failed on setup with &quot;TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'&quot;">@pytest.fixture
    def agent_report_minor_issues() -&gt; AgentReport:
        """Agent report with minor issues (some uncited claims)."""
        return AgentReport(
            agent="test_agent",
            findings=[
&gt;               Insight(
                    title="Sector Analysis",
                    summary=(
                        "Retention rates vary significantly. Healthcare shows 85% "
                        "according to LMIS (QID:Q001). Manufacturing has seen improvements to 78%. "
                        "Some PII data like john.doe@example.com was detected."
                    ),
                    metrics={"retention_healthcare": 0.85, "retention_manufacturing": 0.78},
                    evidence=[
                        Evidence(
                            query_id="Q001",
                            dataset_id="LMIS",
                            locator="test/data.csv",
                            fields=["retention_rate"],
                            freshness_as_of="2025-10-25T00:00:00Z",  # Slightly older
                        ),
                    ],
                    confidence_score=0.9,
                )
            ],
            warnings=["Missing citation for manufacturing retention rate"],
        )
E       TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'

tests\integration\verification\test_confidence_integration.py:93: TypeError</error></testcase><testcase classname="tests.integration.verification.test_confidence_integration.TestConfidenceInWorkflow" name="test_major_issues_red_confidence" time="0.001"><error message="failed on setup with &quot;TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'&quot;">@pytest.fixture
    def agent_report_major_issues() -&gt; AgentReport:
        """Agent report with major issues (many uncited claims, errors)."""
        return AgentReport(
            agent="test_agent",
            findings=[
&gt;               Insight(
                    title="Problematic Report",
                    summary=(
                        "The sector shows declining trends. Multiple metrics like 45%, 67%, "
                        "and 89% indicate variations. Email addresses like test@example.com "
                        "and IDs like 1234567890123 appeared in raw data. "
                        "According to Unknown Source, the rate is 55%."
                    ),
                    metrics={"rate1": 0.45, "rate2": 0.67, "rate3": 0.89},
                    evidence=[],  # No evidence provided
                    confidence_score=0.3,
                )
            ],
            warnings=["No evidence citations", "Unknown data source", "PII detected"],
        )
E       TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'

tests\integration\verification\test_confidence_integration.py:123: TypeError</error></testcase><testcase classname="tests.integration.verification.test_confidence_integration.TestConfidenceInWorkflow" name="test_verification_error_with_confidence_for_audit" time="0.001"><error message="failed on setup with &quot;TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'&quot;">@pytest.fixture
    def agent_report_major_issues() -&gt; AgentReport:
        """Agent report with major issues (many uncited claims, errors)."""
        return AgentReport(
            agent="test_agent",
            findings=[
&gt;               Insight(
                    title="Problematic Report",
                    summary=(
                        "The sector shows declining trends. Multiple metrics like 45%, 67%, "
                        "and 89% indicate variations. Email addresses like test@example.com "
                        "and IDs like 1234567890123 appeared in raw data. "
                        "According to Unknown Source, the rate is 55%."
                    ),
                    metrics={"rate1": 0.45, "rate2": 0.67, "rate3": 0.89},
                    evidence=[],  # No evidence provided
                    confidence_score=0.3,
                )
            ],
            warnings=["No evidence citations", "Unknown data source", "PII detected"],
        )
E       TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'

tests\integration\verification\test_confidence_integration.py:123: TypeError</error></testcase><testcase classname="tests.integration.verification.test_confidence_integration.TestConfidenceSection" name="test_confidence_section_structure" time="0.001"><error message="failed on setup with &quot;TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'&quot;">@pytest.fixture
    def agent_report_perfect() -&gt; AgentReport:
        """Perfect agent report with all citations and evidence."""
        return AgentReport(
            agent="test_agent",
            findings=[
&gt;               Insight(
                    title="Healthcare Retention Analysis",
                    summary=(
                        "The retention rate for Healthcare is 85% according to LMIS (QID:Q001). "
                        "Cross-validated with GCC-STAT at 84% (QID:Q002)."
                    ),
                    metrics={"retention_rate": 0.85},
                    evidence=[
                        Evidence(
                            query_id="Q001",
                            dataset_id="LMIS",
                            locator="test/data.csv",
                            fields=["retention_rate"],
                            freshness_as_of="2025-11-01T00:00:00Z",
                        ),
                        Evidence(
                            query_id="Q002",
                            dataset_id="GCC-STAT",
                            locator="test/ref.csv",
                            fields=["retention_rate"],
                            freshness_as_of="2025-11-01T00:00:00Z",
                        ),
                    ],
                    confidence_score=1.0,
                )
            ],
            warnings=[],
        )
E       TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'

tests\integration\verification\test_confidence_integration.py:57: TypeError</error></testcase><testcase classname="tests.integration.verification.test_confidence_integration.TestConfidenceSection" name="test_confidence_dashboard_payload_structure" time="0.001"><error message="failed on setup with &quot;TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'&quot;">@pytest.fixture
    def agent_report_perfect() -&gt; AgentReport:
        """Perfect agent report with all citations and evidence."""
        return AgentReport(
            agent="test_agent",
            findings=[
&gt;               Insight(
                    title="Healthcare Retention Analysis",
                    summary=(
                        "The retention rate for Healthcare is 85% according to LMIS (QID:Q001). "
                        "Cross-validated with GCC-STAT at 84% (QID:Q002)."
                    ),
                    metrics={"retention_rate": 0.85},
                    evidence=[
                        Evidence(
                            query_id="Q001",
                            dataset_id="LMIS",
                            locator="test/data.csv",
                            fields=["retention_rate"],
                            freshness_as_of="2025-11-01T00:00:00Z",
                        ),
                        Evidence(
                            query_id="Q002",
                            dataset_id="GCC-STAT",
                            locator="test/ref.csv",
                            fields=["retention_rate"],
                            freshness_as_of="2025-11-01T00:00:00Z",
                        ),
                    ],
                    confidence_score=1.0,
                )
            ],
            warnings=[],
        )
E       TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'

tests\integration\verification\test_confidence_integration.py:57: TypeError</error></testcase><testcase classname="tests.integration.verification.test_confidence_integration.TestConfidenceComponents" name="test_citation_component_reflected" time="0.001"><error message="failed on setup with &quot;TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'&quot;">@pytest.fixture
    def agent_report_perfect() -&gt; AgentReport:
        """Perfect agent report with all citations and evidence."""
        return AgentReport(
            agent="test_agent",
            findings=[
&gt;               Insight(
                    title="Healthcare Retention Analysis",
                    summary=(
                        "The retention rate for Healthcare is 85% according to LMIS (QID:Q001). "
                        "Cross-validated with GCC-STAT at 84% (QID:Q002)."
                    ),
                    metrics={"retention_rate": 0.85},
                    evidence=[
                        Evidence(
                            query_id="Q001",
                            dataset_id="LMIS",
                            locator="test/data.csv",
                            fields=["retention_rate"],
                            freshness_as_of="2025-11-01T00:00:00Z",
                        ),
                        Evidence(
                            query_id="Q002",
                            dataset_id="GCC-STAT",
                            locator="test/ref.csv",
                            fields=["retention_rate"],
                            freshness_as_of="2025-11-01T00:00:00Z",
                        ),
                    ],
                    confidence_score=1.0,
                )
            ],
            warnings=[],
        )
E       TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'

tests\integration\verification\test_confidence_integration.py:57: TypeError</error></testcase><testcase classname="tests.integration.verification.test_confidence_integration.TestConfidenceComponents" name="test_privacy_component_penalized_on_redactions" time="0.001"><error message="failed on setup with &quot;TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'&quot;">@pytest.fixture
    def agent_report_minor_issues() -&gt; AgentReport:
        """Agent report with minor issues (some uncited claims)."""
        return AgentReport(
            agent="test_agent",
            findings=[
&gt;               Insight(
                    title="Sector Analysis",
                    summary=(
                        "Retention rates vary significantly. Healthcare shows 85% "
                        "according to LMIS (QID:Q001). Manufacturing has seen improvements to 78%. "
                        "Some PII data like john.doe@example.com was detected."
                    ),
                    metrics={"retention_healthcare": 0.85, "retention_manufacturing": 0.78},
                    evidence=[
                        Evidence(
                            query_id="Q001",
                            dataset_id="LMIS",
                            locator="test/data.csv",
                            fields=["retention_rate"],
                            freshness_as_of="2025-10-25T00:00:00Z",  # Slightly older
                        ),
                    ],
                    confidence_score=0.9,
                )
            ],
            warnings=["Missing citation for manufacturing retention rate"],
        )
E       TypeError: Insight.__init__() got an unexpected keyword argument 'confidence_score'

tests\integration\verification\test_confidence_integration.py:93: TypeError</error></testcase><testcase classname="tests.system.test_api_readiness" name="test_health_and_metrics" time="4.044" /><testcase classname="tests.system.test_api_readiness" name="test_router_smoke" time="4.054"><failure message="TypeError: build_response() got an unexpected keyword argument 'principal'">+ Exception Group Traceback (most recent call last):
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\tests\system\test_api_readiness.py", line 12, in test_router_smoke
    |     baseline = api_client.post(
    |                ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 108, in baseline
    |     return _run_agent(request, "baseline_report", params=_prepare_request(payload))
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 70, in _run_agent
    |     return build_response(
    |            ^^^^^^^^^^^^^^^
    | TypeError: build_response() got an unexpected keyword argument 'principal'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\lmis_int\tests\system\test_api_readiness.py", line 12, in test_router_smoke
    baseline = api_client.post(
               ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 108, in baseline
    return _run_agent(request, "baseline_report", params=_prepare_request(payload))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 70, in _run_agent
    return build_response(
           ^^^^^^^^^^^^^^^
TypeError: build_response() got an unexpected keyword argument 'principal'

During handling of the above exception, another exception occurred:

api_client = &lt;starlette.testclient.TestClient object at 0x000001C13FADB6D0&gt;
analyst_headers = {'X-API-Key': 'integration-key'}

    def test_router_smoke(api_client, analyst_headers):
&gt;       baseline = api_client.post(
            "/api/v1/agents/time/baseline",
            json={"intent": "time.baseline", "params": {"metric": "retention"}},
            headers=analyst_headers,
        )

tests\system\test_api_readiness.py:12: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:178: in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:99: in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\agents_time.py:108: in baseline
    return _run_agent(request, "baseline_report", params=_prepare_request(payload))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

request = &lt;starlette.requests.Request object at 0x000001C143355610&gt;
agent_fn = 'baseline_report'

    def _run_agent(
        request: Request,
        agent_fn: str,
        *,
        params: dict[str, Any],
    ) -&gt; AgentResponse:
        clock = get_clock(request)
        started = clock.time()
        agent_started = clock.time()
    
        client = get_data_client(request)
        agent = TimeMachineAgent(client)
    
        metric = params["metric"]
        try:
            narrative = getattr(agent, agent_fn)(
                metric=metric,
                sector=params.get("sector"),
                start=params.get("start"),
                end=params.get("end"),
            )
        except ValueError as exc:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc)) from exc
        except Exception as exc:  # pragma: no cover - unexpected agent bug
            raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(exc)) from exc
    
        agent_finished = clock.time()
        series_qid = agent.series_map.get(metric)
        if not series_qid:
            raise HTTPException(status_code=400, detail=f"Unknown metric '{metric}'")
        source_result = client.run(series_qid)
    
        principal: Principal = request.state.principal
        request_model: AgentRequest = request.state.agent_request
        request_id = getattr(request.state, "request_id", str(uuid.uuid4()))
&gt;       return build_response(
            request_model=request_model,
            request_id=request_id,
            principal=principal,
            payload={
                "intent": request_model.intent,
                "narrative": narrative,
            },
            sources=[source_result],
            started_ts=started,
            agent_started_ts=agent_started,
            agent_finished_ts=agent_finished,
            clock=clock,
        )
E       TypeError: build_response() got an unexpected keyword argument 'principal'

src\qnwis\api\routers\agents_time.py:70: TypeError</failure></testcase><testcase classname="tests.system.test_api_readiness" name="test_deterministic_time_machine" time="4.055"><failure message="TypeError: build_response() got an unexpected keyword argument 'principal'">+ Exception Group Traceback (most recent call last):
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 77, in collapse_excgroups
  |     yield
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 183, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 246, in &lt;lambda&gt;
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\tests\system\test_api_readiness.py", line 63, in test_deterministic_time_machine
    |     first = api_client.post("/api/v1/agents/time/baseline", json=payload, headers=analyst_headers).json()
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    |     raise app_exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 108, in baseline
    |     return _run_agent(request, "baseline_report", params=_prepare_request(payload))
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 70, in _run_agent
    |     return build_response(
    |            ^^^^^^^^^^^^^^^
    | TypeError: build_response() got an unexpected keyword argument 'principal'
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\lmis_int\tests\system\test_api_readiness.py", line 63, in test_deterministic_time_machine
    first = api_client.post("/api/v1/agents/time/baseline", json=payload, headers=analyst_headers).json()
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 552, in post
    return super().post(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1144, in post
    return self.request(
           ^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 451, in request
    return super().request(
           ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 354, in handle_request
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py", line 351, in handle_request
    portal.call(self.app, scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 456, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Program Files\Python311\Lib\concurrent\futures\_base.py", line 401, in __get_result
    raise self._exception
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 186, in __call__
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 178, in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 182, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Program Files\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py", line 83, in collapse_excgroups
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 184, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\server.py", line 99, in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 159, in call_next
    raise app_exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 78, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py", line 75, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 302, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 108, in baseline
    return _run_agent(request, "baseline_report", params=_prepare_request(payload))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\lmis_int\src\qnwis\api\routers\agents_time.py", line 70, in _run_agent
    return build_response(
           ^^^^^^^^^^^^^^^
TypeError: build_response() got an unexpected keyword argument 'principal'

During handling of the above exception, another exception occurred:

api_client = &lt;starlette.testclient.TestClient object at 0x000001C14065FE50&gt;
analyst_headers = {'X-API-Key': 'integration-key'}

    def test_deterministic_time_machine(api_client, analyst_headers):
        payload = {"intent": "time.baseline", "params": {"metric": "retention"}}
&gt;       first = api_client.post("/api/v1/agents/time/baseline", json=payload, headers=analyst_headers).json()
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\system\test_api_readiness.py:63: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:552: in post
    return super().post(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:451: in request
    return super().request(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:354: in handle_request
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\testclient.py:351: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Program Files\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:178: in auth_middleware
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:182: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Program Files\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_utils.py:83: in collapse_excgroups
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:184: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\server.py:99: in context_middleware
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:159: in call_next
    raise app_exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\fastapi\routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\api\routers\agents_time.py:108: in baseline
    return _run_agent(request, "baseline_report", params=_prepare_request(payload))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

request = &lt;starlette.requests.Request object at 0x000001C140632390&gt;
agent_fn = 'baseline_report'

    def _run_agent(
        request: Request,
        agent_fn: str,
        *,
        params: dict[str, Any],
    ) -&gt; AgentResponse:
        clock = get_clock(request)
        started = clock.time()
        agent_started = clock.time()
    
        client = get_data_client(request)
        agent = TimeMachineAgent(client)
    
        metric = params["metric"]
        try:
            narrative = getattr(agent, agent_fn)(
                metric=metric,
                sector=params.get("sector"),
                start=params.get("start"),
                end=params.get("end"),
            )
        except ValueError as exc:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(exc)) from exc
        except Exception as exc:  # pragma: no cover - unexpected agent bug
            raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=str(exc)) from exc
    
        agent_finished = clock.time()
        series_qid = agent.series_map.get(metric)
        if not series_qid:
            raise HTTPException(status_code=400, detail=f"Unknown metric '{metric}'")
        source_result = client.run(series_qid)
    
        principal: Principal = request.state.principal
        request_model: AgentRequest = request.state.agent_request
        request_id = getattr(request.state, "request_id", str(uuid.uuid4()))
&gt;       return build_response(
            request_model=request_model,
            request_id=request_id,
            principal=principal,
            payload={
                "intent": request_model.intent,
                "narrative": narrative,
            },
            sources=[source_result],
            started_ts=started,
            agent_started_ts=agent_started,
            agent_finished_ts=agent_finished,
            clock=clock,
        )
E       TypeError: build_response() got an unexpected keyword argument 'principal'

src\qnwis\api\routers\agents_time.py:70: TypeError</failure></testcase><testcase classname="tests.test_environment" name="test_python_version" time="0.001" /><testcase classname="tests.test_environment" name="test_package_structure" time="0.001" /><testcase classname="tests.test_environment" name="test_imports" time="0.366" /><testcase classname="tests.test_environment" name="test_config_settings" time="0.013" /><testcase classname="tests.unit.agents.test_national_strategy" name="test_gcc_benchmark_with_and_without_connectors" time="0.002" /><testcase classname="tests.unit.agents.test_national_strategy" name="test_talent_competition_includes_all_citations" time="0.002" /><testcase classname="tests.unit.agents.test_national_strategy" name="test_vision2030_alignment_targets_and_gaps" time="0.002" /><testcase classname="tests.unit.agents.test_national_strategy" name="test_gcc_benchmark_insufficient_countries" time="0.001" /><testcase classname="tests.unit.agents.test_national_strategy" name="test_talent_competition_empty_data" time="0.001" /><testcase classname="tests.unit.agents.test_national_strategy" name="test_vision2030_empty_employment_data" time="0.001" /><testcase classname="tests.unit.agents.test_national_strategy" name="test_vision2030_on_track_scenario" time="0.001" /><testcase classname="tests.unit.agents.test_pattern_detective" name="test_detect_anomalous_retention_flags_expected" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_detective" name="test_find_correlations_returns_expected_coef" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_detective" name="test_identify_root_causes_small_n_graceful" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_detective" name="test_best_practices_topn_sorted_and_truncated" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_detective" name="test_detect_anomalous_retention_insufficient_data" time="0.001" /><testcase classname="tests.unit.agents.test_pattern_detective" name="test_find_correlations_zero_variance_fallback" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_miner.TestPatternMinerAgentInit" name="test_initialization" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_miner.TestStableRelations" name="test_invalid_window" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_miner.TestStableRelations" name="test_valid_windows" time="0.005" /><testcase classname="tests.unit.agents.test_pattern_miner.TestStableRelations" name="test_default_end_date" time="0.003" /><testcase classname="tests.unit.agents.test_pattern_miner.TestStableRelations" name="test_narrative_structure" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_miner.TestStableRelations" name="test_includes_query_ids" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_miner.TestStableRelations" name="test_method_parameter" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_miner.TestStableRelations" name="test_confidence_hint_included" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_miner.TestStableRelations" name="test_missing_driver_warning_displayed" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_miner.TestSeasonalEffects" name="test_default_end_date" time="0.003" /><testcase classname="tests.unit.agents.test_pattern_miner.TestSeasonalEffects" name="test_narrative_structure" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_miner.TestSeasonalEffects" name="test_includes_query_ids" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_miner.TestSeasonalEffects" name="test_sector_parameter" time="0.003" /><testcase classname="tests.unit.agents.test_pattern_miner.TestSeasonalEffects" name="test_confidence_hint_included" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_miner.TestDriverScreen" name="test_invalid_windows_filtered" time="0.008" /><testcase classname="tests.unit.agents.test_pattern_miner.TestDriverScreen" name="test_all_invalid_windows_error" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_miner.TestDriverScreen" name="test_narrative_structure" time="0.010" /><testcase classname="tests.unit.agents.test_pattern_miner.TestDriverScreen" name="test_includes_query_ids" time="0.002" /><testcase classname="tests.unit.agents.test_pattern_miner.TestDriverScreen" name="test_multiple_cohorts_and_windows" time="0.017" /><testcase classname="tests.unit.agents.test_pattern_miner.TestDriverScreen" name="test_confidence_hint_in_driver_screen" time="0.008" /><testcase classname="tests.unit.agents.test_pattern_miner.TestNarrativeFormatting" name="test_classify_strength_strong" time="0.001" /><testcase classname="tests.unit.agents.test_pattern_miner.TestNarrativeFormatting" name="test_classify_strength_moderate" time="0.001" /><testcase classname="tests.unit.agents.test_pattern_miner.TestNarrativeFormatting" name="test_classify_strength_weak" time="0.001" /><testcase classname="tests.unit.agents.test_pattern_miner.TestNarrativeFormatting" name="test_classify_strength_boundaries" time="0.001" /><testcase classname="tests.unit.agents.test_pattern_miner.TestErrorHandling" name="test_stable_relations_handles_exceptions" time="0.001"><skipped type="pytest.skip" message="Current implementation doesn't have reachable error paths">d:\lmis_int\tests\unit\agents\test_pattern_miner.py:467: Current implementation doesn't have reachable error paths</skipped></testcase><testcase classname="tests.unit.agents.test_pattern_miner.TestErrorHandling" name="test_seasonal_effects_handles_exceptions" time="0.034" /><testcase classname="tests.unit.agents.test_pattern_miner.TestErrorHandling" name="test_driver_screen_handles_exceptions" time="0.000"><skipped type="pytest.skip" message="Current implementation doesn't have reachable error paths">d:\lmis_int\tests\unit\agents\test_pattern_miner.py:490: Current implementation doesn't have reachable error paths</skipped></testcase><testcase classname="tests.unit.agents.test_pattern_miner.TestDerivedResultWrapping" name="test_stable_relations_creates_derived_result" time="0.003" /><testcase classname="tests.unit.agents.test_pattern_miner.TestDerivedResultWrapping" name="test_seasonal_effects_creates_derived_result" time="0.003" /><testcase classname="tests.unit.agents.test_pattern_miner.TestDerivedResultWrapping" name="test_driver_screen_creates_derived_result" time="0.003" /><testcase classname="tests.unit.agents.test_scenario_agent.TestScenarioAgentInit" name="test_basic_initialization" time="0.001" /><testcase classname="tests.unit.agents.test_scenario_agent.TestScenarioAgentInit" name="test_rejects_non_data_client" time="0.001" /><testcase classname="tests.unit.agents.test_scenario_agent.TestApplyMethod" name="test_apply_basic_yaml_spec" time="0.005" /><testcase classname="tests.unit.agents.test_scenario_agent.TestApplyMethod" name="test_apply_with_baseline_override" time="0.002" /><testcase classname="tests.unit.agents.test_scenario_agent.TestApplyMethod" name="test_apply_invalid_metric" time="0.017" /><testcase classname="tests.unit.agents.test_scenario_agent.TestApplyMethod" name="test_apply_missing_baseline" time="0.017" /><testcase classname="tests.unit.agents.test_scenario_agent.TestCompareMethod" name="test_compare_multiple_scenarios" time="0.008" /><testcase classname="tests.unit.agents.test_scenario_agent.TestCompareMethod" name="test_compare_inconsistent_metrics" time="0.006" /><testcase classname="tests.unit.agents.test_scenario_agent.TestCompareMethod" name="test_compare_inconsistent_horizons" time="0.006" /><testcase classname="tests.unit.agents.test_scenario_agent.TestBatchMethod" name="test_batch_multiple_sectors" time="0.008" /><testcase classname="tests.unit.agents.test_scenario_agent.TestBatchMethod" name="test_batch_with_weights" time="0.003" /><testcase classname="tests.unit.agents.test_scenario_agent.TestBatchMethod" name="test_batch_inconsistent_metrics" time="0.002" /><testcase classname="tests.unit.agents.test_scenario_agent.TestBatchMethod" name="test_batch_no_sectors" time="0.001" /><testcase classname="tests.unit.agents.test_scenario_agent.TestValidation" name="test_validate_metric_whitelisting" time="0.001" /><testcase classname="tests.unit.agents.test_time_machine.TestTimeMachineAgentInit" name="test_basic_initialization" time="0.001" /><testcase classname="tests.unit.agents.test_time_machine.TestTimeMachineAgentInit" name="test_custom_series_map" time="0.001" /><testcase classname="tests.unit.agents.test_time_machine.TestBaselineReport" name="test_baseline_report_basic" time="0.003" /><testcase classname="tests.unit.agents.test_time_machine.TestBaselineReport" name="test_baseline_report_with_sector" time="0.002" /><testcase classname="tests.unit.agents.test_time_machine.TestBaselineReport" name="test_baseline_report_insufficient_data" time="0.002" /><testcase classname="tests.unit.agents.test_time_machine.TestBaselineReport" name="test_baseline_report_sector_fallback" time="0.003" /><testcase classname="tests.unit.agents.test_time_machine.TestBaselineReport" name="test_baseline_report_invalid_metric" time="0.001" /><testcase classname="tests.unit.agents.test_time_machine.TestBaselineReport" name="test_baseline_report_default_dates" time="0.003" /><testcase classname="tests.unit.agents.test_time_machine.TestTrendReport" name="test_trend_report_basic" time="0.002" /><testcase classname="tests.unit.agents.test_time_machine.TestTrendReport" name="test_trend_report_includes_slopes" time="0.002" /><testcase classname="tests.unit.agents.test_time_machine.TestTrendReport" name="test_trend_report_insufficient_data" time="0.002" /><testcase classname="tests.unit.agents.test_time_machine.TestTrendReport" name="test_trend_report_confidence_hint" time="0.002" /><testcase classname="tests.unit.agents.test_time_machine.TestBreaksReport" name="test_breaks_report_basic" time="0.003" /><testcase classname="tests.unit.agents.test_time_machine.TestBreaksReport" name="test_breaks_report_custom_thresholds" time="0.002" /><testcase classname="tests.unit.agents.test_time_machine.TestBreaksReport" name="test_breaks_report_insufficient_data" time="0.002" /><testcase classname="tests.unit.agents.test_time_machine.TestFetchSeries" name="test_fetch_series_basic" time="0.002" /><testcase classname="tests.unit.agents.test_time_machine.TestFetchSeries" name="test_fetch_series_date_filtering" time="0.002" /><testcase classname="tests.unit.agents.test_time_machine.TestFetchSeries" name="test_fetch_series_invalid_metric" time="0.001" /><testcase classname="tests.unit.agents.test_time_machine.TestFetchSeries" name="test_fetch_series_no_data" time="0.001" /><testcase classname="tests.unit.agents.test_time_machine.TestEdgeCases" name="test_empty_series_map" time="0.001" /><testcase classname="tests.unit.agents.test_time_machine.TestEdgeCases" name="test_report_methods_return_strings" time="0.005" /><testcase classname="tests.unit.agents.test_time_machine.TestEdgeCases" name="test_reports_include_citations" time="0.005" /><testcase classname="tests.unit.analysis.test_baselines.TestSeasonalBaseline" name="test_basic_12_month_pattern" time="0.002" /><testcase classname="tests.unit.analysis.test_baselines.TestSeasonalBaseline" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestSeasonalBaseline" name="test_perfect_seasonal_pattern" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestSeasonalBaseline" name="test_band_computation" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestSeasonalBaseline" name="test_zero_variance_series" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestAnomalyGaps" name="test_basic_gaps" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestAnomalyGaps" name="test_zero_baseline" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestAnomalyGaps" name="test_mismatched_lengths" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestAnomalyGaps" name="test_negative_values" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestDetectSeasonalAnomalies" name="test_detects_clear_anomaly" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestDetectSeasonalAnomalies" name="test_no_anomalies_perfect_pattern" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestDetectSeasonalAnomalies" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestDetectSeasonalAnomalies" name="test_threshold_sensitivity" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestTrendAdjustedBaseline" name="test_basic_trend_adjustment" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestTrendAdjustedBaseline" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestTrendAdjustedBaseline" name="test_no_trend" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestSummarizeBaselineFit" name="test_perfect_fit" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestSummarizeBaselineFit" name="test_basic_fit" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestSummarizeBaselineFit" name="test_mismatched_lengths" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestSummarizeBaselineFit" name="test_zero_baseline_handling" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestSummarizeBaselineFit" name="test_constant_series" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestSummarizeBaselineFit" name="test_empty_series" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestEdgeCases" name="test_all_zeros" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestEdgeCases" name="test_negative_values" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestEdgeCases" name="test_large_seasonal_period" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestEdgeCases" name="test_seasonal_period_equals_length" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestEdgeCases" name="test_integration_baseline_then_gaps" time="0.001" /><testcase classname="tests.unit.analysis.test_baselines.TestEdgeCases" name="test_integration_baseline_then_anomalies" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestCUSUMBreaks" name="test_detects_mean_shift" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestCUSUMBreaks" name="test_no_breaks_constant_series" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestCUSUMBreaks" name="test_sensitivity_with_h_threshold" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestCUSUMBreaks" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestCUSUMBreaks" name="test_zero_std_series" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestCUSUMBreaks" name="test_multiple_breaks" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestZScoreOutliers" name="test_detects_single_outlier" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestZScoreOutliers" name="test_no_outliers_normal_series" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestZScoreOutliers" name="test_threshold_sensitivity" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestZScoreOutliers" name="test_constant_series" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestZScoreOutliers" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestZScoreOutliers" name="test_multiple_outliers" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestSummarizeBreaks" name="test_basic_summary" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestSummarizeBreaks" name="test_no_breaks" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestSummarizeBreaks" name="test_max_jump_calculation" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestSummarizeBreaks" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestSummarizeBreaks" name="test_zero_handling" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestRollingVarianceBreaks" name="test_detects_volatility_change" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestRollingVarianceBreaks" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestRollingVarianceBreaks" name="test_constant_series" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestEdgeCases" name="test_all_same_values" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestEdgeCases" name="test_negative_values" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestEdgeCases" name="test_mixed_signs" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestEdgeCases" name="test_very_small_values" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestEdgeCases" name="test_large_values" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestEdgeCases" name="test_single_outlier_dominates" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestEdgeCases" name="test_gradual_drift" time="0.001" /><testcase classname="tests.unit.analysis.test_change_points.TestEdgeCases" name="test_empty_series" time="0.001" /><testcase classname="tests.unit.analysis.test_time_machine_perf" name="test_time_machine_core_math_under_50ms" time="0.002" /><testcase classname="tests.unit.analysis.test_trend_utils.TestPctChange" name="test_basic_increase" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestPctChange" name="test_basic_decrease" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestPctChange" name="test_zero_prev" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestPctChange" name="test_negative_prev" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestPctChange" name="test_zero_curr" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestPctChange" name="test_both_zero" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestYoY" name="test_basic_12_month" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestYoY" name="test_short_series" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestYoY" name="test_custom_period" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestYoY" name="test_zero_handling" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestQtQ" name="test_basic_3_month" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestQtQ" name="test_decline" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestEWMA" name="test_constant_series" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestEWMA" name="test_step_change" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestEWMA" name="test_invalid_alpha" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestEWMA" name="test_empty_series" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestIndex100" name="test_basic_indexing" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestIndex100" name="test_zero_base" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestIndex100" name="test_invalid_base_idx" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestIndex100" name="test_empty_series" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestWindowSlopes" name="test_linear_increase" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestWindowSlopes" name="test_multiple_windows" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestWindowSlopes" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestWindowSlopes" name="test_constant_series" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestSafeMean" name="test_basic_mean" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestSafeMean" name="test_empty_list" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestSafeMean" name="test_single_value" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestSafeStd" name="test_basic_std" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestSafeStd" name="test_empty_list" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestSafeStd" name="test_single_value" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestSafeStd" name="test_constant_series" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestSafeMAD" name="test_basic_mad" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestSafeMAD" name="test_empty_list" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestSafeMAD" name="test_constant_series" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestSafeMAD" name="test_outlier_resistance" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestEdgeCases" name="test_all_zeros" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestEdgeCases" name="test_negative_values" time="0.001" /><testcase classname="tests.unit.analysis.test_trend_utils.TestEdgeCases" name="test_mixed_signs" time="0.001" /><testcase classname="tests.unit.api.test_auth" name="test_decode_jwt_valid" time="0.002" /><testcase classname="tests.unit.api.test_auth" name="test_decode_jwt_expired" time="0.001" /><testcase classname="tests.unit.api.test_auth" name="test_api_key_store_resolves_and_expires" time="0.001" /><testcase classname="tests.unit.api.test_auth" name="test_auth_provider_issues_and_lists_keys" time="0.002" /><testcase classname="tests.unit.api.test_auth" name="test_auth_provider_jwt" time="0.002" /><testcase classname="tests.unit.api.test_health.TestHealthStatus" name="test_status_values" time="0.001" /><testcase classname="tests.unit.api.test_health.TestComponentHealth" name="test_create_component_health" time="0.001" /><testcase classname="tests.unit.api.test_health.TestComponentHealth" name="test_create_component_without_metadata" time="0.001" /><testcase classname="tests.unit.api.test_health.TestHealthCheck" name="test_create_health_check" time="0.001" /><testcase classname="tests.unit.api.test_health.TestHealthCheck" name="test_to_dict" time="0.001" /><testcase classname="tests.unit.api.test_health.TestHealthChecker" name="test_create_health_checker" time="0.001" /><testcase classname="tests.unit.api.test_health.TestHealthChecker" name="test_check_liveness" time="0.001" /><testcase classname="tests.unit.api.test_health.TestHealthChecker" name="test_liveness_always_healthy" time="0.001" /><testcase classname="tests.unit.api.test_health.TestHealthChecker" name="test_check_readiness_structure" time="0.002" /><testcase classname="tests.unit.api.test_health.TestHealthChecker" name="test_readiness_degrades_with_redis_failure" time="0.002" /><testcase classname="tests.unit.api.test_health.TestCheckHealthFunction" name="test_check_health_liveness" time="0.001" /><testcase classname="tests.unit.api.test_health.TestCheckHealthFunction" name="test_check_health_readiness" time="0.002" /><testcase classname="tests.unit.api.test_health.TestCheckHealthFunction" name="test_check_health_returns_different_results" time="0.002" /><testcase classname="tests.unit.api.test_ratelimit" name="test_rate_limiter_allows_until_burst" time="0.001" /><testcase classname="tests.unit.api.test_ratelimit" name="test_rate_limiter_daily_limit" time="0.001" /><testcase classname="tests.unit.api.test_ratelimit" name="test_rate_limiter_refills_tokens" time="0.001" /><testcase classname="tests.unit.api.test_rbac" name="test_allowed_roles_from_config" time="0.001" /><testcase classname="tests.unit.api.test_rbac" name="test_require_roles_blocks" time="0.001" /><testcase classname="tests.unit.api.test_rbac" name="test_require_roles_allows" time="0.001" /><testcase classname="tests.unit.audit.test_audit_performance" name="test_write_pack_under_500ms" time="0.015" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditManifest" name="test_audit_manifest_creation" time="0.001" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditManifest" name="test_audit_manifest_to_dict" time="0.001" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditManifest" name="test_audit_manifest_from_dict" time="0.001" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditManifest" name="test_audit_manifest_immutable" time="0.001" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditTrail" name="test_audit_trail_initialization" time="0.004" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditTrail" name="test_generate_trail" time="0.005" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditTrail" name="test_write_pack_creates_structure" time="0.013" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditTrail" name="test_evidence_files_handle_duplicate_query_ids" time="0.012" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditTrail" name="test_sources_directory_deduplicates_entries" time="0.022" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditTrail" name="test_write_pack_populates_digest" time="0.013" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditTrail" name="test_write_pack_with_hmac" time="0.013" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditTrail" name="test_write_pack_manifest_json_valid" time="0.024" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditTrail" name="test_verify_pack_valid" time="0.024" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditTrail" name="test_verify_pack_tampered_manifest" time="0.033" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditTrail" name="test_verify_pack_missing_manifest" time="0.004" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditTrail" name="test_verify_pack_with_hmac_valid" time="0.024" /><testcase classname="tests.unit.audit.test_audit_trail.TestAuditTrail" name="test_verify_pack_with_hmac_wrong_key" time="0.024" /><testcase classname="tests.unit.audit.test_audit_utils.TestCanonicalJson" name="test_canonical_json_sorted_keys" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestCanonicalJson" name="test_canonical_json_no_whitespace" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestCanonicalJson" name="test_canonical_json_nested_objects" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestCanonicalJson" name="test_canonical_json_arrays_preserved" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestCanonicalJson" name="test_canonical_json_unicode" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestCanonicalJson" name="test_canonical_json_deterministic" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestSha256Digest" name="test_sha256_digest_known_value" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestSha256Digest" name="test_sha256_digest_empty_string" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestSha256Digest" name="test_sha256_digest_utf8" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestSha256Digest" name="test_sha256_digest_deterministic" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestSha256Digest" name="test_sha256_digest_different_inputs" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestHmacSha256" name="test_hmac_sha256_valid_key" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestHmacSha256" name="test_hmac_sha256_empty_key_raises" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestHmacSha256" name="test_hmac_sha256_deterministic" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestHmacSha256" name="test_hmac_sha256_different_keys" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestHmacSha256" name="test_hmac_sha256_different_texts" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestRedactText" name="test_redact_text_names" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestRedactText" name="test_redact_text_emails" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestRedactText" name="test_redact_text_ids" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestRedactText" name="test_redact_text_short_ids_preserved" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestRedactText" name="test_redact_text_multiple_patterns" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestRedactText" name="test_redact_text_no_pii" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestReproducibilitySnippet" name="test_reproducibility_snippet_structure" time="0.001"><failure message="assert 'from src.qnwis.data.deterministic.api import DataAPI' in '&quot;&quot;&quot;\nReproducibility snippet for audit pack.\nRegistry version: v1.0.0\n&quot;&quot;&quot;\n\nfrom qnwis.data.deterministic.api impo...# Compare results to evidence/*.json in audit pack\nprint(f&quot;Fetched {len(results)} / {len(query_ids)} QueryResults&quot;)\n'">self = &lt;audit.test_audit_utils.TestReproducibilitySnippet object at 0x000001C13D579D90&gt;

    def test_reproducibility_snippet_structure(self):
        """Snippet should contain required components."""
        query_ids = ["qid_abc123", "qid_def456"]
        registry_version = "v1.0.0"
    
        snippet = reproducibility_snippet(query_ids, registry_version)
    
&gt;       assert "from src.qnwis.data.deterministic.api import DataAPI" in snippet
E       assert 'from src.qnwis.data.deterministic.api import DataAPI' in '"""\nReproducibility snippet for audit pack.\nRegistry version: v1.0.0\n"""\n\nfrom qnwis.data.deterministic.api impo...# Compare results to evidence/*.json in audit pack\nprint(f"Fetched {len(results)} / {len(query_ids)} QueryResults")\n'

tests\unit\audit\test_audit_utils.py:198: AssertionError</failure></testcase><testcase classname="tests.unit.audit.test_audit_utils.TestReproducibilitySnippet" name="test_reproducibility_snippet_empty_query_ids" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestReproducibilitySnippet" name="test_reproducibility_snippet_many_query_ids" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestComputeParamsHash" name="test_compute_params_hash_deterministic" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestComputeParamsHash" name="test_compute_params_hash_order_independent" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestComputeParamsHash" name="test_compute_params_hash_different_values" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestComputeParamsHash" name="test_compute_params_hash_empty_dict" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestSlugifyFilename" name="test_slugify_preserves_safe_characters" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestSlugifyFilename" name="test_slugify_replaces_spaces" time="0.001" /><testcase classname="tests.unit.audit.test_audit_utils.TestSlugifyFilename" name="test_slugify_handles_empty_input" time="0.001" /><testcase classname="tests.unit.cache.test_backends_abc" name="test_cannot_instantiate_abstract_backend" time="0.002" /><testcase classname="tests.unit.cache.test_backends_abc" name="test_incomplete_subclass_raises_type_error" time="0.001" /><testcase classname="tests.unit.cache.test_backends_abc" name="test_partial_implementation_raises_type_error" time="0.001" /><testcase classname="tests.unit.cache.test_backends_abc" name="test_complete_implementation_works" time="0.001" /><testcase classname="tests.unit.cache.test_backends_abc" name="test_memory_backend_is_complete" time="0.001" /><testcase classname="tests.unit.cache.test_backends_abc" name="test_abstractmethod_has_ellipsis" time="0.013" /><testcase classname="tests.unit.cache.test_keys.TestStableParamsHash" name="test_identical_params_produce_same_hash" time="0.001" /><testcase classname="tests.unit.cache.test_keys.TestStableParamsHash" name="test_nested_dict_sorted_keys" time="0.001" /><testcase classname="tests.unit.cache.test_keys.TestStableParamsHash" name="test_date_normalization" time="0.001" /><testcase classname="tests.unit.cache.test_keys.TestStableParamsHash" name="test_list_ordering_preserved" time="0.001" /><testcase classname="tests.unit.cache.test_keys.TestStableParamsHash" name="test_hash_length_is_16_chars" time="0.001" /><testcase classname="tests.unit.cache.test_keys.TestMakeCacheKey" name="test_cache_key_format" time="0.001" /><testcase classname="tests.unit.cache.test_keys.TestMakeCacheKey" name="test_ttl_policy_known_operation" time="0.001" /><testcase classname="tests.unit.cache.test_keys.TestMakeCacheKey" name="test_ttl_policy_unknown_operation" time="0.001" /><testcase classname="tests.unit.cache.test_keys.TestMakeCacheKey" name="test_same_params_same_key" time="0.001" /><testcase classname="tests.unit.cache.test_keys.TestMakeCacheKey" name="test_version_affects_key" time="0.001" /><testcase classname="tests.unit.cache.test_middleware.TestCachedDataClient" name="test_non_allowlisted_method_bypasses_cache" time="0.004" /><testcase classname="tests.unit.cache.test_middleware.TestCachedDataClient" name="test_cache_miss_calls_delegate_and_sets_cache" time="0.004" /><testcase classname="tests.unit.cache.test_middleware.TestCachedDataClient" name="test_cache_hit_returns_immediately" time="0.003" /><testcase classname="tests.unit.cache.test_middleware.TestCachedDataClient" name="test_allowlist_enforcement" time="0.001" /><testcase classname="tests.unit.cache.test_middleware.TestCachedDataClient" name="test_non_callable_attribute_passthrough" time="0.003" /><testcase classname="tests.unit.cache.test_middleware.TestCachedDataClient" name="test_negative_cache_ttl_applied_for_empty_results" time="0.004" /><testcase classname="tests.unit.cache.test_middleware.TestCachedDataClient" name="test_missing_query_id_raises" time="0.004" /><testcase classname="tests.unit.cache.test_qnwis_cache_cli" name="test_warmup_sets_and_hits" time="0.001" /><testcase classname="tests.unit.cache.test_qnwis_cache_cli" name="test_warmup_uses_negative_ttl_for_empty_rows" time="0.001" /><testcase classname="tests.unit.cache.test_qnwis_cache_cli" name="test_cli_info_action_outputs_payload" time="0.003" /><testcase classname="tests.unit.cache.test_qnwis_cache_cli" name="test_cli_invalidate_prefix" time="0.002" /><testcase classname="tests.unit.cache.test_qnwis_cache_cli" name="test_cli_list_packs_success" time="0.002" /><testcase classname="tests.unit.cache.test_qnwis_cache_cli" name="test_cli_list_packs_logs_error" time="0.026" /><testcase classname="tests.unit.cache.test_qnwis_cache_cli" name="test_cli_show_pack_success" time="0.002" /><testcase classname="tests.unit.cache.test_qnwis_cache_cli" name="test_cli_show_pack_logs_error" time="0.003" /><testcase classname="tests.unit.cache.test_redis_cache.TestDeterministicRedisCache" name="test_namespace_prefix" time="0.002" /><testcase classname="tests.unit.cache.test_redis_cache.TestDeterministicRedisCache" name="test_set_and_get" time="0.003" /><testcase classname="tests.unit.cache.test_redis_cache.TestDeterministicRedisCache" name="test_get_miss_returns_none" time="0.003" /><testcase classname="tests.unit.cache.test_redis_cache.TestDeterministicRedisCache" name="test_get_hit_deserializes_query_result" time="0.003" /><testcase classname="tests.unit.cache.test_redis_cache.TestDeterministicRedisCache" name="test_delete_prefix_no_keys" time="0.003" /><testcase classname="tests.unit.cache.test_redis_cache.TestDeterministicRedisCache" name="test_delete_prefix_with_keys" time="0.003" /><testcase classname="tests.unit.cache.test_redis_cache.TestDeterministicRedisCache" name="test_info_returns_redis_info" time="0.002" /><testcase classname="tests.unit.cache.test_warmup_packs" name="test_list_warmup_packs_default" time="0.021" /><testcase classname="tests.unit.cache.test_warmup_packs" name="test_load_warmup_pack_returns_specs" time="0.011" /><testcase classname="tests.unit.cache.test_warmup_packs" name="test_unknown_pack_raises" time="0.013" /><testcase classname="tests.unit.cli.test_qnwis_audit_cli.TestCmdShow" name="test_cli_show_and_verify_pack" time="0.016" /><testcase classname="tests.unit.cli.test_qnwis_audit_cli.TestCmdShow" name="test_show_json_output" time="0.006" /><testcase classname="tests.unit.cli.test_qnwis_audit_cli.TestCmdShow" name="test_show_nonexistent_pack" time="0.005" /><testcase classname="tests.unit.cli.test_qnwis_audit_cli.TestCmdList" name="test_cli_list_limits" time="0.007" /><testcase classname="tests.unit.cli.test_qnwis_audit_cli.TestCmdList" name="test_list_empty_directory" time="0.003" /><testcase classname="tests.unit.cli.test_qnwis_audit_cli.TestCmdExport" name="test_export_as_zip" time="0.008" /><testcase classname="tests.unit.cli.test_qnwis_audit_cli.TestCmdExport" name="test_export_nonexistent_pack" time="0.005" /><testcase classname="tests.unit.cli.test_qnwis_audit_cli.TestCmdVerify" name="test_verify_valid_pack" time="0.023" /><testcase classname="tests.unit.cli.test_qnwis_audit_cli.TestMainFunction" name="test_main_no_command" time="0.004" /><testcase classname="tests.unit.forecast.test_backtest.TestRollingOriginBacktest" name="test_sufficient_data" time="0.002" /><testcase classname="tests.unit.forecast.test_backtest.TestRollingOriginBacktest" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.forecast.test_backtest.TestRollingOriginBacktest" name="test_mae_computation" time="0.001" /><testcase classname="tests.unit.forecast.test_backtest.TestRollingOriginBacktest" name="test_mape_safe_with_zeros" time="0.001" /><testcase classname="tests.unit.forecast.test_backtest.TestRollingOriginBacktest" name="test_method_failure_handling" time="0.001" /><testcase classname="tests.unit.forecast.test_backtest.TestRollingOriginBacktest" name="test_multi_horizon" time="0.001" /><testcase classname="tests.unit.forecast.test_backtest.TestChooseBaseline" name="test_sufficient_data" time="0.011" /><testcase classname="tests.unit.forecast.test_backtest.TestChooseBaseline" name="test_insufficient_data_defaults_ewma" time="0.001" /><testcase classname="tests.unit.forecast.test_backtest.TestChooseBaseline" name="test_selects_lowest_mae" time="0.011" /><testcase classname="tests.unit.forecast.test_backtest.TestChooseBaseline" name="test_handles_all_failures" time="0.001" /><testcase classname="tests.unit.forecast.test_backtest.TestChooseBaseline" name="test_seasonal_data_prefers_seasonal" time="0.015" /><testcase classname="tests.unit.forecast.test_backtest.TestChooseBaseline" name="test_flat_series" time="0.007" /><testcase classname="tests.unit.forecast.test_baselines.TestSeasonalNaive" name="test_sufficient_history" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestSeasonalNaive" name="test_insufficient_history" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestSeasonalNaive" name="test_exact_season_length" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestSeasonalNaive" name="test_empty_series" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestEWMAForecast" name="test_normal_forecast" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestEWMAForecast" name="test_high_alpha_responsive" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestEWMAForecast" name="test_invalid_alpha_raises" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestEWMAForecast" name="test_empty_series" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestEWMAForecast" name="test_single_point" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestRollingMeanForecast" name="test_sufficient_window" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestRollingMeanForecast" name="test_insufficient_window" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestRollingMeanForecast" name="test_exact_window_length" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestRobustTrendForecast" name="test_linear_trend" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestRobustTrendForecast" name="test_flat_series" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestRobustTrendForecast" name="test_with_outlier" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestRobustTrendForecast" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestRobustTrendForecast" name="test_empty_series" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestResidualsInSample" name="test_aligned_residuals" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestResidualsInSample" name="test_skip_none_fitted" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestResidualsInSample" name="test_mismatched_lengths" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestMADInterval" name="test_normal_residuals" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestMADInterval" name="test_zero_residuals" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestMADInterval" name="test_empty_residuals" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestMADInterval" name="test_finite_clamping" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestClampNonnegative" name="test_clamp_negatives" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestClampNonnegative" name="test_preserve_none" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestClampNonnegative" name="test_all_positive" time="0.001" /><testcase classname="tests.unit.forecast.test_baselines.TestBuildForecastTable" name="test_standard_table" time="0.001"><failure message="TypeError: build_forecast_table() got an unexpected keyword argument 'method'">self = &lt;forecast.test_baselines.TestBuildForecastTable object at 0x000001C13D614190&gt;

    def test_standard_table(self) -&gt; None:
        """Forecast table built correctly."""
        forecast = [10.0, 12.0, 14.0]
&gt;       table = build_forecast_table(
            method="ewma",
            history=[1.0, 2.0, 3.0],
            forecast=forecast,
            half_width=2.0,
            start_idx=3,
        )
E       TypeError: build_forecast_table() got an unexpected keyword argument 'method'

tests\unit\forecast\test_baselines.py:294: TypeError</failure></testcase><testcase classname="tests.unit.forecast.test_baselines.TestBuildForecastTable" name="test_skip_none_forecast" time="0.001"><failure message="TypeError: build_forecast_table() got an unexpected keyword argument 'method'">self = &lt;forecast.test_baselines.TestBuildForecastTable object at 0x000001C13D6172D0&gt;

    def test_skip_none_forecast(self) -&gt; None:
        """Forecast table skips None values."""
        forecast = [10.0, None, 14.0]
&gt;       table = build_forecast_table(
            method="seasonal_naive",
            history=[],
            forecast=forecast,
            half_width=1.0,
            start_idx=0,
        )
E       TypeError: build_forecast_table() got an unexpected keyword argument 'method'

tests\unit\forecast\test_baselines.py:312: TypeError</failure></testcase><testcase classname="tests.unit.forecast.test_baselines.TestBuildForecastTable" name="test_clamp_lower_bound" time="0.001"><failure message="TypeError: build_forecast_table() got an unexpected keyword argument 'method'">self = &lt;forecast.test_baselines.TestBuildForecastTable object at 0x000001C13D617690&gt;

    def test_clamp_lower_bound(self) -&gt; None:
        """Lower bound clamped to zero for negative intervals."""
        forecast = [2.0]
&gt;       table = build_forecast_table(
            method="test",
            history=[],
            forecast=forecast,
            half_width=5.0,  # Would give lo = -3
            start_idx=0,
        )
E       TypeError: build_forecast_table() got an unexpected keyword argument 'method'

tests\unit\forecast\test_baselines.py:327: TypeError</failure></testcase><testcase classname="tests.unit.forecast.test_early_warning.TestBandBreach" name="test_no_breach" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestBandBreach" name="test_breach_above" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestBandBreach" name="test_breach_below" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestBandBreach" name="test_exact_boundary" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestBandBreach" name="test_zero_half_width" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestSlopeReversal" name="test_clear_reversal" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestSlopeReversal" name="test_no_reversal" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestSlopeReversal" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestSlopeReversal" name="test_flat_to_rising" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestSlopeReversal" name="test_oscillating_series" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestVolatilitySpike" name="test_clear_spike" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestVolatilitySpike" name="test_no_spike" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestVolatilitySpike" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestVolatilitySpike" name="test_all_zeros" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestVolatilitySpike" name="test_gradually_increasing" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestRiskScore" name="test_all_flags_off" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestRiskScore" name="test_all_flags_on" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestRiskScore" name="test_partial_flags" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestRiskScore" name="test_empty_flags" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestRiskScore" name="test_clamping_bounds" time="0.001" /><testcase classname="tests.unit.forecast.test_early_warning.TestRiskScore" name="test_missing_weight" time="0.001" /><testcase classname="tests.unit.gate.test_no_placeholders" name="test_no_pass_statements" time="1.724" /><testcase classname="tests.unit.gate.test_no_placeholders" name="test_no_not_implemented_error" time="0.042" /><testcase classname="tests.unit.gate.test_no_placeholders" name="test_no_todo_fixme_comments" time="0.031" /><testcase classname="tests.unit.gate.test_no_placeholders" name="test_no_placeholder_patterns[^\\s*pass\\s*$-bare pass statement]" time="0.045" /><testcase classname="tests.unit.gate.test_no_placeholders" name="test_no_placeholder_patterns[raise\\s+NotImplementedError-NotImplementedError]" time="0.042" /><testcase classname="tests.unit.gate.test_no_placeholders" name="test_no_placeholder_patterns[#\\s*HACK\\b-HACK comment]" time="0.032" /><testcase classname="tests.unit.gate.test_no_placeholders" name="test_no_placeholder_patterns[#\\s*XXX\\b-XXX comment]" time="0.031" /><testcase classname="tests.unit.materialized.test_postgres_materializer.TestPostgresMaterializer" name="test_create_or_replace_calls_create_refresh_index" time="0.003" /><testcase classname="tests.unit.materialized.test_postgres_materializer.TestPostgresMaterializer" name="test_refresh_calls_refresh_concurrently" time="0.002" /><testcase classname="tests.unit.materialized.test_postgres_materializer.TestPostgresMaterializer" name="test_drop_calls_drop_if_exists" time="0.002" /><testcase classname="tests.unit.materialized.test_postgres_materializer.TestPostgresMaterializer" name="test_create_strips_trailing_semicolon" time="0.002" /><testcase classname="tests.unit.materialized.test_postgres_materializer.TestPostgresMaterializer" name="test_create_with_empty_indexes" time="0.002" /><testcase classname="tests.unit.materialized.test_postgres_materializer.TestPostgresMaterializer" name="test_invalid_index_format_raises" time="0.003" /><testcase classname="tests.unit.materialized.test_postgres_materializer.TestPostgresMaterializer" name="test_create_handles_multiline_sql" time="0.002" /><testcase classname="tests.unit.materialized.test_postgres_materializer.TestPostgresMaterializer" name="test_create_or_replace_calls_in_sequence" time="0.002" /><testcase classname="tests.unit.materialized.test_postgres_materializer.TestPostgresMaterializer" name="test_refresh_with_special_chars_in_name" time="0.002" /><testcase classname="tests.unit.materialized.test_postgres_materializer.TestPostgresMaterializer" name="test_drop_with_special_chars_in_name" time="0.002" /><testcase classname="tests.unit.materialized.test_postgres_materializer.TestPostgresMaterializer" name="test_multiple_indexes_created_in_order" time="0.002" /><testcase classname="tests.unit.materialized.test_registry.TestMaterializedRegistry" name="test_load_valid_spec" time="0.021" /><testcase classname="tests.unit.materialized.test_registry.TestMaterializedRegistry" name="test_missing_required_field_raises" time="0.015" /><testcase classname="tests.unit.materialized.test_registry.TestMaterializedRegistry" name="test_invalid_field_type_raises" time="0.015" /><testcase classname="tests.unit.materialized.test_registry.TestMaterializedRegistry" name="test_invalid_index_format_raises" time="0.017" /><testcase classname="tests.unit.materialized.test_registry.TestMaterializedRegistry" name="test_by_name_success" time="0.011" /><testcase classname="tests.unit.materialized.test_registry.TestMaterializedRegistry" name="test_by_name_not_found_raises" time="0.012" /><testcase classname="tests.unit.materialized.test_registry.TestMaterializedRegistry" name="test_empty_yaml_loads" time="0.005" /><testcase classname="tests.unit.materialized.test_registry.TestMaterializedRegistry" name="test_all_required_fields_validated" time="0.061" /><testcase classname="tests.unit.materialized.test_registry.TestMaterializedRegistry" name="test_string_fields_must_be_strings" time="0.039" /><testcase classname="tests.unit.materialized.test_registry.TestMaterializedRegistry" name="test_indexes_must_be_list_of_strings" time="0.027" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_classify_simple_retention_query" time="0.272" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_classify_gcc_benchmark_complex" time="0.145" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_crisis_detection_by_lexicon" time="0.146" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_ambiguity_parallel_mode" time="0.146" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_low_confidence_triggers_clarification" time="0.148" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_determine_data_needs_declares_only" time="0.147" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_entity_extraction_sectors" time="0.146" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_entity_extraction_metrics" time="0.147" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_entity_extraction_time_horizon_relative" time="0.146" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_entity_extraction_time_horizon_absolute" time="0.146" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_entity_extraction_default_time_horizon" time="0.146" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_empty_query_returns_zero_confidence" time="0.146" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_intent_scores_populated" time="0.147" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_pii_redaction_in_reasons" time="0.146" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_complexity_scoring_simple" time="0.146" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_complexity_scoring_medium" time="0.146" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_prefetch_token_resolution" time="0.146" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_vision2030_intent_detection" time="0.146" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_talent_competition_intent_detection" time="0.145" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_root_causes_intent_detection" time="0.146" /><testcase classname="tests.unit.orchestration.test_classifier" name="test_best_practices_intent_detection" time="0.145" /><testcase classname="tests.unit.orchestration.test_coordination.TestCoordinator" name="test_plan_single_mode" time="0.002" /><testcase classname="tests.unit.orchestration.test_coordination.TestCoordinator" name="test_plan_parallel_mode" time="0.002" /><testcase classname="tests.unit.orchestration.test_coordination.TestCoordinator" name="test_plan_sequential_mode" time="0.002" /><testcase classname="tests.unit.orchestration.test_coordination.TestCoordinator" name="test_plan_invalid_mode" time="0.002" /><testcase classname="tests.unit.orchestration.test_coordination.TestCoordinator" name="test_plan_rejects_unregistered_method" time="0.002" /><testcase classname="tests.unit.orchestration.test_coordination.TestCoordinator" name="test_plan_validates_sequential_dependencies" time="0.002" /><testcase classname="tests.unit.orchestration.test_coordination.TestCoordinatorExecution" name="test_execute_sequential_dependency_skip" time="0.004" /><testcase classname="tests.unit.orchestration.test_coordination.TestCoordinatorExecution" name="test_execute_total_timeout_stops_remaining" time="0.004" /><testcase classname="tests.unit.orchestration.test_coordination.TestMergeResults" name="test_merge_empty_raises_error" time="0.001" /><testcase classname="tests.unit.orchestration.test_coordination.TestMergeResults" name="test_merge_single_result" time="0.002" /><testcase classname="tests.unit.orchestration.test_coordination.TestMergeResults" name="test_merge_multiple_results" time="0.002" /><testcase classname="tests.unit.orchestration.test_coordination.TestMergeResults" name="test_merge_deduplicates_sections" time="0.002" /><testcase classname="tests.unit.orchestration.test_coordination.TestMergeResults" name="test_merge_preserves_ok_status" time="0.002" /><testcase classname="tests.unit.orchestration.test_coordination.TestMergeResults" name="test_merge_freshness_range" time="0.002" /><testcase classname="tests.unit.orchestration.test_coordination.TestMergeResults" name="test_merge_masks_pii_in_sections_and_warnings" time="0.002" /><testcase classname="tests.unit.orchestration.test_coordination.TestMergeResults" name="test_merge_agent_traces_dedup_and_sort" time="0.002" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_pii_redaction_names" time="0.002" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_pii_redaction_emails" time="0.002" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_pii_redaction_long_ids" time="0.002" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_section_order_stable" time="0.002" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_truncation_with_message" time="0.002" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_evidence_truncation" time="0.002" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_citations_deduplication" time="0.002" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_freshness_extraction" time="0.002" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_missing_agent_output_fails" time="0.001" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_missing_task_fails" time="0.001" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_reproducibility_metadata" time="0.002" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_warnings_combined" time="0.002" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_metric_redaction" time="0.002" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_appends_verification_summary_section" time="0.002" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_appends_redaction_reason_codes" time="0.002" /><testcase classname="tests.unit.orchestration.test_format" name="test_format_includes_citations_summary" time="0.002" /><testcase classname="tests.unit.orchestration.test_invoke" name="test_invoke_with_valid_parameters" time="0.002" /><testcase classname="tests.unit.orchestration.test_invoke" name="test_invoke_rejects_extraneous_parameters" time="0.002" /><testcase classname="tests.unit.orchestration.test_invoke" name="test_invoke_handles_missing_required_parameters" time="0.002" /><testcase classname="tests.unit.orchestration.test_invoke" name="test_invoke_uses_default_parameters" time="0.002" /><testcase classname="tests.unit.orchestration.test_invoke" name="test_invoke_handles_missing_route" time="0.001" /><testcase classname="tests.unit.orchestration.test_invoke" name="test_invoke_handles_missing_task" time="0.001" /><testcase classname="tests.unit.orchestration.test_invoke" name="test_invoke_with_metrics_observer" time="0.003" /><testcase classname="tests.unit.orchestration.test_invoke" name="test_invoke_retries_transient_errors" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask&#10;intent&#10;  Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='test.flaky', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/literal_error">def test_invoke_retries_transient_errors() -&gt; None:
        """Test retry logic for transient failures."""
    
        class FailingAgent:
            """Agent that fails on first call, succeeds on retry."""
    
            def __init__(self) -&gt; None:
                self.call_count = 0
    
            def flaky_method(self) -&gt; AgentReport:
                """Method that fails first time."""
                self.call_count += 1
                if self.call_count == 1:
                    raise ConnectionError("Temporary network issue")
    
                insight = Insight(
                    title="Success after retry",
                    summary="This succeeded on retry",
                    metrics={"retries": 1},
                    evidence=[
                        Evidence(
                            query_id="q_retry",
                            dataset_id="test_data",
                            locator="data/test.csv",
                            fields=["field1"],
                            freshness_as_of="2024-01-01T00:00:00Z",
                        )
                    ],
                )
    
                return AgentReport(
                    agent="FailingAgent",
                    findings=[insight],
                    warnings=[],
                )
    
        registry = AgentRegistry()
        agent = FailingAgent()
        registry.register("test.flaky", agent, "flaky_method")
    
&gt;       task = OrchestrationTask(intent="test.flaky", params={})
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask
E       intent
E         Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='test.flaky', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/literal_error

tests\unit\orchestration\test_invoke.py:358: ValidationError</failure></testcase><testcase classname="tests.unit.orchestration.test_invoke" name="test_invoke_fails_after_max_retries" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask&#10;intent&#10;  Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='test.always_fail', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/literal_error">def test_invoke_fails_after_max_retries() -&gt; None:
        """Test that invoke fails after exhausting retries."""
    
        class AlwaysFailingAgent:
            """Agent that always fails."""
    
            def always_fails(self) -&gt; AgentReport:
                """Method that always fails."""
                raise ConnectionError("Persistent network issue")
    
        registry = AgentRegistry()
        agent = AlwaysFailingAgent()
        registry.register("test.always_fail", agent, "always_fails")
    
&gt;       task = OrchestrationTask(intent="test.always_fail", params={})
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask
E       intent
E         Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='test.always_fail', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/literal_error

tests\unit\orchestration\test_invoke.py:399: ValidationError</failure></testcase><testcase classname="tests.unit.orchestration.test_invoke" name="test_invoke_tracks_timeout_exceeded" time="0.002" /><testcase classname="tests.unit.orchestration.test_invoke" name="test_invoke_with_all_optional_parameters" time="0.002" /><testcase classname="tests.unit.orchestration.test_prefetch.TestPrefetcher" name="test_prefetch_single_spec" time="0.002" /><testcase classname="tests.unit.orchestration.test_prefetch.TestPrefetcher" name="test_prefetch_multiple_specs" time="0.001" /><testcase classname="tests.unit.orchestration.test_prefetch.TestPrefetcher" name="test_prefetch_deduplicates_by_cache_key" time="0.001" /><testcase classname="tests.unit.orchestration.test_prefetch.TestPrefetcher" name="test_prefetch_calls_correct_dataclient_method" time="0.001" /><testcase classname="tests.unit.orchestration.test_prefetch.TestPrefetcher" name="test_prefetch_bad_function_name_raises_error" time="0.002" /><testcase classname="tests.unit.orchestration.test_prefetch.TestPrefetcher" name="test_prefetch_non_callable_attribute_raises_error" time="0.002" /><testcase classname="tests.unit.orchestration.test_prefetch.TestPrefetcher" name="test_prefetch_invalid_return_type_raises_error" time="0.003" /><testcase classname="tests.unit.orchestration.test_prefetch.TestPrefetcher" name="test_prefetch_timeout_raises_error" time="0.063" /><testcase classname="tests.unit.orchestration.test_prefetch.TestPrefetcher" name="test_prefetch_method_exception_raises_prefetch_error" time="0.003" /><testcase classname="tests.unit.orchestration.test_prefetch.TestPrefetcher" name="test_prefetch_empty_specs" time="0.001" /><testcase classname="tests.unit.orchestration.test_prefetch.TestPrefetcher" name="test_prefetch_returns_correct_query_result_structure" time="0.001" /><testcase classname="tests.unit.orchestration.test_prefetch.TestPrefetcher" name="test_prefetch_sanitizes_params_for_logging" time="0.001" /><testcase classname="tests.unit.orchestration.test_prefetch.TestPrefetcher" name="test_prefetch_does_not_sanitize_short_params" time="0.001" /><testcase classname="tests.unit.orchestration.test_prefetch.TestGenerateCacheKey" name="test_generate_cache_key_deterministic" time="0.001" /><testcase classname="tests.unit.orchestration.test_prefetch.TestGenerateCacheKey" name="test_generate_cache_key_different_fn" time="0.001" /><testcase classname="tests.unit.orchestration.test_prefetch.TestGenerateCacheKey" name="test_generate_cache_key_different_params" time="0.001" /><testcase classname="tests.unit.orchestration.test_prefetch.TestGenerateCacheKey" name="test_generate_cache_key_param_order_independent" time="0.001" /><testcase classname="tests.unit.orchestration.test_prefetch.TestGenerateCacheKey" name="test_generate_cache_key_format" time="0.001" /><testcase classname="tests.unit.orchestration.test_prefetch.TestGenerateCacheKey" name="test_generate_cache_key_complex_params" time="0.001" /><testcase classname="tests.unit.orchestration.test_registry" name="test_register_and_resolve_ok" time="0.001"><failure message="assert do_analysis is do_analysis&#10; +  where do_analysis = &lt;orchestration.test_registry.FakeAgent object at 0x000001C1406E72D0&gt;.do_analysis">def test_register_and_resolve_ok() -&gt; None:
        """Test successful registration and resolution."""
        registry = AgentRegistry()
        agent = FakeAgent("TestAgent")
    
        # Register intent
        registry.register("test.intent", agent, "do_analysis")
    
        # Verify registration succeeded
        assert registry.is_registered("test.intent")
        assert "test.intent" in registry.intents()
    
        # Resolve intent
        resolved_agent, method_name = registry.resolve("test.intent")
        assert resolved_agent is agent
        assert method_name == "do_analysis"
    
        # Get callable method
        method = registry.get_method("test.intent")
        assert callable(method)
&gt;       assert method is agent.do_analysis
E       assert do_analysis is do_analysis
E        +  where do_analysis = &lt;orchestration.test_registry.FakeAgent object at 0x000001C1406E72D0&gt;.do_analysis

tests\unit\orchestration\test_registry.py:59: AssertionError</failure></testcase><testcase classname="tests.unit.orchestration.test_registry" name="test_duplicate_registration_rejected" time="0.001" /><testcase classname="tests.unit.orchestration.test_registry" name="test_unknown_intent_raises" time="0.001" /><testcase classname="tests.unit.orchestration.test_registry" name="test_register_nonexistent_method_raises" time="0.001" /><testcase classname="tests.unit.orchestration.test_registry" name="test_register_noncallable_attribute_raises" time="0.001" /><testcase classname="tests.unit.orchestration.test_registry" name="test_intents_returns_sorted_list" time="0.002" /><testcase classname="tests.unit.orchestration.test_registry" name="test_clear_removes_all_registrations" time="0.002" /><testcase classname="tests.unit.orchestration.test_registry" name="test_multiple_agents_different_intents" time="0.002" /><testcase classname="tests.unit.orchestration.test_registry" name="test_get_method_unknown_intent_raises" time="0.001" /><testcase classname="tests.unit.orchestration.test_router" name="test_router_accepts_known_intent" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask&#10;intent&#10;  Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='test.intent', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/literal_error">def test_router_accepts_known_intent() -&gt; None:
        """Test that router successfully routes known intents."""
        registry = AgentRegistry()
        agent = MockAgent()
        registry.register("test.intent", agent, "test_method")
    
&gt;       task = OrchestrationTask(
            intent="test.intent",
            params={"param1": "value1"},
            request_id="req-123",
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask
E       intent
E         Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='test.intent', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/literal_error

tests\unit\orchestration\test_router.py:31: ValidationError</failure></testcase><testcase classname="tests.unit.orchestration.test_router" name="test_router_rejects_unknown_intent_with_help" time="0.002" /><testcase classname="tests.unit.orchestration.test_router" name="test_router_handles_missing_task" time="0.001" /><testcase classname="tests.unit.orchestration.test_router" name="test_router_preserves_existing_logs" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask&#10;intent&#10;  Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='test.intent', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/literal_error">def test_router_preserves_existing_logs() -&gt; None:
        """Test that router preserves existing logs in state."""
        registry = AgentRegistry()
        agent = MockAgent()
        registry.register("test.intent", agent, "test_method")
    
&gt;       task = OrchestrationTask(intent="test.intent", params={})
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask
E       intent
E         Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='test.intent', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/literal_error

tests\unit\orchestration\test_router.py:124: ValidationError</failure></testcase><testcase classname="tests.unit.orchestration.test_router" name="test_router_handles_unexpected_exceptions" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask&#10;intent&#10;  Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='test.intent', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/literal_error">def test_router_handles_unexpected_exceptions() -&gt; None:
        """Test that router handles unexpected exceptions gracefully."""
    
        class BrokenRegistry:
            """Mock registry that raises unexpected errors."""
    
            def is_registered(self, intent: str) -&gt; bool:
                raise RuntimeError("Unexpected registry error")
    
        registry = BrokenRegistry()
    
&gt;       task = OrchestrationTask(intent="test.intent", params={})
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask
E       intent
E         Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='test.intent', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/literal_error

tests\unit\orchestration\test_router.py:155: ValidationError</failure></testcase><testcase classname="tests.unit.orchestration.test_router" name="test_router_preserves_metadata" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask&#10;intent&#10;  Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='test.intent', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/literal_error">def test_router_preserves_metadata() -&gt; None:
        """Test that router preserves existing metadata."""
        registry = AgentRegistry()
        agent = MockAgent()
        registry.register("test.intent", agent, "test_method")
    
&gt;       task = OrchestrationTask(intent="test.intent", params={})
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask
E       intent
E         Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='test.intent', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/literal_error

tests\unit\orchestration\test_router.py:183: ValidationError</failure></testcase><testcase classname="tests.unit.orchestration.test_router" name="test_router_validates_task_intent_field" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask&#10;intent&#10;  Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='registered.intent', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/literal_error">def test_router_validates_task_intent_field() -&gt; None:
        """Test that router uses task.intent for validation."""
        registry = AgentRegistry()
        agent = MockAgent()
        registry.register("registered.intent", agent, "test_method")
    
&gt;       task = OrchestrationTask(
            intent="registered.intent",
            params={},
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for OrchestrationTask
E       intent
E         Input should be 'pattern.anomalies', 'pattern.correlation', 'pattern.root_causes', 'pattern.best_practices', 'strategy.gcc_benchmark', 'strategy.talent_competition' or 'strategy.vision2030' [type=literal_error, input_value='registered.intent', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/literal_error

tests\unit\orchestration\test_router.py:206: ValidationError</failure></testcase><testcase classname="tests.unit.orchestration.test_router_node" name="test_route_explicit_intent_pass_through" time="0.002" /><testcase classname="tests.unit.orchestration.test_router_node" name="test_route_explicit_intent_unknown_rejected" time="0.002" /><testcase classname="tests.unit.orchestration.test_router_node" name="test_route_query_text_classification" time="0.003" /><testcase classname="tests.unit.orchestration.test_router_node" name="test_route_query_text_low_confidence" time="0.003" /><testcase classname="tests.unit.orchestration.test_router_node" name="test_route_query_text_no_valid_intents" time="0.004" /><testcase classname="tests.unit.orchestration.test_router_node" name="test_route_query_text_parallel_mode_for_tie" time="0.004" /><testcase classname="tests.unit.orchestration.test_router_node" name="test_route_query_text_single_mode_for_simple" time="0.004" /><testcase classname="tests.unit.orchestration.test_router_node" name="test_route_query_text_prefetch_populated" time="0.004" /><testcase classname="tests.unit.orchestration.test_router_node" name="test_route_no_task_provided" time="0.002" /><testcase classname="tests.unit.orchestration.test_router_node" name="test_route_validates_task_has_intent_or_query" time="0.001" /><testcase classname="tests.unit.orchestration.test_router_node" name="test_route_updates_task_with_classification" time="0.003" /><testcase classname="tests.unit.orchestration.test_router_node" name="test_route_metadata_populated" time="0.003" /><testcase classname="tests.unit.orchestration.test_verify" name="test_verify_valid_structure_passes" time="0.002" /><testcase classname="tests.unit.orchestration.test_verify" name="test_verify_missing_findings_fails" time="0.002" /><testcase classname="tests.unit.orchestration.test_verify" name="test_verify_missing_evidence_with_requirement" time="0.002" /><testcase classname="tests.unit.orchestration.test_verify" name="test_verify_missing_evidence_as_warning" time="0.002" /><testcase classname="tests.unit.orchestration.test_verify" name="test_verify_missing_freshness_fails_when_required" time="0.002" /><testcase classname="tests.unit.orchestration.test_verify" name="test_verify_missing_title_fails" time="0.002" /><testcase classname="tests.unit.orchestration.test_verify" name="test_verify_missing_summary_fails" time="0.002" /><testcase classname="tests.unit.orchestration.test_verify" name="test_verify_missing_query_id_fails" time="0.002" /><testcase classname="tests.unit.orchestration.test_verify" name="test_verify_missing_dataset_id_fails" time="0.002" /><testcase classname="tests.unit.orchestration.test_verify" name="test_verify_invalid_output_type_fails" time="0.001" /><testcase classname="tests.unit.orchestration.test_verify" name="test_verify_missing_agent_output_fails" time="0.001" /><testcase classname="tests.unit.orchestration.test_verify" name="test_verify_missing_invocation_metadata_fails" time="0.002" /><testcase classname="tests.unit.orchestration.test_verify" name="test_verify_with_agent_warnings" time="0.002" /><testcase classname="tests.unit.orchestration.test_verify_node_integration" name="test_verify_node_attaches_summary_and_reasons" time="0.003"><failure message="assert &quot;Verification engine exception: TypeError: test_verify_node_attaches_summary_and_reasons.&lt;locals&gt;.DummyEngine.__init__() got an unexpected keyword argument 'result_tolerances'&quot; is None">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C1411DBDD0&gt;

    def test_verify_node_attaches_summary_and_reasons(monkeypatch: pytest.MonkeyPatch) -&gt; None:
        """Verify node should pass verification summary metadata to downstream nodes."""
        config = VerificationConfig(
            crosschecks=[],
            privacy=PrivacyRule(),
            sanity=[],
            freshness_max_hours=72,
        )
        monkeypatch.setattr(verify_module, "_load_verification_config", lambda: config)
        monkeypatch.setattr(verify_module, "_load_citation_rules", lambda: None)
    
        fake_summary = VerificationSummary(
            ok=True,
            issues=[],
            redacted_text="clean body",
            applied_redactions=2,
            stats={"L3:warning": 2},
            summary_md="Status: PASS",
            redaction_reason_codes=["PII_EMAIL", "PII_ID"],
        )
    
        class DummyEngine:
            def __init__(
                self,
                cfg: VerificationConfig,
                user_roles: list[str] | None = None,
                citation_rules: Any | None = None,
            ) -&gt; None:
                self.cfg = cfg
                self.user_roles = user_roles or []
                self.citation_rules = citation_rules
    
            def run_with_agent_report(
                self,
                narrative_md: str,
                query_results: list[QueryResult],
            ) -&gt; VerificationSummary:
                assert narrative_md
                assert query_results
                return fake_summary
    
        monkeypatch.setattr(verify_module, "VerificationEngine", DummyEngine)
    
        prefetch_cache = {
            "primary": _qr("q_primary", [{"retention_rate": 0.9, "segment": "ALL"}]),
            "reference": _qr("q_reference", [{"retention_rate": 0.92, "segment": "ALL"}]),
        }
    
        task = OrchestrationTask(intent="pattern.correlation", params={})
        state = {
            "task": task,
            "route": "pattern.correlation",
            "agent_output": _report(),
            "error": None,
            "logs": [],
            "metadata": {
                "agent": "TestAgent",
                "method": "run",
            },
            "prefetch_cache": prefetch_cache,
        }
    
        result = verify_structure(state, strict=False)
    
&gt;       assert result["error"] is None
E       assert "Verification engine exception: TypeError: test_verify_node_attaches_summary_and_reasons.&lt;locals&gt;.DummyEngine.__init__() got an unexpected keyword argument 'result_tolerances'" is None

tests\unit\orchestration\test_verify_node_integration.py:126: AssertionError</failure></testcase><testcase classname="tests.unit.orchestration.test_verify_node_integration" name="test_verify_node_warning_issues_only" time="0.003"><failure message="assert &quot;Verification engine exception: TypeError: test_verify_node_warning_issues_only.&lt;locals&gt;.DummyEngine.__init__() got an unexpected keyword argument 'result_tolerances'&quot; is None">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C1432DF5D0&gt;

    def test_verify_node_warning_issues_only(monkeypatch: pytest.MonkeyPatch) -&gt; None:
        """Warnings should annotate metadata but not fail verification."""
        config = VerificationConfig(
            crosschecks=[],
            privacy=PrivacyRule(),
            sanity=[],
            freshness_max_hours=72,
        )
        monkeypatch.setattr(verify_module, "_load_verification_config", lambda: config)
        monkeypatch.setattr(verify_module, "_load_citation_rules", lambda: None)
    
        warning_issue = Issue(
            layer="L2",
            code="MISSING_QID",
            message="QID optional for this metric",
            severity="warning",
            details={},
        )
        fake_summary = VerificationSummary(
            ok=True,
            issues=[warning_issue],
            redacted_text="body",
            applied_redactions=0,
            stats={"L2:warning": 1},
            summary_md="Status: PASS",
        )
    
        class DummyEngine:
            def __init__(
                self,
                cfg: VerificationConfig,
                user_roles: list[str] | None = None,
                citation_rules: Any | None = None,
            ) -&gt; None:
                self.cfg = cfg
                self.user_roles = user_roles or []
                self.citation_rules = citation_rules
    
            def run_with_agent_report(
                self,
                narrative_md: str,
                query_results: list[QueryResult],
            ) -&gt; VerificationSummary:
                return fake_summary
    
        monkeypatch.setattr(verify_module, "VerificationEngine", DummyEngine)
    
        prefetch_cache = {
            "primary": _qr("q_primary", [{"value": 1}]),
            "reference": _qr("q_reference", [{"value": 1}]),
        }
        task = OrchestrationTask(intent="pattern.correlation", params={})
        state = {
            "task": task,
            "route": "pattern.correlation",
            "agent_output": _report(),
            "error": None,
            "logs": [],
            "metadata": {"agent": "TestAgent", "method": "run"},
            "prefetch_cache": prefetch_cache,
        }
    
        result = verify_structure(state, strict=False)
&gt;       assert result["error"] is None
E       assert "Verification engine exception: TypeError: test_verify_node_warning_issues_only.&lt;locals&gt;.DummyEngine.__init__() got an unexpected keyword argument 'result_tolerances'" is None

tests\unit\orchestration\test_verify_node_integration.py:199: AssertionError</failure></testcase><testcase classname="tests.unit.orchestration.test_verify_node_integration" name="test_verify_node_errors_fail_workflow" time="0.003"><failure message="assert False&#10; +  where False = &lt;built-in method startswith of str object at 0x000001C1408CC2D0&gt;('Verification failed with 1 error')&#10; +    where &lt;built-in method startswith of str object at 0x000001C1408CC2D0&gt; = &quot;Verification engine exception: TypeError: test_verify_node_errors_fail_workflow.&lt;locals&gt;.DummyEngine.__init__() got an unexpected keyword argument 'result_tolerances'&quot;.startswith">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C1433D5190&gt;

    def test_verify_node_errors_fail_workflow(monkeypatch: pytest.MonkeyPatch) -&gt; None:
        """Error-severity issues should fail the workflow."""
        config = VerificationConfig(
            crosschecks=[],
            privacy=PrivacyRule(),
            sanity=[],
            freshness_max_hours=72,
        )
        monkeypatch.setattr(verify_module, "_load_verification_config", lambda: config)
        monkeypatch.setattr(verify_module, "_load_citation_rules", lambda: None)
    
        error_issue = Issue(
            layer="L2",
            code="UNCITED_NUMBER",
            message="Missing source",
            severity="error",
            details={},
        )
        fake_summary = VerificationSummary(
            ok=False,
            issues=[error_issue],
            redacted_text="body",
            applied_redactions=0,
            stats={"L2:error": 1},
        )
    
        class DummyEngine:
            def __init__(
                self,
                cfg: VerificationConfig,
                user_roles: list[str] | None = None,
                citation_rules: Any | None = None,
            ) -&gt; None:
                self.cfg = cfg
                self.user_roles = user_roles or []
                self.citation_rules = citation_rules
    
            def run_with_agent_report(
                self,
                narrative_md: str,
                query_results: list[QueryResult],
            ) -&gt; VerificationSummary:
                return fake_summary
    
        monkeypatch.setattr(verify_module, "VerificationEngine", DummyEngine)
    
        prefetch_cache = {
            "primary": _qr("q_primary", [{"value": 1}]),
            "reference": _qr("q_reference", [{"value": 1}]),
        }
        task = OrchestrationTask(intent="pattern.correlation", params={})
        state = {
            "task": task,
            "route": "pattern.correlation",
            "agent_output": _report(),
            "error": None,
            "logs": [],
            "metadata": {"agent": "TestAgent", "method": "run"},
            "prefetch_cache": prefetch_cache,
        }
    
        result = verify_structure(state, strict=False)
&gt;       assert result["error"].startswith("Verification failed with 1 error")
E       assert False
E        +  where False = &lt;built-in method startswith of str object at 0x000001C1408CC2D0&gt;('Verification failed with 1 error')
E        +    where &lt;built-in method startswith of str object at 0x000001C1408CC2D0&gt; = "Verification engine exception: TypeError: test_verify_node_errors_fail_workflow.&lt;locals&gt;.DummyEngine.__init__() got an unexpected keyword argument 'result_tolerances'".startswith

tests\unit\orchestration\test_verify_node_integration.py:268: AssertionError</failure></testcase><testcase classname="tests.unit.patterns.test_metrics.TestPearson" name="test_perfect_positive_correlation" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestPearson" name="test_perfect_negative_correlation" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestPearson" name="test_zero_correlation" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestPearson" name="test_zero_variance_x" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestPearson" name="test_zero_variance_y" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestPearson" name="test_moderate_positive_correlation" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestPearson" name="test_mismatched_lengths" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestPearson" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSpearman" name="test_perfect_monotonic_increasing" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSpearman" name="test_perfect_monotonic_decreasing" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSpearman" name="test_nonlinear_monotonic" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSpearman" name="test_outlier_robustness" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSpearman" name="test_tied_ranks" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSpearman" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSlope" name="test_positive_linear_trend" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSlope" name="test_negative_linear_trend" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSlope" name="test_flat_trend" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSlope" name="test_fractional_slope" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSlope" name="test_zero_variance_x" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSlope" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestLift" name="test_positive_lift" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestLift" name="test_negative_lift" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestLift" name="test_baseline_zero" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestLift" name="test_negative_baseline" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestLift" name="test_empty_lists" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestLift" name="test_clamped_output" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestStability" name="test_perfect_linear_trend" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestStability" name="test_volatile_series" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestStability" name="test_flat_series" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestStability" name="test_insufficient_data" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestStability" name="test_moderate_stability" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestStability" name="test_custom_windows" time="0.002" /><testcase classname="tests.unit.patterns.test_metrics.TestStability" name="test_inverse_variance_behavior" time="0.003" /><testcase classname="tests.unit.patterns.test_metrics.TestSupport" name="test_full_support" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSupport" name="test_double_required" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSupport" name="test_half_required" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSupport" name="test_quarter_required" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSupport" name="test_zero_observations" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSupport" name="test_zero_required" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestSupport" name="test_exact_minimum" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestRankValues" name="test_no_ties" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestRankValues" name="test_tied_values" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestRankValues" name="test_all_tied" time="0.001" /><testcase classname="tests.unit.patterns.test_metrics.TestRankValues" name="test_three_way_tie" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestPatternMiner" name="test_default_initialization" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestPatternMiner" name="test_custom_thresholds" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestDirectionClassification" name="test_flat_classification" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestDirectionClassification" name="test_positive_classification" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestDirectionClassification" name="test_negative_classification" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestDirectionClassification" name="test_boundary_cases" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestSeriesExtraction" name="test_extract_simple_series" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestSeriesExtraction" name="test_extract_with_sector_filter" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestSeriesExtraction" name="test_extract_with_date_filtering" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestSeriesExtraction" name="test_extract_alternative_field_names" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestSeriesExtraction" name="test_extract_with_month_field" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestSeriesExtraction" name="test_extract_handles_missing_values" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestSeriesExtraction" name="test_extract_sorts_by_date" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestSeriesExtraction" name="test_extract_uses_seasonally_adjusted_if_available" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestSeriesAlignment" name="test_equal_length_series" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestSeriesAlignment" name="test_first_series_longer" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestSeriesAlignment" name="test_second_series_longer" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestSeriesAlignment" name="test_empty_series" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestMineStableRelations" name="test_stable_relations_with_perfect_correlation" time="0.002" /><testcase classname="tests.unit.patterns.test_miner.TestMineStableRelations" name="test_stable_relations_filters_flat_patterns" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestMineStableRelations" name="test_stable_relations_insufficient_support" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestMineStableRelations" name="test_stable_relations_prefers_seasonally_adjusted" time="0.002" /><testcase classname="tests.unit.patterns.test_miner.TestMineStableRelations" name="test_stable_relations_ranking_prioritizes_support" time="0.002" /><testcase classname="tests.unit.patterns.test_miner.TestPatternSpec" name="test_default_values" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestPatternSpec" name="test_custom_values" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestPatternFinding" name="test_finding_structure" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestPatternFinding" name="test_composite_score_calculation" time="0.001" /><testcase classname="tests.unit.patterns.test_miner.TestPatternMinerPerformance" name="test_driver_screen_micro_benchmark_under_budget" time="0.022" /><testcase classname="tests.unit.scenario.test_apply.TestIndividualTransforms" name="test_apply_additive" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestIndividualTransforms" name="test_apply_additive_no_end" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestIndividualTransforms" name="test_apply_multiplicative" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestIndividualTransforms" name="test_apply_growth_override" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestIndividualTransforms" name="test_apply_clamp" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestIndividualTransforms" name="test_apply_clamp_min_only" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestIndividualTransforms" name="test_apply_clamp_max_only" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestApplyTransform" name="test_apply_transform_additive" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestApplyTransform" name="test_apply_transform_multiplicative" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestApplyTransform" name="test_apply_transform_unknown_type" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestApplyScenario" name="test_apply_scenario_basic" time="0.002" /><testcase classname="tests.unit.scenario.test_apply.TestApplyScenario" name="test_apply_scenario_with_date_labels" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestApplyScenario" name="test_apply_scenario_with_clamping" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestApplyScenario" name="test_apply_scenario_empty_baseline" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestApplyScenario" name="test_apply_scenario_missing_value_field" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestApplyScenario" name="test_apply_scenario_sequential_transforms" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestCascadeSectorToNational" name="test_cascade_equal_weights" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestCascadeSectorToNational" name="test_cascade_custom_weights" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestCascadeSectorToNational" name="test_cascade_empty_sectors_error" time="0.001" /><testcase classname="tests.unit.scenario.test_apply.TestCascadeSectorToNational" name="test_cascade_inconsistent_horizons_error" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestTransform" name="test_valid_additive_transform" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestTransform" name="test_valid_multiplicative_transform" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestTransform" name="test_multiplicative_rate_out_of_range" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestTransform" name="test_nan_value_rejected" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestTransform" name="test_inf_value_rejected" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestTransform" name="test_end_before_start_rejected" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestTransform" name="test_negative_start_month_rejected" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestScenarioSpec" name="test_valid_scenario_spec" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestScenarioSpec" name="test_empty_transforms_rejected" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestScenarioSpec" name="test_too_many_transforms_rejected" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestScenarioSpec" name="test_invalid_horizon_rejected" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestScenarioSpec" name="test_clamp_min_greater_than_max_rejected" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestScenarioSpec" name="test_nan_clamp_rejected" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestParseScenario" name="test_parse_yaml_string" time="0.004" /><testcase classname="tests.unit.scenario.test_dsl.TestParseScenario" name="test_parse_json_string" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestParseScenario" name="test_parse_dict" time="0.001" /><testcase classname="tests.unit.scenario.test_dsl.TestParseScenario" name="test_parse_invalid_yaml" time="0.002" /><testcase classname="tests.unit.scenario.test_dsl.TestParseScenario" name="test_parse_missing_required_field" time="0.003" /><testcase classname="tests.unit.scenario.test_dsl.TestParseScenario" name="test_parse_invalid_transform_in_spec" time="0.003" /><testcase classname="tests.unit.scenario.test_dsl.TestValidateScenarioFile" name="test_validate_nonexistent_file" time="0.005" /><testcase classname="tests.unit.scenario.test_dsl.TestValidateScenarioFile" name="test_validate_valid_file" time="0.017" /><testcase classname="tests.unit.scenario.test_dsl.TestValidateScenarioFile" name="test_validate_invalid_file" time="0.015" /><testcase classname="tests.unit.scenario.test_microbench.TestScenarioMicroBench" name="test_apply_meets_sla" time="0.010" /><testcase classname="tests.unit.scenario.test_qa.TestErrorMetrics" name="test_mean_absolute_error" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestErrorMetrics" name="test_mean_absolute_error_perfect_fit" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestErrorMetrics" name="test_mean_absolute_error_length_mismatch" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestErrorMetrics" name="test_mean_absolute_error_empty_lists" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestErrorMetrics" name="test_mean_absolute_percentage_error" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestErrorMetrics" name="test_mean_absolute_percentage_error_with_epsilon" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestErrorMetrics" name="test_symmetric_mean_absolute_percentage_error" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestErrorMetrics" name="test_symmetric_mean_absolute_percentage_error_both_zero" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestBacktestForecast" name="test_backtest_forecast_basic" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestBacktestForecast" name="test_backtest_forecast_perfect_fit" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestBacktestForecast" name="test_backtest_forecast_length_mismatch" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestBacktestForecast" name="test_backtest_forecast_empty_data" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestStabilityCheck" name="test_stability_check_stable" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestStabilityCheck" name="test_stability_check_high_volatility" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestStabilityCheck" name="test_stability_check_frequent_reversals" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestStabilityCheck" name="test_stability_check_range_explosion" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestStabilityCheck" name="test_stability_check_insufficient_data" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestSLABenchmark" name="test_sla_benchmark_compliant" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestSLABenchmark" name="test_sla_benchmark_with_error" time="0.001" /><testcase classname="tests.unit.scenario.test_qa.TestSLABenchmark" name="test_sla_benchmark_custom_threshold" time="0.001" /><testcase classname="tests.unit.test_access_api" name="test_execute_sum_to_one_warning" time="0.001" /><testcase classname="tests.unit.test_access_api" name="test_execute_unit_mismatch" time="0.001" /><testcase classname="tests.unit.test_access_api" name="test_execute_world_bank_branch" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C14069EDD0&gt;

    def test_execute_world_bank_branch(monkeypatch):
        spec = models_mod.QuerySpec(
            id="q3",
            title="t",
            description="d",
            source="world_bank",
            expected_unit="percent",
            params={"indicator_id": "SL.TLF.CACT.FE.ZS"},
        )
        registry = type("R", (object,), {"get": lambda self, _: spec})()
    
        def fake_world_bank_query(s):
            return models_mod.QueryResult(
                query_id=s.id,
                rows=[models_mod.Row(data={"year": 2024, "value": 55.0})],
                unit="percent",
                provenance=models_mod.Provenance(
                    source="world_bank",
                    dataset_id="wb",
                    locator="wb:SL.TLF.CACT.FE.ZS",
                    fields=["year", "value"],
                ),
                freshness=models_mod.Freshness(asof_date="auto"),
            )
    
        monkeypatch.setattr(accessmod, "run_world_bank_query", fake_world_bank_query)
        monkeypatch.setattr(accessmod, "verify_result", lambda spec, res: ["ok"])
    
&gt;       result = accessmod.execute("q3", registry)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_access_api.py:96: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\data\deterministic\access.py:41: in execute
    result = run_world_bank_query(spec)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

s = QuerySpec(id='q3', title='t', description='d', source='world_bank', params={'indicator_id': 'SL.TLF.CACT.FE.ZS'}, expected_unit='percent', constraints={}, postprocess=[])

    def fake_world_bank_query(s):
        return models_mod.QueryResult(
            query_id=s.id,
            rows=[models_mod.Row(data={"year": 2024, "value": 55.0})],
            unit="percent",
            provenance=models_mod.Provenance(
                source="world_bank",
                dataset_id="wb",
                locator="wb:SL.TLF.CACT.FE.ZS",
                fields=["year", "value"],
            ),
&gt;           freshness=models_mod.Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_access_api.py:90: ValidationError</failure></testcase><testcase classname="tests.unit.test_access_api" name="test_execute_unknown_source_raises" time="0.001" /><testcase classname="tests.unit.test_access_api" name="test_execute_traces_transforms_when_enabled" time="0.001" /><testcase classname="tests.unit.test_agent_labour_economist" name="test_labour_economist_agent_initialization" time="0.190" /><testcase classname="tests.unit.test_agent_labour_economist" name="test_labour_economist_agent_run" time="0.190" /><testcase classname="tests.unit.test_agent_labour_economist" name="test_labour_economist_metrics" time="0.190" /><testcase classname="tests.unit.test_agent_labour_economist" name="test_labour_economist_evidence" time="0.190" /><testcase classname="tests.unit.test_agent_labour_economist" name="test_labour_economist_with_single_row" time="0.190" /><testcase classname="tests.unit.test_agent_labour_economist" name="test_labour_economist_warnings_propagation" time="0.190" /><testcase classname="tests.unit.test_agent_national_strategy" name="test_national_strategy_initialization" time="0.189" /><testcase classname="tests.unit.test_agent_national_strategy" name="test_national_strategy_run" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C14089C950&gt;

    def test_national_strategy_run(monkeypatch):
        emp = QueryResult(
            query_id="q_employment_share_by_gender_2023",
            rows=[Row(data={"year": 2023, "male_percent": 60.0, "female_percent": 40.0, "total_percent": 100.0})],
            unit="percent",
            provenance=Provenance(
                source="csv", dataset_id="employed", locator="x.csv",
                fields=["year", "male_percent", "female_percent", "total_percent"]
            ),
            freshness=Freshness(asof_date="2023-12-31")
        )
        gcc = QueryResult(
            query_id="q_unemployment_rate_gcc_latest",
            rows=[
                Row(data={"country": "QAT", "year": 2023, "value": 0.1}),
                Row(data={"country": "ARE", "year": 2023, "value": 2.8})
            ],
            unit="percent",
            provenance=Provenance(
                source="world_bank", dataset_id="SL.UEM.TOTL.ZS",
                locator="indicator=SL.UEM.TOTL.ZS", fields=["country", "year", "value"]
            ),
&gt;           freshness=Freshness(asof_date="api")
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_agent_national_strategy.py:38: ValidationError</failure></testcase><testcase classname="tests.unit.test_agent_national_strategy" name="test_national_strategy_combines_metrics" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C13F4AAE50&gt;

    def test_national_strategy_combines_metrics(monkeypatch):
        emp = QueryResult(
            query_id="q_employment_share_by_gender_2023",
            rows=[Row(data={"year": 2023, "male_percent": 60.0, "female_percent": 40.0, "total_percent": 100.0})],
            unit="percent",
            provenance=Provenance(
                source="csv", dataset_id="employed", locator="x.csv",
                fields=["year", "male_percent", "female_percent", "total_percent"]
            ),
            freshness=Freshness(asof_date="2023-12-31")
        )
        gcc = QueryResult(
            query_id="q_unemployment_rate_gcc_latest",
            rows=[
                Row(data={"country": "QAT", "year": 2023, "value": 0.1}),
                Row(data={"country": "SAU", "year": 2023, "value": 5.4})
            ],
            unit="percent",
            provenance=Provenance(
                source="world_bank", dataset_id="SL.UEM.TOTL.ZS",
                locator="indicator=SL.UEM.TOTL.ZS", fields=["country", "year", "value"]
            ),
&gt;           freshness=Freshness(asof_date="api")
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_agent_national_strategy.py:73: ValidationError</failure></testcase><testcase classname="tests.unit.test_agent_national_strategy" name="test_gcc_benchmark_uses_data_client" time="0.191" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestGCCBenchmark" name="test_basic_benchmarking" time="0.003" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestGCCBenchmark" name="test_qatar_best_performer" time="0.002" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestGCCBenchmark" name="test_insufficient_countries" time="0.002" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestGCCBenchmark" name="test_qatar_not_found" time="0.002" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestGCCBenchmark" name="test_gap_calculation" time="0.002" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestTalentCompetitionAssessment" name="test_basic_competition_assessment" time="0.002" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestTalentCompetitionAssessment" name="test_high_competition_threshold" time="0.003" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestTalentCompetitionAssessment" name="test_no_data_warning" time="0.002" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestVision2030Alignment" name="test_basic_alignment_calculation" time="0.002" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestVision2030Alignment" name="test_below_target_high_risk" time="0.002" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestVision2030Alignment" name="test_required_annual_growth" time="0.002" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestVision2030Alignment" name="test_on_track_or_exceeding" time="0.002" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestVision2030Alignment" name="test_no_data_warning" time="0.002" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestLegacyRun" name="test_legacy_strategic_snapshot" time="0.002" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestEvidenceChain" name="test_gcc_benchmark_evidence" time="0.003" /><testcase classname="tests.unit.test_agent_national_strategy_enhanced.TestEvidenceChain" name="test_vision2030_evidence" time="0.002" /><testcase classname="tests.unit.test_agent_nationalization" name="test_nationalization_agent_initialization" time="0.192" /><testcase classname="tests.unit.test_agent_nationalization" name="test_nationalization_agent_run" time="0.190"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C140EEA010&gt;

    def test_nationalization_agent_run(monkeypatch):
        """Test full agent execution with mocked data."""
        client = DataClient()
        monkeypatch.setattr(client, "run", lambda qid: _qr_wb())
&gt;       out = NationalizationAgent(client).run()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_agent_nationalization.py:47: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\agents\nationalization.py:42: in run
    res = self.client.run(UNEMPLOY_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests\unit\test_agent_nationalization.py:46: in &lt;lambda&gt;
    monkeypatch.setattr(client, "run", lambda qid: _qr_wb())
                                                   ^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def _qr_wb():
        """Generate test QueryResult for World Bank unemployment data."""
        rows = [
            Row(data={"country": "QAT", "year": 2023, "value": 0.1}),
            Row(data={"country": "ARE", "year": 2023, "value": 2.8}),
            Row(data={"country": "SAU", "year": 2023, "value": 5.4}),
        ]
        return QueryResult(
            query_id="q_unemployment_rate_gcc_latest",
            rows=rows,
            unit="percent",
            provenance=Provenance(
                source="world_bank",
                dataset_id="SL.UEM.TOTL.ZS",
                locator="indicator=SL.UEM.TOTL.ZS",
                fields=["country", "year", "value"],
            ),
&gt;           freshness=Freshness(asof_date="api"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_agent_nationalization.py:32: ValidationError</failure></testcase><testcase classname="tests.unit.test_agent_nationalization" name="test_nationalization_metrics" time="0.189"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C140693310&gt;

    def test_nationalization_metrics(monkeypatch):
        """Verify agent produces Qatar-specific metrics."""
        client = DataClient()
        monkeypatch.setattr(client, "run", lambda qid: _qr_wb())
&gt;       out = NationalizationAgent(client).run()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_agent_nationalization.py:57: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\agents\nationalization.py:42: in run
    res = self.client.run(UNEMPLOY_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests\unit\test_agent_nationalization.py:56: in &lt;lambda&gt;
    monkeypatch.setattr(client, "run", lambda qid: _qr_wb())
                                                   ^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def _qr_wb():
        """Generate test QueryResult for World Bank unemployment data."""
        rows = [
            Row(data={"country": "QAT", "year": 2023, "value": 0.1}),
            Row(data={"country": "ARE", "year": 2023, "value": 2.8}),
            Row(data={"country": "SAU", "year": 2023, "value": 5.4}),
        ]
        return QueryResult(
            query_id="q_unemployment_rate_gcc_latest",
            rows=rows,
            unit="percent",
            provenance=Provenance(
                source="world_bank",
                dataset_id="SL.UEM.TOTL.ZS",
                locator="indicator=SL.UEM.TOTL.ZS",
                fields=["country", "year", "value"],
            ),
&gt;           freshness=Freshness(asof_date="api"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_agent_nationalization.py:32: ValidationError</failure></testcase><testcase classname="tests.unit.test_agent_nationalization" name="test_nationalization_ranking" time="0.192"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C1432CCF10&gt;

    def test_nationalization_ranking(monkeypatch):
        """Verify agent correctly ranks Qatar among GCC countries."""
        client = DataClient()
        monkeypatch.setattr(client, "run", lambda qid: _qr_wb())
&gt;       out = NationalizationAgent(client).run()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_agent_nationalization.py:69: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\agents\nationalization.py:42: in run
    res = self.client.run(UNEMPLOY_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests\unit\test_agent_nationalization.py:68: in &lt;lambda&gt;
    monkeypatch.setattr(client, "run", lambda qid: _qr_wb())
                                                   ^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def _qr_wb():
        """Generate test QueryResult for World Bank unemployment data."""
        rows = [
            Row(data={"country": "QAT", "year": 2023, "value": 0.1}),
            Row(data={"country": "ARE", "year": 2023, "value": 2.8}),
            Row(data={"country": "SAU", "year": 2023, "value": 5.4}),
        ]
        return QueryResult(
            query_id="q_unemployment_rate_gcc_latest",
            rows=rows,
            unit="percent",
            provenance=Provenance(
                source="world_bank",
                dataset_id="SL.UEM.TOTL.ZS",
                locator="indicator=SL.UEM.TOTL.ZS",
                fields=["country", "year", "value"],
            ),
&gt;           freshness=Freshness(asof_date="api"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_agent_nationalization.py:32: ValidationError</failure></testcase><testcase classname="tests.unit.test_agent_nationalization" name="test_nationalization_with_missing_qatar" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C1400458D0&gt;

    def test_nationalization_with_missing_qatar(monkeypatch):
        """Test agent handles data without Qatar entry."""
        no_qatar_result = QueryResult(
            query_id="q_unemployment_rate_gcc_latest",
            rows=[
                Row(data={"country": "ARE", "year": 2023, "value": 2.8}),
                Row(data={"country": "SAU", "year": 2023, "value": 5.4}),
            ],
            unit="percent",
            provenance=Provenance(
                source="world_bank",
                dataset_id="SL.UEM.TOTL.ZS",
                locator="indicator=SL.UEM.TOTL.ZS",
                fields=["country", "year", "value"],
            ),
&gt;           freshness=Freshness(asof_date="api"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_agent_nationalization.py:91: ValidationError</failure></testcase><testcase classname="tests.unit.test_agent_nationalization" name="test_nationalization_evidence" time="0.190"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C14117D710&gt;

    def test_nationalization_evidence(monkeypatch):
        """Verify agent includes proper provenance evidence."""
        client = DataClient()
        monkeypatch.setattr(client, "run", lambda qid: _qr_wb())
&gt;       out = NationalizationAgent(client).run()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_agent_nationalization.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\agents\nationalization.py:42: in run
    res = self.client.run(UNEMPLOY_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests\unit\test_agent_nationalization.py:103: in &lt;lambda&gt;
    monkeypatch.setattr(client, "run", lambda qid: _qr_wb())
                                                   ^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def _qr_wb():
        """Generate test QueryResult for World Bank unemployment data."""
        rows = [
            Row(data={"country": "QAT", "year": 2023, "value": 0.1}),
            Row(data={"country": "ARE", "year": 2023, "value": 2.8}),
            Row(data={"country": "SAU", "year": 2023, "value": 5.4}),
        ]
        return QueryResult(
            query_id="q_unemployment_rate_gcc_latest",
            rows=rows,
            unit="percent",
            provenance=Provenance(
                source="world_bank",
                dataset_id="SL.UEM.TOTL.ZS",
                locator="indicator=SL.UEM.TOTL.ZS",
                fields=["country", "year", "value"],
            ),
&gt;           freshness=Freshness(asof_date="api"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_agent_nationalization.py:32: ValidationError</failure></testcase><testcase classname="tests.unit.test_agent_nationalization" name="test_nationalization_resilient_field_detection" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C1405BE810&gt;

    def test_nationalization_resilient_field_detection(monkeypatch):
        """Test agent can detect numeric fields dynamically."""
        # Use different field name for unemployment value
        alt_field_result = QueryResult(
            query_id="q_unemployment_rate_gcc_latest",
            rows=[
                Row(data={"country": "QAT", "year": 2023, "unemployment_rate": 0.1}),
                Row(data={"country": "ARE", "year": 2023, "unemployment_rate": 2.8}),
            ],
            unit="percent",
            provenance=Provenance(
                source="world_bank",
                dataset_id="SL.UEM.TOTL.ZS",
                locator="indicator=SL.UEM.TOTL.ZS",
                fields=["country", "year", "unemployment_rate"],
            ),
&gt;           freshness=Freshness(asof_date="api"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_agent_nationalization.py:127: ValidationError</failure></testcase><testcase classname="tests.unit.test_agent_pattern_detective" name="test_pattern_detective_initialization" time="0.190" /><testcase classname="tests.unit.test_agent_pattern_detective" name="test_pattern_detective_run" time="0.191" /><testcase classname="tests.unit.test_agent_pattern_detective" name="test_pattern_detective_detects_inconsistency" time="0.189" /><testcase classname="tests.unit.test_agent_pattern_detective" name="test_find_correlations_fallbacks_to_spearman" time="0.190" /><testcase classname="tests.unit.test_agent_pattern_detective" name="test_detect_anomalous_retention_validates_threshold" time="0.189" /><testcase classname="tests.unit.test_agent_pattern_detective" name="test_best_practices_invokes_data_client_once" time="0.190" /><testcase classname="tests.unit.test_agent_pattern_detective_enhanced.TestDetectAnomalousRetention" name="test_basic_anomaly_detection" time="0.003" /><testcase classname="tests.unit.test_agent_pattern_detective_enhanced.TestDetectAnomalousRetention" name="test_no_anomalies" time="0.002" /><testcase classname="tests.unit.test_agent_pattern_detective_enhanced.TestDetectAnomalousRetention" name="test_insufficient_data" time="0.002" /><testcase classname="tests.unit.test_agent_pattern_detective_enhanced.TestFindCorrelations" name="test_positive_correlation" time="0.003" /><testcase classname="tests.unit.test_agent_pattern_detective_enhanced.TestFindCorrelations" name="test_spearman_vs_pearson" time="0.003" /><testcase classname="tests.unit.test_agent_pattern_detective_enhanced.TestFindCorrelations" name="test_insufficient_overlap" time="0.002" /><testcase classname="tests.unit.test_agent_pattern_detective_enhanced.TestIdentifyRootCauses" name="test_basic_root_cause" time="0.003" /><testcase classname="tests.unit.test_agent_pattern_detective_enhanced.TestIdentifyRootCauses" name="test_insufficient_sectors" time="0.002" /><testcase classname="tests.unit.test_agent_pattern_detective_enhanced.TestBestPractices" name="test_qatarization_leaders" time="0.002" /><testcase classname="tests.unit.test_agent_pattern_detective_enhanced.TestBestPractices" name="test_retention_leaders" time="0.002" /><testcase classname="tests.unit.test_agent_pattern_detective_enhanced.TestBestPractices" name="test_no_data" time="0.002" /><testcase classname="tests.unit.test_agent_pattern_detective_enhanced.TestLegacyRun" name="test_legacy_consistency_check" time="0.002" /><testcase classname="tests.unit.test_agent_reporting" name="test_write_report_creates_directory" time="0.006" /><testcase classname="tests.unit.test_agent_reporting" name="test_write_report_appends_jsonl" time="0.015" /><testcase classname="tests.unit.test_agent_reporting" name="test_write_report_serializes_full_structure" time="0.014" /><testcase classname="tests.unit.test_agent_reporting" name="test_write_report_handles_string_path" time="0.005" /><testcase classname="tests.unit.test_agent_skills" name="test_skills_agent_initialization" time="0.191" /><testcase classname="tests.unit.test_agent_skills" name="test_skills_agent_run" time="0.188" /><testcase classname="tests.unit.test_agent_skills" name="test_skills_metrics" time="0.190" /><testcase classname="tests.unit.test_agent_skills" name="test_skills_title_and_summary" time="0.190" /><testcase classname="tests.unit.test_agent_skills" name="test_skills_evidence" time="0.191" /><testcase classname="tests.unit.test_agent_skills" name="test_skills_with_empty_data" time="0.190" /><testcase classname="tests.unit.test_agent_skills" name="test_skills_with_partial_data" time="0.192" /><testcase classname="tests.unit.test_agent_skills" name="test_skills_warnings_propagation" time="0.189" /><testcase classname="tests.unit.test_agents_base" name="test_dataclasses_exist" time="0.001" /><testcase classname="tests.unit.test_agents_base" name="test_evidence_structure" time="0.001" /><testcase classname="tests.unit.test_agents_base" name="test_insight_structure" time="0.001" /><testcase classname="tests.unit.test_agents_base" name="test_insight_with_data" time="0.001" /><testcase classname="tests.unit.test_agents_base" name="test_insight_confidence_floor" time="0.001" /><testcase classname="tests.unit.test_agents_base" name="test_agent_report_structure" time="0.001" /><testcase classname="tests.unit.test_agents_base" name="test_data_client_initialization" time="0.190" /><testcase classname="tests.unit.test_agents_base" name="test_evidence_from_helper" time="0.001" /><testcase classname="tests.unit.test_agents_base" name="test_evidence_from_empty_result" time="0.001" /><testcase classname="tests.unit.test_agents_base" name="test_no_sql_strings_in_agents" time="0.002" /><testcase classname="tests.unit.test_agents_base" name="test_no_network_calls_in_agents" time="0.001" /><testcase classname="tests.unit.test_agents_base" name="test_data_client_guards" time="0.191" /><testcase classname="tests.unit.test_agents_base" name="test_numeric_fields_helper" time="0.001" /><testcase classname="tests.unit.test_agents_base" name="test_numeric_fields_with_empty" time="0.001" /><testcase classname="tests.unit.test_agents_base" name="test_metric_from_rows" time="0.001" /><testcase classname="tests.unit.test_agents_base" name="test_metric_from_rows_missing_key" time="0.001" /><testcase classname="tests.unit.test_agents_base" name="test_metric_from_rows_non_numeric" time="0.001" /><testcase classname="tests.unit.test_agents_base" name="test_data_client_custom_ttl" time="0.190" /><testcase classname="tests.unit.test_agents_base" name="test_data_client_custom_queries_dir" time="0.001" /><testcase classname="tests.unit.test_agents_base" name="test_data_client_missing_query_raises" time="0.001" /><testcase classname="tests.unit.test_agents_evidence_utils" name="test_format_evidence_table_truncates_with_ellipsis" time="0.001" /><testcase classname="tests.unit.test_agents_evidence_utils" name="test_format_evidence_table_respects_column_order" time="0.001" /><testcase classname="tests.unit.test_agents_evidence_utils" name="test_format_evidence_table_requires_positive_max_rows" time="0.001" /><testcase classname="tests.unit.test_agents_evidence_utils" name="test_agent_response_verifier_flags_unknown_evidence" time="0.001" /><testcase classname="tests.unit.test_agents_reporting_jsonl" name="test_write_report_appends_entries" time="0.017" /><testcase classname="tests.unit.test_api_models" name="test_query_run_request_default" time="0.001" /><testcase classname="tests.unit.test_api_models" name="test_query_run_request_with_ttl" time="0.001" /><testcase classname="tests.unit.test_api_models" name="test_query_run_request_with_overrides" time="0.001" /><testcase classname="tests.unit.test_api_models" name="test_query_run_request_serialization" time="0.001" /><testcase classname="tests.unit.test_api_models" name="test_query_run_response_basic" time="0.001" /><testcase classname="tests.unit.test_api_models" name="test_query_run_response_with_warnings" time="0.001" /><testcase classname="tests.unit.test_api_models" name="test_query_run_response_with_request_id" time="0.001" /><testcase classname="tests.unit.test_api_models" name="test_query_run_response_serialization" time="0.001" /><testcase classname="tests.unit.test_api_models" name="test_models_roundtrip" time="0.001" /><testcase classname="tests.unit.test_apis_qatar_opendata" name="test_base_url_from_environment" time="0.001" /><testcase classname="tests.unit.test_apis_qatar_opendata" name="test_base_url_default" time="0.001" /><testcase classname="tests.unit.test_apis_qatar_opendata" name="test_client_configuration" time="0.257" /><testcase classname="tests.unit.test_apis_qatar_opendata" name="test_scraper_initialization" time="0.008" /><testcase classname="tests.unit.test_apis_qatar_opendata" name="test_test_api_connection_success" time="0.006" /><testcase classname="tests.unit.test_apis_qatar_opendata" name="test_test_api_connection_failure" time="0.756" /><testcase classname="tests.unit.test_apis_qatar_opendata" name="test_get_all_datasets_with_limit" time="0.006" /><testcase classname="tests.unit.test_apis_qatar_opendata" name="test_download_dataset" time="0.021" /><testcase classname="tests.unit.test_apis_qatar_opendata" name="test_download_dataset_http_error" time="0.005" /><testcase classname="tests.unit.test_apis_qatar_opendata" name="test_timeout_configuration" time="0.257" /><testcase classname="tests.unit.test_apis_qatar_opendata" name="test_no_hardcoded_secrets" time="0.016" /><testcase classname="tests.unit.test_apis_semantic_scholar" name="test_api_key_from_environment" time="0.001" /><testcase classname="tests.unit.test_apis_semantic_scholar" name="test_api_key_missing_raises_error" time="0.001" /><testcase classname="tests.unit.test_apis_semantic_scholar" name="test_client_configuration" time="0.255" /><testcase classname="tests.unit.test_apis_semantic_scholar" name="test_search_papers_with_mocked_api" time="0.004" /><testcase classname="tests.unit.test_apis_semantic_scholar" name="test_search_papers_raises_on_http_error" time="2.005" /><testcase classname="tests.unit.test_apis_semantic_scholar" name="test_get_paper_recommendations" time="0.004" /><testcase classname="tests.unit.test_apis_semantic_scholar" name="test_get_paper_by_id_not_found" time="0.004" /><testcase classname="tests.unit.test_apis_semantic_scholar" name="test_no_hardcoded_secrets_in_module" time="0.020" /><testcase classname="tests.unit.test_apis_semantic_scholar" name="test_timeout_is_configurable" time="0.256" /><testcase classname="tests.unit.test_apis_world_bank" name="test_base_url_from_environment" time="0.001" /><testcase classname="tests.unit.test_apis_world_bank" name="test_base_url_default" time="0.001" /><testcase classname="tests.unit.test_apis_world_bank" name="test_client_configuration" time="0.258" /><testcase classname="tests.unit.test_apis_world_bank" name="test_get_indicator_with_mocked_api" time="0.106" /><testcase classname="tests.unit.test_apis_world_bank" name="test_get_indicator_raises_on_http_error" time="0.755" /><testcase classname="tests.unit.test_apis_world_bank" name="test_get_multiple_indicators" time="0.410" /><testcase classname="tests.unit.test_apis_world_bank" name="test_timeout_respected" time="0.259" /><testcase classname="tests.unit.test_apis_world_bank" name="test_no_hardcoded_secrets" time="0.016" /><testcase classname="tests.unit.test_briefing_builder" name="test_briefing_contains_markdown_and_sections" time="0.196" /><testcase classname="tests.unit.test_briefing_builder" name="test_briefing_structure" time="0.195" /><testcase classname="tests.unit.test_briefing_builder" name="test_briefing_markdown_sections" time="0.195" /><testcase classname="tests.unit.test_briefing_builder" name="test_briefing_key_metrics_are_numeric" time="0.195" /><testcase classname="tests.unit.test_briefing_builder" name="test_briefing_provenance_deduped" time="0.194" /><testcase classname="tests.unit.test_briefing_builder" name="test_briefing_red_flags_limited" time="0.193" /><testcase classname="tests.unit.test_briefing_builder" name="test_briefing_handles_empty_consensus" time="0.193" /><testcase classname="tests.unit.test_cache_access_errors" name="test_decode_cached_result_invalid_json" time="0.001" /><testcase classname="tests.unit.test_cache_access_errors" name="test_decode_cached_result_missing_meta" time="0.001" /><testcase classname="tests.unit.test_cache_access_errors" name="test_decode_cached_result_meta_not_mapping" time="0.001" /><testcase classname="tests.unit.test_cache_access_errors" name="test_decode_cached_result_zlib_requires_string" time="0.001" /><testcase classname="tests.unit.test_cache_access_errors" name="test_decode_cached_result_zlib_bad_base64" time="0.001" /><testcase classname="tests.unit.test_cache_access_errors" name="test_decode_cached_result_unsupported_encoding" time="0.001" /><testcase classname="tests.unit.test_cache_access_errors" name="test_canonicalize_params_includes_sets" time="0.001" /><testcase classname="tests.unit.test_cache_access_errors" name="test_execute_cached_drops_corrupt_entry" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C14062F490&gt;

    def test_execute_cached_drops_corrupt_entry(monkeypatch):
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={"pattern": "x.csv"},
        )
        registry = type("R", (object,), {"get": lambda self, _: spec})()
    
        class CorruptBackend(cache_module.CacheBackend):
            def __init__(self) -&gt; None:
                self.value: str | None = None
                self.deleted = 0
    
            def get(self, key: str):
                return self.value
    
            def set(self, key: str, value: str, ttl_s: int | None = None):
                self.value = value
    
            def delete(self, key: str):
                self.deleted += 1
                self.value = None
    
        backend = CorruptBackend()
        backend.value = "{"  # corrupt JSON
    
        def fake_execute(*_, **__):
            return _sample_result()
    
        monkeypatch.setattr(cache_module, "execute_uncached", fake_execute)
        monkeypatch.setattr(cache_module, "get_cache_backend", lambda: backend)
    
&gt;       result = cache_module.execute_cached("q", registry, ttl_s=300)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_cache_access_errors.py:122: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests\unit\test_cache_access_errors.py:117: in fake_execute
    return _sample_result()
           ^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def _sample_result() -&gt; QueryResult:
        return QueryResult(
            query_id="q",
            rows=[Row(data={"value": 1})],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="employed-persons-15-years-and-above.csv",
                fields=["value"],
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_cache_access_errors.py:28: ValidationError</failure></testcase><testcase classname="tests.unit.test_cache_backends" name="test_memory_cache_set_get" time="0.001" /><testcase classname="tests.unit.test_cache_backends" name="test_memory_cache_get_missing" time="0.001" /><testcase classname="tests.unit.test_cache_backends" name="test_memory_cache_set_get_ttl" time="0.001" /><testcase classname="tests.unit.test_cache_backends" name="test_memory_cache_set_without_ttl" time="0.001" /><testcase classname="tests.unit.test_cache_backends" name="test_memory_cache_delete" time="0.001" /><testcase classname="tests.unit.test_cache_backends" name="test_memory_cache_delete_missing" time="0.001" /><testcase classname="tests.unit.test_cache_backends" name="test_memory_cache_zero_ttl" time="0.001" /><testcase classname="tests.unit.test_cache_backends" name="test_redis_cache_backend_basic" time="0.001" /><testcase classname="tests.unit.test_cache_backends" name="test_get_cache_backend_redis_env" time="0.001" /><testcase classname="tests.unit.test_catalog_missing" name="test_catalog_missing_file_safe" time="0.005" /><testcase classname="tests.unit.test_catalog_missing" name="test_catalog_invalid_yaml_safe" time="0.014" /><testcase classname="tests.unit.test_catalog_missing" name="test_catalog_non_dict_items_filtered" time="0.016" /><testcase classname="tests.unit.test_catalog_registry" name="test_catalog_match" time="0.015" /><testcase classname="tests.unit.test_catalog_registry" name="test_catalog_no_match" time="0.007" /><testcase classname="tests.unit.test_catalog_registry" name="test_catalog_multiple_entries" time="0.016" /><testcase classname="tests.unit.test_catalog_registry" name="test_catalog_wildcard_pattern" time="0.015" /><testcase classname="tests.unit.test_catalog_registry" name="test_catalog_empty_list" time="0.014" /><testcase classname="tests.unit.test_catalog_registry" name="test_catalog_missing_file_safe" time="0.005" /><testcase classname="tests.unit.test_catalog_registry" name="test_catalog_invalid_yaml_safe" time="0.006" /><testcase classname="tests.unit.test_catalog_registry" name="test_catalog_directory_path_safe" time="0.005" /><testcase classname="tests.unit.test_chainlit_import" name="test_chainlit_app_imports" time="7.566" /><testcase classname="tests.unit.test_chainlit_import" name="test_chainlit_conditional_registration" time="0.001" /><testcase classname="tests.unit.test_classifier.TestClassifierInitialization" name="test_init_success" time="0.146" /><testcase classname="tests.unit.test_classifier.TestClassifierInitialization" name="test_init_missing_catalog" time="0.001" /><testcase classname="tests.unit.test_classifier.TestClassifierInitialization" name="test_init_missing_sector_lex" time="0.142" /><testcase classname="tests.unit.test_classifier.TestClassifyText" name="test_classify_anomalies_simple" time="0.146" /><testcase classname="tests.unit.test_classifier.TestClassifyText" name="test_classify_correlation" time="0.146" /><testcase classname="tests.unit.test_classifier.TestClassifyText" name="test_classify_root_causes" time="0.146" /><testcase classname="tests.unit.test_classifier.TestClassifyText" name="test_classify_gcc_benchmark" time="0.145" /><testcase classname="tests.unit.test_classifier.TestClassifyText" name="test_classify_vision2030" time="0.146" /><testcase classname="tests.unit.test_classifier.TestClassifyText" name="test_classify_empty_query" time="0.147" /><testcase classname="tests.unit.test_classifier.TestClassifyText" name="test_classify_multi_intent" time="0.145" /><testcase classname="tests.unit.test_classifier.TestClassifyText" name="test_classify_crisis" time="0.147" /><testcase classname="tests.unit.test_classifier.TestClassifyText" name="test_tie_within_threshold_sets_flag" time="0.147" /><testcase classname="tests.unit.test_classifier.TestClassifyText" name="test_intent_scores_are_sorted" time="0.146" /><testcase classname="tests.unit.test_classifier.TestClassifyText" name="test_default_time_horizon_reason" time="0.144" /><testcase classname="tests.unit.test_classifier.TestComplexityDetermination" name="test_simple_complexity_one_intent_one_sector" time="0.146" /><testcase classname="tests.unit.test_classifier.TestComplexityDetermination" name="test_medium_complexity_multi_sector" time="0.146" /><testcase classname="tests.unit.test_classifier.TestComplexityDetermination" name="test_complex_complexity_multi_sector_multi_metric" time="0.145" /><testcase classname="tests.unit.test_classifier.TestComplexityDetermination" name="test_crisis_with_urgency_and_recent_time" time="0.145" /><testcase classname="tests.unit.test_classifier.TestConfidenceScoring" name="test_high_confidence_clear_intent" time="0.146" /><testcase classname="tests.unit.test_classifier.TestConfidenceScoring" name="test_low_confidence_vague_query" time="0.145" /><testcase classname="tests.unit.test_classifier.TestConfidenceScoring" name="test_no_intents_zero_confidence" time="0.146"><failure message="AssertionError: assert 0.3333333333333333 == 0.0&#10; +  where 0.3333333333333333 = Classification(intents=['predict.forecast'], complexity='medium', entities=Entities(sectors=[], metrics=[], time_horiz...mplexity: medium'], intent_scores={'predict.forecast': 1.0}, elapsed_ms=0.3253000322729349, tie_within_threshold=False).confidence">self = &lt;test_classifier.TestConfidenceScoring object at 0x000001C13D89DA90&gt;
classifier = &lt;src.qnwis.orchestration.classifier.QueryClassifier object at 0x000001C143C80AD0&gt;

    def test_no_intents_zero_confidence(self, classifier: QueryClassifier) -&gt; None:
        """Test zero confidence when no intents match."""
        query = "Weather forecast for tomorrow"
        result = classifier.classify_text(query)
    
&gt;       assert result.confidence == 0.0
E       AssertionError: assert 0.3333333333333333 == 0.0
E        +  where 0.3333333333333333 = Classification(intents=['predict.forecast'], complexity='medium', entities=Entities(sectors=[], metrics=[], time_horiz...mplexity: medium'], intent_scores={'predict.forecast': 1.0}, elapsed_ms=0.3253000322729349, tie_within_threshold=False).confidence

tests\unit\test_classifier.py:232: AssertionError</failure></testcase><testcase classname="tests.unit.test_classifier.TestPIIRedaction" name="test_redact_email" time="0.144" /><testcase classname="tests.unit.test_classifier.TestPIIRedaction" name="test_redact_long_id" time="0.145" /><testcase classname="tests.unit.test_classifier.TestPIIRedaction" name="test_no_pii_unchanged" time="0.145" /><testcase classname="tests.unit.test_classifier.TestDataNeedsDetermination" name="test_data_needs_anomalies_retention" time="0.146" /><testcase classname="tests.unit.test_classifier.TestDataNeedsDetermination" name="test_data_needs_gcc_benchmark" time="0.145" /><testcase classname="tests.unit.test_classifier.TestDataNeedsDetermination" name="test_data_needs_vision2030" time="0.144" /><testcase classname="tests.unit.test_classifier.TestDataNeedsDetermination" name="test_data_needs_deduplication" time="0.144" /><testcase classname="tests.unit.test_classifier_entities.TestSectorExtraction" name="test_extract_single_sector" time="0.146" /><testcase classname="tests.unit.test_classifier_entities.TestSectorExtraction" name="test_extract_multiple_sectors" time="0.147" /><testcase classname="tests.unit.test_classifier_entities.TestSectorExtraction" name="test_no_sectors" time="0.145" /><testcase classname="tests.unit.test_classifier_entities.TestSectorExtraction" name="test_case_insensitive_sector" time="0.145" /><testcase classname="tests.unit.test_classifier_entities.TestMetricExtraction" name="test_extract_single_metric" time="0.144" /><testcase classname="tests.unit.test_classifier_entities.TestMetricExtraction" name="test_extract_multiple_metrics" time="0.145" /><testcase classname="tests.unit.test_classifier_entities.TestMetricExtraction" name="test_metric_variations" time="0.143" /><testcase classname="tests.unit.test_classifier_entities.TestMetricExtraction" name="test_no_metrics" time="0.144" /><testcase classname="tests.unit.test_classifier_entities.TestTimeHorizonExtraction" name="test_relative_months" time="0.145" /><testcase classname="tests.unit.test_classifier_entities.TestTimeHorizonExtraction" name="test_relative_years" time="0.146" /><testcase classname="tests.unit.test_classifier_entities.TestTimeHorizonExtraction" name="test_absolute_year_range" time="0.145" /><testcase classname="tests.unit.test_classifier_entities.TestTimeHorizonExtraction" name="test_absolute_since_year" time="0.144" /><testcase classname="tests.unit.test_classifier_entities.TestTimeHorizonExtraction" name="test_absolute_single_year" time="0.145" /><testcase classname="tests.unit.test_classifier_entities.TestTimeHorizonExtraction" name="test_no_time_horizon" time="0.145" /><testcase classname="tests.unit.test_classifier_entities.TestTimeHorizonExtraction" name="test_quarter_time_horizon" time="0.145" /><testcase classname="tests.unit.test_classifier_entities.TestTimeHorizonExtraction" name="test_plain_year_time_horizon" time="0.146" /><testcase classname="tests.unit.test_classifier_entities.TestTimeHorizonExtraction" name="test_recent_months" time="0.145" /><testcase classname="tests.unit.test_classifier_entities.TestConvertToMonths" name="test_convert_years" time="0.145" /><testcase classname="tests.unit.test_classifier_entities.TestConvertToMonths" name="test_convert_months" time="0.144" /><testcase classname="tests.unit.test_classifier_entities.TestConvertToMonths" name="test_convert_weeks" time="0.145" /><testcase classname="tests.unit.test_classifier_entities.TestConvertToMonths" name="test_convert_days" time="0.146" /><testcase classname="tests.unit.test_classifier_entities.TestConvertToMonths" name="test_convert_quarters" time="0.145" /><testcase classname="tests.unit.test_classifier_entities.TestConvertToMonths" name="test_convert_minimum" time="0.144" /><testcase classname="tests.unit.test_classifier_entities.TestCombinedEntityExtraction" name="test_full_extraction" time="0.145" /><testcase classname="tests.unit.test_classifier_entities.TestCombinedEntityExtraction" name="test_sorted_deduplication" time="0.145" /><testcase classname="tests.unit.test_council_purity" name="test_run_council_is_pure" time="1.708"><failure message="FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv&#10;During task with name 'run' and id 'e6c9b4ac-c400-2664-7597-d1790ffdf99f'">synthetic_data_env = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_run_council_is_pure0')

    def test_run_council_is_pure(synthetic_data_env):
        """Verify run_council produces identical results on repeated calls."""
        # Run council twice with identical config
        config = CouncilConfig(queries_dir="src/qnwis/data/queries", ttl_s=120)
&gt;       out1 = run_council(config)
               ^^^^^^^^^^^^^^^^^^^

tests\unit\test_council_purity.py:40: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\orchestration\council.py:273: in run_council
    final_state = graph_app.invoke(state)
                  ^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:3094: in invoke
    for chunk in self.stream(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:2679: in stream
    for _ in runner.tick(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_runner.py:167: in tick
    run_with_retry(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_retry.py:42: in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:656: in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:400: in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:182: in run_step
    state["reports"] = _run_agents(state["agents"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:86: in _run_agents
    reports.append(agent.run())
                   ^^^^^^^^^^^
src\qnwis\agents\labour_economist.py:40: in run
    res = self.client.run(EMPLOYMENT_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\agents\base.py:180: in run
    res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\access.py:39: in execute
    result = run_csv_query(spec)
             ^^^^^^^^^^^^^^^^^^^
src\qnwis\data\connectors\csv_catalog.py:157: in run_csv_query
    file_path = _resolve_latest_csv(parsed.pattern)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

pattern = 'employed-persons-15-years-and-above*.csv'

    def _resolve_latest_csv(pattern: str) -&gt; Path:
        if not BASE.exists():
            raise FileNotFoundError(f"CSV catalog directory missing: {BASE}")
        files = sorted(BASE.glob(pattern))
        if not files:
&gt;           raise FileNotFoundError(f"No CSV matches: {pattern}")
E           FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv
E           During task with name 'run' and id 'e6c9b4ac-c400-2664-7597-d1790ffdf99f'

src\qnwis\data\connectors\csv_catalog.py:118: FileNotFoundError</failure></testcase><testcase classname="tests.unit.test_council_purity" name="test_run_council_verification_identical" time="1.690"><failure message="FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv&#10;During task with name 'run' and id '448fdf6b-7857-d1d2-f096-531f4c5c0470'">synthetic_data_env = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_run_council_verification_0')

    def test_run_council_verification_identical(synthetic_data_env):
        """Verify verification results are identical across runs."""
        config = CouncilConfig(queries_dir="src/qnwis/data/queries", ttl_s=120)
&gt;       out1 = run_council(config)
               ^^^^^^^^^^^^^^^^^^^

tests\unit\test_council_purity.py:56: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\orchestration\council.py:273: in run_council
    final_state = graph_app.invoke(state)
                  ^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:3094: in invoke
    for chunk in self.stream(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:2679: in stream
    for _ in runner.tick(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_runner.py:167: in tick
    run_with_retry(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_retry.py:42: in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:656: in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:400: in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:182: in run_step
    state["reports"] = _run_agents(state["agents"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:86: in _run_agents
    reports.append(agent.run())
                   ^^^^^^^^^^^
src\qnwis\agents\labour_economist.py:40: in run
    res = self.client.run(EMPLOYMENT_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\agents\base.py:180: in run
    res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\access.py:39: in execute
    result = run_csv_query(spec)
             ^^^^^^^^^^^^^^^^^^^
src\qnwis\data\connectors\csv_catalog.py:157: in run_csv_query
    file_path = _resolve_latest_csv(parsed.pattern)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

pattern = 'employed-persons-15-years-and-above*.csv'

    def _resolve_latest_csv(pattern: str) -&gt; Path:
        if not BASE.exists():
            raise FileNotFoundError(f"CSV catalog directory missing: {BASE}")
        files = sorted(BASE.glob(pattern))
        if not files:
&gt;           raise FileNotFoundError(f"No CSV matches: {pattern}")
E           FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv
E           During task with name 'run' and id '448fdf6b-7857-d1d2-f096-531f4c5c0470'

src\qnwis\data\connectors\csv_catalog.py:118: FileNotFoundError</failure></testcase><testcase classname="tests.unit.test_council_purity" name="test_run_council_warnings_identical" time="1.693"><failure message="FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv&#10;During task with name 'run' and id 'ba838fdf-e40a-19ec-6a6b-175add0452e6'">synthetic_data_env = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_run_council_warnings_iden0')

    def test_run_council_warnings_identical(synthetic_data_env):
        """Verify warnings are identical across runs."""
        config = CouncilConfig(queries_dir="src/qnwis/data/queries", ttl_s=120)
&gt;       out1 = run_council(config)
               ^^^^^^^^^^^^^^^^^^^

tests\unit\test_council_purity.py:66: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\orchestration\council.py:273: in run_council
    final_state = graph_app.invoke(state)
                  ^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:3094: in invoke
    for chunk in self.stream(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:2679: in stream
    for _ in runner.tick(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_runner.py:167: in tick
    run_with_retry(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_retry.py:42: in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:656: in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:400: in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:182: in run_step
    state["reports"] = _run_agents(state["agents"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:86: in _run_agents
    reports.append(agent.run())
                   ^^^^^^^^^^^
src\qnwis\agents\labour_economist.py:40: in run
    res = self.client.run(EMPLOYMENT_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\agents\base.py:180: in run
    res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\access.py:39: in execute
    result = run_csv_query(spec)
             ^^^^^^^^^^^^^^^^^^^
src\qnwis\data\connectors\csv_catalog.py:157: in run_csv_query
    file_path = _resolve_latest_csv(parsed.pattern)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

pattern = 'employed-persons-15-years-and-above*.csv'

    def _resolve_latest_csv(pattern: str) -&gt; Path:
        if not BASE.exists():
            raise FileNotFoundError(f"CSV catalog directory missing: {BASE}")
        files = sorted(BASE.glob(pattern))
        if not files:
&gt;           raise FileNotFoundError(f"No CSV matches: {pattern}")
E           FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv
E           During task with name 'run' and id 'ba838fdf-e40a-19ec-6a6b-175add0452e6'

src\qnwis\data\connectors\csv_catalog.py:118: FileNotFoundError</failure></testcase><testcase classname="tests.unit.test_council_purity" name="test_run_council_different_ttl_produces_same_results" time="1.694"><failure message="FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv&#10;During task with name 'run' and id 'db1f6877-8887-3ab7-d2b1-8d908a5a34b5'">synthetic_data_env = WindowsPath('C:/Users/admin-salim/AppData/Local/Temp/2/pytest-of-admin-salim/pytest-200/test_run_council_different_ttl0')

    def test_run_council_different_ttl_produces_same_results(synthetic_data_env):
        """Verify different TTL values don't affect determinism."""
        # Different TTL values should produce identical results
&gt;       out1 = run_council(CouncilConfig(queries_dir="src/qnwis/data/queries", ttl_s=60))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_council_purity.py:80: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\orchestration\council.py:273: in run_council
    final_state = graph_app.invoke(state)
                  ^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:3094: in invoke
    for chunk in self.stream(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\main.py:2679: in stream
    for _ in runner.tick(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_runner.py:167: in tick
    run_with_retry(
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\pregel\_retry.py:42: in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:656: in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\admin-salim\AppData\Roaming\Python\Python311\site-packages\langgraph\_internal\_runnable.py:400: in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:182: in run_step
    state["reports"] = _run_agents(state["agents"])
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\orchestration\council.py:86: in _run_agents
    reports.append(agent.run())
                   ^^^^^^^^^^^
src\qnwis\agents\labour_economist.py:40: in run
    res = self.client.run(EMPLOYMENT_QUERY)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\agents\base.py:180: in run
    res = execute_cached(query_id, self._registry, ttl_s=self.ttl_s)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\qnwis\data\deterministic\access.py:39: in execute
    result = run_csv_query(spec)
             ^^^^^^^^^^^^^^^^^^^
src\qnwis\data\connectors\csv_catalog.py:157: in run_csv_query
    file_path = _resolve_latest_csv(parsed.pattern)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

pattern = 'employed-persons-15-years-and-above*.csv'

    def _resolve_latest_csv(pattern: str) -&gt; Path:
        if not BASE.exists():
            raise FileNotFoundError(f"CSV catalog directory missing: {BASE}")
        files = sorted(BASE.glob(pattern))
        if not files:
&gt;           raise FileNotFoundError(f"No CSV matches: {pattern}")
E           FileNotFoundError: No CSV matches: employed-persons-15-years-and-above*.csv
E           During task with name 'run' and id 'db1f6877-8887-3ab7-d2b1-8d908a5a34b5'

src\qnwis\data\connectors\csv_catalog.py:118: FileNotFoundError</failure></testcase><testcase classname="tests.unit.test_csv_catalog" name="test_csv_reader_semicolon_and_cast" time="0.017" /><testcase classname="tests.unit.test_csv_catalog" name="test_csv_reader_to_percent_and_max_rows" time="0.014" /><testcase classname="tests.unit.test_csv_catalog" name="test_csv_reader_timeout" time="0.015" /><testcase classname="tests.unit.test_csv_catalog" name="test_csv_reader_no_rows" time="0.014" /><testcase classname="tests.unit.test_csv_catalog" name="test_csv_reader_casts_thousands_separator" time="0.015" /><testcase classname="tests.unit.test_csv_catalog" name="test_csv_reader_invalid_max_rows" time="0.004" /><testcase classname="tests.unit.test_data_api_client_analytics.TestTopLists" name="test_top_lists_and_derived" time="1.697" /><testcase classname="tests.unit.test_data_api_client_analytics.TestTopLists" name="test_top_sectors_by_employment_ordering" time="1.687" /><testcase classname="tests.unit.test_data_api_client_analytics.TestTopLists" name="test_top_sectors_by_salary_ordering" time="1.689" /><testcase classname="tests.unit.test_data_api_client_analytics.TestTopLists" name="test_attrition_hotspots_ordering" time="1.693" /><testcase classname="tests.unit.test_data_api_client_analytics.TestYoYCalculations" name="test_yoy_salary_by_sector" time="1.692" /><testcase classname="tests.unit.test_data_api_client_analytics.TestYoYCalculations" name="test_yoy_employment_growth_by_sector" time="1.691" /><testcase classname="tests.unit.test_data_api_client_analytics.TestYoYCalculations" name="test_yoy_handles_single_year" time="1.691" /><testcase classname="tests.unit.test_data_api_client_analytics.TestDerivedMetrics" name="test_qatarization_gap_by_sector" time="1.698" /><testcase classname="tests.unit.test_data_api_client_analytics.TestDerivedMetrics" name="test_early_warning_hotlist_threshold" time="1.696" /><testcase classname="tests.unit.test_data_api_client_analytics.TestDerivedMetrics" name="test_early_warning_hotlist_top_n_limit" time="1.689" /><testcase classname="tests.unit.test_data_api_client_analytics.TestEmptyResults" name="test_top_lists_with_zero_results" time="1.685" /><testcase classname="tests.unit.test_data_api_client_analytics.TestEmptyResults" name="test_yoy_with_no_historical_data" time="1.697" /><testcase classname="tests.unit.test_data_api_client_core.TestAliasResolution" name="test_alias_resolution_and_param_override" time="1.696" /><testcase classname="tests.unit.test_data_api_client_core.TestAliasResolution" name="test_unemployment_alias_resolution" time="1.686" /><testcase classname="tests.unit.test_data_api_client_core.TestAliasResolution" name="test_alias_prefers_synthetic_queries_when_available" time="1.680" /><testcase classname="tests.unit.test_data_api_client_core.TestAliasResolution" name="test_resolve_direct_query_id" time="1.684" /><testcase classname="tests.unit.test_data_api_client_core.TestAliasResolution" name="test_resolve_partial_match_fallback" time="1.681" /><testcase classname="tests.unit.test_data_api_client_core.TestParameterValidation" name="test_year_parameter_coercion" time="1.684" /><testcase classname="tests.unit.test_data_api_client_core.TestParameterValidation" name="test_optional_year_parameter" time="1.683" /><testcase classname="tests.unit.test_data_api_client_core.TestTypeSafety" name="test_employment_share_returns_typed_models" time="1.691" /><testcase classname="tests.unit.test_data_api_client_core.TestTypeSafety" name="test_unemployment_returns_typed_models" time="1.687" /><testcase classname="tests.unit.test_data_api_client_core.TestTypeSafety" name="test_qatarization_returns_typed_models" time="1.686" /><testcase classname="tests.unit.test_data_api_client_core.TestGenderShareInference" name="test_male_share_infers_female" time="1.686" /><testcase classname="tests.unit.test_data_api_client_core.TestGenderShareInference" name="test_female_share_infers_male" time="1.688" /><testcase classname="tests.unit.test_data_api_client_core.TestCacheIntegration" name="test_repeated_calls_use_cache" time="1.692" /><testcase classname="tests.unit.test_data_api_client_core.TestUnemploymentHelpers" name="test_unemployment_qatar_returns_match" time="1.680" /><testcase classname="tests.unit.test_data_api_client_core.TestUnemploymentHelpers" name="test_unemployment_qatar_returns_none_when_missing" time="1.684" /><testcase classname="tests.unit.test_data_api_client_core.TestParameterOverrides" name="test_year_overrides_work_consistently" time="1.694" /><testcase classname="tests.unit.test_data_api_client_core.TestParameterOverrides" name="test_param_overrides_do_not_mutate_registry" time="1.685" /><testcase classname="tests.unit.test_data_api_client_core.TestUtilities" name="test_latest_year_returns_max_year" time="1.701" /><testcase classname="tests.unit.test_data_api_client_core.TestUtilities" name="test_latest_year_unresolved_key_raises" time="1.686" /><testcase classname="tests.unit.test_data_api_client_core.TestUtilities" name="test_latest_year_handles_invalid_values" time="1.688" /><testcase classname="tests.unit.test_data_api_client_core.TestUtilities" name="test_to_dataframe_requires_pandas" time="0.001" /><testcase classname="tests.unit.test_data_api_client_core.TestUtilities" name="test_to_dataframe_converts_rows" time="0.001" /><testcase classname="tests.unit.test_data_api_client_core.TestUtilities" name="test_to_dataframe_handles_empty_input" time="0.001" /><testcase classname="tests.unit.test_data_api_client_core.TestUtilities" name="test_to_dataframe_accepts_mapping_rows" time="0.001" /><testcase classname="tests.unit.test_data_api_client_core.TestUtilities" name="test_to_dataframe_accepts_legacy_models" time="0.001" /><testcase classname="tests.unit.test_data_api_client_core.TestUtilities" name="test_to_dataframe_accepts_dataclasses" time="0.002" /><testcase classname="tests.unit.test_data_api_client_core.TestUtilities" name="test_to_dataframe_rejects_unknown_types" time="0.001" /><testcase classname="tests.unit.test_data_api_models.TestEmploymentShareRow" name="test_employment_share_row_validates" time="0.001" /><testcase classname="tests.unit.test_data_api_models.TestEmploymentShareRow" name="test_employment_share_row_rejects_missing_field" time="0.001" /><testcase classname="tests.unit.test_data_api_models.TestEmploymentShareRow" name="test_employment_share_row_serialization" time="0.001" /><testcase classname="tests.unit.test_data_api_models.TestUnemploymentRow" name="test_unemployment_row_validates" time="0.001" /><testcase classname="tests.unit.test_data_api_models.TestUnemploymentRow" name="test_unemployment_row_rejects_missing_country" time="0.001" /><testcase classname="tests.unit.test_data_api_models.TestQatarizationRow" name="test_qatarization_row_validates" time="0.001" /><testcase classname="tests.unit.test_data_api_models.TestQatarizationRow" name="test_qatarization_row_rejects_negative_counts" time="0.001" /><testcase classname="tests.unit.test_data_api_models.TestAvgSalaryRow" name="test_avg_salary_row_validates" time="0.001" /><testcase classname="tests.unit.test_data_api_models.TestAvgSalaryRow" name="test_avg_salary_row_rejects_negative_salary" time="0.001" /><testcase classname="tests.unit.test_data_api_models.TestAttritionRow" name="test_attrition_row_validates" time="0.001" /><testcase classname="tests.unit.test_data_api_models.TestCompanySizeRow" name="test_company_size_row_validates" time="0.001" /><testcase classname="tests.unit.test_data_api_models.TestSectorEmploymentRow" name="test_sector_employment_row_validates" time="0.001" /><testcase classname="tests.unit.test_data_api_models.TestEwiRow" name="test_ewi_row_validates" time="0.001" /><testcase classname="tests.unit.test_data_api_models.TestEwiRow" name="test_ewi_row_accepts_zero_drop" time="0.001" /><testcase classname="tests.unit.test_execute_cached" name="test_key_for_deterministic" time="0.001" /><testcase classname="tests.unit.test_execute_cached" name="test_key_for_different_params" time="0.001" /><testcase classname="tests.unit.test_execute_cached" name="test_execute_cached_uses_cache" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C143E37750&gt;

    def test_execute_cached_uses_cache(monkeypatch):
        """Test that execute_cached uses cache on second call."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            expected_unit="percent",
            params={"pattern": "x.csv"},
        )
    
        class MockRegistry:
            def get(self, _):
                return spec
    
        reg = MockRegistry()
        called = {"n": 0}
    
        def fake_execute(query_id, registry, spec_override=None):
            called["n"] += 1
            return QueryResult(
                query_id="q",
                rows=[
                    Row(
                        data={
                            "year": 2023,
                            "male_percent": 60.0,
                            "female_percent": 40.0,
                        }
                    )
                ],
                unit="percent",
                provenance=Provenance(
                    source="csv",
                    dataset_id="x",
                    locator="x.csv",
                    fields=["year", "male_percent", "female_percent"],
                ),
                freshness=Freshness(asof_date="auto"),
            )
    
        # Create shared cache backend instance
        cache_backend = MemoryCacheBackend()
    
        monkeypatch.setattr(cache_module, "execute_uncached", fake_execute)
        # Force memory backend - return same instance every time
        monkeypatch.setattr(cache_module, "get_cache_backend", lambda: cache_backend)
    
        # First call populates cache
&gt;       _ = execute_cached("q", reg, ttl_s=300)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_execute_cached.py:112: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

query_id = 'q'
registry = &lt;test_execute_cached.test_execute_cached_uses_cache.&lt;locals&gt;.MockRegistry object at 0x000001C143E36050&gt;
spec_override = QuerySpec(id='q', title='t', description='d', source='csv', params={'pattern': 'x.csv'}, expected_unit='percent', constraints={}, postprocess=[])

    def fake_execute(query_id, registry, spec_override=None):
        called["n"] += 1
        return QueryResult(
            query_id="q",
            rows=[
                Row(
                    data={
                        "year": 2023,
                        "male_percent": 60.0,
                        "female_percent": 40.0,
                    }
                )
            ],
            unit="percent",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=["year", "male_percent", "female_percent"],
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_execute_cached.py:101: ValidationError</failure></testcase><testcase classname="tests.unit.test_execute_cached" name="test_execute_cached_invalidate_forces_refetch" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C143EB09D0&gt;

    def test_execute_cached_invalidate_forces_refetch(monkeypatch):
        """Test that invalidate=True forces cache bypass."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            expected_unit="percent",
            params={"pattern": "x.csv"},
        )
    
        class MockRegistry:
            def get(self, _):
                return spec
    
        reg = MockRegistry()
        called = {"n": 0}
    
        def fake_execute(query_id, registry, spec_override=None):
            called["n"] += 1
            return QueryResult(
                query_id="q",
                rows=[Row(data={"year": 2023, "value": called["n"]})],
                unit="percent",
                provenance=Provenance(
                    source="csv",
                    dataset_id="x",
                    locator="x.csv",
                    fields=["year", "value"],
                ),
                freshness=Freshness(asof_date="auto"),
            )
    
        # Create shared cache backend instance
        cache_backend = MemoryCacheBackend()
    
        monkeypatch.setattr(cache_module, "execute_uncached", fake_execute)
        monkeypatch.setattr(cache_module, "get_cache_backend", lambda: cache_backend)
    
        # First call
&gt;       first = execute_cached("q", reg, ttl_s=300)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_execute_cached.py:162: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

query_id = 'q'
registry = &lt;test_execute_cached.test_execute_cached_invalidate_forces_refetch.&lt;locals&gt;.MockRegistry object at 0x000001C143EB0910&gt;
spec_override = QuerySpec(id='q', title='t', description='d', source='csv', params={'pattern': 'x.csv'}, expected_unit='percent', constraints={}, postprocess=[])

    def fake_execute(query_id, registry, spec_override=None):
        called["n"] += 1
        return QueryResult(
            query_id="q",
            rows=[Row(data={"year": 2023, "value": called["n"]})],
            unit="percent",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=["year", "value"],
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_execute_cached.py:152: ValidationError</failure></testcase><testcase classname="tests.unit.test_execute_cached" name="test_execute_cached_ttl_zero_disables_cache" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C14420A390&gt;

    def test_execute_cached_ttl_zero_disables_cache(monkeypatch):
        """TTL of zero should bypass cache storage."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            expected_unit="percent",
            params={"pattern": "x.csv"},
        )
    
        class MockRegistry:
            def get(self, _):
                return spec
    
        reg = MockRegistry()
        calls = {"n": 0}
    
        def fake_execute(query_id, registry, spec_override=None):
            calls["n"] += 1
            return QueryResult(
                query_id="q",
                rows=[Row(data={"year": 2023, "value": calls["n"]})],
                unit="percent",
                provenance=Provenance(
                    source="csv",
                    dataset_id="x",
                    locator="x.csv",
                    fields=["year", "value"],
                ),
                freshness=Freshness(asof_date="auto"),
            )
    
        cache_backend = MemoryCacheBackend()
        monkeypatch.setattr(cache_module, "execute_uncached", fake_execute)
        monkeypatch.setattr(cache_module, "get_cache_backend", lambda: cache_backend)
    
&gt;       result1 = execute_cached("q", reg, ttl_s=0)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_execute_cached.py:211: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

query_id = 'q'
registry = &lt;test_execute_cached.test_execute_cached_ttl_zero_disables_cache.&lt;locals&gt;.MockRegistry object at 0x000001C14420A7D0&gt;
spec_override = QuerySpec(id='q', title='t', description='d', source='csv', params={'pattern': 'x.csv'}, expected_unit='percent', constraints={}, postprocess=[])

    def fake_execute(query_id, registry, spec_override=None):
        calls["n"] += 1
        return QueryResult(
            query_id="q",
            rows=[Row(data={"year": 2023, "value": calls["n"]})],
            unit="percent",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=["year", "value"],
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_execute_cached.py:204: ValidationError</failure></testcase><testcase classname="tests.unit.test_execute_cached" name="test_execute_cached_rejects_ttl_above_24h" time="0.001" /><testcase classname="tests.unit.test_execute_cached" name="test_execute_cached_compresses_large_payload" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C143E37410&gt;

    def test_execute_cached_compresses_large_payload(monkeypatch):
        """Large payloads are compressed with zlib in the cache."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            expected_unit="percent",
            params={"pattern": "x.csv"},
        )
    
        class MockRegistry:
            def get(self, _):
                return spec
    
        reg = MockRegistry()
        calls = {"n": 0}
        payload = "x" * (cache_module.COMPRESS_THRESHOLD_BYTES + 1024)
    
        def fake_execute(query_id, registry, spec_override=None):
            calls["n"] += 1
            return QueryResult(
                query_id="q",
                rows=[Row(data={"blob": payload})],
                unit="percent",
                provenance=Provenance(
                    source="csv",
                    dataset_id="x",
                    locator="x.csv",
                    fields=["blob"],
                ),
                freshness=Freshness(asof_date="auto"),
            )
    
        cache_backend = MemoryCacheBackend()
        monkeypatch.setattr(cache_module, "execute_uncached", fake_execute)
        monkeypatch.setattr(cache_module, "get_cache_backend", lambda: cache_backend)
    
&gt;       _ = execute_cached("q", reg, ttl_s=300)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_execute_cached.py:283: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

query_id = 'q'
registry = &lt;test_execute_cached.test_execute_cached_compresses_large_payload.&lt;locals&gt;.MockRegistry object at 0x000001C143E37210&gt;
spec_override = QuerySpec(id='q', title='t', description='d', source='csv', params={'pattern': 'x.csv'}, expected_unit='percent', constraints={}, postprocess=[])

    def fake_execute(query_id, registry, spec_override=None):
        calls["n"] += 1
        return QueryResult(
            query_id="q",
            rows=[Row(data={"blob": payload})],
            unit="percent",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=["blob"],
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_execute_cached.py:276: ValidationError</failure></testcase><testcase classname="tests.unit.test_execute_cached" name="test_invalidate_query_helper" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C143E216D0&gt;

    def test_invalidate_query_helper(monkeypatch):
        """invalidate_query removes cached entries."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            expected_unit="percent",
            params={"pattern": "x.csv"},
        )
    
        class MockRegistry:
            def get(self, _):
                return spec
    
        reg = MockRegistry()
    
        def fake_execute(query_id, registry, spec_override=None):
            return QueryResult(
                query_id="q",
                rows=[Row(data={"value": 1})],
                unit="percent",
                provenance=Provenance(
                    source="csv",
                    dataset_id="x",
                    locator="x.csv",
                    fields=["value"],
                ),
                freshness=Freshness(asof_date="auto"),
            )
    
        cache_backend = MemoryCacheBackend()
        monkeypatch.setattr(cache_module, "execute_uncached", fake_execute)
        monkeypatch.setattr(cache_module, "get_cache_backend", lambda: cache_backend)
    
&gt;       execute_cached("q", reg, ttl_s=300)

tests\unit\test_execute_cached.py:332: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

query_id = 'q'
registry = &lt;test_execute_cached.test_invalidate_query_helper.&lt;locals&gt;.MockRegistry object at 0x000001C143E21D50&gt;
spec_override = QuerySpec(id='q', title='t', description='d', source='csv', params={'pattern': 'x.csv'}, expected_unit='percent', constraints={}, postprocess=[])

    def fake_execute(query_id, registry, spec_override=None):
        return QueryResult(
            query_id="q",
            rows=[Row(data={"value": 1})],
            unit="percent",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=["value"],
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_execute_cached.py:325: ValidationError</failure></testcase><testcase classname="tests.unit.test_execute_cached_metrics" name="test_cache_hit_miss_and_invalidate" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C144276410&gt;

    def test_cache_hit_miss_and_invalidate(monkeypatch):
        """Test cache hit/miss counters and invalidate_query helper."""
        # Reset counters
        COUNTERS["hits"] = 0
        COUNTERS["misses"] = 0
        COUNTERS["invalidations"] = 0
    
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={"pattern": "x.csv"},
        )
        reg = type("R", (object,), {"get": lambda self, _: spec})()
        store = MemoryCacheBackend()
        calls = {"n": 0}
    
        def fake_uncached(qid, r, spec_override=None):
            calls["n"] += 1
            return _fake_result(rows=5)
    
        monkeypatch.setattr(cache_module, "execute_uncached", fake_uncached)
        monkeypatch.setattr(cache_module, "get_cache_backend", lambda: store)
    
        # miss -&gt; populate
&gt;       _ = execute_cached("q", reg, ttl_s=300)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_execute_cached_metrics.py:64: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests\unit\test_execute_cached_metrics.py:58: in fake_uncached
    return _fake_result(rows=5)
           ^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

rows = 5, year = 2022

    def _fake_result(rows=50, year=2022):
        """Create a fake query result with specified number of rows."""
        return QueryResult(
            query_id="q",
            rows=[Row(data={"year": year, "v": i}) for i in range(rows)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=["year", "v"],
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_execute_cached_metrics.py:34: ValidationError</failure></testcase><testcase classname="tests.unit.test_execute_cached_metrics" name="test_cache_compression_large_payload" time="0.002"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C1439A0BD0&gt;

    def test_cache_compression_large_payload(monkeypatch):
        """Large payloads trigger compression path (&gt;=8KB)."""
        # Reset counters
        COUNTERS["hits"] = 0
        COUNTERS["misses"] = 0
        COUNTERS["invalidations"] = 0
    
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={"pattern": "x.csv"},
        )
        reg = type("R", (object,), {"get": lambda self, _: spec})()
        store = MemoryCacheBackend()
    
        def fake_uncached(qid, r, spec_override=None):
            # many rows to exceed compression threshold
            return _fake_result(rows=500, year=2020)
    
        monkeypatch.setattr(cache_module, "execute_uncached", fake_uncached)
        monkeypatch.setattr(cache_module, "get_cache_backend", lambda: store)
    
&gt;       r = execute_cached("q", reg, ttl_s=300)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_execute_cached_metrics.py:108: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests\unit\test_execute_cached_metrics.py:103: in fake_uncached
    return _fake_result(rows=500, year=2020)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

rows = 500, year = 2020

    def _fake_result(rows=50, year=2022):
        """Create a fake query result with specified number of rows."""
        return QueryResult(
            query_id="q",
            rows=[Row(data={"year": year, "v": i}) for i in range(rows)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=["year", "v"],
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_execute_cached_metrics.py:34: ValidationError</failure></testcase><testcase classname="tests.unit.test_execute_cached_metrics" name="test_ttl_zero_disables_caching" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C1442C16D0&gt;

    def test_ttl_zero_disables_caching(monkeypatch):
        """TTL of zero bypasses cache storage."""
        # Reset counters
        COUNTERS["hits"] = 0
        COUNTERS["misses"] = 0
        COUNTERS["invalidations"] = 0
    
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={"pattern": "x.csv"},
        )
        reg = type("R", (object,), {"get": lambda self, _: spec})()
        store = MemoryCacheBackend()
        calls = {"n": 0}
    
        def fake_uncached(qid, r, spec_override=None):
            calls["n"] += 1
            return _fake_result()
    
        monkeypatch.setattr(cache_module, "execute_uncached", fake_uncached)
        monkeypatch.setattr(cache_module, "get_cache_backend", lambda: store)
    
&gt;       execute_cached("q", reg, ttl_s=0)

tests\unit\test_execute_cached_metrics.py:144: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests\unit\test_execute_cached_metrics.py:139: in fake_uncached
    return _fake_result()
           ^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

rows = 50, year = 2022

    def _fake_result(rows=50, year=2022):
        """Create a fake query result with specified number of rows."""
        return QueryResult(
            query_id="q",
            rows=[Row(data={"year": year, "v": i}) for i in range(rows)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=["year", "v"],
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_execute_cached_metrics.py:34: ValidationError</failure></testcase><testcase classname="tests.unit.test_execute_cached_metrics" name="test_ttl_capping_24h" time="0.001" /><testcase classname="tests.unit.test_execute_cached_metrics" name="test_ttl_none_stores_without_expiration" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C143F30FD0&gt;

    def test_ttl_none_stores_without_expiration(monkeypatch):
        """TTL of None stores result without expiration."""
        # Reset counters
        COUNTERS["hits"] = 0
        COUNTERS["misses"] = 0
    
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={"pattern": "x.csv"},
        )
        reg = type("R", (object,), {"get": lambda self, _: spec})()
        store = MemoryCacheBackend()
    
        def fake_uncached(qid, r, spec_override=None):
            return _fake_result(rows=3)
    
        monkeypatch.setattr(cache_module, "execute_uncached", fake_uncached)
        monkeypatch.setattr(cache_module, "get_cache_backend", lambda: store)
    
&gt;       r1 = execute_cached("q", reg, ttl_s=None)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_execute_cached_metrics.py:197: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\qnwis\data\deterministic\cache_access.py:229: in execute_cached
    res = execute_uncached(query_id, registry, spec_override=spec)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests\unit\test_execute_cached_metrics.py:192: in fake_uncached
    return _fake_result(rows=3)
           ^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

rows = 3, year = 2022

    def _fake_result(rows=50, year=2022):
        """Create a fake query result with specified number of rows."""
        return QueryResult(
            query_id="q",
            rows=[Row(data={"year": year, "v": i}) for i in range(rows)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=["year", "v"],
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_execute_cached_metrics.py:34: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness" name="test_freshness_no_sla_no_warnings" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_no_sla_no_warnings():
        """Test that no warnings are generated when no SLA is set."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
        )
        res = QueryResult(
            query_id="q",
            rows=[Row(data={"year": 2020})],
            unit="count",
            provenance=Provenance(
                source="csv", dataset_id="x", locator="x.csv", fields=["year"]
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness.py:33: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness" name="test_freshness_sla_violation" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_sla_violation():
        """Test that stale_data warning is generated when SLA is violated."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 30},
        )
        res = QueryResult(
            query_id="q",
            rows=[Row(data={"year": 2020})],
            unit="count",
            provenance=Provenance(
                source="csv", dataset_id="x", locator="x.csv", fields=["year"]
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness.py:56: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness" name="test_freshness_sla_passes" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_sla_passes():
        """Test that no warning when data is fresh enough."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 365},
        )
        res = QueryResult(
            query_id="q",
            rows=[Row(data={"date": "2024-12-15"})],
            unit="count",
            provenance=Provenance(
                source="csv", dataset_id="x", locator="x.csv", fields=["date"]
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness.py:80: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness" name="test_freshness_unknown_when_no_date" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_unknown_when_no_date():
        """Test that freshness_unknown is returned when as-of date cannot be derived."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 30},
        )
        res = QueryResult(
            query_id="q",
            rows=[Row(data={"value": 100})],
            unit="count",
            provenance=Provenance(
                source="csv", dataset_id="x", locator="x.csv", fields=["value"]
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness.py:104: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness" name="test_freshness_derives_from_year" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_derives_from_year():
        """Test that freshness derives as-of date from year column."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 365},
        )
        res = QueryResult(
            query_id="q",
            rows=[Row(data={"year": 2024}), Row(data={"year": 2023})],
            unit="count",
            provenance=Provenance(
                source="csv", dataset_id="x", locator="x.csv", fields=["year"]
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness.py:127: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness" name="test_freshness_explicit_asof_date" time="0.001" /><testcase classname="tests.unit.test_freshness" name="test_freshness_year_string_deduces_year_end" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: '2023' [type=value_error, input_value='2023', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_year_string_deduces_year_end():
        """Year-only as-of dates are normalized to year-end for SLA checks."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 30},
        )
        res = QueryResult(
            query_id="q",
            rows=[Row(data={"value": 1})],
            unit="count",
            provenance=Provenance(
                source="csv", dataset_id="x", locator="x.csv", fields=["value"]
            ),
&gt;           freshness=Freshness(asof_date="2023"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: '2023' [type=value_error, input_value='2023', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness.py:177: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness" name="test_freshness_handles_iso_datetime_strings" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_handles_iso_datetime_strings():
        """Datetime strings with Z suffix should parse correctly."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 365},
        )
        res = QueryResult(
            query_id="q",
            rows=[Row(data={"date": "2024-12-15T00:00:00Z"})],
            unit="count",
            provenance=Provenance(
                source="csv", dataset_id="x", locator="x.csv", fields=["date"]
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness.py:201: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness" name="test_freshness_year_column_float_parses" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_year_column_float_parses():
        """Year column values as floats are supported."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 365},
        )
        res = QueryResult(
            query_id="q",
            rows=[Row(data={"year": "2024.0"})],
            unit="count",
            provenance=Provenance(
                source="csv", dataset_id="x", locator="x.csv", fields=["year"]
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness.py:225: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness" name="test_freshness_invalid_sla_value" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_invalid_sla_value():
        """Invalid SLA constraint produces configuration warning."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": "not-a-number"},
        )
        res = QueryResult(
            query_id="q",
            rows=[Row(data={"year": 2024})],
            unit="count",
            provenance=Provenance(
                source="csv", dataset_id="x", locator="x.csv", fields=["year"]
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness.py:249: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness" name="test_freshness_parse_error_warning" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'not-a-date' [type=value_error, input_value='not-a-date', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_parse_error_warning():
        """Unparseable as-of date triggers parse error warning."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 10},
        )
        res = QueryResult(
            query_id="q",
            rows=[Row(data={"value": 1})],
            unit="count",
            provenance=Provenance(
                source="csv", dataset_id="x", locator="x.csv", fields=["value"]
            ),
&gt;           freshness=Freshness(asof_date="not-a-date"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'not-a-date' [type=value_error, input_value='not-a-date', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness.py:272: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness" name="test_freshness_year_column_string" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = None

    def test_freshness_year_column_string(monkeypatch=None):
        """String year values in rows derive year-end date."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 90},
        )
        res = QueryResult(
            query_id="q",
            rows=[Row(data={"year": "2024"})],
            unit="count",
            provenance=Provenance(
                source="csv", dataset_id="x", locator="x.csv", fields=["year"]
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness.py:295: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness" name="test_freshness_iso_asof_string" time="0.001" /><testcase classname="tests.unit.test_freshness_edges" name="test_freshness_bad_date_string" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_bad_date_string():
        """Invalid date string triggers parse error warning."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 10},
        )
&gt;       res = _mk_res({"date": "2021-13-99"})  # invalid date
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_freshness_edges.py:43: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

data = {'date': '2021-13-99'}, asof = 'auto'

    def _mk_res(data, asof="auto"):
        """Helper to create QueryResult with given data."""
        return QueryResult(
            query_id="q",
            rows=[Row(data=data)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=list(data.keys()),
            ),
&gt;           freshness=Freshness(asof_date=asof),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness_edges.py:29: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness_edges" name="test_freshness_string_year_normalized" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_string_year_normalized():
        """String year values are parsed correctly."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 365},
        )
&gt;       res = _mk_res({"year": "2023"})
              ^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_freshness_edges.py:59: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

data = {'year': '2023'}, asof = 'auto'

    def _mk_res(data, asof="auto"):
        """Helper to create QueryResult with given data."""
        return QueryResult(
            query_id="q",
            rows=[Row(data=data)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=list(data.keys()),
            ),
&gt;           freshness=Freshness(asof_date=asof),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness_edges.py:29: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness_edges" name="test_freshness_float_year_supported" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_float_year_supported():
        """Float year values (e.g., 2024.0) are supported."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 365},
        )
&gt;       res = _mk_res({"year": 2024.0})
              ^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_freshness_edges.py:75: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

data = {'year': 2024.0}, asof = 'auto'

    def _mk_res(data, asof="auto"):
        """Helper to create QueryResult with given data."""
        return QueryResult(
            query_id="q",
            rows=[Row(data=data)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=list(data.keys()),
            ),
&gt;           freshness=Freshness(asof_date=asof),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness_edges.py:29: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness_edges" name="test_freshness_invalid_sla_value" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_invalid_sla_value():
        """Invalid SLA constraint produces warning."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": "not-a-number"},
        )
&gt;       res = _mk_res({"year": 2024})
              ^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_freshness_edges.py:91: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

data = {'year': 2024}, asof = 'auto'

    def _mk_res(data, asof="auto"):
        """Helper to create QueryResult with given data."""
        return QueryResult(
            query_id="q",
            rows=[Row(data=data)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=list(data.keys()),
            ),
&gt;           freshness=Freshness(asof_date=asof),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness_edges.py:29: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness_edges" name="test_freshness_negative_sla_invalid" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_negative_sla_invalid():
        """Negative SLA days treated as invalid."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": -10},
        )
&gt;       res = _mk_res({"year": 2024})
              ^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_freshness_edges.py:106: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

data = {'year': 2024}, asof = 'auto'

    def _mk_res(data, asof="auto"):
        """Helper to create QueryResult with given data."""
        return QueryResult(
            query_id="q",
            rows=[Row(data=data)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=list(data.keys()),
            ),
&gt;           freshness=Freshness(asof_date=asof),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness_edges.py:29: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness_edges" name="test_freshness_explicit_unparseable_date" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'not-a-date' [type=value_error, input_value='not-a-date', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_explicit_unparseable_date():
        """Explicit unparseable as-of date triggers parse error."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 10},
        )
&gt;       res = _mk_res({"value": 1}, asof="not-a-date")
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_freshness_edges.py:121: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

data = {'value': 1}, asof = 'not-a-date'

    def _mk_res(data, asof="auto"):
        """Helper to create QueryResult with given data."""
        return QueryResult(
            query_id="q",
            rows=[Row(data=data)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=list(data.keys()),
            ),
&gt;           freshness=Freshness(asof_date=asof),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'not-a-date' [type=value_error, input_value='not-a-date', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness_edges.py:29: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness_edges" name="test_freshness_datetime_with_z_suffix" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_datetime_with_z_suffix():
        """Datetime strings with Z suffix are parsed correctly."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 365},
        )
&gt;       res = _mk_res({"date": "2024-12-15T00:00:00Z"})
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_freshness_edges.py:136: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

data = {'date': '2024-12-15T00:00:00Z'}, asof = 'auto'

    def _mk_res(data, asof="auto"):
        """Helper to create QueryResult with given data."""
        return QueryResult(
            query_id="q",
            rows=[Row(data=data)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=list(data.keys()),
            ),
&gt;           freshness=Freshness(asof_date=asof),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness_edges.py:29: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness_edges" name="test_freshness_year_only_string" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: '2023' [type=value_error, input_value='2023', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_year_only_string():
        """Four-digit year string is normalized to year-end."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 30},
        )
&gt;       res = _mk_res({"value": 1}, asof="2023")
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_freshness_edges.py:152: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

data = {'value': 1}, asof = '2023'

    def _mk_res(data, asof="auto"):
        """Helper to create QueryResult with given data."""
        return QueryResult(
            query_id="q",
            rows=[Row(data=data)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=list(data.keys()),
            ),
&gt;           freshness=Freshness(asof_date=asof),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: '2023' [type=value_error, input_value='2023', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness_edges.py:29: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness_edges" name="test_freshness_empty_string_asof" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: '' [type=value_error, input_value='', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_empty_string_asof():
        """Empty string as-of date triggers parse error or unknown."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 10},
        )
&gt;       res = _mk_res({"value": 1}, asof="")
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_freshness_edges.py:168: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

data = {'value': 1}, asof = ''

    def _mk_res(data, asof="auto"):
        """Helper to create QueryResult with given data."""
        return QueryResult(
            query_id="q",
            rows=[Row(data=data)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=list(data.keys()),
            ),
&gt;           freshness=Freshness(asof_date=asof),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: '' [type=value_error, input_value='', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness_edges.py:29: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness_edges" name="test_freshness_multiple_rows_takes_max_year" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_multiple_rows_takes_max_year():
        """When multiple rows have years, uses max year for as-of."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 365},
        )
        res = QueryResult(
            query_id="q",
            rows=[
                Row(data={"year": 2020}),
                Row(data={"year": 2024}),
                Row(data={"year": 2022}),
            ],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=["year"],
            ),
&gt;           freshness=Freshness(asof_date="auto"),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness_edges.py:198: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness_edges" name="test_freshness_year_below_supported_range" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_year_below_supported_range():
        """Years below 1000 are ignored leading to unknown freshness."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 30},
        )
&gt;       res = _mk_res({"year": 999})
              ^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_freshness_edges.py:215: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

data = {'year': 999}, asof = 'auto'

    def _mk_res(data, asof="auto"):
        """Helper to create QueryResult with given data."""
        return QueryResult(
            query_id="q",
            rows=[Row(data=data)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=list(data.keys()),
            ),
&gt;           freshness=Freshness(asof_date=asof),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness_edges.py:29: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness_edges" name="test_freshness_non_numeric_year_string" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_non_numeric_year_string():
        """Non-numeric year strings do not trigger parse errors."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 30},
        )
&gt;       res = _mk_res({"year": "twenty-twenty"})
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_freshness_edges.py:230: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

data = {'year': 'twenty-twenty'}, asof = 'auto'

    def _mk_res(data, asof="auto"):
        """Helper to create QueryResult with given data."""
        return QueryResult(
            query_id="q",
            rows=[Row(data=data)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=list(data.keys()),
            ),
&gt;           freshness=Freshness(asof_date=asof),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness_edges.py:29: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness_edges" name="test_freshness_auto_sentinel_skips_parse_error" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'API' [type=value_error, input_value='API', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">def test_freshness_auto_sentinel_skips_parse_error():
        """Explicit 'API' sentinel behaves as auto without warnings."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 30},
        )
&gt;       res = _mk_res({"value": 1}, asof="API")
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_freshness_edges.py:245: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

data = {'value': 1}, asof = 'API'

    def _mk_res(data, asof="auto"):
        """Helper to create QueryResult with given data."""
        return QueryResult(
            query_id="q",
            rows=[Row(data=data)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=list(data.keys()),
            ),
&gt;           freshness=Freshness(asof_date=asof),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'API' [type=value_error, input_value='API', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness_edges.py:29: ValidationError</failure></testcase><testcase classname="tests.unit.test_freshness_edges" name="test_freshness_guess_invalid_asof_triggers_parse" time="0.001"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C143E772D0&gt;

    def test_freshness_guess_invalid_asof_triggers_parse(monkeypatch):
        """If guess returns invalid ISO date, parse guard emits warning."""
        spec = QuerySpec(
            id="q",
            title="t",
            description="d",
            source="csv",
            params={},
            constraints={"freshness_sla_days": 30},
        )
&gt;       res = _mk_res({"value": 1})
              ^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_freshness_edges.py:261: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

data = {'value': 1}, asof = 'auto'

    def _mk_res(data, asof="auto"):
        """Helper to create QueryResult with given data."""
        return QueryResult(
            query_id="q",
            rows=[Row(data=data)],
            unit="count",
            provenance=Provenance(
                source="csv",
                dataset_id="x",
                locator="x.csv",
                fields=list(data.keys()),
            ),
&gt;           freshness=Freshness(asof_date=asof),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'auto' [type=value_error, input_value='auto', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

tests\unit\test_freshness_edges.py:29: ValidationError</failure></testcase><testcase classname="tests.unit.test_metrics" name="test_share_of_total_basic" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_share_of_total_multiple_years" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_share_of_total_custom_out_key" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_share_of_total_none_values" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_share_of_total_string_numbers" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_yoy_growth_basic" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_yoy_growth_decline" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_yoy_growth_first_year" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_yoy_growth_multiple_years" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_yoy_growth_custom_out_key" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_yoy_growth_zero_previous" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_share_of_total_non_numeric_values" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_yoy_growth_non_numeric_values" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_cagr_basic" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_cagr_one_year" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_cagr_decline" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_cagr_zero_years" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_cagr_negative_years" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_cagr_zero_start_value" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_cagr_negative_start_value" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_cagr_zero_end_value" time="0.001" /><testcase classname="tests.unit.test_metrics" name="test_cagr_ten_years" time="0.001" /><testcase classname="tests.unit.test_no_reference_import" name="test_reference_modules_raise_import_error[references.orchestration_reference]" time="0.006" /><testcase classname="tests.unit.test_no_reference_import" name="test_reference_modules_raise_import_error[references.prompts_reference]" time="0.002" /><testcase classname="tests.unit.test_no_reference_import" name="test_reference_modules_raise_import_error[references.rag_system_reference]" time="0.002" /><testcase classname="tests.unit.test_normalize" name="test_to_snake_case" time="0.001" /><testcase classname="tests.unit.test_normalize" name="test_normalize_params_year" time="0.001" /><testcase classname="tests.unit.test_normalize" name="test_normalize_params_timeout_and_max_rows" time="0.001" /><testcase classname="tests.unit.test_normalize" name="test_normalize_params_to_percent" time="0.001" /><testcase classname="tests.unit.test_normalize" name="test_normalize_params_combined" time="0.001" /><testcase classname="tests.unit.test_normalize" name="test_normalize_params_invalid_values" time="0.001" /><testcase classname="tests.unit.test_normalize" name="test_normalize_rows_basic" time="0.001" /><testcase classname="tests.unit.test_normalize" name="test_normalize_rows_plain_dict" time="0.001" /><testcase classname="tests.unit.test_normalize" name="test_normalize_rows_string_trimming" time="0.001" /><testcase classname="tests.unit.test_normalize" name="test_normalize_rows_multiple" time="0.001" /><testcase classname="tests.unit.test_normalize" name="test_normalize_rows_numeric_values" time="0.001" /><testcase classname="tests.unit.test_normalize" name="test_normalize_rows_row_model" time="0.001" /><testcase classname="tests.unit.test_normalize" name="test_normalize_rows_idempotent" time="0.001" /><testcase classname="tests.unit.test_normalize" name="test_normalize_rows_non_mapping_input" time="0.001" /><testcase classname="tests.unit.test_orchestration_council" name="test_council_config_defaults" time="0.001" /><testcase classname="tests.unit.test_orchestration_council" name="test_council_config_custom" time="0.001" /><testcase classname="tests.unit.test_orchestration_council" name="test_default_agents_creates_five" time="0.192" /><testcase classname="tests.unit.test_orchestration_council" name="test_default_agents_types" time="0.190" /><testcase classname="tests.unit.test_orchestration_council" name="test_run_council_structure" time="0.200" /><testcase classname="tests.unit.test_orchestration_council" name="test_run_council_agent_names" time="0.200" /><testcase classname="tests.unit.test_orchestration_council" name="test_run_council_findings_format" time="0.201" /><testcase classname="tests.unit.test_orchestration_council" name="test_run_council_verification_format" time="0.201" /><testcase classname="tests.unit.test_orchestration_council" name="test_run_council_custom_agents" time="0.200" /><testcase classname="tests.unit.test_orchestration_council" name="test_run_council_consensus_computed" time="0.200" /><testcase classname="tests.unit.test_orchestration_council" name="test_run_council_deterministic" time="0.399" /><testcase classname="tests.unit.test_orchestration_council" name="test_run_council_with_ttl" time="0.201" /><testcase classname="tests.unit.test_orchestration_council" name="test_run_council_warnings_collected" time="0.202" /><testcase classname="tests.unit.test_orchestration_council" name="test_run_council_json_serializable" time="0.202" /><testcase classname="tests.unit.test_orchestration_council" name="test_run_council_empty_findings_edge_case" time="0.200" /><testcase classname="tests.unit.test_orchestration_council" name="test_run_council_min_confidence" time="0.200" /><testcase classname="tests.unit.test_orchestration_council" name="test_run_council_rate_limit_env" time="0.201" /><testcase classname="tests.unit.test_orchestration_format" name="test_format_report_redacts_and_enriches_metadata" time="0.002" /><testcase classname="tests.unit.test_orchestration_invoke" name="test_invoke_rejects_unknown_params" time="0.002" /><testcase classname="tests.unit.test_orchestration_invoke" name="test_invoke_allows_var_kwargs" time="0.002" /><testcase classname="tests.unit.test_orchestration_invoke" name="test_invoke_retries_transient_error" time="0.002" /><testcase classname="tests.unit.test_orchestration_registry" name="test_registry_register_and_resolve" time="0.001" /><testcase classname="tests.unit.test_orchestration_registry" name="test_registry_get_method" time="0.001" /><testcase classname="tests.unit.test_orchestration_registry" name="test_registry_intents" time="0.001" /><testcase classname="tests.unit.test_orchestration_registry" name="test_registry_is_registered" time="0.001" /><testcase classname="tests.unit.test_orchestration_registry" name="test_registry_duplicate_registration" time="0.002" /><testcase classname="tests.unit.test_orchestration_registry" name="test_registry_missing_method" time="0.001" /><testcase classname="tests.unit.test_orchestration_registry" name="test_registry_not_callable" time="0.001" /><testcase classname="tests.unit.test_orchestration_registry" name="test_registry_unknown_intent" time="0.001" /><testcase classname="tests.unit.test_orchestration_registry" name="test_registry_clear" time="0.001" /><testcase classname="tests.unit.test_orchestration_schemas" name="test_orchestration_task_minimal" time="0.001" /><testcase classname="tests.unit.test_orchestration_schemas" name="test_orchestration_task_full" time="0.001" /><testcase classname="tests.unit.test_orchestration_schemas" name="test_orchestration_task_invalid_intent" time="0.001" /><testcase classname="tests.unit.test_orchestration_schemas" name="test_report_section" time="0.001" /><testcase classname="tests.unit.test_orchestration_schemas" name="test_citation" time="0.001" /><testcase classname="tests.unit.test_orchestration_schemas" name="test_freshness" time="0.001" /><testcase classname="tests.unit.test_orchestration_schemas" name="test_reproducibility" time="0.001" /><testcase classname="tests.unit.test_orchestration_schemas" name="test_orchestration_result_success" time="0.001" /><testcase classname="tests.unit.test_orchestration_schemas" name="test_orchestration_result_with_warnings" time="0.001" /><testcase classname="tests.unit.test_orchestration_schemas" name="test_orchestration_result_error" time="0.001" /><testcase classname="tests.unit.test_orchestration_schemas" name="test_workflow_state" time="0.001" /><testcase classname="tests.unit.test_orchestration_schemas" name="test_orchestration_task_invalid_year_range" time="0.001" /><testcase classname="tests.unit.test_orchestration_schemas" name="test_orchestration_task_invalid_top_n" time="0.001" /><testcase classname="tests.unit.test_orchestration_schemas" name="test_orchestration_task_invalid_months" time="0.001" /><testcase classname="tests.unit.test_orchestration_synthesis" name="test_synthesize_empty_reports" time="0.001" /><testcase classname="tests.unit.test_orchestration_synthesis" name="test_synthesize_single_report" time="0.001" /><testcase classname="tests.unit.test_orchestration_synthesis" name="test_synthesize_two_reports_consensus" time="0.001" /><testcase classname="tests.unit.test_orchestration_synthesis" name="test_synthesize_multiple_reports_consensus" time="0.001" /><testcase classname="tests.unit.test_orchestration_synthesis" name="test_synthesize_mixed_metrics" time="0.001" /><testcase classname="tests.unit.test_orchestration_synthesis" name="test_synthesize_warnings_deduplication" time="0.001" /><testcase classname="tests.unit.test_orchestration_synthesis" name="test_synthesize_warnings_from_insights" time="0.001" /><testcase classname="tests.unit.test_orchestration_synthesis" name="test_synthesize_findings_aggregation" time="0.001" /><testcase classname="tests.unit.test_orchestration_synthesis" name="test_synthesize_non_numeric_metrics_ignored" time="0.001" /><testcase classname="tests.unit.test_orchestration_synthesis" name="test_synthesize_consensus_precision" time="0.001" /><testcase classname="tests.unit.test_orchestration_synthesis" name="test_synthesize_agent_order_preserved" time="0.001" /><testcase classname="tests.unit.test_orchestration_synthesis" name="test_synthesize_empty_findings" time="0.001" /><testcase classname="tests.unit.test_orchestration_synthesis" name="test_synthesize_integer_metrics" time="0.001" /><testcase classname="tests.unit.test_orchestration_synthesis" name="test_synthesize_zero_values" time="0.001" /><testcase classname="tests.unit.test_orchestration_synthesis" name="test_synthesize_negative_values" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verification_passes_valid_percent" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verification_fails_negative_percent" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verification_fails_excessive_percent" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verification_yoy_within_bounds" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verification_yoy_extreme_negative" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verification_yoy_extreme_positive" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verification_sum_to_one_valid" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verification_sum_to_one_within_tolerance" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verification_sum_to_one_fails" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verification_missing_gender_fields" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verification_non_numeric_values" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verification_multiple_issues" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verify_report_aggregates_insight_issues" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verify_report_empty_findings" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verification_edge_case_exactly_zero" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verification_edge_case_exactly_100" time="0.001" /><testcase classname="tests.unit.test_orchestration_verification" name="test_verification_edge_case_yoy_bounds" time="0.001" /><testcase classname="tests.unit.test_postprocess_pipeline" name="test_empty_pipeline" time="0.001" /><testcase classname="tests.unit.test_postprocess_pipeline" name="test_single_transform" time="0.001" /><testcase classname="tests.unit.test_postprocess_pipeline" name="test_pipeline_compose" time="0.001" /><testcase classname="tests.unit.test_postprocess_pipeline" name="test_share_of_total_pipeline" time="0.001" /><testcase classname="tests.unit.test_postprocess_pipeline" name="test_rename_and_select_pipeline" time="0.001" /><testcase classname="tests.unit.test_postprocess_pipeline" name="test_rolling_avg_pipeline" time="0.001" /><testcase classname="tests.unit.test_postprocess_pipeline" name="test_complex_pipeline" time="0.001" /><testcase classname="tests.unit.test_postprocess_pipeline" name="test_to_percent_pipeline" time="0.001" /><testcase classname="tests.unit.test_postprocess_pipeline" name="test_unknown_transform_raises" time="0.001" /><testcase classname="tests.unit.test_postprocess_pipeline" name="test_pipeline_with_missing_params" time="0.001" /><testcase classname="tests.unit.test_postprocess_pipeline" name="test_top_n_negative_clamped" time="0.001" /><testcase classname="tests.unit.test_postprocess_pipeline" name="test_yoy_in_pipeline" time="0.001" /><testcase classname="tests.unit.test_postprocess_pipeline" name="test_share_of_total_with_groups" time="0.001" /><testcase classname="tests.unit.test_queries_yaml_loads" name="test_yaml_queries_load_successfully" time="0.192" /><testcase classname="tests.unit.test_queries_yaml_loads" name="test_query_specs_have_required_fields" time="0.190" /><testcase classname="tests.unit.test_queries_yaml_loads" name="test_query_params_have_valid_patterns" time="0.190" /><testcase classname="tests.unit.test_queries_yaml_loads" name="test_query_year_filters" time="0.190" /><testcase classname="tests.unit.test_queries_yaml_loads" name="test_constraints_structure" time="0.190" /><testcase classname="tests.unit.test_queries_yaml_loads" name="test_no_duplicate_query_ids" time="0.189" /><testcase classname="tests.unit.test_queries_yaml_loads" name="test_select_fields_not_empty" time="0.189" /><testcase classname="tests.unit.test_queries_yaml_loads" name="test_expected_units_match_data_types" time="0.189" /><testcase classname="tests.unit.test_registry" name="test_registry_load_and_get" time="0.016" /><testcase classname="tests.unit.test_registry" name="test_registry_missing_directory" time="0.003" /><testcase classname="tests.unit.test_registry" name="test_registry_duplicate_ids" time="0.017" /><testcase classname="tests.unit.test_registry" name="test_registry_all_ids" time="0.025" /><testcase classname="tests.unit.test_router_classification.TestExplicitIntentRouting" name="test_explicit_intent_success" time="0.005" /><testcase classname="tests.unit.test_router_classification.TestExplicitIntentRouting" name="test_explicit_intent_unregistered" time="0.005" /><testcase classname="tests.unit.test_router_classification.TestExplicitIntentRouting" name="test_explicit_intent_with_params" time="0.005" /><testcase classname="tests.unit.test_router_classification.TestQueryClassificationRouting" name="test_simple_query_classification" time="0.006" /><testcase classname="tests.unit.test_router_classification.TestQueryClassificationRouting" name="test_correlation_query" time="0.006" /><testcase classname="tests.unit.test_router_classification.TestQueryClassificationRouting" name="test_gcc_benchmark_query" time="0.006" /><testcase classname="tests.unit.test_router_classification.TestQueryClassificationRouting" name="test_low_confidence_query" time="0.006" /><testcase classname="tests.unit.test_router_classification.TestQueryClassificationRouting" name="test_no_matching_intents" time="0.006" /><testcase classname="tests.unit.test_router_classification.TestQueryClassificationRouting" name="test_classification_updates_task" time="0.006" /><testcase classname="tests.unit.test_router_classification.TestQueryClassificationRouting" name="test_crisis_classification" time="0.006" /><testcase classname="tests.unit.test_router_classification.TestRoutingDecision" name="test_routing_decision_single_mode" time="0.006" /><testcase classname="tests.unit.test_router_classification.TestRoutingDecision" name="test_routing_decision_prefetch" time="0.006" /><testcase classname="tests.unit.test_router_classification.TestRoutingDecision" name="test_routing_decision_notes" time="0.006" /><testcase classname="tests.unit.test_router_classification.TestRoutingDecision" name="test_tie_forces_parallel_mode" time="0.006" /><testcase classname="tests.unit.test_router_classification.TestScenarioRouting" name="test_scenario_apply_routes_single" time="0.006"><failure message="KeyError: 'route'">self = &lt;test_router_classification.TestScenarioRouting object at 0x000001C13D9FA5D0&gt;
mock_registry = &lt;src.qnwis.orchestration.registry.AgentRegistry object at 0x000001C144266690&gt;

    def test_scenario_apply_routes_single(self, mock_registry: AgentRegistry) -&gt; None:
        """Scenario apply queries should map to scenario.apply intent."""
        task = OrchestrationTask(
            query_text="Scenario: improve Construction retention by 8% over the next 12 months"
        )
        state = {"task": task.model_dump(), "logs": []}
    
        result = route_intent(state, mock_registry)
    
&gt;       assert result["route"] == "scenario.apply"
               ^^^^^^^^^^^^^^^
E       KeyError: 'route'

tests\unit\test_router_classification.py:265: KeyError</failure></testcase><testcase classname="tests.unit.test_router_classification.TestScenarioRouting" name="test_scenario_compare_routes_single" time="0.007"><failure message="AssertionError: assert 'parallel' == 'single'&#10;  &#10;  - single&#10;  + parallel">self = &lt;test_router_classification.TestScenarioRouting object at 0x000001C13D9FAC50&gt;
mock_registry = &lt;src.qnwis.orchestration.registry.AgentRegistry object at 0x000001C1442C42D0&gt;

    def test_scenario_compare_routes_single(self, mock_registry: AgentRegistry) -&gt; None:
        """Scenario compare queries should not trigger ties."""
        task = OrchestrationTask(
            query_text="Compare optimistic vs pessimistic qatarization scenarios for Energy"
        )
        state = {"task": task.model_dump(), "logs": []}
    
        result = route_intent(state, mock_registry)
    
        assert result["route"] == "scenario.compare"
&gt;       assert result["routing_decision"]["mode"] == "single"
E       AssertionError: assert 'parallel' == 'single'
E         
E         - single
E         + parallel

tests\unit\test_router_classification.py:279: AssertionError</failure></testcase><testcase classname="tests.unit.test_router_classification.TestScenarioRouting" name="test_scenario_batch_routes_single" time="0.006"><failure message="KeyError: 'route'">self = &lt;test_router_classification.TestScenarioRouting object at 0x000001C13D9FB2D0&gt;
mock_registry = &lt;src.qnwis.orchestration.registry.AgentRegistry object at 0x000001C144261D50&gt;

    def test_scenario_batch_routes_single(self, mock_registry: AgentRegistry) -&gt; None:
        """Scenario batch queries should resolve to scenario.batch intent."""
        task = OrchestrationTask(
            query_text="Batch run retention scenarios for Construction, Finance, and ICT to estimate national impact"
        )
        state = {"task": task.model_dump(), "logs": []}
    
        result = route_intent(state, mock_registry)
    
&gt;       assert result["route"] == "scenario.batch"
               ^^^^^^^^^^^^^^^
E       KeyError: 'route'

tests\unit\test_router_classification.py:291: KeyError</failure></testcase><testcase classname="tests.unit.test_router_classification.TestErrorHandling" name="test_no_task_provided" time="0.005" /><testcase classname="tests.unit.test_router_classification.TestErrorHandling" name="test_neither_intent_nor_query" time="0.005" /><testcase classname="tests.unit.test_router_classification.TestErrorHandling" name="test_both_intent_and_query" time="0.001" /><testcase classname="tests.unit.test_router_classification.TestLogging" name="test_logs_updated" time="0.005" /><testcase classname="tests.unit.test_router_classification.TestLogging" name="test_logs_preserve_existing" time="0.005" /><testcase classname="tests.unit.test_secret_scan_script" name="test_secret_scan_allowlist_trims_blank_lines" time="1.201" /><testcase classname="tests.unit.test_secret_scan_script" name="test_secret_scan_reports_diff_on_findings" time="0.786" /><testcase classname="tests.unit.test_svg_renderer" name="test_bar_chart_svg_basic" time="0.001" /><testcase classname="tests.unit.test_svg_renderer" name="test_bar_chart_svg_empty" time="0.001" /><testcase classname="tests.unit.test_svg_renderer" name="test_bar_chart_svg_escaping" time="0.001" /><testcase classname="tests.unit.test_svg_renderer" name="test_line_chart_svg_basic" time="0.001" /><testcase classname="tests.unit.test_svg_renderer" name="test_line_chart_svg_empty" time="0.001" /><testcase classname="tests.unit.test_svg_renderer" name="test_line_chart_svg_single_point" time="0.001" /><testcase classname="tests.unit.test_svg_renderer" name="test_line_chart_svg_none_values" time="0.001" /><testcase classname="tests.unit.test_svg_renderer" name="test_svg_deterministic" time="0.001" /><testcase classname="tests.unit.test_svg_renderer" name="test_line_chart_svg_deterministic" time="0.001" /><testcase classname="tests.unit.test_synthetic_shapes" name="test_companies_csv_shape" time="0.031" /><testcase classname="tests.unit.test_synthetic_shapes" name="test_employment_history_csv_shape" time="0.023" /><testcase classname="tests.unit.test_synthetic_shapes" name="test_aggregate_files_exist" time="0.019" /><testcase classname="tests.unit.test_synthetic_shapes" name="test_avg_salary_values_plausible" time="0.914" /><testcase classname="tests.unit.test_synthetic_shapes" name="test_gcc_unemployment_structure" time="1.146" /><testcase classname="tests.unit.test_synthetic_shapes" name="test_qatarization_percentages" time="1.497" /><testcase classname="tests.unit.test_synthetic_shapes" name="test_attrition_rate_distribution" time="1.491" /><testcase classname="tests.unit.test_synthetic_shapes" name="test_ewi_drop_percent_bounds" time="1.496" /><testcase classname="tests.unit.test_synthetic_shapes" name="test_invalid_generator_args" time="0.004" /><testcase classname="tests.unit.test_transforms_base" name="test_select_columns" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_filter_equals" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_rename_columns" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_to_percent" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_top_n_descending" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_top_n_ascending" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_top_n_descending_none_defaults_true" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_top_n_negative_returns_empty" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_top_n_rejects_non_int_n" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_share_of_total_single_group" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_share_of_total_multiple_groups" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_yoy_basic" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_yoy_missing_values" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_rolling_avg_basic" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_rolling_avg_window_2" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_rolling_avg_custom_out_key" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_composed_transforms" time="0.001" /><testcase classname="tests.unit.test_transforms_base" name="test_top_n_with_select" time="0.001" /><testcase classname="tests.unit.test_triangulation_bundle" name="test_triangulation_runs_on_synthetic" time="1.704" /><testcase classname="tests.unit.test_triangulation_bundle" name="test_triangulation_results_structure" time="1.707" /><testcase classname="tests.unit.test_triangulation_bundle" name="test_triangulation_issues_have_structure" time="1.707" /><testcase classname="tests.unit.test_triangulation_bundle" name="test_triangulation_samples_exist" time="1.699" /><testcase classname="tests.unit.test_triangulation_bundle" name="test_triangulation_warnings_format" time="1.699" /><testcase classname="tests.unit.test_triangulation_rules" name="test_sum_to_one_flags_delta" time="0.001" /><testcase classname="tests.unit.test_triangulation_rules" name="test_sum_to_one_passes_within_tolerance" time="0.001" /><testcase classname="tests.unit.test_triangulation_rules" name="test_percent_bounds" time="0.001" /><testcase classname="tests.unit.test_triangulation_rules" name="test_percent_bounds_passes" time="0.001" /><testcase classname="tests.unit.test_triangulation_rules" name="test_percent_bounds_ignores_non_percent" time="0.001" /><testcase classname="tests.unit.test_triangulation_rules" name="test_yoy_bounds" time="0.001" /><testcase classname="tests.unit.test_triangulation_rules" name="test_yoy_bounds_passes" time="0.001" /><testcase classname="tests.unit.test_triangulation_rules" name="test_qatarization_formula" time="0.001" /><testcase classname="tests.unit.test_triangulation_rules" name="test_qatarization_formula_passes" time="0.001" /><testcase classname="tests.unit.test_triangulation_rules" name="test_qatarization_formula_with_tolerance" time="0.001" /><testcase classname="tests.unit.test_triangulation_rules" name="test_ewi_vs_yoy_sign" time="0.001" /><testcase classname="tests.unit.test_triangulation_rules" name="test_ewi_vs_yoy_sign_passes" time="0.001" /><testcase classname="tests.unit.test_triangulation_rules" name="test_ewi_vs_yoy_sign_low_ewi" time="0.001" /><testcase classname="tests.unit.test_triangulation_rules" name="test_none_handling" time="0.001" /><testcase classname="tests.unit.test_ui_exports" name="test_png_and_csv_exports" time="2.014" /><testcase classname="tests.unit.test_ui_exports" name="test_csv_top_sectors" time="1.713" /><testcase classname="tests.unit.test_ui_exports" name="test_b64img_encoding" time="0.001" /><testcase classname="tests.unit.test_ui_exports" name="test_png_exports_deterministic" time="2.050" /><testcase classname="tests.unit.test_ui_exports" name="test_csv_exports_deterministic" time="1.720" /><testcase classname="tests.unit.test_ui_helpers" name="test_cards_and_charts" time="1.750" /><testcase classname="tests.unit.test_ui_helpers" name="test_top_n_clamping" time="1.736" /><testcase classname="tests.unit.test_ui_helpers" name="test_year_defaulting" time="1.733" /><testcase classname="tests.unit.test_ui_html" name="test_render_dashboard_html" time="2.033" /><testcase classname="tests.unit.test_ui_html" name="test_render_dashboard_html_with_year" time="2.040" /><testcase classname="tests.unit.test_ui_html" name="test_render_dashboard_html_deterministic" time="2.374" /><testcase classname="tests.unit.test_ui_html" name="test_render_dashboard_html_different_sectors" time="2.364" /><testcase classname="tests.unit.test_ui_html" name="test_render_dashboard_html_structure" time="2.055" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_basic_creation" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_stable_query_id" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_different_params_different_id" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_different_operation_different_id" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_provenance_includes_sources" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_provenance_operation_documented" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_empty_sources" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_multiple_rows" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_empty_rows" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_unit_parameter" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_default_unit_unknown" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_freshness_with_timestamps" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_freshness_from_sources" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_freshness_without_timestamps" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_fields_extracted_from_first_row" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_dataset_id_format" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_source_type_csv" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_license_documented" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_warnings_empty_by_default" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_complex_params_in_query_id" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_query_id_hash_length" time="0.001" /><testcase classname="tests.unit.test_utils_derived_results.TestMakeDerivedQueryResult" name="test_integration_example" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestPearson" name="test_perfect_positive_correlation" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestPearson" name="test_perfect_negative_correlation" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestPearson" name="test_no_correlation" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestPearson" name="test_zero_variance_x" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestPearson" name="test_zero_variance_both" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestPearson" name="test_length_mismatch_raises" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestPearson" name="test_insufficient_data_raises" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestPearson" name="test_known_correlation" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestSpearman" name="test_perfect_monotonic_increasing" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestSpearman" name="test_perfect_monotonic_decreasing" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestSpearman" name="test_robust_to_outliers" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestSpearman" name="test_tied_ranks" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestSpearman" name="test_zero_variance" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestZScores" name="test_standardization" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestZScores" name="test_symmetry" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestZScores" name="test_zero_variance_returns_zeros" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestZScores" name="test_single_value" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestZScores" name="test_empty_list" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestZScores" name="test_known_values" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestWinsorize" name="test_clip_extreme_high" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestWinsorize" name="test_clip_extreme_low" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestWinsorize" name="test_symmetric_clipping" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestWinsorize" name="test_no_change_normal_data" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestWinsorize" name="test_single_value_unchanged" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestWinsorize" name="test_empty_list" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestWinsorize" name="test_invalid_p_raises" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestWinsorize" name="test_deterministic" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestRankHelper" name="test_rank_stability" time="0.001" /><testcase classname="tests.unit.test_utils_statistics.TestRankHelper" name="test_tied_ranks_average" time="0.001" /><testcase classname="tests.unit.test_world_bank_connector" name="test_world_bank_query_success" time="0.003"><failure message="pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness&#10;asof_date&#10;  Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]&#10;    For further information visit https://errors.pydantic.dev/2.11/v/value_error">monkeypatch = &lt;_pytest.monkeypatch.MonkeyPatch object at 0x000001C1461A0510&gt;

    def test_world_bank_query_success(monkeypatch: pytest.MonkeyPatch) -&gt; None:
        expected_records = [{"country": "QAT", "year": 2023, "value": 1.23, "indicator": "NY.GDP"}]
    
        class DummyIntegrator:
            def get_indicator(
                self,
                *,
                indicator: str,
                countries: list[str],
                year: int | None,
                start_year: int | None,
                end_year: int | None,
                timeout_s: float | None,
                max_rows: int | None,
            ) -&gt; pd.DataFrame:
                assert indicator == "NY.GDP"
                assert countries == ["QAT"]
                assert timeout_s == pytest.approx(1.5)
                assert max_rows == 10
                return pd.DataFrame(expected_records)
    
        monkeypatch.setattr(world_bank_det, "UDCGlobalDataIntegrator", DummyIntegrator)
        spec = _make_spec(
            {"indicator": "NY.GDP", "countries": ["QAT"], "timeout_s": 1.5, "max_rows": 10}
        )
    
&gt;       result = world_bank_det.run_world_bank_query(spec)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\unit\test_world_bank_connector.py:47: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

spec = QuerySpec(id='wb', title='World Bank', description='test', source='world_bank', params={'indicator': 'NY.GDP', 'countries': ['QAT'], 'timeout_s': 1.5, 'max_rows': 10}, expected_unit='percent', constraints={}, postprocess=[])

    def run_world_bank_query(spec: QuerySpec) -&gt; QueryResult:
        """
        Execute a deterministic World Bank query via the shared API integrator.
    
        Required params:
            indicator (str): World Bank indicator code.
    
        Optional params:
            countries (Iterable[str]): ISO-3 country codes (default GCC set).
            year / start_year / end_year: Passed through to the API client.
            timeout_s (float): Maximum seconds per API request (default 30).
            max_rows (int): Maximum rows to include in the result set (default 10000).
        """
        params = spec.params or {}
        indicator = params.get("indicator")
        if not isinstance(indicator, str) or not indicator.strip():
            raise ValueError("World Bank query requires a non-empty 'indicator' parameter.")
        indicator_code = indicator.strip()
    
        countries = _validate_countries(params.get("countries"))
    
        # Default timeout_s to 30 if not provided
        timeout_s = 30.0
        if "timeout_s" in params:
            timeout_s = _validate_positive_number(params["timeout_s"], "timeout_s")
    
        # Default max_rows to 10000 if not provided
        max_rows = 10000
        if "max_rows" in params:
            max_rows = _validate_positive_int(params["max_rows"], "max_rows")
    
        if UDCGlobalDataIntegrator is None:
            raise ImportError(
                "World Bank connector requires 'data.apis.world_bank' module. "
                "Please install the required external dependency."
            )
    
        integ = UDCGlobalDataIntegrator()
        dataframe = integ.get_indicator(
            indicator=indicator_code,
            countries=countries,
            year=params.get("year"),
            start_year=params.get("start_year"),
            end_year=params.get("end_year"),
            timeout_s=timeout_s,
            max_rows=max_rows,
        )
    
        if dataframe.empty:
            raise ValueError(
                f"World Bank query returned no data for indicator '{indicator_code}' "
                f"with countries {countries}"
            )
    
        records = dataframe.to_dict(orient="records")
        rows: list[Row] = [Row(data=record) for record in records]
    
        return QueryResult(
            query_id=spec.id,
            rows=rows,
            unit=spec.expected_unit,
            provenance=Provenance(
                source="world_bank",
                dataset_id=indicator_code,
                locator=f"indicator={indicator_code}",
                fields=list(dataframe.columns),
                license=WORLD_BANK_LICENSE,
            ),
&gt;           freshness=Freshness(asof_date="api", updated_at=None),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        )
E       pydantic_core._pydantic_core.ValidationError: 1 validation error for Freshness
E       asof_date
E         Value error, Invalid isoformat string: 'api' [type=value_error, input_value='api', input_type=str]
E           For further information visit https://errors.pydantic.dev/2.11/v/value_error

src\qnwis\data\connectors\world_bank_det.py:125: ValidationError</failure></testcase><testcase classname="tests.unit.test_world_bank_connector" name="test_world_bank_query_empty" time="0.002" /><testcase classname="tests.unit.test_world_bank_connector" name="test_world_bank_query_invalid_country" time="0.001" /><testcase classname="tests.unit.test_world_bank_connector" name="test_world_bank_missing_indicator" time="0.001" /><testcase classname="tests.unit.utils.test_derived_results_logging_simple" name="test_derived_results_has_logger" time="0.001" /><testcase classname="tests.unit.utils.test_derived_results_logging_simple" name="test_derived_results_no_bare_pass" time="0.004" /><testcase classname="tests.unit.utils.test_derived_results_logging_simple" name="test_derived_results_uses_logger_debug" time="0.001" /><testcase classname="tests.unit.utils.test_derived_results_logging_simple" name="test_derived_results_handles_type_error" time="0.001" /><testcase classname="tests.unit.utils.test_derived_results_logging_simple" name="test_derived_results_freshness_logic_intact" time="0.001" /><testcase classname="tests.unit.verification.test_audit_perf.TestAuditPerformance" name="test_pack_generation_with_large_narrative" time="0.028" /><testcase classname="tests.unit.verification.test_audit_perf.TestAuditPerformance" name="test_pack_write_creates_all_files" time="0.018" /><testcase classname="tests.unit.verification.test_audit_perf.TestAuditPerformance" name="test_hmac_computation_overhead" time="0.029" /><testcase classname="tests.unit.verification.test_audit_store.TestSQLiteAuditTrailStore" name="test_sqlite_upsert_get_list" time="0.313" /><testcase classname="tests.unit.verification.test_audit_store.TestSQLiteAuditTrailStore" name="test_sqlite_update_existing" time="0.308" /><testcase classname="tests.unit.verification.test_audit_store.TestSQLiteAuditTrailStore" name="test_sqlite_get_nonexistent" time="0.289" /><testcase classname="tests.unit.verification.test_audit_store.TestSQLiteAuditTrailStore" name="test_sqlite_search_by_request_id" time="0.298" /><testcase classname="tests.unit.verification.test_audit_store.TestSQLiteAuditTrailStore" name="test_sqlite_list_failed_verifications" time="0.310" /><testcase classname="tests.unit.verification.test_audit_store.TestSQLiteAuditTrailStore" name="test_sqlite_delete" time="0.309" /><testcase classname="tests.unit.verification.test_audit_store.TestSQLiteAuditTrailStore" name="test_sqlite_limit_parameter" time="0.337" /><testcase classname="tests.unit.verification.test_audit_store.TestFileSystemAuditTrailStore" name="test_filesystem_index_and_lookup" time="0.005" /><testcase classname="tests.unit.verification.test_audit_store.TestFileSystemAuditTrailStore" name="test_filesystem_list_all" time="0.009" /><testcase classname="tests.unit.verification.test_audit_store.TestFileSystemAuditTrailStore" name="test_filesystem_load_manifest" time="0.015" /><testcase classname="tests.unit.verification.test_audit_store.TestFileSystemAuditTrailStore" name="test_filesystem_load_nonexistent" time="0.002" /><testcase classname="tests.unit.verification.test_audit_store.TestFileSystemAuditTrailStore" name="test_filesystem_get_path_nonexistent" time="0.002" /><testcase classname="tests.unit.verification.test_audit_store.TestFileSystemAuditTrailStore" name="test_filesystem_index_idempotent" time="0.006" /><testcase classname="tests.unit.verification.test_audit_trail.TestAuditManifest" name="test_manifest_to_dict_and_from_dict" time="0.001" /><testcase classname="tests.unit.verification.test_audit_trail.TestAuditTrailGenerateTrail" name="test_generate_trail_collects_query_ids_sources_freshness" time="0.003" /><testcase classname="tests.unit.verification.test_audit_trail.TestAuditTrailGenerateTrail" name="test_redaction_applied_to_summaries" time="0.003" /><testcase classname="tests.unit.verification.test_audit_trail.TestAuditTrailWritePack" name="test_write_pack_writes_manifest_and_files" time="0.024"><failure message="assert 'from src.qnwis.data.deterministic.api import DataAPI' in '&quot;&quot;&quot;\nReproducibility snippet for audit pack.\nRegistry version: v1.0.0\n&quot;&quot;&quot;\n\nfrom qnwis.data.deterministic.api impo...# Compare results to evidence/*.json in audit pack\nprint(f&quot;Fetched {len(results)} / {len(query_ids)} QueryResults&quot;)\n'">self = &lt;test_audit_trail.TestAuditTrailWritePack object at 0x000001C13DAC43D0&gt;
sample_query_results = [QueryResult(query_id='labor_supply', rows=[Row(data={'year': 2023, 'count': 100000})], unit='count', provenance=Prove...cense=None), freshness=Freshness(asof_date='2023-12-31', updated_at='2024-01-10T08:30:00Z'), metadata={}, warnings=[])]
sample_verification = VerificationSummary(ok=True, issues=[], redacted_text=None, applied_redactions=0, stats={'L2/ok': 5, 'L3/ok': 3, 'L4/ok': 2}, summary_md=None, redaction_reason_codes=[], citation_report=None, result_verification_report=None)
sample_citations = CitationReport(ok=True, total_numbers=10, cited_numbers=10, uncited=[], malformed=[], missing_qid=[], sources_used={'labor_supply': 6, 'unemployment_rate': 4}, runtime_ms=12.5)
temp_pack_dir = WindowsPath('C:/Users/ADMIN-~1/AppData/Local/Temp/2/tmpkjwfq04e')

    def test_write_pack_writes_manifest_and_files(
        self,
        sample_query_results: list[QueryResult],
        sample_verification: VerificationSummary,
        sample_citations: CitationReport,
        temp_pack_dir: Path,
    ) -&gt; None:
        """Test that write_pack creates all expected files."""
        trail = AuditTrail(pack_dir=str(temp_pack_dir))
    
        manifest = trail.generate_trail(
            response_md="The unemployment rate is 3.5%.",
            qresults=sample_query_results,
            verification=sample_verification,
            citations=sample_citations,
            orchestration_meta={},
            code_version="abc123",
            registry_version="v1.0.0",
            request_id="req-003",
        )
    
        final_manifest = trail.write_pack(
            manifest=manifest,
            response_md="The unemployment rate is 3.5%.",
            qresults=sample_query_results,
            citations=sample_citations,
            result_report=None,
        )
    
        pack_root = Path(final_manifest.pack_root)
    
        # Check directory structure
        assert pack_root.exists()
        assert (pack_root / "manifest.json").exists()
        assert (pack_root / "narrative.md").exists()
        assert (pack_root / "reproducibility.py").exists()
        assert (pack_root / "evidence").is_dir()
        assert (pack_root / "verification").is_dir()
        assert (pack_root / "sources").is_dir()
    
        # Check evidence files
        assert (pack_root / "evidence" / "labor_supply.json").exists()
        assert (pack_root / "evidence" / "unemployment_rate.json").exists()
    
        # Check verification files
        assert (pack_root / "verification" / "citations.json").exists()
    
        # Check reproducibility snippet is executable Python
        snippet_path = pack_root / "reproducibility.py"
        snippet_text = snippet_path.read_text(encoding="utf-8")
&gt;       assert "from src.qnwis.data.deterministic.api import DataAPI" in snippet_text
E       assert 'from src.qnwis.data.deterministic.api import DataAPI' in '"""\nReproducibility snippet for audit pack.\nRegistry version: v1.0.0\n"""\n\nfrom qnwis.data.deterministic.api impo...# Compare results to evidence/*.json in audit pack\nprint(f"Fetched {len(results)} / {len(query_ids)} QueryResults")\n'

tests\unit\verification\test_audit_trail.py:281: AssertionError</failure></testcase><testcase classname="tests.unit.verification.test_audit_trail.TestAuditTrailWritePack" name="test_pack_digest_matches_verify_tool" time="0.023" /><testcase classname="tests.unit.verification.test_audit_trail.TestAuditTrailWritePack" name="test_write_pack_with_hmac" time="0.023" /><testcase classname="tests.unit.verification.test_audit_trail.TestAuditTrailVerifyPack" name="test_verify_pack_detects_tampering" time="0.033" /><testcase classname="tests.unit.verification.test_audit_trail.TestAuditTrailVerifyPack" name="test_verify_pack_missing_manifest" time="0.002" /><testcase classname="tests.unit.verification.test_audit_utils.TestCanonicalJson" name="test_canonical_json_stable_digest" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestCanonicalJson" name="test_canonical_json_no_whitespace" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestCanonicalJson" name="test_canonical_json_unicode_preserved" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestSha256Digest" name="test_sha256_and_hmac_generation" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestSha256Digest" name="test_sha256_different_inputs" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestHmacSha256" name="test_hmac_with_valid_key" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestHmacSha256" name="test_hmac_empty_key_raises" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestHmacSha256" name="test_hmac_different_keys" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestRedactText" name="test_redaction_applied_to_summaries" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestRedactText" name="test_redact_preserves_non_pii" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestRedactText" name="test_redact_multiple_names" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestSlugifyFilename" name="test_slugify_basic" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestSlugifyFilename" name="test_slugify_special_characters" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestSlugifyFilename" name="test_slugify_empty_string" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestSlugifyFilename" name="test_slugify_preserves_safe_chars" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestReproducibilitySnippet" name="test_reproducibility_snippet_contains_query_ids_and_version" time="0.001"><failure message="assert 'from src.qnwis.data.deterministic.api import DataAPI' in '&quot;&quot;&quot;\nReproducibility snippet for audit pack.\nRegistry version: v1.2.3-abc123\n&quot;&quot;&quot;\n\nfrom qnwis.data.deterministic.a...# Compare results to evidence/*.json in audit pack\nprint(f&quot;Fetched {len(results)} / {len(query_ids)} QueryResults&quot;)\n'">self = &lt;test_audit_utils.TestReproducibilitySnippet object at 0x000001C13DAD4850&gt;

    def test_reproducibility_snippet_contains_query_ids_and_version(self) -&gt; None:
        """Test that snippet includes query IDs and registry version."""
        query_ids = ["labor_supply", "unemployment_by_nationality", "wage_trends"]
        registry_version = "v1.2.3-abc123"
    
        snippet = reproducibility_snippet(query_ids, registry_version)
    
        # Should contain all query IDs
        for qid in query_ids:
            assert qid in snippet
    
        # Should contain registry version
        assert registry_version in snippet
    
        # Should be valid Python (basic check)
&gt;       assert "from src.qnwis.data.deterministic.api import DataAPI" in snippet
E       assert 'from src.qnwis.data.deterministic.api import DataAPI' in '"""\nReproducibility snippet for audit pack.\nRegistry version: v1.2.3-abc123\n"""\n\nfrom qnwis.data.deterministic.a...# Compare results to evidence/*.json in audit pack\nprint(f"Fetched {len(results)} / {len(query_ids)} QueryResults")\n'

tests\unit\verification\test_audit_utils.py:195: AssertionError</failure></testcase><testcase classname="tests.unit.verification.test_audit_utils.TestReproducibilitySnippet" name="test_reproducibility_snippet_is_executable_python" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestComputeParamsHash" name="test_compute_params_hash_deterministic" time="0.001" /><testcase classname="tests.unit.verification.test_audit_utils.TestComputeParamsHash" name="test_compute_params_hash_different_values" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestExtractNumericSpans" name="test_simple_number" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestExtractNumericSpans" name="test_percentage" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestExtractNumericSpans" name="test_ignore_year" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestExtractNumericSpans" name="test_ignore_historical_years" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestExtractNumericSpans" name="test_ignore_small_numbers" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestExtractNumericSpans" name="test_ignore_tokens" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestExtractNumericSpans" name="test_ignore_identifier_tokens" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestExtractNumericSpans" name="test_multiple_numbers" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestFindCitationContext" name="test_simple_sentence" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestFindCitationContext" name="test_multi_line_context" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestFindCitationContext" name="test_window_limiting" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestFindCitationContext" name="test_sentence_boundary" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestValidateContext" name="test_valid_citation_with_qid" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestValidateContext" name="test_valid_citation_gcc_stat" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestValidateContext" name="test_missing_source" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestValidateContext" name="test_missing_qid" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestValidateContext" name="test_qid_not_required" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestValidateContext" name="test_case_insensitive_source" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestValidateContext" name="test_query_id_equals_format" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestValidateContext" name="test_synonym_normalization" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestValidateContext" name="test_missing_qid_warning_severity" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestValidateContext" name="test_strict_metric_requires_qid_even_when_optional" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestMapSourcesToQueryResults" name="test_valid_mapping_lmis" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestMapSourcesToQueryResults" name="test_no_mapping_defined" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestMapSourcesToQueryResults" name="test_empty_query_results" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestMapSourcesToQueryResults" name="test_multiple_query_results" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestMapSourcesToQueryResults" name="test_world_bank_mapping" time="0.001" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestEnforceCitations" name="test_valid_citations_pass" time="0.002" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestEnforceCitations" name="test_uncited_number_fails" time="0.002" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestEnforceCitations" name="test_missing_qid_fails" time="0.002" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestEnforceCitations" name="test_unknown_source_fails" time="0.002" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestEnforceCitations" name="test_multiple_citations" time="0.002" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestEnforceCitations" name="test_mixed_citations" time="0.002" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestEnforceCitations" name="test_ignore_years" time="0.002" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestEnforceCitations" name="test_empty_text" time="0.002" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestEnforceCitations" name="test_no_numbers" time="0.002" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestEnforceCitations" name="test_synonym_prefix_passes" time="0.002" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestEnforceCitations" name="test_adjacent_bullet_lines_are_linked" time="0.002" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestEnforceCitations" name="test_missing_qid_warning_allows_workflow" time="0.002" /><testcase classname="tests.unit.verification.test_citation_enforcer.TestEnforceCitations" name="test_performance_runtime_under_20ms" time="0.002" /><testcase classname="tests.unit.verification.test_citation_patterns.TestNumberPattern" name="test_integer" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestNumberPattern" name="test_decimal" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestNumberPattern" name="test_currency" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestNumberPattern" name="test_basis_points" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestNumberPattern" name="test_percentage" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestNumberPattern" name="test_thousand_separator" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestNumberPattern" name="test_negative_number" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestNumberPattern" name="test_multiple_numbers" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestYearPattern" name="test_2000s_year" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestYearPattern" name="test_1900s_year" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestYearPattern" name="test_not_year" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestYearPattern" name="test_year_in_context" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestQIDPattern" name="test_qid_colon" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestQIDPattern" name="test_qid_equals" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestQIDPattern" name="test_query_id_param" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestQIDPattern" name="test_qid_with_underscores" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestQIDPattern" name="test_qid_with_hyphens" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestQIDPattern" name="test_no_qid" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestQIDPattern" name="test_short_qid_rejected" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestSourcePrefixPattern" name="test_per_lmis" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestSourcePrefixPattern" name="test_gcc_stat" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestSourcePrefixPattern" name="test_world_bank" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestSourcePrefixPattern" name="test_gccstat_synonym" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestSourcePrefixPattern" name="test_case_insensitive" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestSourcePrefixPattern" name="test_no_prefix" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestSourcePrefixPattern" name="test_mid_sentence_prefix" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestIgnorableTokens" name="test_iso_code" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestIgnorableTokens" name="test_noc_code" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestIgnorableTokens" name="test_po_box" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestIgnorableTokens" name="test_rfc_number" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestIgnorableTokens" name="test_id_pattern" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestIgnorableTokens" name="test_not_ignorable" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestExtractNumberValue" name="test_positive_integer" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestExtractNumberValue" name="test_negative_number" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestExtractNumberValue" name="test_decimal" time="0.001" /><testcase classname="tests.unit.verification.test_citation_patterns.TestExtractNumberValue" name="test_thousand_separator" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentCitation" name="test_perfect_citation_coverage" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentCitation" name="test_partial_citation_coverage" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentCitation" name="test_citation_with_errors" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentCitation" name="test_no_numbers" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentCitation" name="test_small_sample_guard" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentNumbers" name="test_all_claims_matched" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentNumbers" name="test_partial_claims_matched" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentNumbers" name="test_math_check_failure" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentNumbers" name="test_no_claims" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentNumbers" name="test_small_sample_guard" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentCross" name="test_no_warnings" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentCross" name="test_multiple_warnings" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentCross" name="test_penalty_cap" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentPrivacy" name="test_no_redactions" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentPrivacy" name="test_redactions_penalized" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentFreshness" name="test_within_sla" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentFreshness" name="test_freshness_penalty" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestComponentFreshness" name="test_very_stale_data" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestAggregation" name="test_all_perfect" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestAggregation" name="test_insufficient_evidence" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestAggregation" name="test_weighted_average" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestAggregation" name="test_band_thresholds" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestAggregation" name="test_determinism" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestAggregation" name="test_weights_validation" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestAggregation" name="test_reasons_deduplicated" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestAggregation" name="test_reason_cap_enforced" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestAggregation" name="test_band_hysteresis_respects_previous_score" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestAggregation" name="test_dashboard_payload_exposes_metrics" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestEdgeCases" name="test_extreme_penalties_floor_at_zero" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestEdgeCases" name="test_zero_everything" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestEdgeCases" name="test_rounding_consistency" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestMonotonicity" name="test_more_citations_never_decrease" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestMonotonicity" name="test_fresher_data_never_decrease" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestMonotonicity" name="test_more_verified_claims_increase" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestMonotonicity" name="test_fewer_cross_warnings_increase" time="0.001" /><testcase classname="tests.unit.verification.test_confidence.TestPerformance" name="test_micro_benchmark" time="0.020" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestEndToEndScenarios" name="test_scenario_perfect_report" time="0.001" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestEndToEndScenarios" name="test_scenario_minor_issues" time="0.001" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestEndToEndScenarios" name="test_scenario_major_issues" time="0.002" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestEndToEndScenarios" name="test_scenario_verification_failure_with_audit" time="0.001" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestEndToEndScenarios" name="test_scenario_small_sample_report" time="0.001" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestEndToEndScenarios" name="test_scenario_no_verification_data" time="0.001" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestEndToEndScenarios" name="test_scenario_privacy_heavy_redactions" time="0.001" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestEndToEndScenarios" name="test_scenario_cross_source_discrepancies" time="0.001" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestEndToEndScenarios" name="test_scenario_stale_data" time="0.001" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestReasonAggregation" name="test_reasons_include_all_dimensions" time="0.001" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestReasonAggregation" name="test_reasons_respect_max_count" time="0.001" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestReasonAggregation" name="test_reasons_deterministic_order" time="0.001" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestDashboardPayload" name="test_dashboard_payload_structure" time="0.001" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestDashboardPayload" name="test_dashboard_payload_matches_result" time="0.001" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestBandHysteresis" name="test_band_stays_stable_within_tolerance" time="0.001" /><testcase classname="tests.unit.verification.test_confidence_aggregate.TestBandHysteresis" name="test_band_changes_beyond_tolerance" time="0.001" /><testcase classname="tests.unit.verification.test_confidence_perf.TestPerformanceBenchmarks" name="test_baseline_performance" time="0.050" /><testcase classname="tests.unit.verification.test_confidence_perf.TestPerformanceBenchmarks" name="test_large_input_performance" time="0.016" /><testcase classname="tests.unit.verification.test_confidence_perf.TestPerformanceBenchmarks" name="test_maximum_reasons_performance" time="0.034" /><testcase classname="tests.unit.verification.test_confidence_perf.TestPerformanceBenchmarks" name="test_hysteresis_overhead" time="0.053" /><testcase classname="tests.unit.verification.test_confidence_perf.TestPerformanceBenchmarks" name="test_component_computation_parallel" time="0.061" /><testcase classname="tests.unit.verification.test_confidence_perf.TestPerformanceBenchmarks" name="test_worst_case_performance" time="0.016" /><testcase classname="tests.unit.verification.test_confidence_perf.TestPerformanceBenchmarks" name="test_no_allocations_in_hot_path" time="0.055" /><testcase classname="tests.unit.verification.test_confidence_perf.TestPerformanceBenchmarks" name="test_determinism_no_performance_impact" time="0.146" /><testcase classname="tests.unit.verification.test_confidence_perf.TestScalability" name="test_scales_linearly_with_numbers" time="0.049" /><testcase classname="tests.unit.verification.test_confidence_perf.TestScalability" name="test_scales_with_reason_count" time="0.033" /><testcase classname="tests.unit.verification.test_engine_integration" name="test_verification_engine_basic_flow" time="0.001" /><testcase classname="tests.unit.verification.test_engine_integration" name="test_cross_check_layer" time="0.001" /><testcase classname="tests.unit.verification.test_engine_integration" name="test_sanity_checks_layer" time="0.001" /><testcase classname="tests.unit.verification.test_engine_integration" name="test_rbac_role_based_redaction" time="0.001" /><testcase classname="tests.unit.verification.test_engine_integration" name="test_issue_severity_classification" time="0.001" /><testcase classname="tests.unit.verification.test_engine_integration" name="test_empty_results_handling" time="0.001" /><testcase classname="tests.unit.verification.test_engine_integration" name="test_stats_aggregation" time="0.001" /><testcase classname="tests.unit.verification.test_layer2_crosschecks" name="test_cross_check_equal_values_no_issue" time="0.001" /><testcase classname="tests.unit.verification.test_layer2_crosschecks" name="test_cross_check_within_tolerance" time="0.001" /><testcase classname="tests.unit.verification.test_layer2_crosschecks" name="test_cross_check_outside_tolerance_flags_issue" time="0.001" /><testcase classname="tests.unit.verification.test_layer2_crosschecks" name="test_cross_check_metric_aliases_match" time="0.001" /><testcase classname="tests.unit.verification.test_layer2_crosschecks" name="test_cross_check_defaults_to_all_segment" time="0.001" /><testcase classname="tests.unit.verification.test_layer2_crosschecks" name="test_cross_check_benchmark_under_20ms" time="0.001" /><testcase classname="tests.unit.verification.test_layer3_privacy" name="test_redact_covers_emails_ids_and_names" time="0.001" /><testcase classname="tests.unit.verification.test_layer3_privacy" name="test_redact_respects_name_bypass_flag" time="0.001" /><testcase classname="tests.unit.verification.test_layer3_privacy" name="test_k_anonymity_flags_small_groups" time="0.001" /><testcase classname="tests.unit.verification.test_layer4_sanity" name="test_negative_values_are_flagged" time="0.001" /><testcase classname="tests.unit.verification.test_layer4_sanity" name="test_rate_bounds_enforced" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestNumericClaimExtraction" name="test_extract_simple_integer" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestNumericClaimExtraction" name="test_extract_percentage" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestNumericClaimExtraction" name="test_extract_currency" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestNumericClaimExtraction" name="test_extract_with_query_id" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestNumericClaimExtraction" name="test_ignore_years" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestNumericClaimExtraction" name="test_ignore_small_numbers" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestNumericClaimExtraction" name="test_multiple_claims" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestNumericClaimExtraction" name="test_extract_handles_commas_signs_and_currency" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestClaimBinding" name="test_bind_by_exact_query_id" time="0.011" /><testcase classname="tests.unit.verification.test_result_verifier.TestClaimBinding" name="test_bind_by_source_family" time="0.011" /><testcase classname="tests.unit.verification.test_result_verifier.TestClaimBinding" name="test_bind_data_field_match" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestClaimBinding" name="test_percentage_normalization" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestClaimBinding" name="test_rounding_tolerance" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestClaimBinding" name="test_no_match_when_outside_tolerance" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestClaimBinding" name="test_segment_aware_binding_prefers_matching_row" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestClaimBinding" name="test_ambiguous_sources_without_query_id" time="0.022" /><testcase classname="tests.unit.verification.test_result_verifier.TestClaimBinding" name="test_derived_share_recomputation_flags_inconsistency" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestMathConsistency" name="test_percentage_sum_passes" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestMathConsistency" name="test_percentage_sum_fails" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestMathConsistency" name="test_percentage_sum_within_tolerance" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestMathConsistency" name="test_no_checks_when_disabled" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestMathConsistency" name="test_markdown_table_total_mismatch" time="0.001" /><testcase classname="tests.unit.verification.test_result_verifier.TestVerifyNumbers" name="test_verify_all_claims_matched" time="0.012" /><testcase classname="tests.unit.verification.test_result_verifier.TestVerifyNumbers" name="test_verify_uncited_claim_error" time="0.004" /><testcase classname="tests.unit.verification.test_result_verifier.TestVerifyNumbers" name="test_verify_claim_not_found" time="0.012" /><testcase classname="tests.unit.verification.test_result_verifier.TestVerifyNumbers" name="test_verify_with_math_checks" time="0.002" /><testcase classname="tests.unit.verification.test_result_verifier.TestVerifyNumbers" name="test_verify_ambiguous_sources_surface_warning" time="0.044" /><testcase classname="tests.unit.verification.test_result_verifier.TestVerifyNumbers" name="test_verify_rounding_mismatch_hint_included" time="0.002" /><testcase classname="tests.unit.verification.test_result_verifier.TestVerifyNumbers" name="test_verify_derived_share_inconsistency" time="0.002" /><testcase classname="tests.unit.verification.test_result_verifier.TestVerifyNumbers" name="test_verify_runtime_budget_under_five_seconds" time="2.468" /><testcase classname="tests.unit.verification.test_verification_failures" name="test_verification_errors_fail_workflow" time="0.002" /><testcase classname="tests.unit.verification.test_verification_failures" name="test_structural_failures_still_work" time="0.002" /><testcase classname="tests.unit.verification.test_verification_failures" name="test_verification_warnings_dont_fail" time="0.006" /></testsuite></testsuites>